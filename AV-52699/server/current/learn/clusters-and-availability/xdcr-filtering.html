<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<script>(window.dataLayer=window.dataLayer||[]).push({event:'gtm.js','gtm.start':+new Date()})</script>
<script async src="https://www.googletagmanager.com/gtm.js?id=GTM-MVPNN2"></script>
<title>XDCR Advanced Filtering | Couchbase Docs</title>
<link rel="stylesheet" href="../../../../_/css/site.css">
<script src="../../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="XDCR Advanced Filtering allows specified subsets of documents to be replicated from their source collection.">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="server">
<meta name="dcterms.identifier" content="7.2">
<meta name="page-url" content="/server/current/learn/clusters-and-availability/xdcr-filtering.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://docs.couchbase.com/home/index.html">
                    <img src="../../../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://docs.couchbase.com/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../cloud/index.html">
                      Capella
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/learn/pages/clusters-and-availability/xdcr-filtering.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../../introduction/intro.html">Couchbase Server</a></li>
<li class="crumb">Learn</li>
<li class="crumb"><a href="clusters-and-availability.html">Clusters and Availability</a></li>
<li class="crumb"><a href="replication-architecture.html">Availability</a></li>
<li class="crumb"><a href="xdcr-overview.html">Cross Data Center Replication (XDCR)</a></li>
<li class="crumb"><a href="xdcr-filtering.html">XDCR Advanced Filtering</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">XDCR Advanced Filtering</h1>
<div class="labels">
<ul></ul>
</div>


</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
XDCR Advanced Filtering allows specified subsets of documents to be replicated from their source collection.
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-xdcr-filtering"><a class="anchor" href="#configure-xdcr-filtering"></a>Understanding XDCR Advanced Filtering</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>XDCR filtering</em> allows a document to be included in or excluded from a filtered replication, based on the document&#8217;s fields and values.</p>
</div>
<div class="paragraph">
<p>Case-sensitive matches can be made on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>id</em> and <em>xattrs</em> values, within the document&#8217;s <em>metadata</em>.</p>
</li>
<li>
<p>Field-names and values, within the document&#8217;s <em>data</em>, nested to any degree.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Every document on which a match is successfully made is included in the filtered replication.
Other documents are <em>not</em> included.</p>
</div>
<div class="paragraph">
<p>Match-requirements are specified by means of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Regular Expressions</em>.
These can be used to specify case-sensitive character-matches, and thereby determine whether a field-name or value may entitle a document to be included in a replication.
See the reference information provided in <a href="../../xdcr-reference/xdcr-regular-expressions.html" class="xref page">XDCR Regular Expressions</a>.</p>
</li>
<li>
<p><em>Filtering Expressions</em>.
These allow comparisons and calculations to be made on the fields and values identified by means of <em>regular</em> expressions: based on the results, a document either is or is not included in a replication.
See the reference information provided in
<a href="../../xdcr-reference/xdcr-filtering-expressions.html" class="xref page">XDCR Filtering Expressions</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that fields and values on which matches are to be made should typically be kept immutable.
If the fields or values of a given document are changed after a replication has started (see <a href="#filter-expression-editing">Filter-Expression Editing</a>, below), such a document may no longer meet the criterion for replication, and so go unreplicated in its new form &#8212; and yet may already reside in its <em>previous</em> form on the target cluster; since it formerly met the criterion, and was duly replicated.
In consequence, a single document would be maintained with a different value on each cluster.</p>
</div>
<div class="paragraph">
<p>This page explains XDCR Advanced Filtering at a conceptual level.
For the practical steps involved, see <a href="../../manage/manage-xdcr/filter-xdcr-replication.html" class="xref page">Filter a Replication</a>.
See also the information provided in the <a href="../../xdcr-reference/xdcr-filtering-reference-intro.html" class="xref page">XDCR Advanced Filtering Reference</a>.</p>
</div>
<div class="sect2">
<h3 id="xdcr-advanced-filtering-with-scopes-and-collections"><a class="anchor" href="#xdcr-advanced-filtering-with-scopes-and-collections"></a>XDCR Advanced Filtering with Scopes and Collections</h3>
<div class="paragraph">
<p>One filter can be applied per replication: this filter therefore affects all mappings between scopes and collections, whether implicit or explicit.
The examples on this page show replications as extending from source bucket to target bucket: all mappings between source and target collections within these buckets should be understood to have the single filter applied to them.
For more information, see <a href="xdcr-with-scopes-and-collections.html" class="xref page">XDCR with Scopes and Collections</a>.</p>
</div>
<div class="paragraph">
<p>Note that in the special case of <em>migration</em>, multiple filters <em>can</em> be applied, each to one of multiple mappings: however, migration is intended only for the special case where data is initially established in newly created scopes and collections.
See <a href="xdcr-with-scopes-and-collections.html#migration" class="xref page">Migration</a>, for more information.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="no-filter-applied"><a class="anchor" href="#no-filter-applied"></a>No Filter Applied</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When no filter is applied, all documents in the specified source bucket are replicated to the specified target bucket.
For example:</p>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/xdcr/filter-replication-diagram-1-v3.png" alt="filter replication diagram 1 v3" width="720">
</div>
<div class="title">Figure 1. Replication with no filter applied</div>
</div>
<div class="paragraph">
<p>The replication <em>R</em> specifies as its source <em>Source Bucket</em>, on the <em>Source Cluster</em>; and specifies as its target <em>Target Bucket</em>, on the <em>Target Cluster</em>.
The replication specifies no filter.</p>
</div>
<div class="paragraph">
<p>When it starts, the replication examines the documents in the source bucket, which are <code>airline_10</code> and <code>airport_8835</code>.
Since no filter is applied, both documents are suitable for replication, and are duly replicated to the <em>Target Bucket</em>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="filter-applied"><a class="anchor" href="#filter-applied"></a>Filter Applied</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When a filter is applied, on those documents whose fields or values provide a successful match are included in the replication.
For example:</p>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/xdcr/filter-replication-diagram-2-v2.png" alt="filter replication diagram 2 v2" width="720">
</div>
<div class="title">Figure 2. Replication with filter applied</div>
</div>
<div class="paragraph">
<p>The replication  <em>R</em> specifies as its source <em>Source Bucket</em>, on the <em>Source Cluster</em>; and specifies as its target <em>Target Bucket</em>, on the <em>Target Cluster</em>.
The replication specifies a filter: this requires that a document have a <code>type</code> field, whose value is a string that contains the substring <code>air</code>, and that this be followed by the substring <code>l</code>.
For details on this kind of expression (referred to as <em>positive lookahead</em>), see the reference provided for <a href="../../xdcr-reference/xdcr-filtering-expressions.html" class="xref page">XDCR Filtering Expressions</a>.</p>
</div>
<div class="paragraph">
<p>When it starts, the replication examines the documents in the source bucket.
The document <code>airline_10</code> has a <code>type</code> field whose value provides a successful match; therefore, the document is replicated.
The document <code>airport_8835</code> does have a <code>type</code> field, but its value does not contain a string that provides a successful match; therefore, the document is <em>not</em> replicated.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="multiple-filters-applied"><a class="anchor" href="#multiple-filters-applied"></a>Multiple Filters Applied</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To support replication, <em>multiple filters</em> can be applied in either of two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>By means of ORing, within a single replication.
This allows a document to be replicated if any one of the specified filters makes a successful match.
For information, see the <a href="../../xdcr-reference/xdcr-filtering-reference-intro.html" class="xref page">XDCR Advanced Filtering Reference</a>.</p>
</li>
<li>
<p>By means of individual or multiple ORed filters, specified across multiple replications.
For example:</p>
</li>
</ul>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/xdcr/filter-replication-diagram-3a-v2.png" alt="filter replication diagram 3a v2" width="720">
</div>
<div class="title">Figure 3. Replication with multiple filters applied simultaneously</div>
</div>
<div class="paragraph">
<p>The replication  <em>R1</em> specifies as its source <em>Source Bucket</em>, on the <em>Source Cluster</em>; and specifies as its target <em>Target Bucket 1</em>, on the <em>Target Cluster 1</em>.
The replication specifies a filter: as in the previous example, this requires that a document have a <code>type</code> field, whose value is a string that contains the substring <code>air</code>, and that this be followed by the substring <code>l</code>.</p>
</div>
<div class="paragraph">
<p>When it starts, the replication examines the documents in the source bucket.
The document <code>airline_10</code> has a <code>type</code> field whose value provides a successful match; therefore, the document is replicated to <em>Target Bucket 1</em>.
The document <code>airport_8835</code> does have a <code>type</code> field, but its value does not contain a string that provides a successful match; therefore, the document is <em>not</em> replicated.</p>
</div>
<div class="paragraph">
<p>As <em>R1</em>, the replication <em>R2</em> specifies as its source <em>Source Bucket</em>, on the <em>Source Cluster</em>.
However, it specifies as its target <em>Target Bucket 2</em>, on the <em>Target Cluster 2</em>.
The replication specifies a filter: this requires that a document have a <code>type</code> field, whose value is a string that contains the substring <code>air</code>, and that this be followed by the substring <code>p</code>.</p>
</div>
<div class="paragraph">
<p>The document <code>airport_8835</code> has a <code>type</code> field whose value provides a successful match; therefore, the document is replicated to <em>Target Bucket 2</em>.
The document <code>airline_10</code> does have a <code>type</code> field, but its value does not contain a string that provides a successful match; therefore, the document is <em>not</em> replicated.</p>
</div>
<div class="paragraph">
<p>Thus, each of the two documents in the source is replicated to one, distinct target bucket, on its own target cluster.
Note that many variants of this example can be designed; including replicated the contents of a single source bucket to multiple target buckets on a single target cluster.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="filter-expression-editing"><a class="anchor" href="#filter-expression-editing"></a>Filter-Expression Editing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The filter-expressions defined for a particular replication can be edited after their initial definition and use.
This allows a single replication to employ multiple different filters and filter-combinations, sequentially.</p>
</div>
<div class="paragraph">
<p>Note that once a document has been replicated, it can only be removed from the target by being removed from the source.
Therefore, if a replication&#8217;s filter-expression is changed, although it changes the criterion whereby documents are to be replicated in future, it does not affect the presence on those documents already replicated to the target according to the old criterion.
If the intention is to populate the target <em>only</em> with documents that meet the new criterion, those documents on the target that do not meet the criterion must either be manually removed, or removed by means of <em>flushing</em>: see <a href="xdcr-overview.html#xdcr-bucket-flush" class="xref page">XDCR Bucket Flush</a>, for details.</p>
</div>
<div class="paragraph">
<p>Note also that a replication only prepares to replicate all documents in the source bucket during its <em>initial process</em>; and afterwards, only considers <em>mutations</em> as candidates for replication.
See <a href="xdcr-overview.html#xdcr-process" class="xref page">XDCR Process</a>, for details.
Two options are therefore made available, whereby the continuance of a replication can be configured, following the editing of a filter-expression:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Restart</em>.
The current instance of the replication is ended, and a new instance is started, with the new filtering criterion.
This causes a new running of the replication&#8217;s <em>initial process</em>, whereby all documents in the source bucket are examined.
In consequence, documents that already meet the new filtering criterion, but were not replicated according to the old filtering criterion, and have not been mutated, are determined to be candidates for replication.
This is the default.</p>
</li>
<li>
<p><em>Continue</em>.
The current instance of the replication continues, with the new filtering criterion.
The replication&#8217;s <em>initial process</em> is <em>not</em> re-run.
Therefore, documents that already meet the new filtering criterion, but were not replicated according to the old filtering criterion, and have not been mutated, are <em>not</em> replicated &#8212; unless they are mutated subsequently.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, it might be desirable to modify the replication shown above in Figure 2 &#8212; which searches for the string <code>air</code>, followed by the string <code>l</code> &#8212; without deleting and recreating the replication.
The possible results are shown below.</p>
</div>
<div class="sect2">
<h3 id="restart"><a class="anchor" href="#restart"></a>Restart</h3>
<div class="paragraph">
<p>In the following illustration, the filter-expression used in Figure 2 is changed, to search for the string <code>air</code>, followed by the string <code>p</code>.
The <em>restart</em> option is specified.</p>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/xdcr/filter-replication-diagram-5-v5.png" alt="filter replication diagram 5 v5" width="720">
</div>
<div class="title">Figure 4. Filter-expression edited, with restart option</div>
</div>
<div class="paragraph">
<p>In its original version, <em>R1</em>, the replication had identified, during its <em>initial process</em>, the document <code>airline_10</code>, which was duly replicated to the target bucket.
The original filter-expression is edited, so that the replication becomes <em>R1a</em>; and the replication is restarted.
During its <em>initial process</em>, it examines all documents in the source bucket; finding no match on <code>airline_10</code>, but finding a match on <code>airport_8835</code>, which is duly replicated to the target bucket.</p>
</div>
<div class="paragraph">
<p>Subsequently, <em>R1a</em> will examine all mutations, and will replicate those on which it achieves a successful match.</p>
</div>
</div>
<div class="sect2">
<h3 id="continue"><a class="anchor" href="#continue"></a>Continue</h3>
<div class="paragraph">
<p>In the following illustration, the filter-expression used in Figure 2 is again changed to search for the string <code>air</code>, followed by the string <code>p</code>.
This time, the <em>continue</em> option is specified.</p>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/xdcr/filter-replication-diagram-6-v5.png" alt="filter replication diagram 6 v5" width="720">
</div>
<div class="title">Figure 5. Filter-expression edited, with continue option</div>
</div>
<div class="paragraph">
<p>In its original version, <em>R1</em>, the replication had identified, during its <em>initial process</em>, the document <code>airline_10</code>, which was duly replicated to the target bucket.
The original filter-expression is edited, so that the replication becomes <em>R1a</em>; and the replication is continued.
There is no repetition of the <em>initial process</em>: therefore, the existing documents <code>airline_10</code> and <code>airport_8835</code> are not re-examined; and no replication occurs.</p>
</div>
<div class="paragraph">
<p>Subsequently, <em>R1a</em> will examine all mutations, and will replicate those on which it achieves a successful match.
This is illustrated as follows:</p>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/xdcr/filter-replication-diagram-7-v6.png" alt="filter replication diagram 7 v6" width="720">
</div>
<div class="title">Figure 6. Mutation recognized with continue option</div>
</div>
<div class="paragraph">
<p>The new document <code>airline_8838</code> is added the source bucket, and is examined by <em>R1a</em>.
A successful match is made, and <code>airline_8838</code> is duly replicated to the target bucket.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-deletion-filters"><a class="anchor" href="#using-deletion-filters"></a>Using Deletion Filters</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>Deletion filters</em> control whether the deletion of a document at source causes deletion of a replica document that exists on the replication-target.
For the <a href="../../manage/manage-xdcr/filter-xdcr-replication.html#deletion-filters" class="xref page">UI</a> each filter is selected by means of a checkbox.
For the <a href="#cli:cbcli/couchbase-cli-xdcr-replicate.adoc" class="xref unresolved">CLI</a> and <a href="../../rest-api/rest-xdcr-create-replication.html" class="xref page">REST API</a>, parameter-values must be specified.</p>
</div>
<div class="paragraph">
<p>Examples of filtering are provided in <a href="../../manage/manage-xdcr/filter-xdcr-replication.html" class="xref page">Filter a Replication</a>.</p>
</div>
<div class="sect2">
<h3 id="deletion-filter-types"><a class="anchor" href="#deletion-filter-types"></a>Deletion-Filter Types</h3>
<div class="paragraph">
<p>Deletion filters are of three types, and control the following.</p>
</div>
<div class="sect3">
<h4 id="replication-of-expirations"><a class="anchor" href="#replication-of-expirations"></a>Replication of Expirations</h4>
<div class="paragraph">
<p>Configured through the <a href="../../manage/manage-xdcr/filter-xdcr-replication.html#deletion-filters" class="xref page">UI</a> with the <strong>Do not replicate document expirations</strong> checkbox; through the <a href="#cli:cbcli/couchbase-cli-xdcr-replicate.adoc" class="xref unresolved">CLI</a> with the <code>filter-expiration</code> flag; and through the <a href="../../rest-api/rest-xdcr-create-replication.html" class="xref page">REST API</a> with the <code>filterExpiration</code> flag.
Selecting this option means that if, having been replicated, the document at source expires and is deleted, the replicated copy of the document will <em>not</em> be deleted.
Conversely, if this option is not selected or left <code>false</code> (which are the defaults), expirations at source are replicated; meaning that the replicated copy of the document <em>will</em> be deleted.</p>
</div>
</div>
<div class="sect3">
<h4 id="replication-of-deletions"><a class="anchor" href="#replication-of-deletions"></a>Replication of Deletions</h4>
<div class="paragraph">
<p>Configured through the <a href="../../manage/manage-xdcr/filter-xdcr-replication.html#deletion-filters" class="xref page">UI</a> with the <strong>Do not replicate DELETE operations</strong> checkbox; through the <a href="#cli:cbcli/couchbase-cli-xdcr-replicate.adoc" class="xref unresolved">CLI</a> with the <code>filter-deletion</code> flag; and through the <a href="../../rest-api/rest-xdcr-create-replication.html" class="xref page">REST API</a> with the <code>filterDeletion</code> flag.
Selecting this option determines that if, having been replicated, the document at source is deleted, the replicated copy of the document will <em>not</em> be deleted.
Conversely, leaving this option unselected or <code>false</code> (which are the defaults) replicates deletions that occur at source, meaning that the replicated copy of the document <em>will</em> be deleted.</p>
</div>
</div>
<div class="sect3">
<h4 id="replication-of-ttl"><a class="anchor" href="#replication-of-ttl"></a>Replication of TTL</h4>
<div class="paragraph">
<p>Configured through the <a href="../../manage/manage-xdcr/filter-xdcr-replication.html#deletion-filters" class="xref page">UI</a> with the <strong>Remove TTL from replicated items</strong> checkbox; through the <a href="#cli:cbcli/couchbase-cli-xdcr-replicate.adoc" class="xref unresolved">CLI</a> with the <code>reset-expiry</code> flag; and with the <a href="../../rest-api/rest-xdcr-create-replication.html" class="xref page">REST API</a> with the <code>filterBypassExpiry</code> flag.
Selecting this option determines that the TTL that a document bears at source is <em>not</em> made part of the replicated copy of the document: instead, the TTL of the replicated copy is set to 0.
Conversely, if this option is not selected or left <code>false</code> (which are the defaults), the TTL is made part of the replicated copy of the document, and may thereby determine when the replicated copy of the document expires.
Note, however, that the TTL applied to the replicated document at the target may be that of either the collection or the bucket in which it resides: for information, see <a href="../data/expiration.html" class="xref page">Expiration</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="deletion-filters-versus-filter-expressions"><a class="anchor" href="#deletion-filters-versus-filter-expressions"></a>Deletion Filters versus Filter Expressions</h3>
<div class="paragraph">
<p>By default, any source-document deletion (or expiration) <em>is</em> replicated to the target; resulting in a corresponding target-document deletion.
Note that such replication is <em>not</em> prevented by the specifying of a filter that is formed with regular and other filtering expressions: such expressions only determine which non-deleted documents are to be replicated.
Therefore, to ensure that document-deletions (and expirations) are <em>not</em> replicated, <em>deletion filters</em> must specifically be configured.</p>
</div>
</div>
<div class="sect2">
<h3 id="tombstones-dcp-events-and-replication"><a class="anchor" href="#tombstones-dcp-events-and-replication"></a>Tombstones, DCP Events, and Replication</h3>
<div class="paragraph">
<p>When a document is deleted or is expired, a tombstone is created.
Tombstones and their management are described in <a href="../buckets-memory-and-storage/storage-settings.html#tombstones" class="xref page">Tombstones</a>.
In order to replicate a deletion or an expiration, XDCR must be able to receive, on the source, a DCP event that corresponds to the creation of a tombstone for the deleted or expired document.
On receipt of the DCP event, XDCR generates its own, corresponding deletion or expiration event; and replicates this to the target.</p>
</div>
<div class="paragraph">
<p>However, in some instances, even if a tombstone has been created, XDCR may not receive the DCP event.
For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A document is deleted and then immediately recreated, such that DCP interprets the tombstone to have been at once superseded by the recreated document; and so does not send an event.</p>
</li>
<li>
<p>A replication is deleted; then, source documents are deleted or expired.
Tombstones are created; but no DCP event is sent to XDCR, since no replication exists.
Subsequently, the replication is recreated: the replication will from this point only receive DCP events that correspond to future deletions and expirations.</p>
<div class="paragraph">
<p>Note, however, that conversely, creation of a new replication in this way, if performed with greater immediacy, may indeed result in DCP sending events; and allow XDCR, in turn, to replicate deletion and expiration events to the target.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="expiration-ttl-and-replication"><a class="anchor" href="#expiration-ttl-and-replication"></a>Expiration, TTL, and Replication</h3>
<div class="paragraph">
<p>TTL can be established on individual documents, on collections, and on buckets.
The relationship between these settings, and the way the setting on an individual document is resolved when replicated to the target, is fully described in <a href="../data/expiration.html" class="xref page">Expiration</a>.</p>
</div>
<div class="paragraph">
<p>When a deletion or expiration event is replicated to the target, the replica-document at the target is deleted or expired irrespective of its current TTL.
Thus, the replica-document&#8217;s TTL may have been modified on the target, such that it specifies expiration at a later point in time than that specified by the TTL of the source document: nevertheless, when the source document expires, an expiration event is replicated, and the replica-document on the target is immediately expired.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="#configuring-deletion-filters-to-prevent-data-loss">Configuring Deletion Filters to Prevent Data-Loss</a>, immediately below.</p>
</div>
</div>
<div class="sect2">
<h3 id="configuring-deletion-filters-to-prevent-data-loss"><a class="anchor" href="#configuring-deletion-filters-to-prevent-data-loss"></a>Configuring Deletion Filters to Prevent Data-Loss</h3>
<div class="paragraph">
<p>Appropriate deletion-filter settings protect data.
However, in certain circumstances, inappropriate deletion-filter settings may cause <em>loss</em> of data.
For example:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>By means of replication <em>1</em>, documents of type <em>A</em> and type <em>B</em> are replicated to the target.</p>
</li>
<li>
<p>Replication <em>1</em> is deleted.</p>
</li>
<li>
<p>Documents of type <em>A</em> are deleted on the source; with the expectation that they will continue to exist on the target.</p>
</li>
<li>
<p>Replication <em>2</em> is created, with the default deletion-filter settings, so as to replicate to the target all future changes on the source to documents of type <em>B</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Here, the (incorrectly) expected outcome has been that documents of both type <em>A</em> and type <em>B</em> continue to exist on the target.
However, since document-deletions are replicated by default, replication <em>2</em> has deleted documents of type <em>A</em> from the target; and the actual outcome is therefore that only documents of type <em>B</em> exist on the target; with documents of type <em>A</em> existing on neither source nor target.</p>
</div>
<div class="paragraph">
<p>To avoid this outcome, replication <em>2</em> could be created with deletion filters configured to prevent the replication of deletions: the prior deletions of documents of type <em>A</em> from the source would thereby <em>not</em> be replicated to the target.
Note, however, that this would also prevent the replication of future source-deletions of type <em>B</em> documents.</p>
</div>
</div>
<div class="sect2">
<h3 id="configuring-deletion-filters-to-prevent-replication-of-stale-data"><a class="anchor" href="#configuring-deletion-filters-to-prevent-replication-of-stale-data"></a>Configuring Deletion-Filters to Prevent Replication of Stale Data</h3>
<div class="paragraph">
<p>In certain circumstances, inappropriate deletion-filter settings may allow <em>stale</em> data to be inadvertently replicated to the target.
For example:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A replication is established to replicate documents of type <em>A</em> and type <em>B</em> to the target.
Deletion-filter settings are configured to <em>prevent</em> replication of deletions that occur on the source.</p>
</li>
<li>
<p>After the replication has commenced, for reasons of security, documents of type <em>A</em> are deleted from the source.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Here, the (incorrectly) expected outcome has been that security requirements have been complied with, since documents of type <em>A</em> have been deleted from the source.
However, since deletion-filters have been configured <em>not</em> to replicate deletions, documents of type <em>A</em>, subsequent to their replication, continue to exist on the target as <em>stale</em> data; and do so in contravention of security requirements.</p>
</div>
<div class="paragraph">
<p>To avoid this outcome, the replication should be created with the default deletion-settings, so as to <em>permit</em> the replication of deletions.
This ensures that deletions made on the source also occur on the target.</p>
</div>
</div>
<div class="sect2">
<h3 id="deletion-filters-and-migration"><a class="anchor" href="#deletion-filters-and-migration"></a>Deletion Filters and Migration</h3>
<div class="paragraph">
<p>The appropriate configuring of deletion filters is critically important in cases of <em>migration</em> where documents are being assigned to newly created collections, with their source collection (often the default collection of a legacy bucket) intended subsequently to be dropped.
For example, the following sequence results in loss of data:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The default collection of a legacy bucket is determined to contain only documents that are either of type <em>A</em> or of type <em>B</em>.</p>
</li>
<li>
<p>Migration is configured to replicate documents of type <em>A</em> from the source, default collection to a new, target collection, named <em>A</em>; and documents of type <em>B</em> to another new, target collection, named <em>B</em>.
Deletion filters are left at their default settings.</p>
</li>
<li>
<p>Migration proceeds.
Eventually, all type <em>A</em> documents exist both in the source collection, and in the new, target collection <em>A</em>; and all type <em>B</em> documents exist both in the source collection, and in the new, target collection <em>B</em>.</p>
</li>
<li>
<p>The source, default collection is dropped; and all its data thereby deleted.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Here, the (incorrectly) expected result has been that all documents will continue to exist; in the new, target collections, <em>A</em> and <em>B</em>.
However, since the migration was not deleted prior to the deletion of the source data, and since the default settings of the deletion filters specified that document-deletions should be replicated; the actual result is that all documents from the target collections <em>A</em> and <em>B</em> have been deleted, along with the source, default collection, and all its data.</p>
</div>
<div class="sect3">
<h4 id="guarding-against-accidental-data-loss-during-migration"><a class="anchor" href="#guarding-against-accidental-data-loss-during-migration"></a>Guarding Against Accidental Data-Loss during Migration</h4>
<div class="paragraph">
<p>Either of the following approaches can be used to ensure that no migrated data is lost:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Configure deletion filters to prohibit the replication of deletions and/or expirations.
This ensures that only documents and their mutations are replicated to their new collection.</p>
<div class="paragraph">
<p>Note, however, that if read-write application-access continues to be granted to the source collection during the life of the migration, application-deletions and/or expirations that occur on the source are not replicated to the target collection; eventually rendering source and target collections inconsistent.</p>
</div>
</li>
<li>
<p>Keep deletion filters at their default setting, to permit the replication of deletions and/or expirations.
When the migration is judged to have completed, delete the migration <em>prior to</em> the deletion of any source data.
Then, once the migration is deleted, delete source data as appropriate.</p>
<div class="paragraph">
<p>Note that if a new replication is subsequently created between the same source and target collections, with deletion filters configured to permit the replication of deletions and/or expirations, the deletions and/or expirations will be replicated to the target if the tombstones produced by the source-data deletions and/or expirations have not yet been purged.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that before and during migration, both the <a href="../services-and-indexes/services/backup-service.html" class="xref page">Backup Service</a> and <a href="../../backup-restore/enterprise-backup-restore.html" class="xref page">cbbackupmgr</a> can be used to protect data.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-deletion-filters"><a class="anchor" href="#configuring-deletion-filters"></a>Configuring Deletion Filters</h3>
<div class="paragraph">
<p>For information on configuring deletion filters with the UI, see <a href="../../manage/manage-xdcr/filter-xdcr-replication.html#deletion-filters" class="xref page">Deletion Filters</a>;
with the CLI, see <a href="#cli:cbcli/couchbase-cli-xdcr-replicate.adoc" class="xref unresolved">xdcr-replicate</a>;
with the REST API, see <a href="../../rest-api/rest-xdcr-create-replication.html" class="xref page">Creating XDCR Replications</a>.</p>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>Â© 2023 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Server","components":["server"],"url":"/home/server.html","latestVersions":{"server":"7.2"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../../../_/js/site.js"></script>
<script defer src="../../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
</body>
</html>
