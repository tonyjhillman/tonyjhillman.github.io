<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<script>(window.dataLayer=window.dataLayer||[]).push({event:'gtm.js','gtm.start':+new Date()})</script>
<script async src="https://www.googletagmanager.com/gtm.js?id=GTM-MVPNN2"></script>
<title>Risk Assessment | Couchbase Docs</title>
<link rel="stylesheet" href="../../../_/css/site.css">
<script src="../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="This example illustrates how to leverage Eventing Service in the Banking and Financial domain.">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="server">
<meta name="dcterms.identifier" content="7.2">
<meta name="page-url" content="/server/current/eventing/eventing-examples-high-risk.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://docs.couchbase.com/home/index.html">
                    <img src="../../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://docs.couchbase.com/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../cloud/index.html">
                      Capella
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/eventing/pages/eventing-examples-high-risk.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../introduction/intro.html">Couchbase Server</a></li>
<li class="crumb"><a href="eventing-examples-high-risk.html">Risk Assessment</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Risk Assessment</h1>
<div class="labels">
<ul></ul>
</div>
<div class="labels">
<ul>
<li class="edition"><a href="https://www.couchbase.com/products/editions">Enterprise Edition</a></li>
</ul>
</div>


</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div class="paragraph">
<p><strong>Goal</strong>: This example illustrates how to leverage Eventing Service in the Banking and Financial domain.
When a credit card transaction either 1) exceeds the userâ€™s available credit limit or 2) is made in a foreign currency, a high-risk transaction alert can be generated.</p>
</div>
<div class="paragraph">
<p><strong>Implementation</strong>:</p>
</div>
<div class="paragraph">
<p>Create a JavaScript Function that contains an <strong>OnUpdate</strong> handler.
The handler listens to data-changes within a specified, <strong>'register'</strong> collection.
When a document with type='transaction' within this source collection is mutated, (created or changed),
the Eventing Function executes user-defined code to respond to the change in real time.</p>
</div>
<div class="paragraph">
<p><strong>The Eventing function will</strong>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Lookup details from the customers card information specifically: date, spending limits, location, and default currency. This data is from collection <strong>'register'</strong> with type='card'.</p>
</li>
<li>
<p>Lookup the exchange rates for the date from the transaction. This data is from collection <strong>'register'</strong> with type='exchange_rates'.</p>
</li>
<li>
<p>Normalize the currencies from both the transaction and the spending limit into USD (at the correct day&#8217;s exchange rate).</p>
</li>
<li>
<p>Determine if a spending threshold is exceeded (this is high risk).</p>
</li>
<li>
<p>Determine if the purchase is a foreign purchase (this is high risk).</p>
</li>
<li>
<p>For all high-risk transactions generate a new document containing both some transaction information and some calculated data.</p>
</li>
<li>
<p>Write the new document representing the suspect transaction to the <strong>'review'</strong> collection with type='transaction'.</p>
</li>
<li>
<p>[OPTIONAL] Use of cURL directly from Eventing, use of a custom application written in various Couchbase SDKs, or use of third-party integrations like Kafka to read the items written to the <strong>'review'</strong> collection (type='transaction') for further automated action.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preparations</strong>:</p>
</div>
<div class="paragraph">
<p>For this example, two (2) buckets <strong>'bulk'</strong> and <strong>'rr100'</strong> are required where the latter is intended to be 100% resident.
Create the buckets with a minimum size of 100MB.
For information on buckets, see <a href="../manage/manage-buckets/create-bucket.html" class="xref page">Create a Bucket</a>.
Within the buckets we need three (3) keyspaces <strong>'bulk.data.register'</strong>, <strong>'bulk.data.review'</strong>, and <strong>'rr100.eventing.metadata'</strong>
(we loosely follow this <a href="eventing-buckets-to-collections.html#single-tenancy" class="xref page">organization</a>).</p>
</div>
<div class="paragraph">
<p>For the Function Scope or RBAC grouping ,we will use the <strong>'bulk.data'</strong>, assuming you have the role of either "Full Admin" or "Eventing Full Admin". For standard or non-privileged users refer to <a href="eventing-rbac.html" class="xref page">Eventing Role-Based Access Control</a>.</p>
</div>
<div class="paragraph">
<p><em>If you run a version of Couchbase prior to 7.0 you can just create the buckets <strong>'register'</strong>, <strong>'review'</strong>, and <strong>'metadata'</strong> and run this example.  Furthermore if your cluster was subsequently upgraded from say 6.6.2 to 7.0 your data would be moved to <strong>'register._default._default'</strong>, <strong>'review._default._default'</strong>, and <strong>'metadata._default._default'</strong> and your Eventing Function would be seamlessly upgraded to use the new keyspaces and continue to run correctly.</em></p>
</div>
<div class="paragraph">
<p>For complete details on how to set up your keyspaces refer to <a href="../manage/manage-buckets/create-bucket.html" class="xref page">creating buckets</a> and
<a href="../manage/manage-scopes-and-collections/manage-scopes-and-collections.html" class="xref page">creating scopes and collections</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Eventing Storage keyspace, in this case <strong>'rr100.eventing.metadata'</strong>, is for the sole use of the Eventing system, do not add, modify, or delete documents from it.  In addition do not drop or flush or delete the containing bucket (or delete this collection) while you have any deployed Eventing functions. In a single tenancy deployment this collection can be shared with other Eventing functions.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Setup</strong>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Access the <strong>Couchbase Web Console</strong> &gt; <strong>Buckets</strong> page.</p>
<div class="ulist">
<ul>
<li>
<p>You should see the following once you have created your buckets:</p>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_01_buckets.png" alt="high risk txns 01 buckets" width="100%">
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>[Optional Step] Verify we have our empty collections:</p>
<div class="ulist">
<ul>
<li>
<p>Click the <strong>Scopes &amp; Collections</strong> link of the <strong>bulk</strong> bucket (on the right).</p>
</li>
<li>
<p>Click the <strong>data</strong> scope name to expand the section (on the left).</p>
</li>
<li>
<p>You should see no user records.</p>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_01_data_in_scope.png" alt="high risk txns 01 data in scope" width="100%">
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Click the <strong>Documents</strong> link of the <strong>register</strong> collection (on the right).</p>
<div class="ulist">
<ul>
<li>
<p>Again you should see no user records.</p>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_01_documents.png" alt="high risk txns 01 documents" width="800">
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Change the keyspace from <code>bulk</code>.<code>data</code>.<code>register</code> to <code>bulk</code>.<code>data</code>.<code>review</code> to view the <strong>review</strong> collection.</p>
<div class="ulist">
<ul>
<li>
<p>Again you should see no user records.</p>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_01a_documents.png" alt="high risk txns 01a documents" width="800">
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Procedure</strong>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Modify the <strong>'bulk'</strong> bucket to enable the ability to "flush" the items from the UI (<em>do not do this for the other bucket</em>). Access the <strong>Couchbase Web Console</strong> &gt; <strong>Buckets</strong> page, and select the bucket '<strong>bulk</strong>' to expand the bucket view.</p>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_01_bucket_edit.png" alt="high risk txns 01 bucket edit" width="100%">
</div>
</div>
<div class="paragraph">
<p>Now click on the <strong>'Edit'</strong> button to invoke the settings dialog for the '<strong>bulk</strong>' bucket.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Expand the 'Advanced bucket settings' control, then scroll to the bottom of the dialog
and check the final control <strong>'Flush [X] Enable'</strong>.</p>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_03_bucket_settings.png" alt="high risk txns 03 bucket settings" width="484">
</div>
</div>
<div class="paragraph">
<p>To save this change click the <strong>'Save Changes'</strong> button. Your <strong>'bulk'</strong> bucket can now be flushed (as there is now a new button available for the action).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_04_bucket_edit.png" alt="high risk txns 04 bucket edit" width="100%">
</div>
</div>
<div class="paragraph">
<p>For more details on bucket settings and screen images refer to <a href="../manage/manage-buckets/create-bucket.html#couchbase-bucket-settings" class="xref page">Bucket Settings</a>.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>From the <strong>Couchbase Web Console</strong> &gt; <strong>Query</strong> page, build an index for the <strong>'register'</strong> collection and an index for the '<strong>review</strong>' collection:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX `adv_type_rg` ON `bulk`.`data`.`register`(`type`);
CREATE INDEX `adv_type_rv` ON `bulk`.`data`.`review`(`type`);
CREATE PRIMARY INDEX `adv_prim_rv` ON `bulk`.`data`.`review`;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy and paste the three lines of text (above) into the Query Workbench and click <strong>'Execute'</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_05_create_indexes.png" alt="high risk txns 05 create indexes" width="100%">
</div>
</div>
<div class="paragraph">
<p>Although the above indexes are technically not needed for our Eventing function they will come in useful for exploring
the documents imported to the <strong>'register'</strong> collection and inserted into the '<strong>review</strong>' collection by our Eventing Function using the SQL++ language in the Query Workbench.</p>
</div>
</li>
<li>
<p>From the <strong>Couchbase Web Console</strong> &gt; <strong>Eventing</strong> page, click <strong>ADD FUNCTION</strong>, to add a new Function.
The <strong>ADD FUNCTION</strong> dialog appears.</p>
</li>
<li>
<p>In the <strong>ADD FUNCTION</strong> dialog, for individual Function elements provide the below information:</p>
<div class="ulist">
<ul>
<li>
<p>For the <strong>Function Scope</strong> drop-down, select <strong>'bulk.data'</strong> as the RBAC grouping.</p>
</li>
<li>
<p>For the <strong>Listen To Location</strong> drop-down, select <strong>bulk</strong>, <strong>data</strong>, <strong>source</strong> as the keyspace.</p>
</li>
<li>
<p>For the <strong>Eventing Storage</strong> drop-down, select <strong>rr100</strong>, <strong>eventing</strong>, <strong>metadata</strong> as the keyspace.</p>
</li>
<li>
<p>Enter <strong>high_risk_txns</strong> as the name of the Function you are creating in the <strong>Function Name</strong> text-box.</p>
</li>
<li>
<p>Leave the "Deployment Feed Boundary" as Everything.</p>
</li>
<li>
<p>[Optional Step] Enter text <strong>Flag items over credit threshold or a foreign transaction</strong>, in the <strong>Description</strong> text-box.</p>
</li>
<li>
<p>For the <strong>Settings</strong> option, use the default values.</p>
</li>
<li>
<p>For the <strong>Bindings</strong> option, add two bindings.</p>
<div class="ulist">
<ul>
<li>
<p>For the first binding, select "bucket alias", specify <strong>register</strong> as the "alias name" of the collection,
select <strong>bulk</strong>, <strong>data</strong>, <strong>register</strong> as the associated keyspace, and select "read only" for the access mode.</p>
</li>
<li>
<p>For the second binding, select "bucket alias", specify <strong>review</strong> as the "alias name" of the collection,
select <strong>bulk</strong>, <strong>data</strong>, and <strong>review</strong> as the associated keyspace, and select "read and write" for the access mode.</p>
</li>
</ul>
</div>
</li>
<li>
<p>After configuring your settings the <strong>ADD FUNCTION</strong> dialog should look like this:</p>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_01_settings.png" alt="high risk txns 01 settings" width="484">
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>After providing all the required information in the <strong>ADD FUNCTION</strong> dialog, click <strong>Next: Add Code</strong>.
The <strong>high_risk_txns</strong> dialog appears.</p>
<div class="ulist">
<ul>
<li>
<p>The <strong>high_risk_txns</strong> dialog initially contains a placeholder code block.
You will substitute your actual <strong>high_risk_txns code</strong> in this block.</p>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_02_default_code.png" alt="high risk txns 02 default code" width="100%">
</div>
</div>
</li>
<li>
<p>Copy the following Function and paste it in the placeholder code block of <strong>high_risk_txns</strong> dialog.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function OnUpdate(doc, meta) {
  if (doc.type != "transaction") return;
  try {
    var verbose = 0; // logging - 0: minimal, 1: moderate, 2: massive
    if (verbose &gt; 0) log(meta.id + ' Process transaction for doc.card: ' +
      doc.card + ', doc.amount: ' + nformat(doc.amount, 0, 2));

    // load the associated card info to this transaction
    var card = register['card:' + doc.card];
    if (!card) {
      log(meta.id + ' warn card does not exist: ' + doc.card);
      return;
    }

    // load the exchange rate table for the day of the transaction
    var erid = 'exchange_rates:er-' + (doc.date).substr(0, 10);
    var exchange_rates = register[erid];
    if (!exchange_rates) {
      log(meta.id + ' WARNING exchange_rates does not exist: ' + erid);
      return;
    }
    var to_USD = exchange_rates['to_USD'];
    var trxn_2_USD = to_USD[doc.currency];
    var card_2_USD = to_USD[card['currency']];
    if (!trxn_2_USD || !card_2_USD) {
      log(meta.id + ' WARNING exchange_rates for either ' + card['currency'] +
        ' or ' + doc.currency + ' does exist');
      return;
    }

    // convert transaction charge and credit card limit into USD
    var trxn_amount_USD = doc.amount / trxn_2_USD;
    var card_thresh_USD = card['threshold'] / card_2_USD;

    if (verbose &gt; 1) {
      log(meta.id + ' doc   ', doc);
      log(meta.id + ' card  ', card);
      log(meta.id + ' rates ', exchange_rates)
    }
    if (verbose &gt; 0) {
      log(meta.id + ' 1 doc.amount       ' + nformat(doc.amount, 8, 2) +
        ', card_limit       ' + nformat(card['threshold'], 8, 2));
      log(meta.id + ' 2 trxn_currency    ' + sformat(doc.currency, 8) +
        ', card_currency    ' + sformat(card['currency'], 8));
      log(meta.id + ' 3 trxn_2_USD       ' + nformat(trxn_2_USD, 8, 6) +
        ', card_2_USD       ' + nformat(card_2_USD, 8, 6));
      log(meta.id + ' 4 trxn_amount_USD  ' + nformat(trxn_amount_USD, 8, 2) +
        ', card_thresh_USD  ' + nformat(card_thresh_USD, 8, 2));
    }

    // check if high risk due to over threshold limit
    if (card_thresh_USD &lt; trxn_amount_USD) {
      var msg = 'High Risk Txn: amount: ' + nformat(doc.amount, 8, 2) + ' ' +
        doc.currency + ' exceeds purchase threshold: ' +
        nformat(card['threshold'], 8, 2) + ' ' + card['currency'];
      log(meta.id + ' *** ' + msg);
      doc["comments"] = msg; // append description to the document
      doc["reason_code"] = 'X-CREDIT'; // append the code to the document
      delete doc["city"]; // remove city sub document
      review[meta.id] = doc; // save the modified document for review
      return;
    }

    // check if high risk due to foreign purchase
    if (doc.currency != card['currency']) {
      var msg = 'High Risk Txn: currency mismatch card: ' +
        card['currency'] + ' != txn: ' + doc.currency;
      log(meta.id + ' *** ' + msg);
      doc["comments"] = msg; // append description to the document
      doc["reason_code"] = 'X-MISMATCH'; // append the code to the document
      delete doc["city"]; // remove city sub document
      review[meta.id] = doc; // save the modified document for review
      return;
    }
    if (verbose &gt; 0) log(meta.id + ' Charge by ' + card["firstname"] + ' ' +
      card["lastname"] + ' appears normal in the amount of ' +
      nformat(doc.amount, 0, 2) + ' ' + doc.currency);
  } catch (e) {
    // there was some sort of processing error or Exception, notify the user
    log(meta.id + 'ERROR in OnUpdate:', e);
  }
}

// right justify string with given width
function sformat(s, width) {
  var str = s;
  while (width &gt; str.length) str = ' ' + str;
  return str;
}

// right justify number with given width with given precision
function nformat(n, width, prec) {
  return sformat(n.toFixed(prec), width, prec);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After pasting, the screen appears as displayed below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_03_code.png" alt="high risk txns 03 code" width="100%">
</div>
</div>
</li>
<li>
<p>Click <strong>Save and Return</strong>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The <strong>OnUpdate</strong> handler above is triggered for every transaction.
The handler checks if the transaction amount is less than the userâ€™s available credit limit.
When this condition is breached, then this transaction is flagged as a high-risk transaction.
In addition, the handler checks if a foreign currency purchase has occurred, this is also flagged as a high-risk transaction.</p>
<div class="paragraph">
<p>The Function <strong>high_risk_txns</strong> then copies the transaction to the <strong>review</strong> bucket (but it removes some unneeded data and adds some enriched data). The handler enriches the document with predefined <em>comments</em> and also provides a <em>reason code</em>. In the last part, the handler performs a currency validation step.</p>
</div>
<div class="paragraph">
<p>The handler also converts both the credit limit and the transaction amount to a common currency, in this case USD, based upon current exchange rates on the exact date of the given transaction.</p>
</div>
</li>
<li>
<p>Now we will seed the required sample data. There are a total of four (4) data files that need to be downloaded to your Couchbase instance. Right-click on each of the links below and choose <strong>Save Link As</strong> to download the files. For remote instances, right-click on each of the links below and choose <strong>Copy Link Address</strong>, then use either the cURL or wget utility to download the files.</p>
<table id="optional-id1" class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 8.3333%;">
<col style="width: 16.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Data Set / File Name</strong></th>
<th class="tableblock halign-left valign-top"><strong>Description</strong></th>
<th class="tableblock halign-left valign-top"><strong>JSON type indicator</strong></th>
<th class="tableblock halign-left valign-top"><strong># Records</strong></th>
<th class="tableblock halign-left valign-top"><strong>Download link</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cards.json</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Credit card information</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">type='card'</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="_attachments/examples/high_risk/cards.json" target="_blank" rel="noopener">Download</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">merchants.json</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Merchant information</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">type='merchant'</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5001</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="_attachments/examples/high_risk/merchants.json" target="_blank" rel="noopener">Download</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">exchange_rates.json</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Daily exchange rates</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">type='exchange_rates'</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">422</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="_attachments/examples/high_risk/exchange_rates.json" target="_blank" rel="noopener">Download</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">txns.json</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Credit Card charges</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">type='transaction'</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">417</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="_attachments/examples/high_risk/txns.json" target="_blank" rel="noopener">Download</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>An example record from the <em>cards.json</em> file that you just downloaded encapsulates the information of a credit card:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "type": "card",
  "cardnumber": "4273-6623-8686-4599",
  "firstname": "Winfred",
  "lastname": "Raftery",
  "street": "3965 I-80 E Off Ramp",
  "mobile": "+1-617-555-1371",
  "sms": true,
  "city": {
    "name": "Uxbridge",
    "code": "MA",
    "state": "Massachusetts",
    "county": "Worcester",
    "display": "Uxbridge"
  },
  "issued": "11/15",
  "expiry": "6/19",
  "ccv": 736,
  "issuer": "Helena National Bank",
  "maxcredit": 1000,
  "threshold": 9500,
  "country": "US",
  "currency": "USD"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>An example record from the <em>merchants.json</em> file that you just downloaded encapsulates the information of a merchant:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
 "type": "merchant",
 "merchantid": "merchant-501233450539197794-0",
 "name": "FlightAware Inc",
 "city": {
  "name": "Bentonville",
  "code": "IN",
  "state": "Indiana",
  "county": "Fayette",
  "display": "Bentonville"
 }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>An example record from the <em>exchange_rates.json</em> file that you just downloaded encapsulates the information of a set of exchange rates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "type": "exchange_rates",
  "erid": "er-2017-09-01",
  "to_USD": {
    "CAD": 1.2441275168,
    "INR": 64.0331375839,
    "EUR": 0.8389261745,
    "USD": 1,
    "SGD": 1.3545302013,
    "GBP": 0.7724412752,
    "CNY": 6.5591442953,
    "AUD": 1.2601510067
  }
}</code></pre>
</div>
</div>
</li>
<li>
<p>An example record from the <em>txns.json</em> file that you just downloaded encapsulates the information of a transaction or a card charge:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "type": "transaction",
  "txnid": "tx-1526311379-002",
  "amount": 15.99,
  "product": "Thread Bore Brush: .22 Caliber, Centerfire",
  "card": "4273-6623-8686-4599",
  "merchant": "GoodGuide Inc",
  "city": {
    "name": "Waseca",
    "code": "MN",
    "state": "Minnesota",
    "county": "Waseca",
    "display": "Otisco"
  },
  "date": "2018-05-14T20:52:59+05:30",
  "currency": "USD"
}</code></pre>
</div>
</div>
</li>
<li>
<p>The downloaded files now need to all be loaded into the <strong>register</strong> bucket. This can be done as follows:</p>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_linux"></a>Linux</p>
</li>
<li>
<p><a id="tabset1_macos"></a>macOS</p>
</li>
<li>
<p><a id="tabset1_windows"></a>Windows</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_linux">
<div class="paragraph">
<p>Assuming that the downloaded files needed are in /tmp (note your username and password may differ)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-console hljs" data-lang="console">cd /opt/couchbase/bin/
CB_USERNAME=Administrator
CB_PASSWORD=password

./cbimport json -c http://localhost:8091 -u $CB_USERNAME -p $CB_PASSWORD -b bulk \
    --scope-collection-exp data.register \
    -f list -g '%type%:%txnid%' -d file:///tmp/txns.json

./cbimport json -c http://localhost:8091 -u $CB_USERNAME -p $CB_PASSWORD -b bulk \
    --scope-collection-exp data.register \
    -f list -g '%type%:%cardnumber%' -d file:///tmp/cards.json

./cbimport json -c http://localhost:8091 -u $CB_USERNAME -p $CB_PASSWORD -b bulk \
    --scope-collection-exp data.register \
    -f list -g '%type%:%merchantid%' -d file:///tmp/merchants.json

./cbimport json -c http://localhost:8091 -u $CB_USERNAME -p $CB_PASSWORD -b bulk \
    --scope-collection-exp data.register \
    -f list -g '%type%:%erid%' -d file:///tmp/exchange_rates.json</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_macos">
<div class="paragraph">
<p>Assuming that the downloaded files needed are in /Users/$USER/Downloads (note your username and password may differ)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-console hljs" data-lang="console">cd /Applications/Couchbase\ Server.app/Contents/Resources/couchbase-core/bin/
CB_USERNAME=Administrator
CB_PASSWORD=password

./cbimport json -c http://localhost:8091 -u $CB_USERNAME -p $CB_PASSWORD -b bulk \
    --scope-collection-exp data.register \
    -f list -g '%type%:%txnid%' -d file:///Users/$USER/Downloads/txns.json

./cbimport json -c http://localhost:8091 -u $CB_USERNAME -p $CB_PASSWORD -b bulk \
    --scope-collection-exp data.register \
    -f list -g '%type%:%cardnumber%' -d file:///Users/$USER/Downloads/cards.json

./cbimport json -c http://localhost:8091 -u $CB_USERNAME -p $CB_PASSWORD -b bulk \
    --scope-collection-exp data.register \
    -f list -g '%type%:%merchantid%' -d file:///Users/$USER/Downloads/merchants.json

./cbimport json -c http://localhost:8091 -u $CB_USERNAME -p $CB_PASSWORD -b bulk \
    --scope-collection-exp data.register \
    -f list -g '%type%:%erid%' -d file:///Users/$USER/Downloads/exchange_rates.json</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_windows">
<div class="paragraph">
<p>Assuming that the downloaded files needed are in "C:\Users\%USERNAME%\Downloads" (note your username and password may differ)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-console hljs" data-lang="console">cd "C:\Program Files\Couchbase\Server\bin\"
SET CB_USERNAME=Administrator
SET CB_PASSWORD=password

cbimport json -c http://localhost:8091 -u %CB_USERNAME% -p %CB_PASSWORD% -b bulk ^
    --scope-collection-exp data.register ^
    -f list -g '%type%:%txnid%' -d file:///C:/Users/%USERNAME%/Downloads/txns.json

cbimport json -c http://localhost:8091 -u %CB_USERNAME% -p %CB_PASSWORD% -b bulk ^
    --scope-collection-exp data.register ^
    -f list -g '%type%:%cardnumber%' -d file:///C:/Users/%USERNAME%/Downloads/cards.json

cbimport json -c http://localhost:8091 -u %CB_USERNAME% -p %CB_PASSWORD% -b bulk ^
    --scope-collection-exp data.register ^
    -f list -g '%type%:%merchantid%' -d file:///C:/Users/%USERNAME%/Downloads/merchants.json

cbimport json -c http://localhost:8091 -u %CB_USERNAME% -p %CB_PASSWORD% -b bulk ^
    --scope-collection-exp data.register ^
    -f list -g '%type%:%erid%' -d file:///C:/Users/%USERNAME%/Downloads/exchange_rates.json</code></pre>
</div>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Access the <strong>Couchbase Web Console</strong> &gt; <strong>Buckets</strong> page and notice that a total of 5,847 documents have been loaded into the bucket '<strong>register</strong>'.</p>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_06_json_loaded.png" alt="high risk txns 06 json loaded" width="100%">
</div>
</div>
</li>
<li>
<p>We are now ready to start the Eventing function. From the <strong>Eventing</strong> screen, click the <strong>high_risk_txns</strong> function to select it, then click <strong>Deploy</strong>.</p>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_06a_deploy.png" alt="high risk txns 06a deploy" width="100%">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Click <strong>Deploy Function</strong>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The Eventing function is deployed and starts running within a few seconds. From this point, the defined Function is executed on all existing documents and on subsequent mutations. After sufficient time has elapsed, there will be 40 new documents created in the <strong>'review'</strong> collection as well as logs generated by the Handler&#8217;s JavaScript code.</p>
</li>
<li>
<p>To review the Eventing Application Log for <strong>high_risk_txns</strong> access the <strong>Couchbase Web Console</strong> &gt; <strong>Eventing</strong> and
click the <strong>Log</strong> link of the deployed <strong>high_risk_txns</strong> Eventing function.</p>
<div class="ulist">
<ul>
<li>
<p>Note the Function Log Dialog lists log statements in reverse order (newest items first).</p>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_07_log.png" alt="high risk txns 07 log" width="100%">
</div>
</div>
</li>
<li>
<p>The dialog should have data similar to the following (only a few selected lines are displayed below):</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-console hljs" data-lang="console">2021-07-18T16:00:58.953-07:00 [INFO] "transaction:tx-1511710690-182 *** High Risk Txn: amount: 12506.00 USD exceeds purchase threshold: 12000.00 USD"

2021-07-18T16:00:58.952-07:00 [INFO] "transaction:tx-1505402809-074 *** High Risk Txn: currency mismatch card: USD != txn: EUR"

2021-07-18T16:00:58.938-07:00 [INFO] "transaction:tx-1514648212-166 *** High Risk Txn: amount: 12506.00 USD exceeds purchase threshold: 12000.00 USD"

2021-07-18T16:00:58.934-07:00 [INFO] "transaction:tx-1505315650-406 *** High Risk Txn: currency mismatch card: USD != txn: GBP"</code></pre>
</div>
</div>
</li>
<li>
<p>Alternatively you can locate the log file for your Eventing function "high_risk_txns.log" in the file system and inspect the output (only the last 10 lines are displayed below).  Below is a macOS logfile dump. <em>Note, that if you have more than one Eventing node the logs files will be split up as each eventing node only handles a portion of the documents.</em></p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-console hljs" data-lang="console">cd /Users/a_windows_user/Library/Application\ Support/Couchbase/var/lib/couchbase/data/@eventing

tail -10 high_risk_txns.log

2021-07-18T16:00:58.927-07:00 [INFO] "transaction:tx-1515315650-412 *** High Risk Txn: currency mismatch card: USD != txn: GBP"

2021-07-18T16:00:58.929-07:00 [INFO] "transaction:tx-1519055003-127 *** High Risk Txn: amount: 12506.00 USD exceeds purchase threshold: 12000.00 USD"

2021-07-18T16:00:58.931-07:00 [INFO] "transaction:tx-1520387868-416 *** High Risk Txn: currency mismatch card: USD != txn: GBP"

2021-07-18T16:00:58.934-07:00 [INFO] "transaction:tx-1505315650-406 *** High Risk Txn: currency mismatch card: USD != txn: GBP"

2021-07-18T16:00:58.938-07:00 [INFO] "transaction:tx-1514648212-166 *** High Risk Txn: amount: 12506.00 USD exceeds purchase threshold: 12000.00 USD"

2021-07-18T16:00:58.952-07:00 [INFO] "transaction:tx-1505402809-074 *** High Risk Txn: currency mismatch card: USD != txn: EUR"

2021-07-18T16:00:58.953-07:00 [INFO] "transaction:tx-1511710690-182 *** High Risk Txn: amount: 12506.00 USD exceeds purchase threshold: 12000.00 USD"

2021-07-18T16:00:58.959-07:00 [INFO] "transaction:tx-1514388425-140 *** High Risk Txn: amount: 12506.00 USD exceeds purchase threshold: 12000.00 USD"

2021-07-18T16:00:58.960-07:00 [INFO] "transaction:tx-1520344750-416 *** High Risk Txn: currency mismatch card: USD != txn: GBP"

2021-07-18T16:00:58.978-07:00 [INFO] "transaction:tx-1505315650-403 *** High Risk Txn: currency mismatch card: USD != txn: GBP"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default directories for the Eventing Application Logs are as follows:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Platform</th>
<th class="tableblock halign-left valign-top">Location</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Linux</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/opt/couchbase/var/lib/couchbase/data/@eventing/</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Windows</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">C:\Program Files\Couchbase\Server\var\lib\couchbase\data\@eventing\<br>
(Assumes default installation location)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mac OS X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/Users/&lt;user&gt;/Library/Application\ Support/Couchbase/var/lib/couchbase/data/@eventing/</p></td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
</li>
<li>
<p>To check the resulting documents of the deployed Function, access the <strong>Couchbase Web Console</strong> &gt; <strong>Documents</strong> page then select the keyspace <code>bulk</code>.<code>data</code>.<code>review</code>. You should see 40 new documents in this collection.  All documents written to this collection are transactions that are flagged as high-risk transactions.</p>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_08_bucket_documents.png" alt="high risk txns 08 bucket documents" width="%100">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>You can select any document in the <strong>review</strong> collection. In addition you can select by a specific key, for example <code>transaction:tx-1505315650-403</code>, by cutting and pasting this ID into the <strong>Document ID</strong> text box and hitting <kbd>Return</kbd>.</p>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_08_bucket_documents_by_id.png" alt="high risk txns 08 bucket documents by id" width="%100">
</div>
</div>
<div class="paragraph">
<p>Edit the document, the resulting dialog indicates that a purchase of an iMac was flagged as the credit card&#8217;s default currency was USD, but the purchase was in GBP, e.g. made with a merchant in a foreign country using a foreign currency.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "type": "transaction",
  "txnid": "tx-1505315650-403",
  "amount": 5383.35,
  "product": "Computer, iMac 64GB 4TB Nvme",
  "card": "4273-6623-8686-4599",
  "merchant": "Apple Regent Street",
  "date": "2018-09-14T20:46:10+05:30",
  "currency": "GBP",
  "comments": "High Risk Txn: currency mismatch card: USD != txn: GBP",
  "reason_code": "X-MISMATCH"
}</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_08_bucket_documents_edit.png" alt="high risk txns 08 bucket documents edit" width="578">
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>From the <strong>Couchbase Web Console</strong> &gt; <strong>Query</strong> page, run a few SQL++ queries on the new documents create in the <strong>'review</strong>' bucket:</p>
<div class="paragraph">
<p><strong>QUERY A</strong>, see how many high-risk transactions we found.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT COUNT(*) num_high_risk FROM `bulk`.`data`.`review` WHERE type='transaction';</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_09_n1ql_a.png" alt="high risk txns 09 n1ql a" width="%100">
</div>
</div>
<div class="paragraph">
<p><strong>QUERY B</strong>, look at all the data and with a specific order.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT * FROM `bulk`.`data`.`review` WHERE type='transaction'
ORDER BY currency, amount DESC;</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_09_n1ql_b.png" alt="high risk txns 09 n1ql b" width="%100">
</div>
</div>
<div class="paragraph">
<p><strong>QUERY C</strong>, look at the summarized data and with a specific order and grouping.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT COUNT(*) count, reason_code, SUM(amount) total_amount, currency
FROM `bulk`.`data`.`review` WHERE type='transaction'
GROUP BY reason_code, currency ORDER by count DESC;</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_09_n1ql_c.png" alt="high risk txns 09 n1ql c" width="%100">
</div>
</div>
<div class="paragraph">
<p><strong>QUERY D</strong>, look at a transaction record or document by key.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT * FROM `bulk`.`data`.`register` USE KEYS ('transaction:tx-1505315650-403');</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_09_n1ql_d.png" alt="high risk txns 09 n1ql d" width="%100">
</div>
</div>
<div class="paragraph">
<p><strong>QUERY E</strong>, look at a card record or document by key.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT * FROM `bulk`.`data`.`register` USE KEYS ('card:4273-6623-8686-4599');</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_09_n1ql_e.png" alt="high risk txns 09 n1ql e" width="%100">
</div>
</div>
<div class="paragraph">
<p><strong>QUERY F</strong>, look at a flagged transaction record or document that we wrote by key.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT * FROM `bulk`.`data`.`review` USE KEYS ('transaction:tx-1505315650-403');</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_09_n1ql_f.png" alt="high risk txns 09 n1ql f" width="%100">
</div>
</div>
</li>
<li>
<p>The next step is to follow the Function logic in detail. To do this we need to remove all of the generated documents in review collection.  We will use SQL++ to do this.</p>
<div class="paragraph">
<p>From the <strong>Couchbase Web Console</strong> &gt; <strong>Query</strong> page, run a the SQL++ statement</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">DELETE FROM `bulk`.`data`.`review`;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will get a warning about <em>"no WHERE clause or USE KEYS"</em>, ignore this and Click <strong>Continue</strong>.</p>
</div>
</li>
<li>
<p>From the <strong>Couchbase Web Console</strong> &gt; <strong>Eventing</strong> page, click <strong>high_risk_txns</strong> to expand the function, and then click <strong>Pause</strong>.</p>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_10_pause.png" alt="high risk txns 10 pause" width="%100">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>In the <strong>Confirm Pause Function</strong> dialog, click <strong>Pause Function</strong>.</p>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_10_pause_confirm.png" alt="high risk txns 10 pause confirm" width="344">
</div>
</div>
</li>
<li>
<p>The Eventing function is paused in a few seconds and can be edited. Click the <strong>'Edit JavaScript'</strong> button.</p>
</li>
<li>
<p>In the Editor dialog change the OnUpdate handler code from <code>var verbose = 0</code> to <code>var verbose = 3</code>&#8201;&#8212;&#8201;you are only modifying line four of the <strong>high_risk_txns</strong> function as below:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-JavaScript hljs" data-lang="JavaScript">function OnUpdate(doc, meta) {
  if (doc.type != "transaction") return;
  try {
    var verbose = 3; // logging - 0: minimal, 1: moderate, 2: massive
    // *** many lines not shown ***</code></pre>
</div>
</div>
</li>
<li>
<p>Click <strong>'Save and Return'</strong>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>From the <strong>Eventing</strong> screen, click <strong>Resume</strong>.</p>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_10_resume.png" alt="high risk txns 10 resume" width="%100">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>In the <strong>Confirm Resume Function</strong> dialog, click <strong>Resume Function</strong>.</p>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_10_resume_confirm.png" alt="high risk txns 10 resume confirm" width="346">
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>The Eventing function is resumed from the check point created when you paused the function and will start running within a few seconds. The defined function is resumed form a checkpoint created when you paused the function. Â The functionÂ will execute on all new documents and any mutations occurring after the checkpoint. Until a mutation is triggered there will be no processing at all by our modified handler&#8217;s JavaScript code.</p>
</li>
<li>
<p>The next step is to create one mutation, to do this access the <strong>Couchbase Web Console</strong> &gt; <strong>Documents</strong> page then select the keyspace <code>bulk</code>.<code>data</code>.<code>register</code> (the source of the mutations that our Function watches).</p>
<div class="ulist">
<ul>
<li>
<p>Select the document <code>transaction:tx-1505315650-403</code> by cutting and pasting this ID into the <strong>Document ID</strong> text box and hitting <kbd>Return</kbd>.</p>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_10_bucket_register_id.png" alt="high risk txns 10 bucket register id" width="%100">
</div>
</div>
</li>
<li>
<p>This should display a single document. Edit it by clicking on it.</p>
</li>
<li>
<p>Adjust the document slightly from <code>"amount": 5383.35</code> to <code>"amount": 5383.36</code>.</p>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_10_modify.png" alt="high risk txns 10 modify" width="580">
</div>
</div>
</li>
<li>
<p>Click <strong>'Save'</strong>.</p>
</li>
<li>
<p>Inspect the new data written to the "high_risk_txns.log" in the file system (or alternatively use the UI&#8217;s Log link).</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-console hljs" data-lang="console">cd /Users/jon.strabala/Library/Application\ Support/Couchbase/var/lib/couchbase/data/@eventing

tail -9 high_risk_txns.log

2021-07-18T16:41:20.522-07:00 [INFO] "transaction:tx-1505315650-403 Process transaction for doc.card: 4273-6623-8686-4599, doc.amount: 5383.36"

2021-07-18T16:41:20.525-07:00 [INFO] "transaction:tx-1505315650-403 doc   " {"type":"transaction","txnid":"tx-1505315650-403","amount":5383.36,"product":"Computer, iMac 64GB 4TB Nvme","card":"4273-6623-8686-4599","merchant":"Apple Regent Street","city":{"name":"London","code":"W1B 2EL","county":"Westminster","display":"London Westminster"},"date":"2018-09-14T20:46:10+05:30","currency":"GBP"}

2021-07-18T16:41:20.525-07:00 [INFO] "transaction:tx-1505315650-403 card  " {"type":"card","cardnumber":"4273-6623-8686-4599","firstname":"Winfred","lastname":"Raftery","street":"3965 I-80 E Off Ramp","mobile":"+1-617-555-1371","sms":true,"city":{"name":"Uxbridge","code":"MA","state":"Massachusetts","county":"Worcester","display":"Uxbridge"},"issued":"11/15","expiry":"6/19","ccv":736,"issuer":"Helena National Bank","maxcredit":1000,"threshold":9500,"country":"US","currency":"USD"}

2021-07-18T16:41:20.525-07:00 [INFO] "transaction:tx-1505315650-403 rates " {"type":"exchange_rates","erid":"er-2018-09-14","to_USD":{"CAD":1.3008811703,"INR":71.8162374882,"EUR":0.8555051758,"USD":1,"SGD":1.3698348875,"GBP":0.7633501583,"CNY":6.8543074686,"AUD":1.3910514159}}

2021-07-18T16:41:20.525-07:00 [INFO] "transaction:tx-1505315650-403 1 doc.amount        5383.36, card_limit        9500.00"

2021-07-18T16:41:20.525-07:00 [INFO] "transaction:tx-1505315650-403 2 trxn_currency         GBP, card_currency         USD"

2021-07-18T16:41:20.525-07:00 [INFO] "transaction:tx-1505315650-403 3 trxn_2_USD       0.763350, card_2_USD       1.000000"

2021-07-18T16:41:20.525-07:00 [INFO] "transaction:tx-1505315650-403 4 trxn_amount_USD   7052.28, card_thresh_USD   9500.00"

2021-07-18T16:41:20.525-07:00 [INFO] "transaction:tx-1505315650-403 *** High Risk Txn: currency mismatch card: USD != txn: GBP"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Above we see that for one mutation the Function <strong>high_risk_txns</strong> printed the following log messages:</p>
</div>
</li>
<li>
<p>The transaction document 'doc' that mutated (what you just changed).</p>
</li>
<li>
<p>The 'card' or credit card that the transaction was made with was looked up via the key <em>'card:' + doc.card</em> from the bucket alias  register.</p>
</li>
<li>
<p>A daily 'rates' or exchange rates for the date of the transaction which was looked up via the key <em>'exchange_rates:er-' + (doc.date).substr(0, 10))</em> from the bucket alias register.</p>
</li>
<li>
<p>Next a bit of information (4 lines) was emitted  to show what was done in order to make the final decision.</p>
</li>
<li>
<p>Finally, the last log line is the decision line (if the transaction is considered 'High Risk').
The amount of information at this verbosity level would be excessive for millions of documents, however it can be very handy for developing and debugging Eventing handler JavaScript logic.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Cleanup</strong>:</p>
</div>
<div class="paragraph">
<p>Go to the Eventing portion of the UI and undeploy the Function <strong>high_risk_txns</strong>, this will remove the 1024 documents (64 for macOS) for the function from the 'rr100.eventing.metadata' collection (in the Bucket view of the UI). Remember you may only delete the 'rr100.eventing.metadata' keyspace if there are no deployed Eventing Functions.</p>
</div>
<div class="paragraph">
<p>From the <strong>Eventing</strong> screen, click <strong>Undeploy</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_11_undeploy.png" alt="high risk txns 11 undeploy" width="%100">
</div>
</div>
<div class="paragraph">
<p>In the <strong>Confirm Undeploy Function</strong> dialog, click <strong>high_risk_txns</strong> to expand the function, and then click <strong>Undeploy Function</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/high_risk_txns_11_undeploy_confirm.png" alt="high risk txns 11 undeploy confirm" width="346">
</div>
</div>
<div class="paragraph">
<p>The Eventing function will be undeployed within a few seconds.</p>
</div>
<div class="paragraph">
<p>Now flush the 'bulk' bucket if you plan to run other examples (you may need to Edit the bucket 'bulk' and enable the flush capability).</p>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>Â© 2023 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Server","components":["server"],"url":"/home/server.html","latestVersions":{"server":"7.2"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../../_/js/site.js"></script>
<script defer src="../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
</body>
</html>
