<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<script>(window.dataLayer=window.dataLayer||[]).push({event:'gtm.js','gtm.start':+new Date()})</script>
<script async src="https://www.googletagmanager.com/gtm.js?id=GTM-MVPNN2"></script>
<title>Debugging and Diagnosability | Couchbase Docs</title>
<link rel="stylesheet" href="../../../_/css/site.css">
<script src="../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="Debugging and diagnostics in the Eventing Service comprises of debugging functions, functions log, and log redaction.">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="server">
<meta name="dcterms.identifier" content="7.2">
<meta name="page-url" content="/server/current/eventing/eventing-debugging-and-diagnosability.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://docs.couchbase.com/home/index.html">
                    <img src="../../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://docs.couchbase.com/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../cloud/index.html">
                      Capella
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/eventing/pages/eventing-debugging-and-diagnosability.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../introduction/intro.html">Couchbase Server</a></li>
<li class="crumb"><a href="eventing-debugging-and-diagnosability.html">Debugging and Diagnosability</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Debugging and Diagnosability</h1>
<div class="labels">
<ul></ul>
</div>
<div class="labels">
<ul>
<li class="edition"><a href="https://www.couchbase.com/products/editions">Enterprise Edition</a></li>
</ul>
</div>


</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
Debugging and diagnostics in the Eventing Service comprises of debugging functions, functions log, and log redaction.
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="debugging-functions"><a class="anchor" href="#debugging-functions"></a>Debugging Functions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Couchbase Server, for its Eventing Service framework, includes a powerful full function online real-time JavaScript Debugger.
Debug is a special flag on a Function.
The Debug option integrates seamlessly with the Google Chrome Debugger engine for running the JavaScript code of any Eventing Function.</p>
</div>
<div class="paragraph">
<p>The default Eventing debug port is <strong>9140</strong>. To change the default port settings, see <a href="#modifydebugport">Modifying the Debug Port</a>.</p>
</div>
<div class="sect2">
<h3 id="debugging-workflow"><a class="anchor" href="#debugging-workflow"></a>Debugging Workflow</h3>
<div class="ulist">
<ul>
<li>
<p>During a debug session, a single mutation received by the Eventing Function is taken from the primary processing stream(s) and sent to the Debugger.
This technique ensures that processing of the other data mutations in the cluster does not stall or get blocked.</p>
</li>
<li>
<p>When a worker thread traps the next event-instance for debugging, it opens an ephemeral TCP port, and generates a Chrome dev-tools URL, with a session cookie that controls the debug worker.</p>
</li>
<li>
<p>The Chrome dev-tools URL must be hand copied due to built-in security in the browser.</p>
</li>
<li>
<p>All other events processed by the Eventing Function are unaffected except for the single the trapped event-instance.</p>
</li>
<li>
<p>Using the Debug option, you can place breakpoints in the code and run the Function execution, step through your code one line at a time, and inspect values of your variables.
The step-step execution helps while troubleshooting the deployed Eventing Function under real world constraints.</p>
</li>
<li>
<p>If the debugged event-instance completes execution, no further event-instances get trapped for debugging.  If you wish to debug a second event-instance you need to stop and restart the debugger in the Function&#8217;s code editor.</p>
</li>
<li>
<p>If a debug session gets terminated during execution, then the mutation may be abruptly processed or canceled.</p>
</li>
<li>
<p>Debugging is a convenience-feature intended to help during Function development: it is highly discouraged for use in production environments.</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Debug mode should be avoided in production environments, as it affects the in-order processing of the document mutations as well as introducing timing related issues.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="enable-debugging-of-eventing-functions"><a class="anchor" href="#enable-debugging-of-eventing-functions"></a>Enable Debugging of Eventing Functions</h3>
<div class="paragraph">
<p>The debugger should only be enabled when you plan to debug your functions.  When done with interactive debugging you should disable the option to increase security.  This setting change is needed to enable the <strong>Debug</strong> button in the <strong>View JavaScript</strong> code editor for a deployed Function.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To enable debugging for the Eventing Service, navigate to <strong>Couchbase Web Console</strong> &gt; <strong>Eventing</strong> page</p>
<div class="imageblock">
<div class="content">
<img src="_images/debugger_01_eventing_page.png" alt="debugger 01 eventing page" width="100%">
</div>
</div>
</li>
<li>
<p>Click *SETTINGS" in the top banner.</p>
</li>
<li>
<p>In the "Eventing Settings" Dialog check the *Enable debugger" checkbox.</p>
<div class="imageblock">
<div class="content">
<img src="_images/debugger_02_eventing_settings.png" alt="debugger 02 eventing settings" width="350">
</div>
</div>
</li>
<li>
<p>Click "<strong>Save</strong></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="debugging-a-function"><a class="anchor" href="#debugging-a-function"></a>Debugging a Function</h3>
<div class="paragraph">
<p>Below we have expanded the deployed Eventing Function "case_2_enrich_ips" from the Example <a href="#eventing-example-data-enrichment">Data Enrichment</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The deployed Function expands (when you click the Function&#8217;s name) to provide additional options:</p>
<div class="imageblock">
<div class="content">
<img src="_images/debugger_03_deployed_function.png" alt="debugger 03 deployed function" width="100%">
</div>
</div>
</li>
<li>
<p>Click <strong>View JavaScript</strong> to bring up the Function&#8217;s JavaScript</p>
<div class="imageblock">
<div class="content">
<img src="_images/debugger_04_function_editor.png" alt="debugger 04 function editor" width="100%">
</div>
</div>
</li>
<li>
<p>Because we enabled debugging we now have a button, <strong>Debug</strong>, in the lower left of the code editor</p>
</li>
<li>
<p>From the <strong>View JavaScript</strong> page, click <strong>Debug</strong>.
This will activate a one-time debug session. As a result, the next event-instance will get trapped and is forwarded to the Debugger.</p>
<div class="imageblock">
<div class="content">
<img src="_images/debugger_05_debugger_waiting.png" alt="debugger 05 debugger waiting" width="100%">
</div>
</div>
</li>
<li>
<p>In the above screen, you can notice the message: "Waiting for mutation."</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
During a debugging session this window must remain active. When you are presented a debug URL you must copy then paste it into a new browser window (described below). If you are using the UI to create the mutation, you must use a different browser tab/window to create the mutation.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Since we are using an Example we need to trigger a mutation in another tab/window, <em>*do not close this browser tab/window with your debugging dialog*</em>.</p>
<div class="paragraph">
<p>If you are debugging  an Eventing Function that has a constant stream of mutations you would not need to make your own mutation.</p>
</div>
</li>
<li>
<p><strong>In tab/another window</strong> access the <strong>Couchbase Web Console</strong> &gt; <strong>Buckets</strong> page and click the <strong>Scopes and Collections</strong> link of the <strong>bulk</strong> bucket.</p>
<div class="ulist">
<ul>
<li>
<p>Click <strong>Documents</strong> in the upper right banner for the <strong>data</strong> scope.</p>
</li>
<li>
<p>Select the keyspace <strong>bulk</strong>, <strong>data</strong>, <strong>source</strong></p>
<div class="imageblock">
<div class="content">
<img src="_images/debugger_06a_make_event.png" alt="debugger 06a make event" width="100%">
</div>
</div>
</li>
<li>
<p>You should see no user records (for this example).</p>
</li>
<li>
<p>Click <strong>Add Document</strong> in the upper right banner</p>
</li>
<li>
<p>For the <strong>ID</strong> in the <strong>Create New Document</strong> dialog specify <strong>SampleDocument</strong></p>
<div class="listingblock">
<div class="content">
<pre>ID [ SampleDocument         ]</pre>
</div>
</div>
</li>
<li>
<p>For the document body in the <strong>Create New Document</strong> dialog, the following text is displayed:</p>
<div class="listingblock">
<div class="content">
<pre>{
"click": "to edit",
"with JSON": "there are no reserved field names"
}</pre>
</div>
</div>
</li>
<li>
<p>replace the above text with the following JSON document via a cut-n-paste</p>
<div class="listingblock">
<div class="content">
<pre>{
"country": "AD",
  "ip_start": "5.62.60.1",
  "ip_end": "5.62.60.9"
}</pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/debugger_06b_make_event.png" alt="debugger 06b make event" width="100%">
</div>
</div>
</li>
<li>
<p>Click <strong>Save</strong> to generate a mutation in your Eventing Function&#8217;s "Listen to Location".</p>
</li>
</ul>
</div>
</li>
<li>
<p>Return to the tab/window that was in "Waiting for mutation." state.  You can see the one-time debugging URL is now filled in and available to copy.</p>
<div class="imageblock">
<div class="content">
<img src="_images/debugger_07_debugger_have_url.png" alt="debugger 07 debugger have url" width="100%">
</div>
</div>
</li>
<li>
<p>In the above debugging dialog Click <strong>COPY</strong></p>
</li>
<li>
<p>Open a new tab/window, <em>*do not close this browser tab/window with your debugging dialog*</em>, for the Google Chrome Debugging session.</p>
</li>
<li>
<p>Paste the copied one-time debugging URL into the address bar and hit return.</p>
<div class="imageblock">
<div class="content">
<img src="_images/debugger_08_new_tab_paste_url.png" alt="debugger 08 new tab paste url" width="100%">
</div>
</div>
</li>
<li>
<p>When the debugger comes up it may or may not display your Eventing Function&#8217;s JavaScript.  If you do not see your code you may have to Click on the <strong>step</strong> button once or twice in the debugger (see the highlighted RED box above and below). Once you see your Function&#8217;s JavaScript code adjust the sizes of the various debugging windows to your personal preference.</p>
<div class="imageblock">
<div class="content">
<img src="_images/debugger_09_chrome_step.png" alt="debugger 09 chrome step" width="100%">
</div>
</div>
</li>
<li>
<p>Set a breakpoint at line 12 by clicking on the line # on the left (see the highlighted RED box below).  Once a break point is set it will display a bold BLUE bookmark.</p>
<div class="imageblock">
<div class="content">
<img src="_images/debugger_10_chrome_breakpoint.png" alt="debugger 10 chrome breakpoint" width="100%">
</div>
</div>
</li>
<li>
<p>Click the <strong>Resume</strong> button in the debugger to continue execution and to run until the break point you set.</p>
<div class="imageblock">
<div class="content">
<img src="_images/debugger_11_chrome_run_to_bp.png" alt="debugger 11 chrome run to bp" width="100%">
</div>
</div>
</li>
<li>
<p>The Eventing Function will execute (accessing KV and/or SQL++ and interacting with REST endpoints) as it would in production until it hits your breakpoint.</p>
<div class="imageblock">
<div class="content">
<img src="_images/debugger_12_chrome_run_at_bp.png" alt="debugger 12 chrome run at bp" width="100%">
</div>
</div>
</li>
<li>
<p>Note the variable values displayed while at the breakpoint set at line 12. Click on the <strong>Resume</strong> button a second time to finish executing your Function.</p>
</li>
<li>
<p>The debugger is done return to the tab/window where your one-time debugging URL was created and Click <strong>Stop debugging</strong>.  If you need to debug another mutation Click <strong>Debug</strong> again and repeat the process.</p>
</li>
<li>
<p>If you are done with all needed interactive debugger disable debugging via the <strong>SETTINGS</strong>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="possible-debugging-problems-and-issues"><a class="anchor" href="#possible-debugging-problems-and-issues"></a>Possible Debugging Problems and Issues</h3>
<div class="ulist">
<ul>
<li>
<p>During a debugging session this window must remain active. When you are presented a debug URL you must copy then paste it into a new browser window (described below). If you are using the UI to create the mutation, you must use a different tab/browser window to create the mutation.  A debug session will also be terminated if from the Debugging pop-up (or debugging dialog), you can click <strong>Stop Debugging</strong>.</p>
</li>
<li>
<p>The URL you copied is valid only for a single mutation, to debug another subsequent mutation you must click <strong>Stop debugging</strong> button and capture click <strong>Debug</strong> again to get a fresh one-time debugging URL.</p>
</li>
<li>
<p>You are trying to debug a Couchbase server via a NAT&#8217;d IP Address and the debugger doesn&#8217;t work because the generated one-time debugger URL doesn&#8217;t reflect the NAT.</p>
<div class="paragraph">
<p>Example NAT&#8217;d setup</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Couchbase server is running 192.168.3.150 key ports 8091 for UI and 9140 for websocket devtools debugger
A public NAT for 192.168.3.150 is 4.71.116.187 (for both ports 8091 and 9140) in your firewall</pre>
</div>
</div>
<div class="paragraph">
<p>Solution:</p>
</div>
<div class="paragraph">
<p>On the actual Couchbase server, i.e. 192.168.3.150, set up an alternate address for the debugger as follows for 7.0 GA (and also 6.6.3):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>curl -X PUT http://$CB_USERNAME:$CB_PASSWORD@localhost:8091/node/controller/setupAlternateAddresses/external \
    -d hostname=4.71.116.187 -d eventingDebug=9140</pre>
</div>
</div>
<div class="paragraph">
<p>The Debug URL is now correct and needs no hand editing.</p>
</div>
<div class="paragraph">
<p>To delete/remove the alternate address on 192.168.3.150 on the actual server host, i.e. 192.168.3.150 run the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>curl -X DELETE http://$CB_USERNAME:$CB_PASSWORD@localhost:8091/node/controller/setupAlternateAddresses/external \
    -d hostname=4.71.116.187 -d eventingDebug=9140</pre>
</div>
</div>
</li>
<li>
<p>Although every effort is done to remain current Google changes the websocket URL format from time to time.  You might have to manually alter the start of the debugging URL from <strong>chrome-devtools://</strong> to just <strong>devtools://</strong> and also at the end of debugging URL from <strong>js_app.html</strong> to <strong>inspector.html</strong> depending on the version of your Google Chrome browser due to a recent changes made by Google. Currently these manual changes (if needed) have to be done after pasting the URL into a new Chrome browser tab.</p>
<div class="paragraph">
<p>There are currently three known URL variants from the oldest Chrome release to newest Chrome release:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>chrome-devtools://devtools/bundled/js_app.html</p>
</li>
<li>
<p>devtools://devtools/bundled/js_app.html</p>
</li>
<li>
<p>*devtools://devtools/bundled/inspector.html</p>
</li>
</ul>
</div>
</li>
<li>
<p>Potential issue with debugging International Components for Unicode (ICU)</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
In earlier versions 6.5.0, 6.5.1, and 6.6.0 users might experience bug MB-41508 a Chrome "WebSocket Disconnected" when debugging Eventing functions that call either toLocaleString() or Intl.DateTimeFormat. Essentially the file "icudtl.dat" which provides support for International Components for Unicode (ICU) is not in the needed location. The following step (copying the Chrome "icudtl.dat" file) is necessary only for development or staging clusters as users aren&#8217;t expected to spawn a debugger in a live production environment.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Typically this issue will occur when the debugger hits an ICU function like <em>Intl.DateTimeFormat</em> or <em>toLocaleString</em>, the result is your debugging session is disconnected as follows:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/debug_websocket_disconnected.png" alt="debug websocket disconnected" width="400">
</div>
</div>
<div class="paragraph">
<p>To fix the issue in Chrome you merely need to copy a file on the server to the expected file system location.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux</p>
<div class="paragraph">
<p>cp -p /opt/couchbase/bin/icudtl.dat /opt/couchbase/var/lib/couchbase</p>
</div>
</li>
<li>
<p>macOS</p>
<div class="paragraph">
<p>cp -p /Applications/Couchbase\ Server.app/Contents/Resources/couchbase-core/bin/icudtl.dat /Users/$USER/Library/Application\ Support/Couchbase/</p>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="transpiler-and-source-map"><a class="anchor" href="#transpiler-and-source-map"></a>Transpiler and Source Map</h3>
<div class="paragraph">
<p>A transpiler accepts source code provided as input from one high-level programming language and produces an equivalent code in another high-level programming language.</p>
</div>
<div class="paragraph">
<p>Couchbase Server uses a native transpiler. This transpiler converts the Eventing Function&#8217;s JavaScript syntax into a pure JavaScript representation that the JavaScript engine can understand. If this transpiler was unavailable, then the JavaScript engine would have failed to compile any native SQL++ queries or curl() functions.</p>
</div>
<div class="paragraph">
<p>When your source code is transformed, debugging becomes a problem because we must know where the original code is. Source maps solve this problem by providing a mapping between the original and the transformed source code.</p>
</div>
<div class="paragraph">
<p>A source map, generated by our native transpiler provides a mapping between the transpiled code and the original function Eventing Function JavaScript code. Debugging is easy as the debugger detects the source map and presents the code to the developer in the original Eventing Function JavaScript format.</p>
</div>
<div class="paragraph">
<p>Upon source map detection, a text confirmation flag gets displayed in the bottom of your browser&#8217;s debug window as a very long comment an example is highlighted below:</p>
</div>
<div class="paragraph">
<p><code class="out">//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpb</code> <strong>truncated</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="modifydebugport"><a class="anchor" href="#modifydebugport"></a>Modifying the Debug Port</h3>
<div class="paragraph">
<p>The Eventing Service Debugger port, <code>eventing_debug_port</code> (9140), is an internal port and is one of the ports that are configured by the <strong>ns_server</strong>. Note this port is not supported for external access outside of the cluster and should only be used in development environments. To modify this port setting (Linux example):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="../install/install-intro.html" class="xref page">Install Couchbase Server</a>.</p>
</li>
<li>
<p><a href="../install/startup-shutdown.html" class="xref page">Stop the Couchbase Server service</a>.</p>
</li>
<li>
<p>Edit the <strong>/opt/couchbase/etc/couchbase/static_config</strong> file to add the new eventing_debug_port and the new port-number information. For example, to change the Eventing debugging port from 9140 to 9444, you would add the following line (enclosed in braces and terminated by a period):</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">{eventing_debug_port, 9444}.</code></pre>
</div>
</div>
</li>
<li>
<p>If Couchbase Server was previously configured, you&#8217;ll need to delete the <strong>/opt/couchbase/var/lib/couchbase/config/config.dat</strong> file to remove the old configuration.</p>
</li>
<li>
<p><a href="../install/startup-shutdown.html" class="xref page">Start Couchbase Server</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For detailed information on the modifying <strong>ns_server</strong> port mappings, refer to <a href="../install/install-ports.html#map-custom-ports" class="xref page">Custom Port Mapping</a>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Changing port mappings should only be done at the time of initial node/cluster setup as the required reset and reconfiguration will also purge all data on the node.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="logging-functions"><a class="anchor" href="#logging-functions"></a>Logging Functions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Eventing Service creates two different types of logs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>System Log</p>
</li>
<li>
<p>Application Logs</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Couchbase Server creates different application log files depending on the level and severity of the reported problem, as configured during Function definition</p>
</div>
<div class="sect2">
<h3 id="system-log"><a class="anchor" href="#system-log"></a>System Log</h3>
<div class="paragraph">
<p>For the Eventing Service, Couchbase Server creates a system log file named <strong>eventing.log</strong> (refer to Table 1 for filesystem location by platform).
This file is common across all Eventing Functions.
The system log file captures information related to general management and supervision of the Eventing service (not the business logic of the Function).
In addition this log file also captures life cycle or housekeeping information of every individual Eventing function depending on the Function&#8217;s "System Log Level" setting.
An end user cannot write a message (via their JavaScript code in an Eventing Function) to this log file it is intended for debugging for customers that are on support contracts.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Eventing System Log Location in Platform</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Platform</th>
<th class="tableblock halign-left valign-top">Location</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Linux</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/opt/couchbase/var/lib/couchbase/logs/eventing.log</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Windows</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">C:\Program Files\Couchbase\Server\var\lib\couchbase\logs\eventing.log<br>
(Assumes default installation location)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mac OS X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/Users/&lt;user&gt;/Library/Application\ Support/Couchbase/var/lib/couchbase/logs/eventing.log</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <strong>eventing.log</strong> contains redactable user data and the log is collected using the <strong>cbcollect_info</strong> tool.
For log rotation, refer to <a href="../manage/manage-logging/manage-logging.html#log-file-rotation" class="xref page">Log File Rotation</a>.</p>
</div>
<div class="paragraph">
<p>The available logging levels are: <em>Info, Error, Warning, Debug, and Trace (Info is the default since version 6.0)</em>.
The level can be altered via the "System Log Level" choice in the Settings dialog of each individual Eventing function and impacts the detail and quantity of information sent to the System Log (but has no effect on a specific Function&#8217;s Application Log). Unless directed by support you should not change the "System Log Level".</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/debug_5_log_level.png" alt="debug 5 log level" width="484">
</div>
</div>
</div>
<div class="sect2">
<h3 id="application-logs"><a class="anchor" href="#application-logs"></a>Application Logs</h3>
<div class="paragraph">
<p>Application logs allow you to identify and capture various business logic related activities and errors via user defined messages specific to each Eventing function.</p>
</div>
<div class="paragraph">
<p>You must have the appropriate RBAC privileges to view an Eventing Function&#8217;s Application log in the UI or via the REST API. The role of either "Full Admin" or "Eventing Full Admin" can see Application log or can access any Eventing Function&#8217;s Application log. For more information refer to <a href="eventing-rbac.html" class="xref page">Eventing Role-Based Access Control</a>.</p>
</div>
<div class="paragraph">
<p>Unlike the System Log, Application logs can be viewed in the UI for any deployed function by clicking on the function&#8217;s “Log” hyperlink in the Eventing page.</p>
</div>
<div class="paragraph">
<p>Each Eventing function will have its own Application log based on the function name, e.g. <strong>the_function_name.log</strong>. (refer to Table 2 for filesystem path by platform).  The information that goes to these log files is solely dependent the logic of the Function via <em>log(…)</em> statements put inside the individual Eventing Function’s JavaScript code.  Unlike the system log there is currently is no logging level for Application logs. Application logs are primarily used for development and debugging business logic.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function OnUpdate(doc, meta) {
    log('document', doc);
    try {
        var response = curl(
            'http://localhost:3000/notify',
            {method : 'POST', data : doc}
        );
        log('curl', response);
    } catch (e) {
        log('error', e);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Application logs receive user defined messages when a <em>log(&#8230;&#8203;)</em> statement is encountered in the Function&#8217;s JavaScript code (they do not have a Log Level).</p>
</div>
<div class="paragraph">
<p>As a best practice the use of <em>log(&#8230;&#8203;)</em> messages with try catch blocks can greatly assist Eventing Function development and debugging.</p>
</div>
<div class="paragraph">
<p>Below a function processes one mutation from the test bucket <strong>travel-sample</strong> but has an undefined JavaScript variable <strong>a</strong> without a try catch block.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function OnUpdate(doc, meta) {
    if (meta.id != "airport_1255") return
    log('id', meta.id);
    // undefined variable 'a' stops processing, an error indicator [X] will be
    // displayed via selecting "View JavaScript" when the function is deployed.
    // Failure(s) will also be logged in Eventing Stats: _function_name_ in the
    // UI 'Server &gt; Statistics' view for the charts of the _function_name_
    if (a == 1) {
        log('a is 1')
    }
    // never reached
    log('complete')
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Only the first of three log messages is emitted and the processing stops and is marked as failed in the statistics.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">2020-02-09T07:12:17.936-08:00 [INFO] "id" "airport_1255"</code></pre>
</div>
</div>
<div class="paragraph">
<p>By selecting the "View JavaScript" button when the function is deployed a [X] indicator at the exact line in the JavaScript code failed will be displayed. By hovering over the [X] indicator more information is revealed.</p>
</div>
<div class="paragraph">
<p>However, by adding a try catch block the root cause of the failure is easily apparent, and the function is
considered processed (without a failure) because the error is caught and handled in the function.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function OnUpdate(doc, meta) {
    if (meta.id != "airport_1255") return
    log('id', meta.id);
    try {
        if (a == 1) {
        log('a is 1')
        }
    } catch (e) {
        log('error', e);
    }
    log('complete')
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output now indicates the exact error that occurred via the Function&#8217;s Application log as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">2020-02-09T07:12:17.936-08:00 [INFO] "id" "airport_1255"
2020-02-09T07:12:17.936-08:00 [INFO] "error" "ReferenceError: a is not defined"
2020-02-09T07:12:17.936-08:00 [INFO] "complete"</code></pre>
</div>
</div>
<div class="paragraph">
<p>As previously indicated, by selecting the "View JavaScript" button when the function is deployed a [X] indicator at the exact line in the JavaScript code failed will be displayed. By hovering over the [X] indicator more information is revealed.</p>
</div>
<div class="paragraph">
<p>Application logs can also record summaries of low level issues and exceptions once a minute per worker.  For example if you have 1M items that all throw the same exception, you will only see a few messages with the line number along with a count of each exception.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function OnUpdate(doc, meta) {
    if (a == 1) {
        // never reached
        log('a is 1')
    }
    // never reached
    log('complete')
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Running the above on a source keyspace <code>travel-sample</code>.<code>_default</code>.<code>_default</code> will result in a failure count of 31,951 however the errors will be summarized into a single line per worker.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">2021-07-19T15:35:44.895-07:00 [INFO] {"count":31591,"exception":"\"ReferenceError: a is not defined\"","file":"test_summary.js","line":2,"since":"2021-07-19T15:35:44","srcLine":"if (a == 1) {","stack":"ReferenceError: a is not defined\n    at OnUpdate (test_summary.js:3:5)"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This summarization greatly reduces the size of the Eventing logs in the event there is a low level issue or a syntax error that detected only at deploy time.</p>
</div>
<div class="paragraph">
<p>You can access a Function&#8217;s Application log file using the UI by selecting the Function name and clicking on the 'Log' hyperlink/button or by opening a terminal and issuing Linux commands such as <em>cat</em>, <em>more</em>, <em>head</em>, <em>tail</em>, or ‘<em>tail -F</em>’ on a specific Eventing function’s log.</p>
</div>
<div class="paragraph">
<p>Couchbase Server creates an individual log file for every Function in the cluster on each Eventing node. Application logs will only contain information for the mutations processed on a given Eventing node.</p>
</div>
<div class="paragraph">
<p>By default, the maximum size of a node&#8217;s Application log file is 40MB, and the number of log files before rotation is 10.
Unlike system logs, the Application logs are user-configurable in number and size.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <strong>cbcollect_info</strong> tool does not collect the Application log files.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Eventing Application Logs Location by Platform</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Platform</th>
<th class="tableblock halign-left valign-top">Location</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Linux</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/opt/couchbase/var/lib/couchbase/data/@eventing/</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Windows</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">C:\Program Files\Couchbase\Server\var\lib\couchbase\data\@eventing\<br>
(Assumes default installation location)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mac OS X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/Users/&lt;user&gt;/Library/Application\ Support/Couchbase/var/lib/couchbase/data/@eventing/</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
During Cluster setup, if you have chosen a custom path, then the path for Application logs is same as that of the selected Indexes Path. The @eventing folder in the selected Indexes Path stores the Application logs.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To configure an Application log, use the REST endpoint settings option.  Note you must always specify deployment_status (deployed/undeployed) and processing_status (paused/not-paused) when using this REST endpoint.</p>
</div>
<div class="paragraph">
<p><strong>Sample URL</strong>: <code>192.168.1.5:8091/_p/event/api/v1/functions/&lt;Function_name&gt;/settings</code></p>
</div>
<div class="paragraph">
<p><strong>Sample Payload</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
  "settings":
    {
      "deployment_status":false,
      "processing_status":false,
      "app_log_max_files": 10,
      "app_log_max_size": 10485760
    }
  }</pre>
</div>
</div>
<div class="paragraph">
<p>The sample payload above illustrates that the system stores 10 application log files and each file records about 10 MB of data.</p>
</div>
<div class="paragraph">
<p>At some point in time, old application log files that are no longer necessary need to be deleted to make way for new log records.
When an Application log file reaches the set limit, a new log file gets created.
All the recorded information from the active log file gets transferred to this newly created file.</p>
</div>
<div class="paragraph">
<p>For illustration, consider <strong>case_1_enrich_ips</strong> from the example <a href="#eventing-example-data-enrichment">Data Enrichment</a> as the name of the Function.
A corresponding Application log file, <strong>case_1_enrich_ips.log</strong>, gets created in the Couchbase cluster.
Whenever the <strong>case_1_enrich_ips.log</strong> reaches 10MB in size, assuming the maximum size of an Application log file is 10MB and the number of log files before rotation is 10, the system automatically generates the <strong>case_1_enrich_ips.log.1</strong> file, during its first iteration.
The file <strong>case_1_enrich_ips.log</strong> transfers all the log information to this new log file.
For this illustration, since the number of log files is 10, the system stores 10 such files, the currently active log file along with 9 truncated files, at any given instance.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="log-redaction"><a class="anchor" href="#log-redaction"></a>Log Redaction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can use logs for multiple purposes ranging from security, monitoring, and diagnostics.
Suppression of sensitive data such as personally identifiable information (PII), hostnames, internal asset information, credit card details, during the logging operation is termed as log redaction.
Organizations implement log redaction as part of their legal compliance and security risk mitigations.</p>
</div>
<div class="paragraph">
<p>Couchbase Server provides a capability to redact sensitive user data from getting captured in the logs.
All sensitive data are scrubbed and gets removed from the log files.
Post redaction, log files can be shared for troubleshooting without disregarding any regulatory compliance.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Log redaction is applicable only for System logs and not for Application logs.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For details, see <a href="../manage/manage-logging/manage-logging.html#understanding_redaction" class="xref page">Understanding Redaction</a>.</p>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2023 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Server","components":["server"],"url":"/home/server.html","latestVersions":{"server":"7.2"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../../_/js/site.js"></script>
<script defer src="../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
</body>
</html>
