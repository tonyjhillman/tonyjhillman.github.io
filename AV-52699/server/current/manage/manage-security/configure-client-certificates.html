<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<script>(window.dataLayer=window.dataLayer||[]).push({event:'gtm.js','gtm.start':+new Date()})</script>
<script async src="https://www.googletagmanager.com/gtm.js?id=GTM-MVPNN2"></script>
<title>Configure Client Certificates | Couchbase Docs</title>
<link rel="stylesheet" href="../../../../_/css/site.css">
<script src="../../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="Couchbase Server supports client-authentication by means of X.509 certificates.">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="server">
<meta name="dcterms.identifier" content="7.2">
<meta name="page-url" content="/server/current/manage/manage-security/configure-client-certificates.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://docs.couchbase.com/home/index.html">
                    <img src="../../../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://docs.couchbase.com/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../cloud/index.html">
                      Capella
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/manage/pages/manage-security/configure-client-certificates.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../../introduction/intro.html">Couchbase Server</a></li>
<li class="crumb">Manage</li>
<li class="crumb"><a href="security-management-overview.html">Manage Security</a></li>
<li class="crumb"><a href="manage-authentication.html">Manage Authentication</a></li>
<li class="crumb"><a href="manage-certificates.html">Manage Certificates</a></li>
<li class="crumb"><a href="configure-client-certificates.html">Configure Client Certificates</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Configure Client Certificates</h1>
<div class="labels">
<ul></ul>
</div>


</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
Couchbase Server supports client-authentication by means of X.509 certificates.
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="couchbase-client-authentication"><a class="anchor" href="#couchbase-client-authentication"></a>Couchbase Client Authentication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Couchbase clients can authenticate by means of X.509 certificates.
This page provides step-by-step instructions for the creation of client certificates for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Couchbase Server</em>.
The certificate can be used by a Couchbase Server-cluster that wishes to secure its connection to another Couchbase Server-cluster.
This certificate might be used by a <em>source</em> cluster that wishes to perform <em>Cross Data Center Replication</em> securely, to a <em>destination</em> cluster.</p>
</li>
<li>
<p><em>Java Applications</em>.
A Java application based on the Couchbase SDK can obtain its client certificate from a Java <em>keystore</em>, and so authenticate with Couchbase Server securely.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For a list of Couchbase-Server ports that provide secure connectivity to clients, see
<a href="../../learn/clusters-and-availability/connectivity.html" class="xref page">Connectivity</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cert-auth-for-couchbase-server"><a class="anchor" href="#cert-auth-for-couchbase-server"></a>Configure Client Certificates for Couchbase Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The section contains two procedures for the creation of a client certificate and key, whereby authentication with Couchbase Server can be performed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#client-certificate-authorized-by-a-root-certificate">Client Access: Root-Certificate Authorization</a> shows how to create a client certificate that is authorized by a cluster&#8217;s root certificate.
The procedure for creating a root certificate (and, based on the root certificate, the cluster&#8217;s individual per node certificates), is provided in <a href="configure-server-certificates.html#root-and-node-certificates" class="xref page">Cluster Protection with Root and Node Certificates</a>.
The instructions on the current page assume that <em>that</em> procedure has already been followed: therefore, they duly make use of the previously created directory structure and files.</p>
<div class="paragraph">
<p>Note that in Couchbase Server Version 7.1 and later, multiple root certificates can be uploaded into the cluster, some potentially to be used for client authentication only; and therefore not to be used for the signing of node certificates.
Therefore, a client no longer <em>needs</em> to base its authority on a CA that is being used to protect the server: however, the CA it uses must be recognizable to the cluster; and as such, must be a root certificate uploaded into the cluster&#8217;s trust store.
For an overview, see <a href="../../learn/security/using-multiple-cas.html" class="xref page">Using Multiple Root Certificaes</a>.</p>
</div>
</li>
<li>
<p><a href="#client-certificate-authorized-by-an-intermediate-certificate">Client Access: Intermediate-Certificate Authorization</a> shows how to create a client certificate that is authorized by an <em>intermediate</em> certificate; which derives its own authority from a root certificate; and which is used instead of the root for the signing of the client certificate.
The procedure for creating a root, server-intermediate and per node certificates is provided in <a href="configure-server-certificates.html#root-intermediate-and-node-certificates" class="xref page">Cluster Protection with Root, Intermediate, and Node Certificates</a>.
The instructions on the current page assume that <em>that</em> procedure has already been followed: therefore, they duly make use of the previously created directory structure and files.</p>
</li>
</ul>
</div>
<div id="assumptions" class="paragraph">
<p>Both procedures additionally assume that the instance of Couchbase Server to be accessed by the client:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Contains the sample bucket <code>travel-sample</code>: this is the bucket whose contents the client wishes to read and write.
For information on sample buckets and how to install them, see <a href="../manage-settings/install-sample-buckets.html" class="xref page">Sample Buckets</a>.</p>
</li>
<li>
<p>Has a defined, locally authenticated user named <code>clientuser</code>, who has been assigned a role that permits reading and writing to the <code>travel-sample</code> bucket.
For information on creating users and roles, see <a href="manage-users-and-roles.html" class="xref page">Manage Users and Roles</a>.</p>
</li>
<li>
<p>Has client-certificate handling configured as either <em>enabled</em> or <em>mandatory</em>.
For details, see <a href="enable-client-certificate-handling.html" class="xref page">Enable Client-Certificate Handling</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that additional information on file-types can be found in the procedures for <em>server</em>-certificate generation; in <a href="configure-server-certificates.html" class="xref page">Configure Server Certificates</a>.</p>
</div>
<div class="sect2">
<h3 id="client-certificate-authorized-by-a-root-certificate"><a class="anchor" href="#client-certificate-authorized-by-a-root-certificate"></a>Client Access: Root-Certificate Authorization</h3>
<div class="paragraph">
<p>Proceed as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Within the top-level directory created in <a href="configure-server-certificates.html#root-and-node-certificates" class="xref page">Cluster Protection with Root and Node Certificates</a>, create and access a new working directory.</p>
<div class="listingblock">
<div class="content">
<pre>cd servercertfiles
mkdir clientcertfiles
cd clientcertfiles</pre>
</div>
</div>
</li>
<li>
<p>Create an extensions file for the use of all clients.</p>
<div class="listingblock">
<div class="content">
<pre>cat &gt; client.ext &lt;&lt;EOF
basicConstraints = CA:FALSE
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer:always
extendedKeyUsage = clientAuth
keyUsage = digitalSignature
EOF</pre>
</div>
</div>
<div class="paragraph">
<p>This specifies a value of <code>FALSE</code> for <code>CA</code>, indicating that the client certificate will not have the ability to act as an authority for other certificates.
Its <code>extendedKeyUsage</code> is specified as <code>clientAuth</code>, indicating that the certificate will be used for authenticating a client.
It <code>keyUsage</code> is specified as <code>digitalSignature</code>, indicating that its public key is usable for data-origin authentication.</p>
</div>
<div class="paragraph">
<p>This extensions file thus contains definitions judged appropriate for all clients.
Further constraints can be added for individual clients, as necessary.</p>
</div>
</li>
<li>
<p>Create a client private key.</p>
<div class="listingblock">
<div class="content">
<pre>openssl genrsa -out ./travel-sample.key 2048</pre>
</div>
</div>
<div class="paragraph">
<p>This creates the private key <code>travel-sample.key</code>.</p>
</div>
</li>
<li>
<p>Generate the client-certificate signing-request.</p>
<div class="listingblock">
<div class="content">
<pre>openssl req -new -key ./travel-sample.key -out ./travel-sample.csr -subj "/CN=clientuser"</pre>
</div>
</div>
<div class="paragraph">
<p>The client&#8217;s private key, <code>travel-sample.key</code> is provided as input for the signing request.
The <em>Common Name</em> provided as <code>Subject</code> for the certificate is specified as <code>clientuser</code>, which is the name of the server-defined user to be authenticated by the client.
The output request-file, <code>travel-sample.csr</code> is saved in the current directory.</p>
</div>
</li>
<li>
<p>Optionally, customize a client extensions file, to identify a <em>username</em> to be authenticated.</p>
<div class="paragraph">
<p>As described in <a href="../../learn/security/certificates.html#identity-encoding-in-client-certificates" class="xref page">Specifying Usernames for Client-Certificate Authentication</a>, a client certificate should contain a username, against which authentication can be performed on Couchbase Server.
The server&#8217;s default handling assumes that the <em>Subject Common Name</em> specifies the username.
However, a <em>Subject Alternative Name</em> might be used; either in addition, or as an alternative.</p>
</div>
<div class="paragraph">
<p>The following <code>subjectAltName</code> statement allows an email address to be specified as the basis for the username.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>cp ./client.ext ./client.ext.tmp

echo "subjectAltName = email:john.smith@mail.com" \
&gt;&gt; ./client.ext.tmp</pre>
</div>
</div>
<div class="paragraph">
<p>If Couchbase Server is configured to search for an email address to be used as a username (as described in <a href="../../learn/security/certificates.html#identity-encoding-in-client-certificates" class="xref page">Specifying Usernames for Client-Certificate Authentication</a> and <a href="enable-client-certificate-handling.html" class="xref page">Enable Client-Certificate Handling</a>), the user <code>john.smith</code> will be submitted for authentication.</p>
</div>
<div class="paragraph">
<p>If this extension is <em>not</em> added, and Couchbase Server client-certificate handling is left at its default, the <em>Common Name</em> (which was specified as <code>clientuser</code>, when the client-certificate signing-request was generated) will continue to be used as the username.</p>
</div>
</li>
<li>
<p>Create the client certificate.
In this example, the customized extensions file, <code>client.ext.tmp</code>, is used.
However, if no email address or other Subject Alternative Name has been added, the generic client-extensions file, <code>client.ext</code>, can be used instead.</p>
<div class="listingblock">
<div class="content">
<pre>openssl x509 -CA ../ca.pem -CAkey ../ca.key \
-CAcreateserial -days 365 -req -in ./travel-sample.csr \
-out ./travel-sample.pem -extfile ./client.ext.tmp</pre>
</div>
</div>
<div class="paragraph">
<p>The root certificate for the cluster, and its corresponding private key, <code>ca.pem</code> and <code>ca.key</code> are specified as inputs for certificate generation, so establishing the root certificate&#8217;s authority, within the client certificate.
The output file, <code>travel-sample.pem</code>, is the client certificate, and is saved in <code>clientcertfiles</code>.</p>
</div>
<div class="paragraph">
<p>The confirmatory output is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Signature ok
subject=/CN=clientuser
Getting CA Private Key</pre>
</div>
</div>
<div class="paragraph">
<p>This concludes the process.
The client can now use <code>travel-sample.pem</code> to authenticate itself as having the authority of <code>ca.pem</code> (which is shared by the server it intends to access); and provides the username of <code>clientuser</code> (which the server associates with a role appropriate for access to the <code>travel-sample</code> bucket).
The client key, <code>travel-sample.key</code>, can be used for digital signing.</p>
</div>
<div class="paragraph">
<p>A possible use case for the client certificate thus generated is described below, in <a href="#using-client-and-server-certificates-for-secure-xdcr">Using Client and Server Certificates for Secure XDCR</a>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="client-certificate-authorized-by-an-intermediate-certificate"><a class="anchor" href="#client-certificate-authorized-by-an-intermediate-certificate"></a>Client Access: Intermediate-Certificate Authorization</h3>
<div class="paragraph">
<p>The following procedure demonstrates how an <em>intermediate</em> certificate, with the authority of the <em>root</em> certificate, can be created in order itself to sign <em>client</em> certificates.
The procedure assumes that the server-equivalent procedure described in <a href="configure-server-certificates.html#root-intermediate-and-node-certificates" class="xref page">Cluster Protection with Root, Intermediate, and Node Certificates</a> has already been followed; and that the resulting directory-structure is still available.</p>
</div>
<div class="paragraph">
<p>Proceed as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Access the <code>servercertfiles2/root</code> directory, created in <a href="configure-server-certificates.html#root-intermediate-and-node-certificates" class="xref page">Cluster Protection with Root, Intermediate, and Node Certificates</a>.</p>
<div class="listingblock">
<div class="content">
<pre>cd servercertfiles2/root</pre>
</div>
</div>
</li>
<li>
<p>Create an encrypted private key and a certificate signing request, for an intermediate certificate that is to be used for signing client certificates.</p>
<div class="listingblock">
<div class="content">
<pre>openssl req -new -sha256 -newkey rsa:2048 -keyout ../clients/int.key \
-out reqs/client-signing.csr \
-subj '/C=UA/O=MyCompany/OU=People/CN=ClientSigningCA'</pre>
</div>
</div>
<div class="paragraph">
<p>Since this specifies that an encrypted private key be created, prompts appear requesting entry of an appropriate <em>pass phrase</em>.
Enter an appropriate phrase against the prompts.</p>
</div>
<div class="paragraph">
<p>This new private key is named <code>../clients/int.key</code>.
The signing-request file is saved as <code>reqs/client-signing.csr</code>.</p>
</div>
</li>
<li>
<p>Create the intermediate certificate to be used for client-certificate signing.</p>
<div class="listingblock">
<div class="content">
<pre>openssl x509 -CA ca.pem -CAkey ca.key -CAcreateserial -CAserial serial.srl \
-days 3650 -req -in reqs/client-signing.csr -out issued/client-signing.pem \
-extfile int.ext</pre>
</div>
</div>
<div class="paragraph">
<p>The root certificate and key for the cluster, <code>ca.pem</code> and <code>ca.key</code>, are specified as the authority for the intermediate certificate.
Since <code>ca.key</code> is an encrypted key, a prompt appears, requesting that the appropriate pass phrase be entered: enter the appropriate phrase.</p>
</div>
<div class="paragraph">
<p>Note that the extension file used here to constrain the capabilities of the intermediate certificate is that created in <a href="configure-server-certificates.html#create-intermediate-extensions-file" class="xref page">Cluster Protection with Root, Intermediate, and Node Certificates</a>.</p>
</div>
</li>
<li>
<p>Save the intermediate certificate as the certificate-authority for the client certificate that is to be created.</p>
<div class="listingblock">
<div class="content">
<pre>cp issued/client-signing.pem ../clients/int.pem</pre>
</div>
</div>
</li>
<li>
<p>Within the <code>../clients</code> directory, create an extension file for the client certificate:</p>
<div class="listingblock">
<div class="content">
<pre>cd ../clients

cat &gt; client.ext &lt;&lt;EOF
basicConstraints = CA:FALSE
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer:always
extendedKeyUsage = clientAuth
keyUsage = digitalSignature
EOF</pre>
</div>
</div>
<div class="paragraph">
<p>The value of <code>extendedKeyUsage</code> is specified as <code>clientAuth</code>, indicating that the certificate will be used to authenticate a client.
The value of <code>keyUsage</code> is specified as <code>digitalSignature</code>, indicating that the certificate may be used in the verifying of information-origin.</p>
</div>
</li>
<li>
<p>Create a private key for the client certificate.</p>
<div class="listingblock">
<div class="content">
<pre>openssl genrsa -out private/clientuser.key 2048</pre>
</div>
</div>
</li>
<li>
<p>Create a certificate signing request for the client certificate.</p>
<div class="listingblock">
<div class="content">
<pre>openssl req -new -key private/clientuser.key -out reqs/clientuser.csr \
-subj "/C=UA/O=MyCompany/OU=People/CN=clientuser"</pre>
</div>
</div>
<div class="paragraph">
<p>The signing request is based on the private key <code>clientuser.key</code>.
The username associated with the certificate is specified as <code>clientuser</code>: this is the username to be recognized by Couchbase Server, and associated with specific roles.</p>
</div>
</li>
<li>
<p>Create the client certificate.</p>
<div class="listingblock">
<div class="content">
<pre>openssl x509 -CA int.pem -CAkey int.key -CAcreateserial -CAserial serial.srl \
-days 365 -req -in reqs/clientuser.csr \
-out issued/clientuser.pem -extfile client.ext</pre>
</div>
</div>
<div class="paragraph">
<p>This creates the client certificate <code>clientuser.pem</code>, based on the signing request <code>clientuser.csr</code>, and signed with the authority of the intermediate certificate and key, <code>int.pem</code> and <code>int.key</code>.
Since <code>int.key</code> is encrypted, a prompt appears, requesting entry of the appropriate pass phrase: enter the appropriate phrase against the prompt.
The certificate is saved in the <code>issued</code> folder.</p>
</div>
</li>
<li>
<p>Check the validity of the client certificate.
The following use of the <code>openssl</code> command verifies the relationship between the root certificate, the client-intermediate certificate, and the client certificate.</p>
<div class="listingblock">
<div class="content">
<pre>openssl verify -trusted ../root/ca.pem -untrusted int.pem \
issued/clientuser.pem</pre>
</div>
</div>
<div class="paragraph">
<p>If the certificate is valid, the following output is displayed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>issued/clientuser.pem: OK</pre>
</div>
</div>
</li>
<li>
<p>Concatenate the issued client certificate with the client-intermediate certificate, to establish the chain of authority.</p>
<div class="listingblock">
<div class="content">
<pre>cat issued/clientuser.pem int.pem &gt; clientuser.pem</pre>
</div>
</div>
<div class="paragraph">
<p>The result of the concatenation, <code>clientuser.pem</code> is the completed client certificate.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="using-client-and-server-certificates-for-secure-xdcr"><a class="anchor" href="#using-client-and-server-certificates-for-secure-xdcr"></a>Using Client and Server Certificates for Secure XDCR</h3>
<div class="paragraph">
<p>Examples of using the certificates and keys created on this page above and in <a href="configure-server-certificates.html" class="xref page">Configure Server Certificates</a> can be found in the documentation provided for securing <em>Cross Data Center Replication</em>, in <a href="../manage-xdcr/enable-full-secure-replication.html#specify-full-xdcr-security-with-certificates" class="xref page">Specify Root and Client Certificates, and Client Private Key</a>.
When securing XDCR according to these instructions, use the following files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the procedures explained in <a href="configure-server-certificates.html#root-and-node-certificates" class="xref page">Cluster Protection with Root and Node Certificates</a> and <a href="#client-certificate-authorized-by-a-root-certificate">Client Access: Root-Certificate Authorization</a> have been followed, specify:</p>
<div class="ulist">
<ul>
<li>
<p>The remote cluster root certificate as <code>servercertfiles/ca.pem</code>.</p>
</li>
<li>
<p>The client certificate as <code>servercertfiles/clientcertfiles/travel-sample.pem</code>.</p>
</li>
<li>
<p>The client private key as <code>servercertfiles/clientcertfiles/travel-sample.key</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If the procedures explained in <a href="configure-server-certificates.html#root-intermediate-and-node-certificates" class="xref page">Cluster Protection with Root, Intermediate, and Node Certificates</a> and <a href="#client-certificate-authorized-by-an-intermediate-certificate">Client Access: Intermediate-Certificate Authorization</a> have been followed, specify:</p>
<div class="ulist">
<ul>
<li>
<p>The remote cluster root certificate as <code>servercertfiles2/root/ca.pem</code>.</p>
</li>
<li>
<p>The client certificate as <code>servercertfiles2/clients/clientuser.pem</code>.</p>
</li>
<li>
<p>The client private key as <code>servercertfiles2/clients/private/clientuser.key</code>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cert_auth_for_java_client"><a class="anchor" href="#cert_auth_for_java_client"></a>Configure Client Certificates for Java Clients</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A <em>Java</em> client uses a <em>keystore</em> to access the certificates it requires for authentication.
Certificate and keystore preparation is demonstrated by the procedures in the following two sections, which are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#java-client-access-root-certificate-authorization">Java Client Access: Root-Certificate Authorization</a>.
This creates a Java-client certificate signed by the cluster&#8217;s root certificate.
As such, the procedure follows on from the server-certificate creation-process documented in <a href="configure-server-certificates.html#root-and-node-certificates" class="xref page">Cluster Protection with Root and Node Certificates</a>; and makes use of the directories and keys created there.</p>
</li>
<li>
<p><a href="#java-client-access-intermediate-certificate-authorization">Java Client Access: Intermediate-Certificate Authorization</a>.
This creates a Java-client certificate signed by the cluster&#8217;s intermediate certificate.
As such, the procedure follows on from the server-certificate creation-process documented in <a href="configure-server-certificates.html#root-intermediate-and-node-certificates" class="xref page">Cluster Protection with Root, Intermediate and Node Certificates</a>; and makes use of the directories and keys created there.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that the <a href="#assumptions">assumptions</a> specified for the examples above likewise apply to the Java client examples below.</p>
</div>
<div class="sect2">
<h3 id="java-client-access-root-certificate-authorization"><a class="anchor" href="#java-client-access-root-certificate-authorization"></a>Java Client Access: Root-Certificate Authorization</h3>
<div class="paragraph">
<p>Proceed as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Access the main working directory created in <a href="configure-server-certificates.html#root-and-node-certificates" class="xref page">Cluster Protection with Root and Node Certificates</a>, and create and access a new working directory for the Java client certificate to be created.</p>
<div class="listingblock">
<div class="content">
<pre>cd servercertfiles
mkdir javaclient
cd javaclient</pre>
</div>
</div>
</li>
<li>
<p>Define two environment variables: one for the name of the keystore to be created, another for its password.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export KEYSTORE_FILE=my.keystore
export STOREPASS=storepass</code></pre>
</div>
</div>
</li>
<li>
<p>If necessary, install a package containing the <code>keytool</code> utility:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo apt install openjdk-11-jre-headless</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that available packages can be found by means of <code>sudo apt-cache search openjdk</code>.</p>
</div>
</li>
<li>
<p>Generate the keystore.
Note that the password you specify for the alias, by means of the <code>--keypass</code> flag, must be identical to the password you specify for the keystore, by means of the <code>--storepass</code> flag.
In this case, both passwords are specified as <code>&#36;&#123;STOREPASS&#125;</code>; which resolves to <code>storepass</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">keytool -genkey -keyalg RSA -alias selfsigned \
-keystore ${KEYSTORE_FILE} -storepass ${STOREPASS} -validity 360 \
-keysize 2048 -noprompt  -dname "CN=clientuser, OU=People, O=MyCompany, \
L=None, S=None, C=UA" -keypass ${STOREPASS}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the <code>Common Name</code> for the certificate is specified as <code>clientuser</code>, which is the username established on Couchbase Server, whose role-assignment is supportive of reading and writing data to the <code>travel-sample</code> bucket.</p>
</div>
</li>
<li>
<p>Generate the certificate signing-request:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">keytool -certreq -alias selfsigned -keyalg RSA -file my.csr \
-keystore ${KEYSTORE_FILE} -storepass ${STOREPASS} -noprompt</code></pre>
</div>
</div>
<div class="paragraph">
<p>This creates the signing-request file, <code>my.csr</code>.</p>
</div>
<div class="paragraph">
<p>Note that in this example, although only the <code>Common Name</code> is being used to establish the identity of the user seeking authorization, one or more <code>Subject Alternative Names</code> could also be added.
For example, by adding <code>-ext "san=email:john.smith@mail.com"</code> to the certificate signing-request used in the current step, the email-address <code>john.smith@mail.com</code> could be established as the basis for an alternative username to be submitted for authentication.
See <a href="../../learn/security/certificates.html#identity-encoding-in-client-certificates" class="xref page">Specifying Usernames for Client-Certificate Authentication</a>, for more information.</p>
</div>
</li>
<li>
<p>Generate the client certificate, signing it with the root private key, and thereby establishing the root certificate&#8217;s authority:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">openssl x509 -req -in my.csr -CA ../ca.pem \
-CAkey ../ca.key -CAcreateserial -out clientcert.pem -days 365</code></pre>
</div>
</div>
</li>
<li>
<p>Add the root certificate to the keystore:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">keytool -import -trustcacerts -file ../ca.pem \
-alias root -keystore ${KEYSTORE_FILE} -storepass ${STOREPASS} -noprompt</code></pre>
</div>
</div>
</li>
<li>
<p>Add the client certificate to the keystore:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">keytool -import -keystore ${KEYSTORE_FILE} -file clientcert.pem \
-alias selfsigned -storepass ${STOREPASS} -noprompt</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>This concludes preparation of the Java client&#8217;s keystore.
Copy the file (in this case, <code>my.keystore</code>) to a location on a local filesystem from which the Java client can access it.
A sample Java program, which accesses a keystore from a local filesystem, is provided in <a href="#java-sdk:howtos:sdk-authentication.adoc#authenticating-the-java-client-by-certificate" class="xref unresolved">Authenticating a Java Client by Certificate</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="java-client-access-intermediate-certificate-authorization"><a class="anchor" href="#java-client-access-intermediate-certificate-authorization"></a>Java Client Access: Intermediate-Certificate Authorization</h3>
<div class="paragraph">
<p>Proceed as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Access the main working directory created in <a href="configure-server-certificates.html#root-intermediate-and-node-certificates" class="xref page">Cluster Protection with Root, Intermediate, and Node Certificates</a>, and create and access a new working directory for the Java client certificate to be created.</p>
<div class="listingblock">
<div class="content">
<pre>cd servercertfiles2
mkdir javaclient
cd javaclient</pre>
</div>
</div>
</li>
<li>
<p>Define two environment variables: one for the name of the keystore to be created, another for its password:</p>
<div class="listingblock">
<div class="content">
<pre>export KEYSTORE_FILE=my.keystore
export STOREPASS=storepass</pre>
</div>
</div>
</li>
<li>
<p>If necessary, install a package containing the <code>keytool</code> utility:</p>
<div class="listingblock">
<div class="content">
<pre>sudo apt install openjdk-11-jre-headless</pre>
</div>
</div>
</li>
<li>
<p>Generate the keystore.
Note that the password you specify for the alias, by means of the <code>--keypass</code> flag, must be identical to the password you specify for the keystore, by means of the <code>--storepass</code> flag.
In this case, both passwords are specified as <code>&#36;&#123;STOREPASS&#125;</code>; which resolves to <code>storepass</code>.</p>
<div class="listingblock">
<div class="content">
<pre>keytool -genkey -keyalg RSA -alias selfsigned \
-keystore ${KEYSTORE_FILE} -storepass ${STOREPASS} -validity 360 \
-keysize 2048 -noprompt  -dname "CN=clientuser, OU=People, O=MyCompany, \
L=None, S=None, C=UA" -keypass ${STOREPASS}</pre>
</div>
</div>
<div class="paragraph">
<p>Note that the Common Name for the certificate is specified as <code>clientuser</code>, which is the username established on Couchbase Server, whose role-assignment is supportive of reading and writing data to the <code>travel-sample</code> bucket.</p>
</div>
</li>
<li>
<p>Generate the certificate signing-request:</p>
<div class="listingblock">
<div class="content">
<pre>keytool -certreq -alias selfsigned -keyalg RSA -file my.csr \
-keystore ${KEYSTORE_FILE} -storepass ${STOREPASS} -noprompt</pre>
</div>
</div>
</li>
<li>
<p>Generate the client certificate, signing it with the intermediate private key, and thereby establishing the intermediate certificate’s authority:</p>
<div class="listingblock">
<div class="content">
<pre>openssl x509 -req -in my.csr -CA ../servers/int.pem \
-CAkey ../servers/int.key -CAcreateserial -out clientcert.pem -days 365</pre>
</div>
</div>
<div class="paragraph">
<p>Since the intermediate private key was encrypted, a prompt now appears, requesting entry of the pass phrase for the key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Enter pass phrase for ../servers/int.key:</pre>
</div>
</div>
<div class="paragraph">
<p>Enter the pass phrase against the prompt.</p>
</div>
</li>
<li>
<p>Add the root certificate to the keystore:</p>
<div class="listingblock">
<div class="content">
<pre>keytool -import -trustcacerts -file ../root/ca.pem \
-alias root -keystore ${KEYSTORE_FILE} -storepass ${STOREPASS} -noprompt</pre>
</div>
</div>
</li>
<li>
<p>Add the intermediate certificate to the keystore:</p>
<div class="listingblock">
<div class="content">
<pre>keytool -import -trustcacerts -file ../servers/int.pem \
-alias root2 -keystore ${KEYSTORE_FILE} -storepass ${STOREPASS} -noprompt</pre>
</div>
</div>
</li>
<li>
<p>Add the client certificate to the keystore:</p>
<div class="listingblock">
<div class="content">
<pre>keytool -import -keystore ${KEYSTORE_FILE} -file clientcert.pem \
-alias selfsigned -storepass ${STOREPASS} -noprompt</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>This concludes preparation of the Java client&#8217;s keystore.
Copy the file (in this case, <code>my.keystore</code>) to a location on a local filesystem from which the Java client can access it.
A sample Java program, which accesses a keystore from a local filesystem, is provided in <a href="#java-sdk:howtos:sdk-authentication.adoc#authenticating-the-java-client-by-certificate" class="xref unresolved">Authenticating a Java Client by Certificate</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="enabling-client-security"><a class="anchor" href="#enabling-client-security"></a>Securing Client Access with TLS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For an application to communicate securely with Couchbase Server, SSL/TLS must be enabled on the client side.
Enablement requires a copy of the root certificate used by Couchbase Server: this can be accessed from the Couchbase Web Console, as described in
<a href="manage-security-settings.html#root-certificate-security-screen-display" class="xref page">Root Certificate</a>.</p>
</div>
<div class="paragraph">
<p>Note that if, at some point, the root certificate gets regenerated on the server-side, a copy of the new version must be obtained, and the client re-enabled.</p>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2023 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Server","components":["server"],"url":"/home/server.html","latestVersions":{"server":"7.2"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../../../_/js/site.js"></script>
<script defer src="../../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
</body>
</html>
