<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<script>(window.dataLayer=window.dataLayer||[]).push({event:'gtm.js','gtm.start':+new Date()})</script>
<script async src="https://www.googletagmanager.com/gtm.js?id=GTM-MVPNN2"></script>
<title>JOIN Clause | Couchbase Docs</title>
<link rel="stylesheet" href="../../../../_/css/site.css">
<script src="../../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="The JOIN clause enables you to create new input objects by combining two or more source objects.">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="server">
<meta name="dcterms.identifier" content="7.2">
<meta name="page-url" content="/server/current/n1ql/n1ql-language-reference/join.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://docs.couchbase.com/home/index.html">
                    <img src="../../../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://docs.couchbase.com/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../cloud/index.html">
                      Capella
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/pages/n1ql-language-reference/join.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../../introduction/intro.html">Couchbase Server</a></li>
<li class="crumb"><a href="../query.html">Query</a></li>
<li class="crumb"><a href="index.html">SQL++ Language Reference</a></li>
<li class="crumb">Statements</li>
<li class="crumb"><a href="selectintro.html">SELECT</a></li>
<li class="crumb"><a href="join.html">JOIN Clause</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">JOIN Clause</h1>
<div class="labels">
<ul><li class="reference"><span><i class="fas fa-book"></i></i> reference</span></li>
</ul>
</div>


</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<style type="text/css">
  /* DOC-10177 */
  .hdlist table tr td.hdlist1,
  .hdlist table tr td.hdlist2 {
    padding: 1.5rem 0 0;
  }

  /* Compact horizontal definition lists */
  .hdlist.compact,
  .hdlist.compact {
    padding-top: 1rem;
  }
  .hdlist.compact table tr td.hdlist1,
  .hdlist.compact table tr td.hdlist2 {
    padding: 0.5rem 0 0;
  }

  /* Descriptions in horizontal description lists should have left padding */
  .hdlist table tr td.hdlist2,
  .hdlist.compact table tr td.hdlist2 {
    padding-left: 1rem;
  }

  /* Paragraphs in horizontal description lists should not have left margin */
  .hdlist table .hdlist1 + .hdlist2 p {
    margin-left: 0; !important
  }

  /* Horizontal definitions should match style of vertical definitions */
  td.hdlist1 {
    font-weight: 600;
  }
</style>
<div class="quoteblock abstract">
<blockquote>
The <code>JOIN</code> clause enables you to create new input objects by combining two or more source objects.
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="purpose"><a class="anchor" href="#purpose"></a>Purpose</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>JOIN</code> clause is used within the <a href="from.html" class="xref page">FROM</a> clause.
It creates an input object by combining two or more source objects.
Couchbase Server supports three types of <code>JOIN</code> clause, which are described in the sections below: <a href="#section_ek1_jnx_1db">ANSI JOIN</a>, <a href="#lookup-join-clause">Lookup JOIN</a>, and <a href="#index-join-clause">Index JOIN</a>.</p>
</div>
<div class="paragraph">
<p>In Couchbase Server 7.1 and later, you may also use comma-separated joins.
For further details, refer to <a href="comma.html" class="xref page">Comma-Separated Join</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="prerequisites"><a class="anchor" href="#prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For you to select data from keyspace or expression, you must have the <code class="param">query_select</code> privilege on that keyspace.
For more details about user roles, see
<a href="../../learn/security/authorization-overview.html" class="xref page">Authorization</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="syntax"><a class="anchor" href="#syntax"></a>Syntax</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/dql.ebnf#L129">join-clause ::= ansi-join-clause | lookup-join-clause | index-join-clause</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/join-clause.png" alt="Syntax diagram">
</div>
</div>
<div class="hdlist compact">
<table>
<tr>
<td class="hdlist1">
ansi-join-clause
</td>
<td class="hdlist2">
<p><a href="#section_ek1_jnx_1db">ANSI JOIN Clause</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
<tr>
<td class="hdlist1">
lookup-join-clause
</td>
<td class="hdlist2">
<p><a href="#lookup-join-clause">Lookup JOIN Clause</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
<tr>
<td class="hdlist1">
index-join-clause
</td>
<td class="hdlist2">
<p><a href="#index-join-clause">Index JOIN Clause</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="section_nkd_3nx_1db"><a class="anchor" href="#section_nkd_3nx_1db"></a>Left-Hand Side</h3>
<div class="paragraph">
<p>The <code>JOIN</code> clause cannot be the first term within the <code>FROM</code> clause; it must be preceded by another FROM term.
The term immediately preceding the <code>JOIN</code> clause represents the <em>left-hand side</em> of the <code>JOIN</code> clause.</p>
</div>
<div class="paragraph">
<p>You can chain the <code>JOIN</code> clause with any of the other permitted FROM terms, including another <code>JOIN</code> clause.
For more information, see the page on the <a href="from.html" class="xref page">FROM</a> clause.</p>
</div>
<div class="paragraph">
<p>There are restrictions on what types of FROM terms may be chained and in what order&#8201;&#8212;&#8201;see the descriptions on this page for more details.</p>
</div>
<div class="paragraph">
<p>The types of FROM term that may be used as the left-hand side of the <code>JOIN</code> clause are summarized in the following table.</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/partials/n1ql-language-reference/from-term.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<table id="table_vrv_nxx_1db" class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><a href="from.html#sec_from-keyspace" class="xref page">keyspace identifier</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-N1QL hljs" data-lang="N1QL">hotel</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><a href="from.html#generic-expr" class="xref page">generic expression</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-N1QL hljs" data-lang="N1QL">20+10 AS Total</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><a href="from.html#select-expr" class="xref page">subquery</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-N1QL hljs" data-lang="N1QL">SELECT ARRAY_AGG(t1.city) AS cities,
  SUM(t1.city_cnt) AS apnum
FROM (
  SELECT city, city_cnt, country,
    ARRAY_AGG(airportname) AS apnames
  FROM airport
  GROUP BY city, country
  LETTING city_cnt = COUNT(city)
) AS t1
WHERE t1.city_cnt &gt; 5;</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">previous <a href="#">join</a>, <a href="nest.html" class="xref page">nest</a>, or <a href="unnest.html" class="xref page">unnest</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-N1QL hljs" data-lang="N1QL">SELECT *
FROM route AS rte
JOIN airport AS apt
  ON rte.destinationairport = apt.faa
NEST landmark AS lmk
  ON apt.city = lmk.city
LIMIT 5;</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="section_ek1_jnx_1db"><a class="anchor" href="#section_ek1_jnx_1db"></a>ANSI JOIN Clause</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="purpose-2"><a class="anchor" href="#purpose-2"></a>Purpose</h3>
<div class="paragraph">
<p>To be closer to standard SQL syntax, ANSI JOIN can join arbitrary fields of the documents and can be chained together.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<a href="#section_ek1_jnx_1db">ANSI JOIN</a> and <a href="nest.html#section_tc1_nnx_1db" class="xref page">ANSI NEST</a> clauses have much more flexible functionality than their earlier INDEX and LOOKUP equivalents.
Since these are standard compliant and more flexible, we recommend you to use ANSI JOIN and ANSI NEST exclusively, where possible.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="syntax-2"><a class="anchor" href="#syntax-2"></a>Syntax</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/dql.ebnf#L136">ansi-join-clause ::= ansi-join-type? 'JOIN' ansi-join-rhs ansi-join-predicate</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/ansi-join-clause.png" alt="Syntax diagram">
</div>
</div>
<div class="hdlist compact">
<table>
<tr>
<td class="hdlist1">
ansi-join-type
</td>
<td class="hdlist2">
<p><a href="#ansi-join-type">Join Type</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
<tr>
<td class="hdlist1">
ansi-join-rhs
</td>
<td class="hdlist2">
<p><a href="#ansi-join-rhs">ANSI JOIN Right-Hand Side</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
<tr>
<td class="hdlist1">
ansi-join-predicate
</td>
<td class="hdlist2">
<p><a href="#ansi-join-predicate">Join Predicate</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="ansi-join-type"><a class="anchor" href="#ansi-join-type"></a>Join Type</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/dql.ebnf#L140">ansi-join-type ::= 'INNER' | ( 'LEFT' | 'RIGHT' ) 'OUTER'?</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/ansi-join-type.png" alt="Syntax diagram">
</div>
</div>
<div class="paragraph">
<p>This clause represents the type of ANSI join.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>INNER</code></dt>
<dd>
<p>For each joined object produced, both the left-hand side and right-hand side source objects of the <code>ON</code> clause must be non-MISSING and non-NULL.</p>
</dd>
<dt class="hdlist1"><code>LEFT [OUTER]</code></dt>
<dd>
<p>[Query Service interprets <code>LEFT</code> as <code>LEFT OUTER</code>]</p>
<div class="paragraph">
<p>For each joined object produced, only the left-hand source objects of the <code>ON</code> clause must be non-MISSING and non-NULL.</p>
</div>
</dd>
<dt class="hdlist1"><code>RIGHT [OUTER]</code></dt>
<dd>
<p>[Query Service interprets <code>RIGHT</code> as <code>RIGHT OUTER</code>]</p>
<div class="paragraph">
<p>For each joined object produced, only the right-hand source objects of the <code>ON</code> clause must be non-MISSING and non-NULL.</p>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>This clause is optional.
If omitted, the default is <code>INNER</code>.</p>
</div>
<div class="paragraph">
<p>The following table summarizes the ANSI join types currently supported, and describes how you may chain them together.</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/join.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 16.6666%;">
<col style="width: 50.0001%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Join Type</th>
<th class="tableblock halign-left valign-top">Remarks</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>[INNER] JOIN ... ON</strong></p></td>
<td class="tableblock halign-left valign-middle" rowspan="2"><p class="tableblock">INNER JOIN and LEFT OUTER JOIN can be mixed in any number and/or order.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT *
FROM route
JOIN airline
ON route.airlineid = META(airline).id
WHERE airline.country = "France";</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>LEFT [OUTER] JOIN ... ON</strong></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT *
FROM route
LEFT JOIN airline
ON route.airlineid = META(airline).id
WHERE route.sourceairport = "SFO";</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>RIGHT [OUTER] JOIN ... ON</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RIGHT OUTER JOIN can only be the first join specified in a FROM clause.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT *
FROM route
RIGHT JOIN airline
ON route.airlineid = META(airline).id
WHERE route.sourceairport = "SFO";</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In Couchbase Server 6.5 and later, if you create either of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A LEFT OUTER JOIN where all the NULL or MISSING results on the right-hand side are filtered out by the <a href="where.html" class="xref page">WHERE clause</a> or by the ON clause of a subsequent INNER JOIN, or</p>
</li>
<li>
<p>A RIGHT OUTER JOIN where all the NULL or MISSING results on the left-hand side are filtered out by the <a href="where.html" class="xref page">WHERE clause</a> or by the ON clause of a subsequent INNER JOIN,</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then the query is transformed internally into an INNER JOIN for greater efficiency.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="ansi-join-predicate"><a class="anchor" href="#ansi-join-predicate"></a>Join Predicate</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/dql.ebnf#L193">ansi-join-predicate ::= 'ON' expr</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/ansi-join-predicate.png" alt="Syntax diagram">
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>expr</code></dt>
<dd>
<p>Boolean expression representing the join condition between the left-hand side <a href="#section_nkd_3nx_1db">FROM term</a> and the <a href="#ansi-join-rhs">ANSI JOIN Right-Hand Side</a>.
This expression may contain fields, constant expressions, or any complex SQL++ expression.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="limitations"><a class="anchor" href="#limitations"></a>Limitations</h3>
<div class="ulist">
<ul>
<li>
<p>A RIGHT OUTER join is only supported when itâ€™s the only join in the query; or when it&#8217;s the first join in a chain of joins.</p>
</li>
<li>
<p>No mixing of ANSI join syntax with lookup or index join syntax in the same FROM clause.</p>
</li>
<li>
<p>If the right-hand side of an ANSI join is a keyspace reference, then for the nested-loop join method an appropriate secondary index must exist on the right-hand side keyspace; for the hash join method, a primary index can be used.</p>
</li>
<li>
<p>Adaptive indexes are not considered when selecting indexes on inner side of the join.</p>
</li>
<li>
<p>You may chain ANSI joins with comma-separated joins; however, the comma-separated joins must come after any JOIN, NEST, or UNNEST clauses.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="examples"><a class="anchor" href="#examples"></a>Examples</h3>
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/join.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div id="ANSI-Join-Example-1" class="exampleblock">
<div class="title">Example 1. Inner Join</div>
<div class="content">
<div class="paragraph">
<p>List the source airports and airlines that fly into SFO, where only the non-null <code>route</code> documents join with matching <code>airline</code> documents.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/ansi-join-inner.n1ql">SELECT route.airlineid, airline.name, route.sourceairport, route.destinationairport
FROM route
INNER JOIN airline
ON route.airlineid = META(airline).id
WHERE route.destinationairport = "SFO"
ORDER BY route.sourceairport;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-JSON hljs" data-lang="JSON" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/ansi-join-inner.jsonc">[
  {
    "airlineid": "airline_5209",
    "destinationairport": "SFO",
    "name": "United Airlines",
    "sourceairport": "ABQ"
  },
  {
    "airlineid": "airline_5209",
    "destinationairport": "SFO",
    "name": "United Airlines",
    "sourceairport": "ACV"
  },
  {
    "airlineid": "airline_5209",
    "destinationairport": "SFO",
    "name": "United Airlines",
    "sourceairport": "AKL"
  },
// ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The INNER JOIN only returns results where a left-side document matches a right-side document.</p>
</div>
</div>
</div>
<div id="ANSI-Join-Example-2" class="exampleblock">
<div class="title">Example 2. Left Outer Join of U.S. airports in the same city as a landmark</div>
<div class="content">
<div class="paragraph">
<p>List the airports and landmarks in the same city, ordered by the airports.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/ansi-join-left.n1ql">SELECT DISTINCT  MIN(aport.airportname) AS Airport__Name,
                 MIN(aport.tz) AS Airport__Time,
                 MIN(lmark.name) AS Landmark_Name
FROM airport aport <i class="conum" data-value="1"></i><b>(1)</b>
LEFT JOIN landmark lmark <i class="conum" data-value="2"></i><b>(2)</b>
  ON aport.city = lmark.city
  AND lmark.country = "United States"
GROUP BY aport.airportname
ORDER BY aport.airportname
LIMIT 4;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>airport</code> keyspace is on the left-hand side of the join.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>landmark</code> keyspace is on the right-hand side of the join.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-JSON hljs" data-lang="JSON" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/ansi-join-left.jsonc">[
  {
    "Airport__Name": "Abbeville",
    "Airport__Time": "Europe/Paris",
    "Landmark_Name": null <i class="conum" data-value="1"></i><b>(1)</b>
  },
  {
    "Airport__Name": "Aberdeen Regional Airport",
    "Airport__Time": "America/Chicago",
    "Landmark_Name": null
  },
  {
    "Airport__Name": "Abilene Rgnl",
    "Airport__Time": "America/Chicago",
    "Landmark_Name": null
  },
  {
    "Airport__Name": "Abraham Lincoln Capital",
    "Airport__Time": "America/Chicago",
    "Landmark_Name": null
  }
]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The LEFT OUTER JOIN lists all the left-side results, even if there are no matching right-side documents, as indicated by the results in which the fields from the <code>landmark</code> keyspace are null or missing.</td>
</tr>
</table>
</div>
</div>
</div>
<div id="ANSI-Join-Example-3" class="exampleblock">
<div class="title">Example 3. RIGHT OUTER JOIN of <a href="#ANSI-Join-Example-2">Example 2</a></div>
<div class="content">
<div class="paragraph">
<p>List the airports and landmarks in the same city, ordered by the landmarks.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/ansi-join-right.n1ql">SELECT DISTINCT MIN(aport.airportname) AS Airport__Name,
                MIN(aport.tz) AS Airport__Time,
                MIN(lmark.name) AS Landmark_Name,
FROM airport aport <i class="conum" data-value="1"></i><b>(1)</b>
RIGHT JOIN landmark lmark <i class="conum" data-value="2"></i><b>(2)</b>
  ON aport.city = lmark.city
  AND aport.country = "United States"
GROUP BY lmark.name
ORDER BY lmark.name
LIMIT 4;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>airport</code> keyspace is on the left-hand side of the join.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>landmark</code> keyspace is on the right-hand side of the join.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-JSON hljs" data-lang="JSON" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/ansi-join-right.jsonc">[
  {
    "Airport__Name": "San Francisco Intl",
    "Airport__Time": "America/Los_Angeles",
    "Landmark_Name": "&amp;quot;Hippie Temptation&amp;quot; house"
  },
  {
    "Airport__Name": null, <i class="conum" data-value="1"></i><b>(1)</b>
    "Airport__Time": null,
    "Landmark_Name": "'The Argyll Arms Hotel"
  },
  {
    "Airport__Name": null,
    "Airport__Time": null,
    "Landmark_Name": "'Visit the Hut of the Shadows and other End of the Road sculptures"
  },
  {
    "Airport__Name": "London-Corbin Airport-MaGee Field",
    "Airport__Time": "America/New_York",
    "Landmark_Name": "02 Shepherd's Bush Empire"
  }
]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The RIGHT OUTER JOIN lists all the right-side results, even if there are no matching left-side documents, as indicated by the results in which the fields from the <code>airport</code> keyspace are null or missing.</td>
</tr>
</table>
</div>
</div>
</div>
<div id="ANSI-Join-Example-4" class="exampleblock">
<div class="title">Example 4. Inner Join with Covering Index</div>
<div class="content">
<div class="paragraph">
<p>Use an ANSI JOIN to list the routes and destination airports that are available from London Heathrow (ICAO code <code>EGLL</code>).</p>
</div>
<div class="paragraph">
<p>By default, the ANSI JOIN uses the <code>def_inventory_route_sourceairport</code> index, which is installed with the <code>travel-sample</code> bucket.
This index has <code>sourceairport</code> as its leading key.</p>
</div>
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/ansi-join-cover.n1ql#L2-L3">CREATE INDEX def_inventory_route_sourceairport
ON route (sourceairport);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/ansi-join-cover.n1ql#L12-L15">SELECT META(route).id route_id, route.airline, route.destinationairport
FROM airport JOIN route ON route.sourceairport = airport.faa
WHERE airport.icao = "EGLL"
ORDER BY route_id;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-JSON hljs" data-lang="JSON" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/ansi-join-cover.jsonc">[
  {
    "airline": "AH",
    "destinationairport": "ALG",
    "route_id": "route_10186"
  },
  {
    "airline": "AI",
    "destinationairport": "BOM",
    "route_id": "route_10570"
  },
// ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>If no covering index is available, the Query Service has to fetch each matching record from the <code>route</code> keyspace to get the airline and destination airport information, as shown in the query plan:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/FROM_AnsiJoin-Ex4-BeerVisual1.png" alt="Query plan with Fetch 'route' step before Nested Loop Join">
</div>
</div>
<div class="paragraph">
<p>If you create a covering index, with <code>sourceairport</code> as the leading key, and <code>airline</code> and <code>destinationairport</code> as additional index keys:</p>
</div>
<div class="listingblock">
<div class="title">Covering Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/ansi-join-cover.n1ql#L7-L8">CREATE INDEX idx_route_src_dst_airline
ON route (sourceairport, destinationairport, airline);</code></pre>
</div>
</div>
<div class="paragraph">
<p>... then the Query Service does not need to fetch any records from the <code>route</code> keyspace, as shown in the query plan:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/FROM_AnsiJoin-Ex4-BeerVisual2.png" alt="Query plan with no Fetch 'route' step before Nested Loop Join">
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ansi-join-rhs"><a class="anchor" href="#ansi-join-rhs"></a>ANSI JOIN Right-Hand Side</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/dql.ebnf#L144">ansi-join-rhs ::= rhs-keyspace | rhs-subquery | rhs-generic</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/ansi-join-rhs.png" alt="Syntax diagram">
</div>
</div>
<div class="paragraph">
<p>In Couchbase Server 6.5 and later, the right-hand side of an ANSI join may be a keyspace reference, a subquery, or a generic expression term.</p>
</div>
<div class="hdlist compact">
<table>
<tr>
<td class="hdlist1">
rhs-keyspace
</td>
<td class="hdlist2">
<p><a href="#ansi-rhs-keyspace">Right-Hand Side Keyspace</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
<tr>
<td class="hdlist1">
rhs-subquery
</td>
<td class="hdlist2">
<p><a href="#ansi-rhs-subquery">Right-Hand Side Subquery</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
<tr>
<td class="hdlist1">
rhs-generic
</td>
<td class="hdlist2">
<p><a href="#ansi-rhs-generic">Right-Hand Side Generic Expression</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="ansi-rhs-keyspace"><a class="anchor" href="#ansi-rhs-keyspace"></a>Right-Hand Side Keyspace</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/dql.ebnf#L148">rhs-keyspace ::= keyspace-ref ( 'AS'? alias )? ansi-join-hints?</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/rhs-keyspace.png" alt="Syntax diagram">
</div>
</div>
<div class="hdlist compact">
<table>
<tr>
<td class="hdlist1">
keyspace-ref
</td>
<td class="hdlist2">
<p><a href="#ansi-keyspace-ref">Keyspace Reference</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
<tr>
<td class="hdlist1">
alias
</td>
<td class="hdlist2">
<p><a href="#ansi-keyspace-alias">AS Alias</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
<tr>
<td class="hdlist1">
ansi-join-hints
</td>
<td class="hdlist2">
<p><a href="#ansi-join-hints">ANSI JOIN Hints</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="ansi-keyspace-ref"><a class="anchor" href="#ansi-keyspace-ref"></a>Keyspace Reference</h4>
<div class="paragraph">
<p>Keyspace reference for the right-hand side of the ANSI join.
For details, see <a href="from.html#from-keyspace-ref" class="xref page">Keyspace Reference</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="ansi-keyspace-alias"><a class="anchor" href="#ansi-keyspace-alias"></a>AS Alias</h4>
<div class="paragraph">
<p>Assigns another name to the keyspace reference.
For details, see <a href="from.html#section_ax5_2nx_1db" class="xref page">AS Clause</a>.</p>
</div>
<div class="paragraph">
<p>Assigning an alias to the keyspace reference is optional.
If you assign an alias to the keyspace reference, the <code>AS</code> keyword may be omitted.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ansi-rhs-subquery"><a class="anchor" href="#ansi-rhs-subquery"></a>Right-Hand Side Subquery</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/dql.ebnf#L152">rhs-subquery ::= subquery-expr 'AS'? alias</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/rhs-subquery.png" alt="Syntax diagram">
</div>
</div>
<div class="hdlist compact">
<table>
<tr>
<td class="hdlist1">
subquery-expr
</td>
<td class="hdlist2">
<p><a href="#ansi-subquery-expr">Subquery Expression</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
<tr>
<td class="hdlist1">
alias
</td>
<td class="hdlist2">
<p><a href="#ansi-subquery-alias">AS Alias</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="ansi-subquery-expr"><a class="anchor" href="#ansi-subquery-expr"></a>Subquery Expression</h4>
<div class="paragraph">
<p>Use parentheses to specify a subquery for the right-hand side of the ANSI join.
For details, see <a href="from.html#select-expr-clause" class="xref page">Subquery Expression</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A subquery on the right-hand side of the ANSI join cannot be <strong>correlated</strong>, i.e. it cannot refer to a keyspace in the outer query block.
This will lead to an error.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="ansi-subquery-alias"><a class="anchor" href="#ansi-subquery-alias"></a>AS Alias</h4>
<div class="paragraph">
<p>Assigns another name to the subquery.
For details, see <a href="from.html#section_ax5_2nx_1db" class="xref page">AS Clause</a>.</p>
</div>
<div class="paragraph">
<p>You must assign an alias to a subquery on the right-hand side of the join.
However, when you assign an alias to the subquery, the <code>AS</code> keyword may be omitted.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ansi-rhs-generic"><a class="anchor" href="#ansi-rhs-generic"></a>Right-Hand Side Generic Expression</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/dql.ebnf#L156">rhs-generic ::= expr ( 'AS'? alias )?</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/rhs-generic.png" alt="Syntax diagram">
</div>
</div>
<div class="hdlist compact">
<table>
<tr>
<td class="hdlist1">
expr
</td>
<td class="hdlist2">
<p><a href="#ansi-generic-expr">Expression Term</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
<tr>
<td class="hdlist1">
alias
</td>
<td class="hdlist2">
<p><a href="#ansi-generic-alias">AS Alias</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="ansi-generic-expr"><a class="anchor" href="#ansi-generic-expr"></a>Expression Term</h4>
<div class="paragraph">
<p>A SQL++ <a href="index.html" class="xref page">expression</a> generating JSON documents or objects for the right-hand side of the ANSI join.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
An expression on the right-hand side of the ANSI join may be <strong>correlated</strong>, i.e. it may refer to a keyspace on the left-hand side of the join.
In this case, only a <a href="#ansi-join-hints">nested-loop join</a> may be used.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="ansi-generic-alias"><a class="anchor" href="#ansi-generic-alias"></a>AS Alias</h4>
<div class="paragraph">
<p>Assigns another name to the generic expression.
For details, see <a href="from.html#section_ax5_2nx_1db" class="xref page">AS Clause</a>.</p>
</div>
<div class="paragraph">
<p>You must assign an alias to the generic expression if it is not an identifier; otherwise, assigning an alias is optional.
However, when you assign an alias to the generic expression, the <code>AS</code> keyword may be omitted.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="examples-2"><a class="anchor" href="#examples-2"></a>Examples</h3>
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/join.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div id="ANSI-Join-Example-sub" class="exampleblock">
<div class="title">Example 5. Inner Join with Subquery on Right-Hand Side</div>
<div class="content">
<div class="paragraph">
<p>Find the destination airport of all routes whose source airport is in San Francisco.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/ansi-join-sub.n1ql">SELECT DISTINCT subquery.destinationairport
FROM airport
JOIN (
  SELECT destinationairport, sourceairport
  FROM route
) AS subquery
ON airport.faa = subquery.sourceairport
WHERE airport.city = "San Francisco";</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-JSON hljs" data-lang="JSON" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/ansi-join-sub.jsonc">[
  {
    "destinationairport": "HKG"
  },
  {
    "destinationairport": "ICN"
  },
  {
    "destinationairport": "ATL"
  },
  {
    "destinationairport": "BJX"
  },
  {
    "destinationairport": "GDL"
  },
// ...</code></pre>
</div>
</div>
</div>
</div>
<div id="ANSI-Join-Example-expr" class="exampleblock">
<div class="title">Example 6. Inner Join with Generic Expression on Right-Hand Side</div>
<div class="content">
<div class="paragraph">
<p>Find the destination airport of all routes in the given array whose source airport is in San Francisco.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/ansi-join-expr.n1ql">SELECT DISTINCT expression.destinationairport
FROM airport JOIN [
  {"destinationairport": "KEF", "sourceairport": "SFO", "type": "route"},
  {"destinationairport": "KEF", "sourceairport": "LHR", "type": "route"}
] AS expression
ON airport.faa = expression.sourceairport
WHERE airport.city = "San Francisco";</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-JSON hljs" data-lang="JSON" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/ansi-join-expr.jsonc">[
  {
    "destinationairport": "KEF"
  }
]</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ansi-join-hints"><a class="anchor" href="#ansi-join-hints"></a>ANSI JOIN Hints</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/dql.ebnf#L160">ansi-join-hints ::= use-hash-hint | use-nl-hint | multiple-hints</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/ansi-join-hints.png" alt="Syntax diagram">
</div>
</div>
<div class="hdlist compact">
<table>
<tr>
<td class="hdlist1">
use-hash-hint
</td>
<td class="hdlist2">
<p><a href="#use-hash-hint">USE HASH Hint</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
<tr>
<td class="hdlist1">
use-nl-hint
</td>
<td class="hdlist2">
<p><a href="#use-nl-hint">USE NL Hint</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
<tr>
<td class="hdlist1">
multiple-hints
</td>
<td class="hdlist2">
<p><a href="#multiple-hints">Multiple Hints</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Couchbase Server Enterprise Edition supports two join methods for performing ANSI join: nested-loop join and hash join.
Two corresponding join hints are introduced: <code>USE HASH</code> and <code>USE NL</code>.</p>
</div>
<div class="paragraph">
<p>The ANSI join hints are similar to the <a href="hints.html#use-index-clause" class="xref page">USE INDEX</a> or <a href="hints.html#use-keys-clause" class="xref page">USE KEYS</a> hints.
The ANSI join hints can be specified after the right-hand side of an ANSI join specification.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The join hint for the first join should be specified on the first join&#8217;s right-hand side, and the join hint for the second join should be specified on the second join&#8217;s right-hand side, etc.
If a join hint is specified on the first FROM term, i.e. the first join&#8217;s left-hand side, an error is returned.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In Couchbase Server 7.1 and later, you can also supply a join hint within a specially-formatted <a href="optimizer-hints.html" class="xref page">hint comment</a>.
Note that you cannot specify a join hint for the same keyspace using both the <code>USE</code> clause and a hint comment.
If you do this, the <code>USE</code> clause and the hint comment are both marked as erroneous and ignored by the optimizer.
</td>
</tr>
</table>
</div>
<div id="default-join-method" class="sidebarblock">
<div class="content">
<div class="title">Default Join Method</div>
<div class="paragraph">
<p><span class="edition"><a href="https://www.couchbase.com/products/editions">ENTERPRISE EDITION</a></span></p>
</div>
<div class="paragraph">
<p>In Enterprise Edition, for an ANSI join with a subquery or a generic expression as the right-hand side, the default method is hash.
In this case:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The subquery or expression on the right-hand side of the join is used as the <a href="#use-hash-hint">build side</a> of the hash join.
If <code>USE HASH(PROBE)</code> is specified, then the expression or subquery will be used as the <a href="#use-hash-hint">probe side</a> of the hash join.</p>
</li>
<li>
<p>If an expression on the right-hand side is <a href="#ansi-generic-expr">correlated</a>, a nested-loop join is used.
(If a subquery on the right-hand side is <a href="#ansi-subquery-expr">correlated</a>, the query returns an error.)</p>
</li>
<li>
<p>If a hash join is not feasible or not supported, or if the <code>USE NL</code> hint is specified, a nested-loop join is used.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For other types of join, the default method is nested-loop.
In this case:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Hash join is only considered when the <code>USE HASH</code> hint is specified, and it requires at least one equality predicate between the left-hand side and right-hand side.</p>
</li>
<li>
<p>If the join meets these conditions, hash join is used.
If the hash join cannot be generated, then the planner will further consider nested-loop join, and will either generate a nested-loop join or return an error for the join.</p>
</li>
<li>
<p>If no join hint is specified, or the <code>USE NL</code> hint is specified, then nested-loop join is considered.</p>
</li>
</ul>
</div>
<hr>
<div class="paragraph">
<p><span class="edition"><a href="https://www.couchbase.com/products/editions">COMMUNITY EDITION</a></span></p>
</div>
<div class="paragraph">
<p>For Community Edition (CE), only nested-loop join is considered by the planner, and any specified <code>USE HASH</code> hint will be silently ignored.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="use-hash-hint"><a class="anchor" href="#use-hash-hint"></a>USE HASH Hint</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/dql.ebnf#L164">use-hash-hint ::= 'USE' use-hash-term</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/use-hash-hint.png" alt="Syntax diagram">
</div>
</div>
<div id="use-hash-term" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/dql.ebnf#L168">use-hash-term ::= 'HASH' '(' ( 'BUILD' | 'PROBE' ) ')'</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/use-hash-term.png" alt="Syntax diagram">
</div>
</div>
<div class="paragraph">
<p>There are two versions of the <code>USE HASH</code> hint:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>USE HASH(BUILD)</code>&#8201;&#8212;&#8201;The right-hand side of the join is to be used as the build side.</p>
</li>
<li>
<p><code>USE HASH(PROBE)</code>&#8201;&#8212;&#8201;The right-hand side of the join is to be used as the probe side.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A hash join has two sides: a <strong>build</strong> side and a <strong>probe</strong> side.
The build side of the join will be used to create an in-memory hash table.
The probe side will use that table to find matches and perform the join.
Typically, this means you want the build side to be used on the smaller of the two sets.
However, you can only supply one hash hint, and only to the right side of the join.
So if you specify <code>BUILD</code> on the right side, then you are implicitly using <code>PROBE</code> on the left side (and vice versa).</p>
</div>
<div class="paragraph">
<p>In Couchbase Server 7.1 and later, this clause is equivalent to the <code>USE_HASH</code> optimizer hint.
For more details, refer to <a href="keyspace-hints.html#use-hash" class="xref page">Keyspace Hints</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="use-nl-hint"><a class="anchor" href="#use-nl-hint"></a>USE NL Hint</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/dql.ebnf#L172">use-nl-hint ::= 'USE' use-nl-term</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/use-nl-hint.png" alt="Syntax diagram">
</div>
</div>
<div id="use-nl-term" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/dql.ebnf#L176">use-nl-term ::= 'NL'</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/use-nl-term.png" alt="Syntax diagram">
</div>
</div>
<div class="paragraph">
<p>This join hint instructs the planner to use nested-loop join (NL join) for the join being considered.</p>
</div>
<div class="paragraph">
<p>In Couchbase Server 7.1 and later, this clause is equivalent to the <code>USE_NL</code> optimizer hint.
For more details, refer to <a href="keyspace-hints.html#use-hash" class="xref page">Keyspace Hints</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="multiple-hints"><a class="anchor" href="#multiple-hints"></a>Multiple Hints</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/dql.ebnf#L180-L181">multiple-hints ::= 'USE' ( ansi-hint-terms other-hint-terms |
                           other-hint-terms ansi-hint-terms )</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/multiple-hints.png" alt="Syntax diagram">
</div>
</div>
<div id="ansi-hint-terms" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/dql.ebnf#L185">ansi-hint-terms ::= use-hash-term | use-nl-term</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/ansi-hint-terms.png" alt="Syntax diagram">
</div>
</div>
<div id="other-hint-terms" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/dql.ebnf#L189">other-hint-terms ::= use-index-term | use-keys-term</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/other-hint-terms.png" alt="Syntax diagram">
</div>
</div>
<div class="paragraph">
<p>You can use only one join hint (<a href="#use-hash-term">USE HASH</a> or <a href="#use-nl-term">USE NL</a>) together with only one other hint (<a href="hints.html#use-index-term" class="xref page">USE INDEX</a> or <a href="hints.html#use-keys-term" class="xref page">USE KEYS</a>) for a total of two hints.
The order of the two hints doesn&#8217;t matter.</p>
</div>
<div class="paragraph">
<p>When multiple hints are being specified, use only one <code>USE</code> keyword with one following the other, as shown in <a href="#Multiple-hint-Example-1">Example 10</a> and <a href="#Multiple-hint-Example-2">Example 11</a>.</p>
</div>
<div class="paragraph">
<p>When chosen, the hash join will always work; the restrictions are on any USE KEYS hint clause:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Must not depend on any previous keyspaces.</p>
</li>
<li>
<p>The expression must be constants, host variables, etc.</p>
</li>
<li>
<p>Must not contain any subqueries.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the USE KEYS hint contains references to other keyspaces or subqueries, then the USE HASH hint will be ignored and nested-loop join will be used instead.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="examples-3"><a class="anchor" href="#examples-3"></a>Examples</h3>
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/join.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div id="USE-HASH-Example-1" class="exampleblock">
<div class="title">Example 7. USE HASH with PROBE</div>
<div class="content">
<div class="paragraph">
<p>The keyspace <code>aline</code> is to be joined (with <code>rte</code>) using hash join, and <code>aline</code> is used as the probe side of the hash join.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/use-hash-probe-legacy.n1ql#L6-L10">SELECT COUNT(1) AS Total_Count
FROM route rte
INNER JOIN airline aline
USE HASH (PROBE)
ON rte.airlineid = META(aline).id;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-JSON hljs" data-lang="JSON">[
  {
    "Total_Count": 17629
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div id="USE-HASH-Example-2" class="exampleblock">
<div class="title">Example 8. USE HASH with BUILD</div>
<div class="content">
<div class="paragraph">
<p>This is effectively the same query as the previous example, except the two keyspaces are switched, and here the <code>USE HASH(BUILD)</code> hint is used, indicating the hash join should use <code>rte</code> as the build side.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/use-hash-build-legacy.n1ql#L6-L10">SELECT COUNT(1) AS Total_Count
FROM airline aline
INNER JOIN route rte
USE HASH (BUILD)
ON (rte.airlineid = META(aline).id);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-JSON hljs" data-lang="JSON">[
  {
    "Total_Count": 17629
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 9. USE NL</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/use-nl-legacy.n1ql#L6-L12">SELECT a.airportname AS airport, r.id AS route
FROM route AS r
JOIN airport AS a
USE NL
ON a.faa = r.sourceairport
WHERE r.sourceairport = "SFO"
LIMIT 4;</code></pre>
</div>
</div>
</div>
</div>
<div id="Multiple-hint-Example-1" class="exampleblock">
<div class="title">Example 10. USE INDEX with USE HASH</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT COUNT(1) AS Total_Count
FROM route rte
INNER JOIN airline aline
USE INDEX (idx_destinations) HASH (PROBE)
ON (rte.airlineid = META(aline).id);</code></pre>
</div>
</div>
</div>
</div>
<div id="Multiple-hint-Example-2" class="exampleblock">
<div class="title">Example 11. USE HASH with USE KEYS</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT COUNT(1) AS Total_Count
FROM route rte
INNER JOIN airline aline
USE HASH (PROBE) KEYS ["airline_10", "airline_21", "airline_22"]
ON (rte.airlineid = META(aline).id);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ansi-join-and-arrays"><a class="anchor" href="#ansi-join-and-arrays"></a>ANSI JOIN and Arrays</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ANSI JOIN provides great flexibility since the <code>ON</code> clause of an ANSI JOIN can be any expression as long as it evaluates to TRUE or FALSE.
Below are different join scenarios involving arrays and ways to handle each scenario.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These keyspaces and indexes will be used throughout this section&#8217;s array scenarios.
As a convention, when a field name starts with <code>a</code> it is an array, so each keyspace has two array fields and two regular fields.</p>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="../_images/diag-d16c97af6921989a6dbc9d47881ee624b6eb1a27.svg" alt="ansi-join-example">
</div>
</div>
<div class="paragraph">
<p>Within each keyspace, both <code>_idx1</code> indexes index each element of its array, while both <code>_idx2</code> indexes use its entire array as the index key.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX b1_idx1 ON b1 (c11, c12, DISTINCT a11);
CREATE INDEX b1_idx2 ON b1 (a12);
CREATE INDEX b2_idx1 ON b2 (c21, c22, DISTINCT a21);
CREATE INDEX b2_idx2 ON b2 (a22);</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="ansi-join-with-no-arrays"><a class="anchor" href="#ansi-join-with-no-arrays"></a>ANSI JOIN with No Arrays</h3>
<div class="paragraph">
<p>In this scenario, there is no involvement of arrays in the join.
These are just straight-forward joins:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT *
FROM b1
JOIN b2
  ON b1.c11 = b2.c21
  AND b2.c22 = 100
WHERE b1.c12 = 10;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here the joins are using non-array fields of each keyspace.</p>
</div>
<div class="paragraph">
<p>The following case also falls in this scenario:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT *
FROM b1
JOIN b2
  ON b1.c11 = b2.c21
  AND b2.c22 = 100
  AND ANY v IN b2.a21 SATISFIES v = 10 END
WHERE b1.c12 = 10;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, although there is an ANY predicate on the right-hand side array <code>b2.a21</code>, the ANY predicate does not involve any joins, and thus, as far as the join is concerned, it is still a 1-to-1 join.
Similarly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT *
FROM b1
JOIN b2
  ON b1.c11 = b2.c21
WHERE b1.c11 = 10
  AND b1.c12 = 100
  AND ANY v IN b1.a11 SATISFIES v = 20 END;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case the ANY predicate is on the left-hand side array <code>b1.a11</code>; however, similar to above, the ANY predicate does not involve any joins, and thus the join is still 1-to-1.
We can even have ANY predicates on both sides:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT *
FROM b1
JOIN b2
  ON b1.c11 = b2.c21
  AND b2.c22 = 100
  AND ANY v IN b2.a21 SATISFIES v = 10 END
WHERE b1.c11 = 10
  AND b1.c12 = 100
  AND ANY v IN b1.a11 SATISFIES v = 10 END;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, the ANY predicates do not involve any join, and the join is still 1-to-1.</p>
</div>
</div>
<div class="sect2">
<h3 id="ansi-join-with-entire-array-as-index-key"><a class="anchor" href="#ansi-join-with-entire-array-as-index-key"></a>ANSI JOIN with Entire Array as Index Key</h3>
<div class="paragraph">
<p>As a special case, it is possible to perform ANSI JOIN on an entire array as a join key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT *
FROM b1
JOIN b2
  ON b1.a21 = b2.a22
WHERE b1.c11 = 10
  AND b1.c12 = 100;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the entire array must match each other for the join to work.
For all practical purposes, the array here is treated as a scalar since there is no logic to iterate through elements of an array here.
The entire array is used as an index key (<code>b2_idx2</code>) and as such, an entire array is used as an index span to probe the index.
The join here can also be considered as 1-to-1.</p>
</div>
</div>
<div class="sect2">
<h3 id="ansi-join-involving-right-hand-side-arrays"><a class="anchor" href="#ansi-join-involving-right-hand-side-arrays"></a>ANSI JOIN Involving Right-Hand Side Arrays</h3>
<div class="paragraph">
<p>In this scenario, the join involves an array on the right-hand side keyspace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT *
FROM b1
JOIN b2
  ON b2.c21 = 10
  AND b2.c22 = 100
  AND ANY v IN b2.a21 SATISFIES v = b1.c12 END
WHERE b1.c11 = 10;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the ANY predicate involves a join, and thus, effectively we are joining <code>b1</code> with elements of the <code>b2.a21</code> array.
This now becomes a 1-to-many join.
Note that we use an ANY clause for this scenario since itâ€™s a natural extension of the existing support for array indexes; the only difference is for index span generation, we now can have a potential join expression.
Array indexes can be used for join in this scenario.</p>
</div>
</div>
<div class="sect2">
<h3 id="ansi-join-involving-left-hand-side-arrays"><a class="anchor" href="#ansi-join-involving-left-hand-side-arrays"></a>ANSI JOIN Involving Left-Hand Side Arrays</h3>
<div class="paragraph">
<p>This is a slightly more complex scenario, where the array reference is on the left-hand side of the join, and itâ€™s a many-to-1 join.
There are two alternative ways to handle the scenario where the array appears on the left-hand side of the join.</p>
</div>
<div class="sect3">
<h4 id="use-unnest"><a class="anchor" href="#use-unnest"></a>Use UNNEST</h4>
<div class="paragraph">
<p>This alternative will flatten the left-hand side array first, before performing the join:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT *
FROM b1 UNNEST b1.a12 AS ba1
JOIN b2
  ON ba1 = b2.c22
  AND b2.c21 = 10
WHERE b1.c11 = 10
  AND b1.c12 = 100;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="#unnest">UNNEST</a> operation is used to flatten the array, turning one left-hand side document into multiple documents; and then for each one of them, join with the right-hand side.
This way, by the time join is being performed, it is a regular join, since the array is already flattened in the UNNEST step.</p>
</div>
</div>
<div class="sect3">
<h4 id="use-in-clause"><a class="anchor" href="#use-in-clause"></a>Use IN clause</h4>
<div class="paragraph">
<p>This alternative uses the IN clause to handle the array:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT *
FROM b1
JOIN b2
  ON b2.c22 IN b1.a12 AND b2.c21 = 10
WHERE b1.c11 = 10 AND b1.c12 = 100;</code></pre>
</div>
</div>
<div class="paragraph">
<p>By using the <a href="indexing-arrays.html" class="xref page">IN</a> clause, the right-hand side field value can match any of the elements of the left-hand side array.
Conceptually, we are using each element of the left-hand side array to probe the right-hand side index.</p>
</div>
</div>
<div class="sect3">
<h4 id="differences-between-the-two-alternatives"><a class="anchor" href="#differences-between-the-two-alternatives"></a>Differences Between the Two Alternatives</h4>
<div class="paragraph">
<p>There is a semantical difference between the two alternatives.
With UNNEST, we are first turning one left-hand side document into multiple documents and then performing the join.
With IN-clause, there is still only one left-hand side document, which can then join with one or more right-hand side documents.
Thus:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the array contains duplicate values,</p>
<div class="ulist">
<ul>
<li>
<p>the UNNEST method treats each duplicate as an individual value and thus duplicated results will be returned;</p>
</li>
<li>
<p>the IN clause method will not duplicate the result.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If no duplicate values exists and we are performing inner join,</p>
<div class="ulist">
<ul>
<li>
<p>then the two alternatives will likely give the same result.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If outer join is performed, assuming there are N elements in the left-hand side array, and assuming there is at most one matching document from the right-hand side for each element of the array,</p>
<div class="ulist">
<ul>
<li>
<p>the UNNEST method will produce N result documents;</p>
</li>
<li>
<p>the IN clause method may produce &lt; N result documents if some of the array elements do not have matching right-hand side documents.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ansi-join-with-arrays-on-both-sides"><a class="anchor" href="#ansi-join-with-arrays-on-both-sides"></a>ANSI JOIN with Arrays on Both Sides</h3>
<div class="paragraph">
<p>If the join involves arrays on both sides, then we can combine the approaches above, i.e., using ANY clause to handle the right-hand side array and either UNNEST or IN clause to handle the left-hand side array.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT *
FROM b1
UNNEST b1.a12 AS ba1
  JOIN b2
    ON ANY v IN b2.a21 SATISFIES v = ba1 END
    AND b2.c21 = 10
    AND b2.c22 = 100
WHERE b1.c11 = 10
  AND b1.c12 = 100;</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT *
FROM b1
JOIN b2
  ON ANY v IN b2.a21 SATISFIES v IN b1.a12 END
  AND b2.c21 = 10
  AND b2.c22 = 100
WHERE b1.c11 = 10
  AND b1.c12 = 100;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lookup-join-clause"><a class="anchor" href="#lookup-join-clause"></a>Lookup JOIN Clause</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="purpose-3"><a class="anchor" href="#purpose-3"></a>Purpose</h3>
<div class="paragraph">
<p>A <em>lookup join</em> is a legacy syntax for joins.
It enables you to join a foreign key field on the left-hand side of the join with the primary <a href="../../learn/data/data.html#keys" class="xref page">document key</a> on the right-hand side of the join.
Couchbase Server version 4.1 and earlier supported only lookup joins.</p>
</div>
<div class="paragraph">
<p>In the join predicate for a lookup join, the <code>ON KEYS</code> expression must refer to the foreign key in the left-hand side keyspace.
This is then used to retrieve documents from the right-hand side keyspace.</p>
</div>
</div>
<div class="sect2">
<h3 id="syntax-3"><a class="anchor" href="#syntax-3"></a>Syntax</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/dql.ebnf#L200">lookup-join-clause ::= lookup-join-type? 'JOIN' lookup-join-rhs lookup-join-predicate</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/lookup-join-clause.png" alt="Syntax diagram">
</div>
</div>
<div class="hdlist compact">
<table>
<tr>
<td class="hdlist1">
lookup-join-type
</td>
<td class="hdlist2">
<p><a href="#lookup-join-type">Join Type</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
<tr>
<td class="hdlist1">
lookup-join-rhs
</td>
<td class="hdlist2">
<p><a href="#lookup-join-rhs">Join Right-Hand Side</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
<tr>
<td class="hdlist1">
lookup-join-predicate
</td>
<td class="hdlist2">
<p><a href="#lookup-join-predicate">Join Predicate</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="lookup-join-type"><a class="anchor" href="#lookup-join-type"></a>Join Type</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/dql.ebnf#L204">lookup-join-type ::= 'INNER' | ( 'LEFT' 'OUTER'? )</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/lookup-join-type.png" alt="Syntax diagram">
</div>
</div>
<div class="paragraph">
<p>This clause represents the type of join.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>INNER</code></dt>
<dd>
<p>For each joined object produced, both the left-hand and right-hand source objects must be non-<code>MISSING</code> and non-<code>NULL</code>.</p>
</dd>
<dt class="hdlist1"><code>LEFT [OUTER]</code></dt>
<dd>
<p>[Query Service interprets <code>LEFT</code> as <code>LEFT OUTER</code>]</p>
<div class="paragraph">
<p>For each joined object produced, only the left-hand source objects must be non-<code>MISSING</code> and non-<code>NULL</code>.</p>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>This clause is optional.
If omitted, the default is <code>INNER</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="lookup-join-rhs"><a class="anchor" href="#lookup-join-rhs"></a>Join Right-Hand Side</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/dql.ebnf#L208">lookup-join-rhs ::= keyspace-ref ( 'AS'? alias )?</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/lookup-join-rhs.png" alt="Syntax diagram">
</div>
</div>
<div class="hdlist compact">
<table>
<tr>
<td class="hdlist1">
keyspace-ref
</td>
<td class="hdlist2">
<p><a href="#lookup-keyspace-ref">Keyspace Reference</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
<tr>
<td class="hdlist1">
alias
</td>
<td class="hdlist2">
<p><a href="#lookup-as-alias">AS Alias</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="lookup-keyspace-ref"><a class="anchor" href="#lookup-keyspace-ref"></a>Keyspace Reference</h5>
<div class="paragraph">
<p>Keyspace reference for the right-hand side of the lookup join.
For details, see <a href="from.html#from-keyspace-ref" class="xref page">Keyspace Reference</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The right-hand side of a lookup join must be a keyspace.
Expressions, subqueries, or other join combinations cannot be on the right-hand side of a lookup join.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="lookup-as-alias"><a class="anchor" href="#lookup-as-alias"></a>AS Alias</h5>
<div class="paragraph">
<p>Assigns another name to the right-hand side of the lookup join.
For details, see <a href="from.html#section_ax5_2nx_1db" class="xref page">AS Clause</a>.</p>
</div>
<div class="paragraph">
<p>Assigning an alias to the keyspace reference is optional.
If you assign an alias to the keyspace reference, the <code>AS</code> keyword may be omitted.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="lookup-join-predicate"><a class="anchor" href="#lookup-join-predicate"></a>Join Predicate</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/dql.ebnf#L212">lookup-join-predicate ::= 'ON' 'PRIMARY'? 'KEYS' expr</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/lookup-join-predicate.png" alt="Syntax diagram">
</div>
</div>
<div class="paragraph">
<p>The <code>ON KEYS</code> expression produces a document key or array of document keys, which is used to retrieve documents from the right-hand side keyspace.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">expr</dt>
<dd>
<p>[Required] String or expression representing the foreign key in the left-hand side keyspace.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="return-values"><a class="anchor" href="#return-values"></a>Return Values</h3>
<div class="paragraph">
<p>If <code>LEFT</code> or <code>LEFT OUTER</code> is specified, then a left outer join is performed.</p>
</div>
<div class="paragraph">
<p>At least one joined object is produced for each left-hand source object.</p>
</div>
<div class="paragraph">
<p>If the right-hand source object is <code>NULL</code> or <code>MISSING</code>, then the joined object&#8217;s right-hand side value is also <code>NULL</code> or <code>MISSING</code> (omitted), respectively.</p>
</div>
</div>
<div class="sect2">
<h3 id="limitations-2"><a class="anchor" href="#limitations-2"></a>Limitations</h3>
<div class="paragraph">
<p>Lookup joins can be chained with other lookup joins or nests and index joins or nests, but they cannot be mixed with ANSI joins, ANSI nests, or comma-separated joins.</p>
</div>
</div>
<div class="sect2">
<h3 id="examples-4"><a class="anchor" href="#examples-4"></a>Examples</h3>
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/join.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div id="Lookup-JOIN-Example-1" class="exampleblock">
<div class="title">Example 12. Inner Lookup Join</div>
<div class="content">
<div class="paragraph">
<p>List all airlines and non-stop routes from SFO in the <code>route</code> keyspace.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/lookup-join-inner.n1ql">SELECT DISTINCT route.destinationairport, route.stops, route.airline,
  airline.name, airline.callsign
FROM route
  JOIN airline
  ON KEYS route.airlineid
WHERE route.sourceairport = "SFO"
AND route.stops = 0
LIMIT 4;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-JSON hljs" data-lang="JSON" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/lookup-join-inner.jsonc">[
  {
    "airline": "B6",
    "callsign": "JETBLUE",
    "destinationairport": "AUS",
    "name": "JetBlue Airways",
    "stops": 0
  },
  {
    "airline": "B6",
    "callsign": "JETBLUE",
    "destinationairport": "BOS",
    "name": "JetBlue Airways",
    "stops": 0
  },
  {
    "airline": "B6",
    "callsign": "JETBLUE",
    "destinationairport": "DXB",
    "name": "JetBlue Airways",
    "stops": 0
  },
  {
    "airline": "B6",
    "callsign": "JETBLUE",
    "destinationairport": "FLL",
    "name": "JetBlue Airways",
    "stops": 0
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div id="Lookup-JOIN-Example-2" class="exampleblock">
<div class="title">Example 13. Left Outer Lookup Join</div>
<div class="content">
<div class="paragraph">
<p>List routes from Atlanta to Seattle, including those for which there is no airline in the <code>airline</code> keyspace.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/lookup-join-left.n1ql">SELECT route.airline, route.sourceairport, route.destinationairport,
  airline.callsign
FROM route
  LEFT JOIN airline
  ON KEYS route.airlineid
WHERE route.destinationairport = "ATL"
  AND route.sourceairport = "SEA";</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-JSON hljs" data-lang="JSON" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/lookup-join-left.jsonc">[
  {
    "airline": "AF",
    "callsign": "AIRFRANS",
    "destinationairport": "ATL",
    "sourceairport": "SEA"
  },
  {
    "airline": "AM",
    "destinationairport": "ATL",
    "sourceairport": "SEA"
  },
  {
    "airline": "AS",
    "destinationairport": "ATL",
    "sourceairport": "SEA"
  },
  {
    "airline": "AZ",
    "destinationairport": "ATL",
    "sourceairport": "SEA"
  },
  {
    "airline": "DL",
    "callsign": "DELTA",
    "destinationairport": "ATL",
    "sourceairport": "SEA"
  },
  {
    "airline": "KL",
    "destinationairport": "ATL",
    "sourceairport": "SEA"
  }
]</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="index-join-clause"><a class="anchor" href="#index-join-clause"></a>Index JOIN Clause</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="purpose-4"><a class="anchor" href="#purpose-4"></a>Purpose</h3>
<div class="paragraph">
<p>An <em>index join</em> is another legacy syntax for joins which reverses the direction of a lookup join.
It enables you to join the primary <a href="../../learn/data/data.html#keys" class="xref page">document key</a> on the left-hand side of the join with a foreign key field on the right-hand side of the join.</p>
</div>
<div class="paragraph">
<p>You can use an index join when a lookup join would be inefficient, and you need to flip the relationship so the join predicate is on the right-hand side of the join.</p>
</div>
<div class="paragraph">
<p>For index joins, the syntax uses <code>ON KEY &#8230;&#8203; FOR</code> (singular) instead of <code>ON KEYS</code> (plural).
This is because an index join&#8217;s <code>ON KEY &#8230;&#8203; FOR</code> expression produces a single scalar value; whereas a lookup join&#8217;s <code>ON KEYS</code> expression can produce either a single scalar or an array of scalar values.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
An index join requires an inverse index on the foreign key in the keyspace on the right-hand side of the join.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="syntax-4"><a class="anchor" href="#syntax-4"></a>Syntax</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/dql.ebnf#L219">index-join-clause ::= index-join-type? 'JOIN' index-join-rhs index-join-predicate</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/index-join-clause.png" alt="Syntax diagram">
</div>
</div>
<div class="hdlist compact">
<table>
<tr>
<td class="hdlist1">
index-join-type
</td>
<td class="hdlist2">
<p><a href="#index-join-type">Join Type</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
<tr>
<td class="hdlist1">
index-join-rhs
</td>
<td class="hdlist2">
<p><a href="#index-join-rhs">Join Right-Hand Side</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
<tr>
<td class="hdlist1">
index-join-predicate
</td>
<td class="hdlist2">
<p><a href="#index-join-predicate">Join Predicate</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="index-join-type"><a class="anchor" href="#index-join-type"></a>Join Type</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/dql.ebnf#L223">index-join-type ::= 'INNER' | ( 'LEFT' 'OUTER'? )</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/index-join-type.png" alt="Syntax diagram">
</div>
</div>
<div class="paragraph">
<p>This clause represents the type of join.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>INNER</code></dt>
<dd>
<p>For each joined object produced, both the left-hand and right-hand source objects must be non-<code>MISSING</code> and non-<code>NULL</code>.</p>
</dd>
<dt class="hdlist1"><code>LEFT [OUTER]</code></dt>
<dd>
<p>[Query Service interprets <code>LEFT</code> as <code>LEFT OUTER</code>]</p>
<div class="paragraph">
<p>For each joined object produced, only the left-hand source objects must be non-<code>MISSING</code> and non-<code>NULL</code>.</p>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>This clause is optional.
If omitted, the default is <code>INNER</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="index-join-rhs"><a class="anchor" href="#index-join-rhs"></a>Join Right-Hand Side</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/dql.ebnf#L227">index-join-rhs ::= keyspace-ref ( 'AS'? alias )?</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/index-join-rhs.png" alt="Syntax diagram">
</div>
</div>
<div class="hdlist compact">
<table>
<tr>
<td class="hdlist1">
keyspace-ref
</td>
<td class="hdlist2">
<p><a href="#index-keyspace-ref">Keyspace Reference</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
<tr>
<td class="hdlist1">
alias
</td>
<td class="hdlist2">
<p><a href="#index-as-alias">AS Alias</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="index-keyspace-ref"><a class="anchor" href="#index-keyspace-ref"></a>Keyspace Reference</h5>
<div class="paragraph">
<p>Keyspace reference for right-hand side of an index join.
For details, see <a href="from.html#from-keyspace-ref" class="xref page">Keyspace Reference</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The right-hand side of an index join must be a keyspace.
Expressions, subqueries, or other join combinations cannot be on the right-hand side of an index join.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="index-as-alias"><a class="anchor" href="#index-as-alias"></a>AS Alias</h5>
<div class="paragraph">
<p>Assigns another name to the right-hand side of the index join.
For details, see <a href="from.html#section_ax5_2nx_1db" class="xref page">AS Clause</a>.</p>
</div>
<div class="paragraph">
<p>Assigning an alias to the keyspace reference is optional.
If you assign an alias to the keyspace reference, the <code>AS</code> keyword may be omitted.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="index-join-predicate"><a class="anchor" href="#index-join-predicate"></a>Join Predicate</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/dql.ebnf#L231">index-join-predicate ::= 'ON' 'PRIMARY'? 'KEY' expr 'FOR' alias</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/index-join-predicate.png" alt="Syntax diagram">
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>expr</code></dt>
<dd>
<p>Expression in the form <code><em>rhs-expression</em>.<em>lhs-expression-key</em></code>:</p>
<div class="dlist">
<dl>
<dt class="hdlist1"><code><em>rhs-expression</em></code></dt>
<dd>
<p>Keyspace reference for the right-hand side of the index join.</p>
</dd>
<dt class="hdlist1"><code><em>lhs-expression-key</em></code></dt>
<dd>
<p>String or expression representing the attribute in <code><em>rhs-expression</em></code> and referencing the document key for <code>alias</code>.</p>
</dd>
</dl>
</div>
</dd>
<dt class="hdlist1"><code>alias</code></dt>
<dd>
<p>Keyspace reference for the left-hand side of the index join.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="limitations-3"><a class="anchor" href="#limitations-3"></a>Limitations</h3>
<div class="paragraph">
<p>Index joins can be chained with other index joins or nests and lookup joins or nests, but they cannot be mixed with ANSI joins, ANSI nests, or comma-separated joins.</p>
</div>
</div>
<div class="sect2">
<h3 id="examples-5"><a class="anchor" href="#examples-5"></a>Examples</h3>
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/join.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div id="Index-JOIN-Example-0" class="exampleblock">
<div class="title">Example 14. Use INDEX join to flip the direction of <a href="#Lookup-JOIN-Example-1">Example 12</a> above</div>
<div class="content">
<div class="paragraph">
<p>Consider the query below, similar to <a href="#Lookup-JOIN-Example-1">Example 12</a> above with route and airline documents, where <code>route.airlineid</code> is the document key of route documents and airline documents have no reference to route documents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/index-join.n1ql#L2-L8">SELECT DISTINCT route.destinationairport, route.stops, route.airline,
  airline.name, airline.callsign
FROM route
  JOIN airline
  ON KEYS route.airlineid
WHERE airline.icao = "SWA"
LIMIT 4;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This query gets a list of Southwest Airlines (<code>SWA</code>) flights, but getting <code>SWA</code> flights cannot be efficiently executed without making a Cartesian product of all route documents (left-hand side) with all airline documents (right-hand side).</p>
</div>
<div class="paragraph">
<p>This query cannot use any index on airline to directly access SWA flights because airline is on the right-hand side.</p>
</div>
<div class="paragraph">
<p>Also, you cannot rewrite the query to put the airline document on the left-hand side (to use any index) and the route document on the right-hand side because the airline documents (on the left-hand side) have no primary keys to access the route documents (on the right-hand side).</p>
</div>
<div class="paragraph">
<p>Using index joins, the same query can be written as:</p>
</div>
<div class="listingblock">
<div class="title">Required Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/index-join.n1ql#L12">CREATE INDEX route_airlineid ON route(airlineid);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Optional Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/index-join.n1ql#L16">CREATE INDEX airline_icao ON airline(icao);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/index-join.n1ql#L20-L23">SELECT * FROM airline
  JOIN route
  ON KEY route.airlineid FOR airline
WHERE airline.icao = "SWA";</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-JSON hljs" data-lang="JSON" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/select/index-join.jsonc">[
  {
    "name": "JetBlue Airways",
    "schedule": [
      {
        "day": 0,
        "flight": "B6076",
        "utc": "10:15:00"
      },
      {
        "day": 0,
        "flight": "B6321",
        "utc": "00:06:00"
      },
// ...
    ]
  }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you generalize the same query, it looks like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE INDEX <em>on-key-for-index-name</em> <em>rhs-expression</em> (<em>lhs-expression-key</em>);</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT <em>projection-list</em>
FROM <em>lhs-expression</em>
JOIN <em>rhs-expression</em>
  ON KEY <em>rhs-expression</em>.<em>lhs-expression-key</em> FOR <em>lhs-expression</em>
[ WHERE <em>predicates</em> ] ;</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>There are three important changes in the index scan syntax example above:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CREATE INDEX</code> on the <code>ON KEY</code> expression <code>route.airlineid</code> to access <code>route</code> documents using <code>airlineid</code>, which are produced on the left-hand side.</p>
</li>
<li>
<p>The <code>ON KEY route.airlineid FOR airline</code> enables SQL++ to use the index <code>route.airlineid</code>.</p>
</li>
<li>
<p>Create any optional index such as <code>route.airline</code> that can be used on airline (left-hand side).</p>
</li>
</ul>
</div>
<div id="Index-JOIN-Example-1" class="exampleblock">
<div class="title">Example 15. <code>ON KEY ... FOR</code></div>
<div class="content">
<div class="paragraph">
<p>The following example counts the number of distinct "AA" airline routes for each airport after creating the following index, if not already created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX route_airlineid ON route(airlineid);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT COUNT(DISTINCT route.sourceairport) AS DistinctAirports
FROM airline
  JOIN route
  ON KEY route.airlineid FOR airline
WHERE airline.iata = "AA";</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-JSON hljs" data-lang="JSON">[
  {
    "DistinctAirports": 429
  }
]</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix-summary-of-join-types"><a class="anchor" href="#appendix-summary-of-join-types"></a>Appendix: Summary of JOIN Types</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/join.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div class="sect2">
<h3 id="ansi"><a class="anchor" href="#ansi"></a>ANSI</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><strong>Left-Hand Side (lhs)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any field or expression that produces a value that will be matched on the right-hand side.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><strong>Right-Hand Side (rhs)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Anything that can have a proper index on the join expression.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><strong>Syntax</strong></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre><em>lhs-expr</em>
JOIN <em>rhs-keyspace</em>
ON <em>any join condition</em></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><strong>Example</strong></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT *
FROM route r
JOIN airline a
ON r.airlineid = META(a).id</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Refer also to <a href="comma.html" class="xref page">Comma-Separated Join</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="lookup"><a class="anchor" href="#lookup"></a>Lookup</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><strong>Left-Hand Side (lhs)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Must produce a Document Key for the right-hand side.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><strong>Right-Hand Side (rhs)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Must have a Document Key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><strong>Syntax</strong></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre><em>lhs-expr</em>
JOIN <em>rhs-keyspace</em>
ON KEYS <em>lhs-expr.foreign-key</em></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><strong>Example</strong></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT *
FROM route r
JOIN airline
ON KEYS r.airlineid</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="index"><a class="anchor" href="#index"></a>Index</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><strong>Left-Hand Side (lhs)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Must produce a key for the right-hand side index.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><strong>Right-Hand Side (rhs)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Must have a proper index on the field or expression that maps to the Document Key of the left-hand side.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><strong>Syntax</strong></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre><em>lhs-keyspace</em>
JOIN <em>rhs-keyspace</em>
ON KEY <em>rhs-kspace.idx_key</em>
FOR <em>lhs-keyspace</em></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><strong>Example</strong></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT *
FROM airline a
JOIN route r
ON KEY r.airlineid
FOR a</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>Â© 2023 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Server","components":["server"],"url":"/home/server.html","latestVersions":{"server":"7.2"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../../../_/js/site.js"></script>
<script defer src="../../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
</body>
</html>
