<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<script>(window.dataLayer=window.dataLayer||[]).push({event:'gtm.js','gtm.start':+new Date()})</script>
<script async src="https://www.googletagmanager.com/gtm.js?id=GTM-MVPNN2"></script>
<title>Subqueries | Couchbase Docs</title>
<link rel="stylesheet" href="../../../../_/css/site.css">
<script src="../../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="In SQL++, a subquery is a SELECT query that is a constituent part of another SQL++ query or subquery.">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="server">
<meta name="dcterms.identifier" content="7.2">
<meta name="page-url" content="/server/current/n1ql/n1ql-language-reference/subqueries.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://docs.couchbase.com/home/index.html">
                    <img src="../../../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://docs.couchbase.com/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../cloud/index.html">
                      Capella
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/pages/n1ql-language-reference/subqueries.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../../introduction/intro.html">Couchbase Server</a></li>
<li class="crumb"><a href="../query.html">Query</a></li>
<li class="crumb"><a href="index.html">SQL++ Language Reference</a></li>
<li class="crumb"><a href="subqueries.html">Subqueries</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Subqueries</h1>
<div class="labels">
<ul><li class="reference"><span><i class="fas fa-book"></i></i> reference</span></li>
</ul>
</div>


</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
In SQL++, a subquery is a SELECT query that is a constituent part of another SQL++ query or subquery.
</blockquote>
</div>
<div class="paragraph">
<p>Using subqueries, you can create multiple levels of nesting of queries.
The outer levels of queries are called outer or parent queries, and inner level subqueries are called inner or child queries, or simply subqueries.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Examples on this Page</div>
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/subqueries.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="syntax"><a class="anchor" href="#syntax"></a>Syntax</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/n1ql.ebnf#L317">subquery-expr ::= '(' select ')'</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/subquery-expr.png" alt="Syntax diagram">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>A subquery in SQL++ is limited to a <a href="select-syntax.html" class="xref page">SELECT</a> query, whereas the outermost parent query can be any DML statement such as SELECT, INSERT, UPDATE, DELETE or MERGE.</p>
</li>
<li>
<p>Subquery <strong>must</strong> be enclosed in parenthesis.</p>
</li>
<li>
<p>When subquery is used in <code>FROM</code> clause, it must be aliased.</p>
</li>
<li>
<p>Subqueries are SQL++ expressions and SQL++ evaluates them like any other SQL++ <a href="index.html#N1QL_Expressions" class="xref page">language expressions</a>.
When an expression is contained in a SQL++ statement, the expression is evaluated once for every input document to the statement, and same applies to a subquery-expression&#8201;&#8212;&#8201;the inner SELECT or subquery is executed once for every input document considered in the outer query.</p>
</li>
<li>
<p>A subquery expression returns an array every time it is evaluated, and the array contains the results of the inner SELECT subquery.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="subqueries-in-dml-statement-clauses"><a class="anchor" href="#subqueries-in-dml-statement-clauses"></a>Subqueries in DML Statement Clauses</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A subquery can occur as part of various clauses of the parent query where generic SQL++ expressions can be used.
For instance, a SELECT statement can have a subquery in the projection list, WHERE clause, FROM clause, LET clause, and GROUP BY clause.
Similarly, an UPDATE, INSERT, DELETE can have a subquery in the WHERE clause.
For example, consider the following query which finds all the cities with landmarks that have airports.</p>
</div>
<div id="Q1" class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">Q1</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/subquery-1.n1ql">SELECT t1.city FROM landmark t1
WHERE t1.city IN (SELECT RAW city FROM airport);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "city": "Abbeville"
  },
  {
    "city": "Avignon"
  }..
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In the above example, the subquery is used as a part of WHERE condition of the parent query and it returns an array of cities that have airports.</p>
</div>
<div class="paragraph">
<p>Note that the IN or WITHIN predicate needs an array on right-side expression as the subquery evaluates to.
Further, the usage of keyword <code>RAW</code> in the subquery projection ensures just the <code>city</code> attribute values in the result without JSON wrapping.
The outer query browses through each of the landmark cities and returns the city name if it is in the array of cities returned by the inner subquery.</p>
</div>
<div class="paragraph">
<p>When subquery is used in the FROM clause, that must be aliased, to be able to access and refer to the results documents of the subquery.
In the following example <a href="#Q2">Q2</a>, the subquery is named as <code>t1</code>, and it returns the aggregated value of airport names by city and country.
The outer query further processes the result of the subquery to find total number of airports by country where each city has more than 5 airports.</p>
</div>
<div id="Q2" class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">Q2</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT t1.country, array_agg(t1.city), sum(t1.city_cnt) as apnum
FROM (SELECT city, city_cnt, array_agg(airportname) as apnames, country
      FROM airport
      GROUP BY city, country LETTING city_cnt = count(city) ) AS t1
WHERE t1.city_cnt &gt; 5
GROUP BY t1.country;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "$1": [
      "Paris"
    ],
    "apnum": 9,
    "country": "France"
  },
  {
    "$1": [
      "London"
    ],
    "apnum": 13,
    "country": "United Kingdom"
  },
  {
    "$1": [
      "Houston",
      "New York",
      "San Diego"
    ],
    "apnum": 22,
    "country": "United States"
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>For more examples, see the <a href="#section_cjh_pck_mz">Examples</a> section.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="subquery-n1ql-exp"><a class="anchor" href="#subquery-n1ql-exp"></a>Subqueries in SQL++ Expressions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Subqueries can appear as independent SELECT queries or can be combined as a constituent part of other SQL++ language expressions.</p>
</div>
<div class="paragraph">
<p>For example, in the above queries <a href="#Q1">Q1</a> and <a href="#Q2">Q2</a>, the subquery is a full independent SELECT query.
In the following example <a href="#Q3">Q3</a>, the subquery is part of a SQL++ expression.</p>
</div>
<div id="Q3" class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">Q3</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT array_max((SELECT  count(city) as cnt
                  FROM airport
                  GROUP BY city)[*].cnt);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "$1": 14
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In this example, the subquery is wrapped in a parenthesis ( ) and it occurs as part of the expression <code>[*].cnt</code> which treats the result of the subquery as an array of JSON documents (with one attribute <code>cnt</code>) and extracts the <code>cnt</code> values from all the subquery result array elements.
Finally, the <code>array_max()</code> function is applied to this to get the maximum number of airports in any of the cities.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="section_onz_3tj_mz"><a class="anchor" href="#section_onz_3tj_mz"></a>Variables in Scope of a Subquery</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The scope of subquery is defined as the set of names, identifiers, and variables that are accessible to the subquery.
Variables include all keyspace names, aliases, LET or LETTING variables that can be referenced by the subquery.
For a multilevel nested subquery, the scope includes scope of the subquery and all the scopes of its parent queries.</p>
</div>
<div class="paragraph">
<p>A subquery cannot access variables from its sibling subqueries or its parents’ sibling subqueries.
For example, in the following nested query structure, the subquery SQ13 can only access the variables from SQ13, SQ1, and Q0, but not from SQ12, or SQ2.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Q0: SELECT ...
      (SELECT ..
	     (SELECT ...) AS SQ12
	     (SELECT ...) AS SQ13   ) AS SQ1
      (SELECT ...
	     (SELECT ...) AS SQ21
	     (SELECT ...) AS SQ22   ) AS SQ2</pre>
</div>
</div>
<div class="paragraph">
<p>Note that the keyspace name identifiers themselves are NOT variables, whereas any aliases of the keyspace name identifiers are variables in the scope.
For example, in the above query <a href="#Q1">Q1</a>, the keyspace identifier <code>landmark</code> in the outer query is not considered a variable for the subquery.
In fact, that is the reason the subquery can also use the same keyspace name independently and still be a non-correlated subquery.
However, the alias <code>t1</code> defined in the outer query is considered a variable in scope for the subquery.</p>
</div>
<div class="paragraph">
<p>The following example <a href="#Q4">Q4</a> is a correlated subquery that uses the variable <code>t1</code> from the outer query:</p>
</div>
<div id="Q4" class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">Q4: Find the landmarks that are named with corresponding city name</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT t1.city, t1.name
FROM landmark t1
WHERE t1.city IN SPLIT((SELECT RAW t2.name
                        FROM t1 AS t2)[0]);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "city": "Aberdour",
    "name": "Aberdour Castle"
  },
  {
    "city": "Aberdour",
    "name": "Aberdour Railway Station"
  },
  {
    "city": "Aberdulais",
    "name": "Aberdulais Falls and Tin Works"
  }
  // ...
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This above example <a href="#Q4">Q4</a> uses the alias <code>t1</code> from outer query in the FROM clause of subquery.
The subquery aliases <code>t1</code> to <code>t2</code> to avoid conflict in same variable name <code>t1</code> being present in both outer and inner queries scope.
The reference to <code>t2</code> in the subquery is actually referring to the same document from <code>landmark</code> that is being processed as <code>t1</code> in the outer query.
In other words, the same query can be simply rewritten (without using subqueries) as follows:</p>
</div>
<div id="Q4A" class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">Q4A</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT t1.city, t1.name
FROM landmark t1
WHERE t1.city IN SPLIT(t1.name);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "city": "Aberdour",
    "name": "Aberdour Castle"
  },
  {
    "city": "Aberdour",
    "name": "Aberdour Railway Station"
  },
  {
    "city": "Aberdulais",
    "name": "Aberdulais Falls and Tin Works"
  }
  // ...
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Typically, subqueries may refer to any variables and aliases available in the scope to build correlated subqueries and to perform subqueries specific to some context of outer query.
See <a href="correlated-subqueries.html" class="xref page">Correlated Subqueries</a> for more details and <a href="subquery-examples.html" class="xref page">Examples</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="from-clause"><a class="anchor" href="#from-clause"></a>FROM clause in Subqueries</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="keyspace-identifier-versus-expression"><a class="anchor" href="#keyspace-identifier-versus-expression"></a>Keyspace Identifier versus Expression</h3>
<div class="paragraph">
<p>As described in the <a href="from.html" class="xref page">FROM clause</a>, the from-term can be a keyspace name or identifier or a SQL++ expression:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Keyspace identifiers are independent sources of data for a query.</p>
</li>
<li>
<p>SQL++ <a href="index.html#N1QL_Expressions" class="xref page">expressions</a> can be constructed using various SQL++ language constructs including subqueries.</p>
<div class="ulist">
<ul>
<li>
<p>Constant expressions are independent sources of data for a query.</p>
</li>
<li>
<p>Variable expressions depend on variables in scope and are evaluated to resolve as input data for the query.
These are applicable to subqueries.</p>
</li>
<li>
<p>This applies irrespective of whether it is a simple identifier such as <code>alias</code>, <code>var</code> or a nested path identifier such as <code>keyspace.subdoc1.subdoc2.field</code>, <code>alias.subdoc.field</code>, or <code>var.subdoc.field</code>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>An expression can be a simple identifier or variable such as <code>alias</code>, <code>var</code> or more complex with various SQL++ language constructs.
Either way, SQL++ evaluates <code>from-term</code> to resolve to keyspace identifiers or expressions as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>from-term</code> is considered as an expression if it is not a keyspace name identifier.</p>
</li>
<li>
<p>If simple identifier can be considered as identifier or expression depending on various factors.
An identifier <code>var</code> is considered as an expression if it is variable in scope defined through LET or LETTING, or explicit keyspace alias in parent queries.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the following equivalent queries, explicit alias <code>t</code> of <code>airport</code> or LET variable <code>x</code> is treated as an expression and hence a nested path like <code>t.geo.lat</code> is allowed in the subquery FROM clause.</p>
</div>
<div id="Q5A" class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">Q5A</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT count(*) FROM airport t
WHERE (SELECT RAW t.geo.alt FROM t t1)[0] &gt; 6000 ;</code></pre>
</div>
</div>
</div>
</div>
<div id="Q5B" class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">Q5B</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT count(*) FROM airport t
WHERE (SELECT RAW alt FROM t.geo.alt)[0] &gt; 6000;</code></pre>
</div>
</div>
</div>
</div>
<div id="Q5C" class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">Q5C</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT count(*) FROM `travel-sample` .inventory.airport t
LET x = t.geo
WHERE (SELECT RAW y.alt FROM x y)[0] &gt; 6000;</code></pre>
</div>
</div>
</div>
</div>
<div id="Q5D" class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">Q5D</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT count(*) FROM airport t
WHERE (SELECT RAW geo.alt FROM t.geo)[0] &gt; 6000;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="implicit-alias"><a class="anchor" href="#implicit-alias"></a>Implicit Alias</h3>
<div class="paragraph">
<p>When explicit alias is not defined, every identifier will have an implicit alias predefined with the same name as the identifier.
Implicit alias of a nested path is defined as the last component in the path.
In above example  <a href="#Q5D">Q5D</a>, the implicit alias of the nested path <code>t.geo</code> in subquery is <code>geo</code>, and in example <a href="#Q5B">Q5B</a> the implicit alias of <code>t.geo.alt</code> is <code>alt</code>.</p>
</div>
<div class="paragraph">
<p>For example, the following example <a href="#Q6">Q6</a> has no explicit alias for <code>travel-sample</code>.
So the <code>airport</code> used in the subquery FROM clause is considered a keyspace identifier, but not an expression.
That makes the subquery non-correlated by the FROM clause, and the subquery returns all documents from keyspace <code>airport</code>.</p>
</div>
<div id="Q6" class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">Q6</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT array_length((SELECT RAW t1.geo.alt
                     FROM airport t1))
FROM airport LIMIT 4;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "$1": 1968
  },
  // ...
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Contrast Q6 with Q6A below, the subquery is correlated by using the keyspace alias in the FROM clause.
The result is only <code>1</code> because the subquery is applicable to only the current document <code>t</code> being processed in the parent query.</p>
</div>
<div id="Q6A" class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">Q6A</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT array_length((SELECT RAW t1.geo.alt FROM t t1))
FROM airport t;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "$1": 1
  },
  // ...
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Further, the subquery is required to alias its <code>from-term</code> to avoid conflict with the same identifier in both outer and inner queries.
For example, the following example Q6B shows an error:</p>
</div>
<div id="Q6B" class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">Q6B</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT array_length((SELECT RAW t1.geo.alt
                     FROM airport))
FROM airport;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "code": 4020,
    "msg": "Duplicate subquery alias airport",
    "query": "SELECT array_length((SELECT RAW t1.geo.alt\nFROM airport))\nFROM airport;"
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>An implicit keyspace alias is not considered as an expression, as in the above example Q6.
However, the nested paths are expressions.
In the following example Q6C, the FROM term has the nested path <code>airport.geo</code> as an expression, where <code>airport</code> refers to the implicit alias of the keyspace in the parent query.
Hence this is a correlated subquery, and the result is <code>1</code> corresponds to the current document in the parent query.</p>
</div>
<div id="Q6C" class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">Q6C</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT array_length((SELECT RAW t1.alt
                     FROM airport.geo t1))
FROM airport
LIMIT 1;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "$1": 1
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If the expression does not resolve to any of the variables in scope for the subquery, then that is treated as keyspace identifier and subsequently if the keyspace is not found, an error is raised.
For example, in the following query <code>hotel</code> is not defined in the scope and is treated as a new keyspace identifier.</p>
</div>
<div id="Q7" class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">Q7</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT * FROM landmark t1
WHERE t1.city IN (SELECT RAW city
                  FROM hotel
                  LIMIT 3
                  );</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "t1": {
      "activity": "see",
      "address": "Prince Arthur Road, ME4 4UG",
      "alt": null,
      "city": "Gillingham",
      "content": "Adult - £6.99 for an Adult ticket that allows you to come back for further visits within a year (children's and concessionary tickets also available). Museum on military engineering and the history of the British Empire. A quite extensive collection that takes about half a day to see. Of most interest to fans of British and military history or civil engineering. The outside collection of tank mounted bridges etc can be seen for free. There is also an extensive series of themed special event weekends, admission to which is included in the cost of the annual ticket.",
      "country": "United Kingdom",
      "directions": null,
      "email": null,
      "geo": {
        "accuracy": "RANGE_INTERPOLATED",
        "lat": 51.39184,
        "lon": 0.53616
      },
      "hours": "Tues - Fri 9.00am to 5.00pm, Sat - Sun 11.30am - 5.00pm",
      "id": 10019,
      "image": null,
      "name": "Royal Engineers Museum",
      "phone": "+44 1634 822839",
      "price": null,
      "state": null,
      "title": "Gillingham (Kent)",
      "tollfree": null,
      "type": "landmark",
      "url": "http://www.remuseum.org.uk"
    }
  }
  // ...
]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="nested-path-expr"><a class="anchor" href="#nested-path-expr"></a>Nested Path Expressions in Subqueries</h3>
<div class="paragraph">
<p>As mentioned in the <a href="from.html" class="xref page">FROM clause</a>, the <code>from-term</code> of both parent and subqueries allow nested path expressions over constants and subqueries.
However, only subqueries allow variable expressions (including paths), that are referenced through any <a href="#section_onz_3tj_mz">variables defined in scope</a> of the subquery.
This is very powerful for language expressibility, simplicity and flexibility to SQL++ queries.
Especially, when combined with subqueries, nested path expressions over variables extend full power of SQL++ syntax to array attributes/sub-documents without losing the structure of the array elements in results, or requiring tricky processing (with UNNEST, GROUP BY, ORDER BY and so).
See the <a href="#section_cjh_pck_mz">examples</a> below.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The usage of nested paths over keyspace identifiers is NOT allowed in the from-terms, and it results in a syntax error.
Nested paths are always considered expressions in SQL++.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="section_cjh_pck_mz"><a class="anchor" href="#section_cjh_pck_mz"></a>Examples</h2>
<div class="sectionbody">
<div class="exampleblock">
<div class="title">Example 1. </div>
<div class="content">
<div class="paragraph">
<p>The following query is valid because the nested path in the subquery is based on the explicit alias variable <code>k1</code> in scope.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT * FROM keyspace1 AS  k1
WHERE (SELECT … FROM k1.subdoc1.subdoc2.field3 …);</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 2. </div>
<div class="content">
<div class="paragraph">
<p>The following query is invalid and raises an error because the nested path is in the outermost query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT * FROM keyspace1.subdoc1.subdoc2.field3 … ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The subquery is based on the keyspace identifiers.
Note that, the outer query has explicit alias defined, and hence the keyspace1/keyspace2 in subquery <code>from-term</code> are treated as identifiers.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT * FROM keyspace1 AS  k1
WHERE (SELECT … FROM keyspace1.subdoc1.field3 …);

SELECT * FROM keyspace1 AS  k1
WHERE (SELECT … FROM keyspace2.subdoc2 …);</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 3. </div>
<div class="content">
<div class="paragraph">
<p>The following example shows usage of nested path over subquery expression.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT x.alt
FROM (SELECT geo from airport
      )[*].geo AS x
LIMIT 2;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "alt": 12
  },
  {
    "alt": 295
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 4. </div>
<div class="content">
<div class="paragraph">
<p>The following example shows usage of nested path over constant expression.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT x
FROM [{"a" : 1, "b" : {"c" : 2}},
      {"a" : 3, "b" : {"d" : 4}}][*].b AS x
LIMIT 2;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "x": {
      "c": 2
    }
  },
  {
    "x": {
      "d": 4
    }
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 5. </div>
<div class="content">
<div class="paragraph">
<p>The following two queries show valid and invalid examples with the <code>airport</code> collection.
Note the nested paths used in the FROM clause of the subquery.</p>
</div>
<div id="Q8" class="listingblock">
<div class="title">Q8: Find airports that are at altitudes more than 4000ft</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-n1ql hljs" data-lang="n1ql">SELECT t1.city, t1.geo.alt
FROM airport t1
WHERE (SELECT RAW t2.alt
      FROM airport.geo t2)[0] &gt; 4000;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "code": 3000,
    "msg": "Ambiguous reference to field travel-sample.",
    "query_from_user": "SELECT t1.city, t1.geo.alt\nFROM `travel-sample` t1\nWHERE t1.type = \"airport\" AND \n(SELECT RAW t2.alt \n FROM `travel-sample`.geo t2)[0] &gt; 4000;"
  }
]</code></pre>
</div>
</div>
<div id="Q8A" class="listingblock">
<div class="title">Q8A: Q8 rewritten to use nested path using outer query variable t1</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-n1ql hljs" data-lang="n1ql">SELECT t1.city, t1.geo.alt
FROM airport t1
WHERE (SELECT RAW t2.alt FROM t1.geo t2)[0] &gt; 4000;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "alt": 6537,
    "city": "Grants"
  },
  {
    "alt": 5045,
    "city": "Prescott"
  },
  // ...
]</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 6. </div>
<div class="content">
<div class="paragraph">
<p>The following query demonstrates the power of using nested path expressions in <a href="correlated-subqueries.html" class="xref page">correlated subqueries</a> over the array subdocument <code>hotel.reviews</code>.
The query Q9 finds the top 10 hotels and number of reviewers which have Overall rating at least 4 and rated by minimum 6 people.</p>
</div>
<div id="Q9" class="listingblock">
<div class="title">Q9</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-n1ql hljs" data-lang="n1ql">SELECT name, cnt_reviewers
FROM hotel AS t
LET cnt_reviewers = (SELECT raw count(*)
                     FROM t.reviews AS s
                     WHERE s.ratings.Overall &gt;= 4)[0]
WHERE cnt_reviewers &gt;= 6
ORDER BY cnt_reviewers DESC
LIMIT 10;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "cnt_reviewers": 9,
    "name": "Holiday Inn London Kensington Forum"
  },
  {
    "cnt_reviewers": 9,
    "name": "Campanile"
  },
  {
    "cnt_reviewers": 9,
    "name": "Drop in Chalets"
  },
  {
    "cnt_reviewers": 9,
    "name": "Cadogan Hotel"
  },
  {
    "cnt_reviewers": 9,
    "name": "Negresco"
  },
  {
    "cnt_reviewers": 9,
    "name": "Suites at Fisherman's Wharf"
  },
  {
    "cnt_reviewers": 9,
    "name": "Wyndham Parc 55 Hotel"
  },
  {
    "cnt_reviewers": 8,
    "name": "Lochmaddy Hotel"
  },
  {
    "cnt_reviewers": 8,
    "name": "Kensington West"
  },
  {
    "cnt_reviewers": 8,
    "name": "Ibis Hotel Stratford"
  }
]</code></pre>
</div>
</div>
<div id="Q9A" class="listingblock">
<div class="title">Q9A</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-n1ql hljs" data-lang="n1ql">SELECT name, cnt_reviewers
FROM  hotel AS t
LET cnt_reviewers = (SELECT raw count(*)
                     FROM hotel tmp
                     USE KEYS meta(t).id
                     UNNEST tmp.reviews s
                     WHERE s.ratings.Overall &gt;= 4)[0]
WHERE cnt_reviewers &gt;= 6
ORDER BY cnt_reviewers DESC
LIMIT 10;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above query Q9A is an equivalent of query <a href="#Q9">Q9</a> that does not use nested paths in the subquery FROM clause.
Therefore, it requires a USE KEYS clause on the same document as in the outer query, that is <code>meta(t).id</code> where <code>t</code> refers to the outer query document.
Nested paths cannot be used in the FROM clause and hence UNNEST is used on nested structures.</p>
</div>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2023 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Server","components":["server"],"url":"/home/server.html","latestVersions":{"server":"7.2"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../../../_/js/site.js"></script>
<script defer src="../../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
</body>
</html>
