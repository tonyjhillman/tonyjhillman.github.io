<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<script>(window.dataLayer=window.dataLayer||[]).push({event:'gtm.js','gtm.start':+new Date()})</script>
<script async src="https://www.googletagmanager.com/gtm.js?id=GTM-MVPNN2"></script>
<title>Replicate Using Scopes and Collections | Couchbase Docs</title>
<link rel="stylesheet" href="../../../../_/css/site.css">
<script src="../../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="XDCR can be performed with reference to scopes and collections within source and target buckets.">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="server">
<meta name="dcterms.identifier" content="7.2">
<meta name="page-url" content="/server/current/manage/manage-xdcr/replicate-using-scopes-and-collections.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://docs.couchbase.com/home/index.html">
                    <img src="../../../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://docs.couchbase.com/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../cloud/index.html">
                      Capella
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/manage/pages/manage-xdcr/replicate-using-scopes-and-collections.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../../introduction/intro.html">Couchbase Server</a></li>
<li class="crumb">Manage</li>
<li class="crumb"><a href="xdcr-management-overview.html">Manage XDCR</a></li>
<li class="crumb"><a href="replicate-using-scopes-and-collections.html">Replicate Using Scopes and Collections</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Replicate Using Scopes and Collections</h1>
<div class="labels">
<ul></ul>
</div>


</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
XDCR can be performed with reference to scopes and collections within source and target buckets.
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="understanding-scopes-collections-and-replication"><a class="anchor" href="#understanding-scopes-collections-and-replication"></a>Understanding Scopes, Collections, and Replication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As described in <a href="../../learn/data/scopes-and-collections.html" class="xref page">Scopes and Collections</a>, scopes and collections are containers for data within a bucket.
A cluster can contain up to 1000 scopes; and it can contain 1000 collections.</p>
</div>
<div class="paragraph">
<p>As well as specifying a source bucket and a target bucket, XDCR can specify scopes and collections within those buckets.
This allows data to be replicated from one collection to another.
For an overview, see <a href="../../learn/clusters-and-availability/xdcr-overview.html#xdcr-using-scopes-and-collections" class="xref page">XDCR Using Scopes and Collections</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="applying-filters"><a class="anchor" href="#applying-filters"></a>Applying Filters</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Data replicated between collections can be <em>filtered</em>.
An overview is provided in <a href="../../learn/clusters-and-availability/xdcr-filtering.html" class="xref page">XDCR Advanced Filtering</a>; and examples of filtering are provided in <a href="filter-xdcr-replication.html" class="xref page">Filter a Replication</a>.</p>
</div>
<div class="paragraph">
<p>Note in particular that settings for <em>deletion filters</em> must be appropriately determined before replication or migration is performed: failure to establish the correct settings for deletion filters may, in certain circumstances, lead to data loss.
For information, see <a href="../../learn/clusters-and-availability/xdcr-filtering.html#using-deletion-filters" class="xref page">Using Deletion Filters</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="examples-on-this-page"><a class="anchor" href="#examples-on-this-page"></a>Examples on this Page</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first set of examples provided on this page &#8212; <a href="#replicate-data-between-collections-implicitly-with-the-ui">Replicate Data Between Collections Implicitly, with the UI</a>, <a href="#replicate-data-between-collections-explicitly-with-the-ui">Replicate Data Between Collections Explicitly, with the UI</a> and <a href="#migrate-data-to-a-collection-with-the-ui">Migrate Data to a Collection, with the UI</a>
&#8212; demonstrate how XDCR can be performed with reference to scopes and collections within source and target buckets, using Couchbase Web Console.
The examples assume the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A single-node cluster named <code>10.144.210.101</code> has been created, and features the <code>travel-sample</code> and <code>beer-sample</code> buckets.
See <a href="../manage-settings/install-sample-buckets.html" class="xref page">Install Sample Buckets</a>, for information on installing these buckets.
Note that the <code>travel-sample</code> bucket contains multiple scopes and collections, from which replications to the target cluster can be immediately established.
The <code>beer-sample</code> contains only the <code><em>default</code> scope and collection, within which all data is contained: the _migration</em> process will be used to separate data into scopes and collections on the target cluster.</p>
</li>
<li>
<p>A single-node cluster named <code>10.144.210.102</code> has been created, and features no buckets.
Note that during the course of the examples on this page, buckets, scopes, and collections will need to be created on the <code>10.144.210.102</code> cluster: therefore, knowledge of how to create buckets, scopes, and collections must first be attained.
For comprehensive instructions, see <a href="../manage-buckets/create-bucket.html" class="xref page">Create a Bucket</a> and <a href="../manage-scopes-and-collections/manage-scopes-and-collections.html" class="xref page">Manage Scopes and Collections</a>.</p>
</li>
<li>
<p>The cluster <code>10.144.210.101</code> has defined <code>10.144.210.102</code> as a remote cluster for XDCR: this will permit replications to be established between the two clusters.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before following the examples, familiarity should be gained with all XDCR management-basics explained on other pages. In particular, see <a href="prepare-for-xdcr.html" class="xref page">Prepare for XDCR</a>, <a href="create-xdcr-reference.html" class="xref page">Create a Reference</a>, and <a href="create-xdcr-replication.html" class="xref page">Create a Replication</a>.</p>
</div>
<div class="paragraph">
<p>The subsequent examples provided on this page &#8212; in <a href="#manage:manage-xdcr/replicate-using-scopes-andcollections.adoc#cli-procedures" class="xref unresolved">CLI Procedures</a> and <a href="#manage:manage-xdcr/replicate-using-scopes-andcollections.adoc#rest-api-procedures" class="xref unresolved">REST API Procedures</a> &#8212; assume the same starting-points as those for the UI; and achieve the same goals, by means of the Couchbase CLI and REST API respectively.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="replicate-data-between-collections-implicitly-with-the-ui"><a class="anchor" href="#replicate-data-between-collections-implicitly-with-the-ui"></a>Replicate Data Between Collections Implicitly, with the UI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>XDCR allows data to be replicated between collections <em>implicitly</em>.</p>
</div>
<div class="paragraph">
<p>An <em>implicit</em> mapping is one supported by XDCR whenever the same <em>keyspace</em> exists within both the source and the target buckets.
The <em>keyspace</em> is formed with a <em>scope-name</em> and the <em>collection-name</em>.
Therefore, if a source bucket contains the keyspace <code>scope1.collection1</code>, and the target bucket also contains the keyspace <code>scope1.collection1</code>, once a replication has been established from the source bucket to the target cluster and bucket, data will be automatically replicated from the source collection to the target collection.
This is demonstrated in the following example.</p>
</div>
<div class="paragraph">
<p>Proceed as follows.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On cluster <code>101.144.210.101</code>, access the <strong>Buckets</strong> screen:</p>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-xdcr/access-buckets-screen.png" alt="access buckets screen" width="100">
</div>
</div>
</li>
<li>
<p>When the screen appears, vertically expand the row for the <code>travel-sample</code> bucket; then, by means of the <strong>Scopes and Collections</strong> tab at the right-hand side of the row, examine the scopes already defined for the bucket.
Then, vertically expand the row for the scope <code>inventory</code>.
The screen now appears as follows:</p>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-xdcr/source-bucket-screen.png" alt="source bucket screen" width="720">
</div>
</div>
<div class="paragraph">
<p>The screen shows that the scope <code>inventory</code> contains five collections; which are named <code>airport</code>, <code>airline</code>, <code>route</code>, <code>landmark</code>, and <code>hotel</code>.
In this example, the scope <code>inventory</code> and all five collections within it will be replicated to the target cluster.</p>
</div>
<div class="paragraph">
<p>The screen also shows that the <code>travel-sample</code> bucket contains, as well as its <code>&#95;default</code> scope, five additional scopes: which are named <code>tenant_agent_00</code> to <code>tenant_agent_04</code>.
These scopes will <em>not</em> be replicated in this example.</p>
</div>
</li>
<li>
<p>On cluster <code>101.144.210.102</code>, access the <strong>Buckets</strong> screen.</p>
</li>
<li>
<p>Using the procedure described in <a href="../manage-buckets/create-bucket.html" class="xref page">Create a Bucket</a>, create a Couchbase bucket namd <code>ts</code>.</p>
</li>
<li>
<p>Using the procedures described in <a href="../manage-scopes-and-collections/manage-scopes-and-collections.html" class="xref page">Manage Scopes and Collections</a>, create, within <code>ts</code>, a scope named <code>inventory</code>; and within <code>inventory</code>, five collections; named <code>airport</code>, <code>airline</code>, <code>route</code>, <code>landmark</code>, and <code>hotel</code>.
(The <strong>Time-to-Live</strong> for each of these collections can be left at the default of <code>0</code>.)</p>
<div class="paragraph">
<p>With the row for <code>inventory</code> vertically expanded, the <strong>Scopes and Collections</strong> screen for the bucket <code>ts</code> now appears as follows:</p>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-xdcr/target-bucket-screen.png" alt="target bucket screen" width="720">
</div>
</div>
<div class="paragraph">
<p>This indicates that the scope and collections have been successfully created, and contain no data.
The keyspaces thus formed &#8212; <em>inventory.airline</em>, <em>inventory.airport</em>, etc &#8212; are identical to ones that already exist on the source cluster, <code>10.144.210.101</code>.
The <code>&#95;default</code> scope for <code>ts</code> is also displayed.
Note that the other scopes on the target cluster &#8212; named <code>tenant_agent_00</code> to <code>tenant_agent_03</code> &#8212; have <em>not</em> been created here, and will not be used for replication in the current example.</p>
</div>
</li>
<li>
<p>On cluster <code>101.144.210.101</code>, access the <strong>XDCR Replications</strong> screen.</p>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-xdcr/access-xdcr-screen.png" alt="access xdcr screen" width="100">
</div>
</div>
<div class="paragraph">
<p>Currently, this has a remote reference to cluster <code>101.144.210.102</code> defined; but no replications have yet been defined.</p>
</div>
</li>
<li>
<p>Left-click on the <strong>ADD REPLICATION</strong> button, at the upper right, to begin the process of defining a replication.</p>
</li>
<li>
<p>When the <strong>XDCR Add Replication</strong> screen is displayed, use the fields in the upper part of the screen to specify a replication from the bucket <code>travel-sample</code> to the bucket <code>ts</code>, on cluster <code>101.144.210.102</code>.
The fields now appear as follows;</p>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-xdcr/xdcr-replicate-to-102.png" alt="xdcr replicate to 102" width="640">
</div>
</div>
</li>
<li>
<p>Save the replication, by left-clicking on the <strong>Save Replication</strong> button.</p>
<div class="imageblock text-Left">
<div class="content">
<img src="../_images/manage-xdcr/saveReplicationButton.png" alt="saveReplicationButton" width="140">
</div>
</div>
<div class="paragraph">
<p>The replication is now started.</p>
</div>
</li>
<li>
<p>Examine the <strong>XDCR Replications</strong> screen.</p>
<div class="imageblock text-Left">
<div class="content">
<img src="../_images/manage-xdcr/outgoingReplicationImplicit.png" alt="outgoingReplicationImplicit" width="680">
</div>
</div>
<div class="paragraph">
<p>This confirms that replication is underway.</p>
</div>
</li>
<li>
<p>On cluster <code>10.144.210.102</code>, access the <strong>Buckets</strong> screen; and access the <strong>Scopes and Collections</strong> screen for the bucket <code>ts</code>.
By successively left-clicking, open the row for <code>ts</code>, for the scope <code>inventory</code>; and then left-click on the <strong>Documents</strong> tab for any of the five collections previously created &#8212; for example, <code>airline</code>.
The <strong>Documents</strong> screen appears as follows:</p>
<div class="imageblock text-Left">
<div class="content">
<img src="../_images/manage-xdcr/targetCollectionAfterImplicit.png" alt="targetCollectionAfterImplicit" width="680">
</div>
</div>
<div class="paragraph">
<p>The presence of these documents verifies that replication has occurred from <code>travel-sample</code> on the source, to <code>ts</code> on the target; with replication occurring according to the implicit mappings discovered by XDCR.
Note that those scopes within <code>travel-sample</code> that did <em>not</em> have an implicit mapping created have not been replicated.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="replicate-data-between-collections-explicitly-with-the-ui"><a class="anchor" href="#replicate-data-between-collections-explicitly-with-the-ui"></a>Replicate Data Between Collections Explicitly, with the UI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An <em>explicit</em> mapping between collections is one established by an administrator, so as to allow replication to occur between different keyspaces.
This is demonstrated in the following example; which assumes, as its starting point, that the previous example, <a href="#replicate-data-between-collections-implicitly-with-the-ui">Replicate Data Between Collections Implicitly, with the UI</a>, has been completed, and the resulting state has not been modified.</p>
</div>
<div class="paragraph">
<p>Proceed as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On cluster <code>10.144.210.102</code>, access the <strong>Scopes &amp; Collections</strong> screen for the bucket <code>ts</code>.
Left-click on the <strong>Add Collection</strong> tab, at the left-hand side of the row for the <code>inventory</code> scope:</p>
<div class="paragraph">
<p><span class="image"><img src="../_images/manage-xdcr/add-collection-tab.png" alt="add collection tab" width="120"></span></p>
</div>
<div class="paragraph">
<p>When the <strong>Add Collection</strong> dialog appears, specify the name <code>MyAirport</code>, and leave Time-to-Live at <code>0</code>:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../_images/manage-xdcr/add-collection-dialog.png" alt="add collection dialog" width="240"></span></p>
</div>
<div class="paragraph">
<p>Left-click on the <strong>Save</strong> button.
The <strong>Scopes &amp; Collections</strong> screen now confirms that the collection <code>MyAirport</code> has been added to the scope <code>inventory</code>:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../_images/manage-xdcr/scope-with-new-collection.png" alt="scope with new collection" width="720"></span></p>
</div>
</li>
<li>
<p>On cluster <code>10.144.210.101</code>, access the <strong>XDCR Replications</strong> screen.
Currently, a remote reference to <code>10.144.210.102</code> is defined; and a single replication exists.</p>
</li>
<li>
<p>Delete the existing replication: this is because we now intend to create another replication to the same bucket, <code>ts</code>; and XDCR only permits one replication to be defined, for a given target-bucket.</p>
<div class="paragraph">
<p>Vertically expand the row for the existing replication, by left-clicking.
Then, left-click on the <strong>Delete</strong> button, and confirm deletion of the replication:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../_images/manage-xdcr/confirm-deletion-of-replication.png" alt="confirm deletion of replication" width="220"></span></p>
</div>
</li>
<li>
<p>Left-click on the <strong>ADD REPLICATION</strong> button, at the upper right of the screen, to begin creating a new replication.
When the <strong>XDCR Add Replication</strong> screen is displayed, in the <strong>Replicate From Bucket</strong> field, specify <code>travel-sample</code>; in the <strong>Remote Bucket</strong> field, specify <code>ts</code>; and in the <strong>Remote Cluster</strong> field, specify <code>10.144.210.102</code>.</p>
</li>
<li>
<p>Left-click on the <strong>Specify Scopes, Collections, and Mappings</strong> toggle:</p>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-xdcr/xdcr-collections-mapping-toggle.png" alt="xdcr collections mapping toggle" width="260">
</div>
</div>
<div class="paragraph">
<p>This expands the panel, as follows:</p>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-xdcr/xdcr-collections-mapping-panel.png" alt="xdcr collections mapping panel" width="720">
</div>
</div>
<div class="paragraph">
<p>The principal element is a list of scopes that are defined within the specified source bucket, <code>ts</code>.
Note that a <strong>filter scopes</strong> field is provided; which permits strings to be entered, such that only those scopes whose names include matches to the strings are displayed in the list.</p>
</div>
<div class="paragraph">
<p>Note the information that is displayed immediately above the list.
This relates to the presentation of scope-names, in the list&#8217;s <strong>scope</strong> column.
Each scope-name is preceded by a checked checkbox; and is succeeded by the <strong>&gt;</strong> symbol, after which is displayed a remote scope-name &#8212; which is by default assumed to be the name of the scope on the target system, to which replication will occur.
If this assumption is correct, the assumed name need not be modified.
However, if a remote scope to which replication is to occur has a different name from the one represented by default in the list, the remote-scope name must be changed: by left-clicking directly on the scope name, and editing as appropriate.
(Note that this requirement will also apply to the specification of collection-names, demonstrated in the next step of this procedure.)</p>
</div>
<div class="paragraph">
<p>In the list currently presented, five scopes appear: which are the <code>inventory</code> scope, and the scopes <code>tenant_agent_00</code> to <code>tenant_agent_03</code>.</p>
</div>
</li>
<li>
<p>Left-click on the list-row for <code>inventory</code>.
The row expands, and appears as follows:</p>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-xdcr/xdcr-scope-row-expansion.png" alt="xdcr scope row expansion" width="720">
</div>
</div>
<div class="paragraph">
<p>The expanded row displays a field whereby collections in the scope can be filtered, based on a string-match.
It also features a <strong>check all</strong> checkbox, which allows all collections to be checked and thereby included in the intended replication.</p>
</div>
</li>
<li>
<p>Uncheck all collection checkboxes except the checkbox for <code>airline</code>.</p>
</li>
<li>
<p>Access the remote-collection-name field for <code>airline</code>; and change the name of the remote collection from <code>airline</code> to <code>MyAirline</code>.</p>
</li>
<li>
<p>Uncheck the checkboxes for the scopes <code>tenant_agent_00</code> to <code>tenant_agent_03</code>.
The rows for <code>ts</code> scopes now appear as follows:</p>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-xdcr/xdcr-modified-remote-scope-name.png" alt="xdcr modified remote scope name" width="720">
</div>
</div>
</li>
<li>
<p>Observe the <strong>Mapping Rules</strong> panel, at the upper right of the screen:</p>
<div class="paragraph">
<p><span class="image"><img src="../_images/manage-xdcr/mapping-rules.png" alt="mapping rules" width="220"></span></p>
</div>
<div class="paragraph">
<p>These rules are for informational purposes only: they are generated by the UI in conformance with the interactive selections that you make; and are used by the underlying processes that establish explicit mappings and due replications.
Note that you will make use of these rules, in JSON format, when establishing explicit mappings by means of the CLI or REST API.
The rules confirm that replication will occur between <code>inventory.airport</code> and <code>inventory.MyAirport</code>.</p>
</div>
</li>
<li>
<p>Save the replication, by left-clicking on the <strong>Save Replication</strong> button, in the lower part of the screen.
The <strong>XDCR Replications</strong> screen is now displayed, with the <strong>Outgoing Replications</strong> panel indicating that replication is occurring as required between <code>10.144.210.101</code> and <code>10.144.210.102</code>.</p>
</li>
<li>
<p>On cluster <code>10.144.210.102</code>, access the <strong>Scopes &amp; Collections</strong> screen for the bucket <code>ts</code>.
Left-click on the <strong>Documents</strong> tab, at the right-hand side of the row for the <code>MyAirport</code> collection, within the <code>inventory</code> scope.
The <strong>Documents</strong> screen is displayed, as follows:</p>
<div class="paragraph">
<p><span class="image"><img src="../_images/manage-xdcr/documents-after-explicit.png" alt="documents after explicit" width="720"></span></p>
</div>
<div class="paragraph">
<p>The displayed contents confirm that the explicit-mapping-based replication was successfully created, and is ongoing.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="migrate-data-to-a-collection-with-the-ui"><a class="anchor" href="#migrate-data-to-a-collection-with-the-ui"></a>Migrate Data to a Collection, with the UI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By specifying a scope and collection within a target bucket, XDCR can be used to replicate data selectively from the <code>&#95;default</code> collection within one bucket to the purpose-created collection within another.
Once such migration is complete, all future replications between collections should be performed with <em>implicit</em> or <em>explicit</em> mapping, as described in the examples provided on this page, above.</p>
</div>
<div class="paragraph">
<p>Before migrating data in a production context, note the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each established migration rule is CPU-intensive, and may lower XDCR replication performance.
The more migration rules are added, the slower each migration replication will be.
Therefore, the total number of simultaneous migration-rule-based replications per source cluster should be no greater than 2.</p>
</li>
<li>
<p>Correspondingly, if migration is to be performed with many rules; the replications should be performed 2 at a time.
On conclusion of those replications, applications intended to use the migrated data should be appropriately switched over.
Then, the next two migration rules should be configured, and the process repeated.
Continue in this way until the overall migration is complete.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that prior to attempting migration, appropriate settings for <em>deletion filters</em> should be determined.
These are individually described in <a href="filter-xdcr-replication.html#deletion-filters" class="xref page">Deletion Filters</a>.
However, the significance of deletion-filter settings for replication and migration is explained in detail in <a href="../../learn/clusters-and-availability/xdcr-filtering.html#using-deletion-filters" class="xref page">Using Deletion Filters</a>: this information should be fully understood before migration is performed.</p>
</div>
<div class="paragraph">
<p>Migration can now be exemplified as follows.
Note that this example assumes the existence of the clusters already used to demonstrate implicit and explicit mapping, which are <code>10.144.210.101</code> and <code>10.144.210.102</code>.
The source cluster, <code>101.144.210.101</code>, is assumed to contain the sample bucket <code>beer-sample</code>: note that <code>beer-sample</code> features only the <code>&#95;default</code> scope and collection: therefore, all documents are within the <code>&#95;default</code> collection.
By means of migration, this example separates the document progressively into different keyspaces.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Access the <strong>Buckets</strong> screen of the target cluster, <code>10.144.210.102</code>.</p>
</li>
<li>
<p>Using the procedure described in <a href="../manage-buckets/create-bucket.html" class="xref page">Create a Bucket</a>, create a Couchbase bucket named <code>beerSampleByLocation</code>.</p>
</li>
<li>
<p>Within <code>beerSampleByLocation</code>, using the procedures described in <a href="../manage-scopes-and-collections/manage-scopes-and-collections.html" class="xref page">Manage Scopes and Collections</a>, create a scope named <code>California</code>; and within <code>California</code>, three collections, respectively named <code>SanFrancisco</code>, <code>SanJose</code>, and <code>Sacramento</code>.
Leave <strong>Time-to-Live</strong> at its default value of <code>0</code> for each collection.</p>
<div class="paragraph">
<p>The <strong>Scopes &amp; Collections</strong> screen should now look as follows:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../_images/manage-xdcr/new-beer-sample-collections.png" alt="new beer sample collections" width="720"></span></p>
</div>
<div class="paragraph">
<p>A subset of the data in the source bucket <code>beer-sample</code> will now be replicated and sorted into the above keyspaces.</p>
</div>
</li>
<li>
<p>Access the <strong>XDCR Replications</strong> screen of cluster <code>101.144.210.101</code>.
Currently, a remote reference to <code>10.144.210.102</code> is defined.</p>
</li>
<li>
<p>Create a replication from <code>101.144.210.101</code> to <code>101.144.210.102</code>.
Left-click on the <strong>ADD REPLICATION</strong> button, at the upper right of the screen.
The <strong>XDCR Add Replication</strong> screen is now displayed:</p>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-xdcr/xdcr-add-replication-screen.png" alt="xdcr add replication screen" width="720">
</div>
</div>
</li>
<li>
<p>Using the three upper fields &#8212; <strong>Replicate From Bucket</strong>, <strong>Remote Cluster</strong>, and <strong>Remote Bucket</strong> &#8212; define a replication from <code>beer-sample</code> on <code>101</code> to the bucket <code>beerSampleByLocation</code> on <code>102</code>:</p>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-xdcr/beer-sample-replication-definition.png" alt="beer sample replication definition" width="520">
</div>
</div>
<div class="paragraph">
<p>Note the confirmatory notification that appears underneath the replication-definition.
As this indicates, if a replication is defined to include any destination-entity &#8212; bucket, scope, or collection &#8212; that does not exist, the entity will be ignored, and no attempt will be made to replicate data to it.
However, if other specified entities are valid, replication to them will proceed.</p>
</div>
</li>
<li>
<p>Establish appropriate settings for <em>deletion filters</em>.
These filters are individually described in <a href="filter-xdcr-replication.html#deletion-filters" class="xref page">Deletion Filters</a>.
Detailed information on their significance for migration is provided in <a href="../../learn/clusters-and-availability/xdcr-filtering.html#using-deletion-filters" class="xref page">Using Deletion Filters</a>.</p>
<div class="paragraph">
<p>Left-click on the <strong>Filter Replication</strong> toggle:</p>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-xdcr/filter-replication-toggle.png" alt="filter replication toggle" width="180">
</div>
</div>
<div class="paragraph">
<p>When the <strong>Filter Replication</strong> panel opens, access the <strong>Deletion Filters</strong>:</p>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-xdcr/filter-xdcr-deletion-filters.png" alt="filter xdcr deletion filters" width="320">
</div>
</div>
<div class="paragraph">
<p>For each filter, to ensure that deletions, expirations, and/or TTLs are replicated, leave the settings at their defaults (in each case, with the checkbox unchecked); and to ensure that deletions, expirations, and/or TTLs are <em>not</em> replicated, modify the settings, by checking each checkbox.</p>
</div>
</li>
<li>
<p>To migrate data, switch on the <strong>Migrate collections</strong> toggle, in the middle of the screen:</p>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-xdcr/xdcr-migrate-collections-toggle.png" alt="xdcr migrate collections toggle" width="520">
</div>
</div>
<div class="paragraph">
<p>Three new fields thus appear, which allow migration to be defined.
<strong>Replication Filter for Source</strong> allows a <em>regular expression</em> to be specified, whereby only a subset of documents within <code>travel-sample</code> are replicated.
<strong>Replicate to Collection</strong> allows specification of a collection on the target cluster: the collection must be preceded by the name of the scope that contains it, with scope-name and collection-name comma-separated.
The <strong>Save Mapping</strong> button allows the migration-definition to be saved.</p>
</div>
</li>
<li>
<p>Specify that documents from <code>beer-sample</code> be migrated to the collection <code>California.SanFrancisco</code> in the bucket <code>beerSampleByLocation</code>; using the filter expression <code>city="San Francisco"</code> &#8212; thereby ensuring that only documents that contain the key-value pair <code>"city": "San Francisco"</code> are included in the migration.
The fields now appear as follows:</p>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-xdcr/xdcr-migrate-collections-definition.png" alt="xdcr migrate collections definition" width="520">
</div>
</div>
<div class="paragraph">
<p>Left-click on the <strong>Save Mapping</strong> button, to save the mapping:</p>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-xdcr/xdcr-save-mapping-button.png" alt="xdcr save mapping button" width="100">
</div>
</div>
<div class="paragraph">
<p>Note that the saved rule now appears in the <strong>Mapping Rules</strong> column, at the upper right of the screen:</p>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-xdcr/mapping-rules-migration-definition.png" alt="mapping rules migration definition" width="200">
</div>
</div>
</li>
<li>
<p>Save the replication, by left-clicking on the <strong>Save Replication</strong> button, at the bottom of the screen:</p>
<div class="imageblock text-Left">
<div class="content">
<img src="../_images/manage-xdcr/saveReplicationButton.png" alt="saveReplicationButton" width="140">
</div>
</div>
<div class="paragraph">
<p>The <strong>XDCR Replications</strong> screen now returns, with the <strong>Outgoing Replications</strong> panel appearing as follows:</p>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-xdcr/xdcr-outgoing-replication-migration.png" alt="xdcr outgoing replication migration" width="680">
</div>
</div>
<div class="paragraph">
<p>As this indicates, the defined replication is now proceeding from <code>travel-sample</code> on the source cluster, to <code>beerSampleByLocation</code> on the remote.</p>
</div>
</li>
<li>
<p>On cluster <code>10.144.210.102</code>, access the <strong>Buckets</strong> screen, and examine the collection <code>San Francisco</code> within the scope <code>California</code>, in the bucket <code>beerSampleByLocation</code>:</p>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-xdcr/scopes-in-bsbl.png" alt="scopes in bsbl" width="680">
</div>
</div>
<div class="paragraph">
<p>The non-zero figures for <strong>memory used</strong> and <strong>disk used</strong> for the collection <code>SanFrancisco</code> within the scope <code>California</code> indicate that migration of documents into the collection has occurred.</p>
</div>
</li>
<li>
<p>Left-click on the <strong>Documents</strong> tab, at the right-hand side of the row for the collection <code>SanFrancisco</code>:</p>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-xdcr/documents-tab.png" alt="documents tab" width="120">
</div>
</div>
<div class="paragraph">
<p>The documents within the collection are now displayed:</p>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-xdcr/xdcr-target-collection-filled.png" alt="xdcr target collection filled" width="680">
</div>
</div>
<div class="paragraph">
<p>This indicates that those documents from <code>beer-sample</code> whose <code>city</code> value is <code>"San Francisco"</code> have been successfully filtered and replicated to the <code>California</code> collection, within the remote bucket <code>beerSampleByLocation</code>.</p>
</div>
</li>
<li>
<p>Having determined that migration has been successfully completed, delete the migration.
Return to the <strong>XDCR Replications</strong> screen, and inspect the row for the replication:</p>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-xdcr/xdcr-outgoing-replication-migration-complete.png" alt="xdcr outgoing replication migration complete" width="680">
</div>
</div>
<div class="paragraph">
<p>Left-click on the row, in order to display the controls:</p>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-xdcr/replication-controls.png" alt="replication controls" width="280">
</div>
</div>
<div class="paragraph">
<p>Left-click on the <strong>Delete</strong> button, to delete the migration.</p>
</div>
<div class="paragraph">
<p>Note that in cases where, following migration, source data is to be deleted, it is essential to delete the migration <em>prior</em> to deletion of the source data, if all data is intended to continue to exist on the targets, and <em>deletion filters</em> have been left at their default values.
For detailed information, see <a href="../../learn/clusters-and-availability/xdcr-filtering.html#using-deletion-filters" class="xref page">Using Deletion Filters</a></p>
</div>
</li>
<li>
<p>Repeating the procedure so far demonstrated, create new, successive migrations for the <code>SanJose</code> and <code>Sacramento</code> collections; specifying the appropriate <code>city</code> value for each collection.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In this way, all documents within the source <code>travel-sample</code> bucket can be migrated to appropriate collections on the target cluster.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cli-procedures"><a class="anchor" href="#cli-procedures"></a>CLI Procedures</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The procedures described above for the UI &#8212; covering XDCR replication between scopes and collections, based on implicit and explicit mapping; and migration &#8212; can also be effected by means of the Couchbase CLI.
The required steps are provided below.</p>
</div>
<div class="paragraph">
<p>For detailed information on all CLI options for XDCR replication, see the reference page for <a href="#cli:cbcli/couchbase-cli-xdcr-replicate.adoc" class="xref unresolved">xdcr-replicate</a>.
For more information on creating buckets, scopes, and collections with the CLI, see the reference pages for <a href="#cli:cbcli/couchbase-cli-bucket-create.adoc" class="xref unresolved">bucket-create</a> and <a href="#cli:cbcli/couchbase-cli-collection-manage.adoc" class="xref unresolved">collection-manage</a>.</p>
</div>
<div class="sect2">
<h3 id="replicate-data-implicitly-with-the-cli"><a class="anchor" href="#replicate-data-implicitly-with-the-cli"></a>Replicate Data Implicitly, with the CLI</h3>
<div class="paragraph">
<p>Proceed as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Establish two one-node clusters, <code>10.144.210.101</code> and <code>10.144.210.102</code>, according to the description provided above, in <a href="#examples-on-this-page">Examples on this Page</a>.</p>
</li>
<li>
<p>To replicate data according to the implicit mapping of scopes and collections within the source bucket <code>travel-sample</code> and the target bucket <code>ts</code>, enter the following:</p>
<div class="listingblock">
<div class="content">
<pre>/opt/couchbase/bin/couchbase-cli xdcr-replicate \
-c 10.144.210.101:8091 \
-u Administrator \
-p password \
--create \
--xdcr-cluster-name 10.144.210.102 \
--xdcr-from-bucket travel-sample \
--xdcr-to-bucket ts</pre>
</div>
</div>
<div class="paragraph">
<p>If the command succeeds, the following response is printed to the console:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SUCCESS: XDCR replication created</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Inspection of the collections within the <code>inventory</code> scope on <code>ts</code> now confirms that replication has occurred, according to the implicit mapping established between identically named keyspaces.</p>
</div>
</div>
<div class="sect2">
<h3 id="replicate-data-explicitly-with-the-cli"><a class="anchor" href="#replicate-data-explicitly-with-the-cli"></a>Replicate Data Explicitly, with the CLI</h3>
<div class="paragraph">
<p>Proceed as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On the target cluster, <code>10.144.210.102</code>, within the scope <code>inventory</code>, establish a new collection named <code>MyAirport</code>.</p>
</li>
<li>
<p>On the source cluster, <code>10.144.210.101</code>, delete the replication created above in <a href="#replicat-data-implicitly-with-the-cli">Replicate Data Explicitly with the CLI</a>.</p>
<div class="paragraph">
<p>To do this, first, obtain the id of the existing replication, by means of the <code>list</code> flag to <code>xdcr-replicate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/opt/couchbase/bin/couchbase-cli xdcr-replicate \
-c 10.144.210.101:8091 \
-u Administrator \
-p password \
--list</pre>
</div>
</div>
<div class="paragraph">
<p>If the command is successful, the following output is provided:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>stream id: ac41764b9e261725e874dbd34c7eda6b/travel-sample/ts
   status: running
   source: travel-sample
   target: /remoteClusters/ac41764b9e261725e874dbd34c7eda6b/buckets/ts</pre>
</div>
</div>
<div class="paragraph">
<p>Then, delete the replication, using the <code>delete</code> flag, and specifying the replication&#8217;s id:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/opt/couchbase/bin/couchbase-cli xdcr-replicate \
-c l10.144.210.101:8091 \
-u Administrator \
-p password \
--delete \
--xdcr-replicator ac41764b9e261725e874dbd34c7eda6b/travel-sample/ts</pre>
</div>
</div>
<div class="paragraph">
<p>If the command is successful, the following output is provided:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SUCCESS: XDCR replication deleted</pre>
</div>
</div>
</li>
<li>
<p>On the source cluster, <code>10.144.210.101</code>, create a new replication to the target cluster <code>10.144.210.102</code>, specifying the explicit mapping of the source collection <code>airline</code> to the target collection <code>MyAirline</code>:</p>
<div class="listingblock">
<div class="content">
<pre>/opt/couchbase/bin/couchbase-cli xdcr-replicate \
-c 10.144.210.101:8091 \
-u Administrator \
-p password \
--create \
--xdcr-cluster-name 10.144.210.102 \
--xdcr-from-bucket travel-sample \
--xdcr-to-bucket ts \
--collection-explicit-mappings 1 \
--collection-mapping-rules  '{"inventory.airline":"inventory.MyAirline"}'</pre>
</div>
</div>
<div class="paragraph">
<p>Note that the <code>collection-explicit-mappings</code> flag has been specified, with a value of <code>1</code>; indicating that an explicit-mapping rule is being provided.
The rule itself is specified as the value for the <code>collection-mapping-rules</code> flag; and affirms that the documents in the source collection <code>inventory.airline</code> are to be replicated to the target collection <code>inventory.MyAirline</code>.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Examination of the target collection <code>inventory.MyAirline</code> will confirm that replication is occurring, due to the presence of replicated documents from the source collection <code>inventory.airline</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="migrate-data-with-the-cli"><a class="anchor" href="#migrate-data-with-the-cli"></a>Migrate Data, with the CLI</h3>
<div class="paragraph">
<p>Before migrating data with the CLI, read the information regarding the CPU-intensiveness of data migration, provided above in <a href="#migrate-data-to-a-collection-with-the-ui">Migrate Data to a Collection with the UI</a>.
Then, proceed as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ensure that the source cluster contains the sample bucket <code>beer-sample</code>; and that the target cluster contains a bucket named <code>beerSampleByLocation</code>, with a scope and collections as described above, in <a href="#migrate-data-with-the-ui">Migrate Data, with the UI</a>.</p>
</li>
<li>
<p>Replicate to the target collection <code>California.SanFrancisco</code>, within the target bucket <code>beerSampleByLocation</code>, all documents from the source bucket <code>beer-sample</code> whose <code>city</code> value is <code>"San Francisco"</code>.
Enter the following expression:</p>
<div class="listingblock">
<div class="content">
<pre>/opt/couchbase/bin/couchbase-cli xdcr-replicate \
-c 10.144.210.101:8091 \
-u Administrator \
-p password \
--create \
--xdcr-cluster-name 10.144.210.102 \
--xdcr-from-bucket beer-sample \
--xdcr-to-bucket beerSampleByLocation \
--collection-migration 1 \
--collection-mapping-rules '{"city=\"San Francisco\"":"California.SanFrancisco"}'</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>collection-migration</code> flag is specified, with a value of <code>1</code>.
Note the format required for the specifying of <code>collection-mapping-rules</code>: the regular expression <code>"city=\"San Francisco\"</code> is provided as the key of a key-value pair, whose value is the destination collection, <code>"California.SanFrancisco"</code>.
Note also that, in cases where <em>all</em> data from the source bucket is to be migrated, and no regular expression is therefore required, the key of the key-value pair should be specified as the keyspace of the default bucket: i.e. <code>"_default._default"</code>.</p>
</div>
<div class="paragraph">
<p>If the command is successful, the following output is displayed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SUCCESS: XDCR replication created</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Documents are now replicated as specified by the explicit mapping and filter.</p>
</div>
<div class="paragraph">
<p>See <a href="#cli:cbcli/couchbase-cli-xdcr-replicate.adoc" class="xref unresolved">xdcr-replicate</a> for information on setting <em>deletion filters</em> with the CLI; and see <a href="../../learn/clusters-and-availability/xdcr-filtering.html#using-deletion-filters" class="xref page">Using Deletion Filters</a> for information on how to use deletion filters, in the context of migrating data.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="rest-api-procedures"><a class="anchor" href="#rest-api-procedures"></a>REST API Procedures</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The procedures described above for the UI and CLI &#8212; covering XDCR replication between scopes and collections, based on implicit and explicit mapping; and migration &#8212; can also be effected by means of the Couchbase REST API.
The required steps are provided below.</p>
</div>
<div class="paragraph">
<p>For detailed information on all REST API options for XDCR replication, see the reference page for <a href="#cli:cbcli/couchbase-cli-xdcr-replicate.adoc" class="xref unresolved">xdcr-replicate</a>.
For more information on creating buckets, scopes, and collections with the REST API, see the reference pages for <a href="../../rest-api/rest-bucket-create.html" class="xref page">Creating and Editing Buckets</a> and <a href="#rest-api/scopes-and-collections-api.adoc" class="xref unresolved">Scopes and Collections REST API</a>.</p>
</div>
<div class="sect2">
<h3 id="replicate-data-implicitly-with-the-rest-api"><a class="anchor" href="#replicate-data-implicitly-with-the-rest-api"></a>Replicate Data Implicitly, with the REST API</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Establish two one-node clusters, <code>10.144.210.101</code> and <code>10.144.210.102</code>, according to the description provided above, in <a href="#examples-on-this-page">Examples on this Page</a>.</p>
</li>
<li>
<p>To replicate data according to the implicit mapping of scopes and collections within the source bucket <code>travel-sample</code> and the target bucket <code>ts</code>, enter the following:</p>
<div class="listingblock">
<div class="content">
<pre>curl -v -X POST -u Administrator:password \
http://localhost:8091/controller/createReplication \
-d replicationType=continuous \
-d fromBucket=travel-sample \
-d toCluster=10.144.210.102 \
-d toBucket=ts</pre>
</div>
</div>
<div class="paragraph">
<p>If the command succeeds, a response similar to the following is printed to the console:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{"id":"ac41764b9e261725e874dbd34c7eda6b/travel-sample/ts"}</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Inspection of the collections within the <code>inventory</code> scope on <code>ts</code> now confirms that replication has occurred, according to the implicit mapping established between identically named keyspaces.</p>
</div>
</div>
<div class="sect2">
<h3 id="replicate-data-explicitly-with-the-rest-api"><a class="anchor" href="#replicate-data-explicitly-with-the-rest-api"></a>Replicate Data Explicitly, with the REST API</h3>
<div class="paragraph">
<p>Proceed as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On the target cluster, <code>10.144.210.102</code>, within the scope <code>inventory</code>, establish a new collection named <code>MyAirport</code>.</p>
</li>
<li>
<p>On the source cluster, <code>10.144.210.101</code>, delete the replication created above in <a href="#replicat-data-implicitly-with-the-cli">Replicate Data Explicitly with the CLI</a>.</p>
<div class="paragraph">
<p>To do this, first, obtain the id of the existing replication, by means of the following expression, which uses the <code>GET /pools/default/tasks</code> method and URL, as well as <a href="https://stedolan.github.io/jq/jq" target="_blank" rel="noopener">jq</a> and <code>grep</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>curl -v -u Administrator:password -X GET \
http://10.144.210.101:8091/pools/default/tasks | \
jq '.' |  \
grep "cancelURI"</pre>
</div>
</div>
<div class="paragraph">
<p>If the command is successful, the following output is retrieved from the returned object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>"cancelURI": "/controller/cancelXDCR/ac41764b9e261725e874dbd34c7eda6b%2Ftravel-sample%2Fts",</pre>
</div>
</div>
<div class="paragraph">
<p>The returned <code>cancelURI</code> references the id of the replication.</p>
</div>
<div class="paragraph">
<p>Now, delete the replication by means of the <code>DELETE /conroller/cancelXDCR/&lt;replication-id&gt;</code> method and URI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>curl -X DELETE -u Administrator:password  \
http://10.144.210.101:8091/controller/cancelXDCR/ac41764b9e261725e874dbd34c7eda6b%2Ftravel-sample%2Fts</pre>
</div>
</div>
<div class="paragraph">
<p>If the command is successful, no output is provided.</p>
</div>
</li>
<li>
<p>On the source cluster, <code>10.144.210.101</code>, create a new replication to the target cluster <code>10.144.210.102</code>, specifying the explicit mapping of the source collection <code>airline</code> to the target collection <code>MyAirline</code>:</p>
<div class="listingblock">
<div class="content">
<pre>curl -v -X POST -u Administrator:password \
http://localhost:8091/controller/createReplication \
-d replicationType=continuous \
-d toBucket=ts \
-d toCluster=10.144.210.102 \
-d fromBucket=travel-sample \
-d collectionsExplicitMapping=true \
-d colMappingRules=%7B%22inventory.airline%22%3A%22inventory.MyAirline%22%7D</pre>
</div>
</div>
<div class="paragraph">
<p>Note that the <code>collectionsExplicitMapping</code> flag has been specified, with a value of <code>true</code>.
The value of <code>colMappingRules</code> is an encoded JSON object whose key is the source collection, and whose target is the target collection.
If the call is successful, the following output is displayed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SUCCESS: XDCR replication created</pre>
</div>
</div>
<div class="paragraph">
<p>Examination of the target collection <code>inventory.MyAirline</code> will confirm that replication is occurring, due to the presence of replicated documents from the source collection <code>inventory.airline</code>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="migrate-data-with-the-rest-api"><a class="anchor" href="#migrate-data-with-the-rest-api"></a>Migrate Data, with the REST API</h3>
<div class="paragraph">
<p>Before migrating data with the REST API, read the information regarding the CPU-intensiveness of data migration, provided above in <a href="#migrate-data-to-a-collection-with-the-ui">Migrate Data to a Collection with the UI</a>.
Then, proceed as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ensure that the source cluster contains the sample bucket <code>beer-sample</code>; and that the target cluster contains a bucket named <code>beerSampleByLocation</code>, with a scope and collections as described above, in <a href="#migrate-data-with-the-ui">Migrate Data, with the UI</a>.</p>
</li>
<li>
<p>Replicate to the target collection <code>California.SanFrancisco</code>, within the target bucket <code>beerSampleByLocation</code>, all documents from the source bucket <code>beer-sample</code> whose <code>city</code> value is <code>"San Francisco"</code>.
Enter the following expression:</p>
<div class="listingblock">
<div class="content">
<pre>curl -v -X POST http://10.144.210.101:8091/controller/createReplication \
-u Administrator:password \
-d replicationType=continuous \
-d toBucket=beerSampleByLocation \
-d toCluster=10.144.210.102 \
-d fromBucket=beer-sample \
-d collectionsMigrationMode=true \
-d colMappingRules='{"city=\"San Francisco\"":"California.SanFrancisco"}'</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>collectionsMigrationMode</code> flag is specified, with a value of <code>true</code>.
Note the format required for the specifying of <code>colMappingRules</code>: the regular expression <code>"city=\"San Francisco\"</code> is provided as the key of a key-value pair, whose value is the destination collection, <code>"California.SanFrancisco"</code>.
(Note also that, in cases where <em>all</em> data from the source bucket is to be migrated, and no regular expression is therefore required, the key of the key-value pair should be specified as the keyspace of the default bucket: i.e. <code>"_default._default"</code>.)</p>
</div>
<div class="paragraph">
<p>If the command is successful, output containing the id of the replication is displayed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{"id":"ac41764b9e261725e874dbd34c7eda6b/beer-sample/beerSampleByLocation"}</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Documents are now migrated as specified by the explicit mapping and filter.</p>
</div>
<div class="paragraph">
<p>See <a href="../../rest-api/rest-xdcr-create-replication.html" class="xref page">Creating XDCR Replications</a> for information on setting <em>deletion filters</em> with the REST API; and see <a href="../../learn/clusters-and-availability/xdcr-filtering.html#using-deletion-filters" class="xref page">Using Deletion Filters</a> for information on how to use deletion filters, in the context of migrating data.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="rules-for-explicit-mapping"><a class="anchor" href="#rules-for-explicit-mapping"></a>Rules for Explicit Mapping and Migration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Explicit mapping and migration must be specified according to <em>rules</em>.
Use of Couchbase Web Console generates mappings that automatically conform with these rules: however, use of the CLI and REST API requires creation of a JSON payload, in which rules are correctly expressed by the administrator.</p>
</div>
<div class="paragraph">
<p>All rules are listed in <a href="../../learn/clusters-and-availability/xdcr-with-scopes-and-collections.html#rules-for-explicit-mappings" class="xref page">Rules for Explicit Mappings</a> and <a href="../../learn/clusters-and-availability/xdcr-with-scopes-and-collections.html#rules-for-migration" class="xref page">Rules for Migration</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="next-steps-after-replicate-between-scopes-and-collections"><a class="anchor" href="#next-steps-after-replicate-between-scopes-and-collections"></a>Next Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An XDCR replication can be <em>filtered</em>, by means of <em>regular expressions</em>; so that only selected documents are replicated from the source to the target cluster.
See <a href="filter-xdcr-replication.html" class="xref page">Filter a Replication</a>.</p>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2023 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Server","components":["server"],"url":"/home/server.html","latestVersions":{"server":"7.2"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../../../_/js/site.js"></script>
<script defer src="../../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
</body>
</html>
