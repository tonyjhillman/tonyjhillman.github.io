<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<script>(window.dataLayer=window.dataLayer||[]).push({event:'gtm.js','gtm.start':+new Date()})</script>
<script async src="https://www.googletagmanager.com/gtm.js?id=GTM-MVPNN2"></script>
<title>Adaptive Index | Couchbase Docs</title>
<link rel="stylesheet" href="../../../../_/css/site.css">
<script src="../../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="Adaptive Indexes are a special type of GSI array index that can index all or specified fields of a document.">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="server">
<meta name="dcterms.identifier" content="7.2">
<meta name="page-url" content="/server/current/n1ql/n1ql-language-reference/adaptive-indexing.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://docs.couchbase.com/home/index.html">
                    <img src="../../../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://docs.couchbase.com/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../cloud/index.html">
                      Capella
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/pages/n1ql-language-reference/adaptive-indexing.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../../introduction/intro.html">Couchbase Server</a></li>
<li class="crumb"><a href="../query.html">Query</a></li>
<li class="crumb"><a href="index.html">SQL++ Language Reference</a></li>
<li class="crumb">Statements</li>
<li class="crumb"><a href="createindex.html">CREATE INDEX</a></li>
<li class="crumb"><a href="adaptive-indexing.html">Adaptive Index</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Adaptive Index</h1>
<div class="labels">
<ul></ul>
</div>


</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Adaptive Indexes are a special type of GSI array index that can index all or specified fields of a document.
Such an index is generic in nature, and it can efficiently index and lookup any of the index-key values.
This enables efficient ad hoc queries (that may have WHERE clause predicates on any of the index-key fields) without requiring to create various composite indexes for different combinations of fields.
Adaptive Index is a functional array index created using the SQL++ function <a href="metafun.html#pairs" class="xref page">PAIRS()</a>.</p>
</div>
<div class="paragraph">
<p>Basically, the idea is to be able to simply load data and start querying:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>using a single secondary index, and</p>
</li>
<li>
<p>not worrying about creating appropriate secondary indexes for each query.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that without Adaptive Indexes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Only primary index can help run any ad hoc query.
But using primary index can be expensive for queries with predicates on any of the non-key fields of the document.</p>
</li>
<li>
<p>Each query will need a compatible secondary index that can qualify for the predicates in the WHERE clause.
See section <a href="#section_w31_bnm_5z">Contrast with Composite Indexes</a> for details.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For instance, consider a user profile or hotel reservation search use case.
A person&#8217;s profile may need to be searched based on any of the personal attributes such as first name, last name, age, city, address, job, title, company, etc.
Similarly, a hotel room availability may be searched based on wide criteria, such as room facilities, amenities, price, and other features.
In this scenario, traditional secondary indexes or composite indexes can&#8217;t be used effectively&#8201;&#8212;&#8201;see section <a href="#section_w31_bnm_5z">Contrast with Composite Indexes</a> to understand some of the concerns.
Adaptive indexes can help effectively and efficiently run such ad hoc search queries.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="syntax"><a class="anchor" href="#syntax"></a>Syntax</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An adaptive index is a type of array index.
To create an adaptive index, the overall syntax is the same as for an array index.</p>
</div>
<div class="paragraph">
<p>Refer to the <a href="createindex.html" class="xref page">CREATE INDEX</a> statement for details of the syntax.</p>
</div>
<div class="sect2">
<h3 id="index-key"><a class="anchor" href="#index-key"></a>Index Key</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/ddl.ebnf#L101">simple-array-expr ::= ( 'ALL' | 'DISTINCT' ) expr</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/simple-array-expr.png" alt="Syntax diagram: refer to source code listing">
</div>
</div>
<div class="paragraph">
<p>To create an adaptive index, the index key must be a simple array expression containing a <a href="metafun.html#pairs" class="xref page">PAIRS()</a> function.</p>
</div>
</div>
<div class="sect2">
<h3 id="pairs-function"><a class="anchor" href="#pairs-function"></a>PAIRS() Function</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/ddl.ebnf#L105">pairs-function ::= 'PAIRS' '(' ( 'SELF' | index-key-object ) ')'</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/pairs-function.png" alt="Syntax diagram: refer to source code listing">
</div>
</div>
<div class="paragraph">
<p>When the <code>SELF</code> keyword is used, the adaptive index is created with all fields in the documents of the keyspace.</p>
</div>
<div class="paragraph">
<p>If you want to create an adaptive index on selected fields only, you must specify an index key object.</p>
</div>
</div>
<div class="sect2">
<h3 id="index-key-object"><a class="anchor" href="#index-key-object"></a>Index Key Object</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/n1ql.ebnf#L233">object ::= '{' ( ( name-expr ':' )? expr (',' ( name-expr ':' )? expr)* )? '}'</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/object.png" alt="Syntax diagram: refer to source code listing">
</div>
</div>
<div class="paragraph">
<p>For the purposes of an adaptive index, the index key object should be an <a href="constructionops.html#object-construction" class="xref page">object constructor</a> that generates an object of name-value pairs from the document fields to be indexed.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>name-expr</em></dt>
<dd>
<p>The field name that corresponds to <code><em>expr</em></code>.</p>
</dd>
<dt class="hdlist1"><em>expr</em></dt>
<dd>
<p>A SQL++ expression that is allowed in <a href="createindex.html" class="xref page">CREATE INDEX</a>.
This must be an expression over any document fields.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>When the value expression is an identifier directly referring to a named document field, then you may omit the name expression.
In this case, the name of the field in the data source will be used as the name of the field in the object constructor.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When using <a href="metafun.html#pairs" class="xref page">PAIRS()</a> with an object constructor, you need to keep in mind:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If two fields have the same name, such as <code>{a, c.a}</code>&#8201;&#8212;&#8201;when evaluated, both will inherit the same name of <code>a</code>, causing one value to overwrite the other.
Neither value will be indexed.
A better way to handle this is to name one field explicitly, such as <code>{a, "ca":c.a}</code>.</p>
</li>
<li>
<p>If the value expression is <em>not</em> an identifier directly referring to a named document field, such as <code>{abs(a)}</code>&#8201;&#8212;&#8201;the name of the object field is null, and this will generate an error.
A better way to handle this is to use a field name explicitly, such as <code>{"abs_a":abs(a)}</code>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/adaptive-indexing.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div class="paragraph">
<p>Consider the following indexes, which are included with the <code>travel-sample</code> data that is shipped with the product.
To install sample data, see <a href="../../manage/manage-settings/install-sample-buckets.html" class="xref page">Sample Buckets</a>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="C1" class="listingblock">
<div class="title">C1</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-c1.n1ql">CREATE INDEX `def_inventory_airport_airportname`
ON `travel-sample`.`inventory`.`airport`(`airportname`) WITH { "defer_build":true }</code></pre>
</div>
</div>
<div id="C2" class="listingblock">
<div class="title">C2</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-c2.n1ql">CREATE INDEX `def_inventory_airport_city`
ON `travel-sample`.`inventory`.`airport`(`city`) WITH { "defer_build":true }</code></pre>
</div>
</div>
<div id="C3" class="listingblock">
<div class="title">C3</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-c3.n1ql">CREATE INDEX `def_inventory_airport_faa`
ON `travel-sample`.`inventory`.`airport`(`faa`) WITH { "defer_build":true }</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Here, three different indexes are needed to help different queries whose WHERE clause predicates may refer to different fields.
For instance, the following queries <a href="#Q1">Q1</a>, <a href="#Q2">Q2</a>, and <a href="#Q3">Q3</a> will use the indexes created in <a href="#C1">C1</a>, <a href="#C2">C2</a>, and <a href="#C3">C3</a>, respectively:</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="Q1" class="listingblock">
<div class="title">Q1</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-q1.n1ql">SELECT * FROM airport WHERE airportname LIKE "San Francisco%";</code></pre>
</div>
</div>
<div id="Q2" class="listingblock">
<div class="title">Q2</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-q2.n1ql">SELECT * FROM airport WHERE city = "San Francisco";</code></pre>
</div>
</div>
<div id="Q3" class="listingblock">
<div class="title">Q3</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-q3.n1ql">SELECT * FROM airport WHERE faa = "SFO";</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>However, the following single adaptive index <a href="#C4">C4</a> can serve all three of the following queries <a href="#Q1A">Q1A</a>, <a href="#Q2A">Q2A</a>, and <a href="#Q3A">Q3A</a>:</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="C4" class="listingblock">
<div class="title">C4</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-c4.n1ql">CREATE INDEX `ai_airport_day_faa`
ON airport(DISTINCT PAIRS({airportname, city, faa, type}));</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div id="Q1A" class="listingblock">
<div class="title">Q1A</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-q1a.n1ql">SELECT * FROM airport
USE INDEX (ai_airport_day_faa)
WHERE airportname LIKE "San Francisco%";</code></pre>
</div>
</div>
<div id="Q2A" class="listingblock">
<div class="title">Q2A</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-q2a.n1ql">SELECT * FROM airport
USE INDEX (ai_airport_day_faa)
WHERE city = "San Francisco";</code></pre>
</div>
</div>
<div id="Q3A" class="listingblock">
<div class="title">Q3A</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-q3a.n1ql">SELECT * FROM airport
USE INDEX (ai_airport_day_faa)
WHERE faa = "SFO";</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Similarly, the following adaptive index over <code>SELF</code> in <a href="#C5">C5</a> is also qualified for these queries.
In fact, an adaptive index that includes all fields in the documents can serve any query on the keyspace, though it might have different performance characteristics when compared to specific indexes created for a particular query.
See the section <a href="#section_m12_552_dbb">Performance Implications</a> for details.
For example, the following queries <a href="#Q5">Q5</a> and <a href="#Q5A">Q5A</a> show how the generic adaptive index <a href="#C5">C5</a> is used to query predicates on different fields of the "airport" documents.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="C5" class="listingblock">
<div class="title">C5</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-c5.n1ql">CREATE INDEX `ai_self`
ON airport(DISTINCT PAIRS(self));</code></pre>
</div>
</div>
<div id="Q5" class="listingblock">
<div class="title">Q5</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-q5.n1ql">EXPLAIN SELECT * FROM airport
USE INDEX (ai_self)
WHERE faa = "SFO";</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "plan": {
      "#operator": "Sequence",
      "~children": [
        {
          "#operator": "DistinctScan",
          "scan": {
            "#operator": "IndexScan3",
            "bucket": "travel-sample",
            "index": "ai_self",
            "index_id": "1243095ed73061b5",
            "index_projection": {
              "primary_key": true
            },
            "keyspace": "airport",
            "namespace": "default",
            "scope": "inventory",
            "spans": [
              {
                "exact": true,
                "range": [
                  {
                    "high": "[\"faa\", \"SFO\"]",
                    "inclusion": 3,
                    "low": "[\"faa\", \"SFO\"]"
                  }
                ]
              }
            ],
            "using": "gsi"
          }
// ...</code></pre>
</div>
</div>
<div id="Q5A" class="listingblock">
<div class="title">Q5A</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-q5a.n1ql">EXPLAIN SELECT *
FROM airport
USE INDEX (ai_self)
WHERE tz = "Europe/Paris";</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "plan": {
      "#operator": "Sequence",
      "~children": [
        {
          "#operator": "DistinctScan",
          "scan": {
            "#operator": "IndexScan3",
            "bucket": "travel-sample",
            "index": "ai_self",
            "index_id": "1243095ed73061b5",
            "index_projection": {
              "primary_key": true
            },
            "keyspace": "airport",
            "namespace": "default",
            "scope": "inventory",
            "spans": [
              {
                "exact": true,
                "range": [
                  {
                    "high": "[\"tz\", \"Europe/Paris\"]",
                    "inclusion": 3,
                    "low": "[\"tz\", \"Europe/Paris\"]"
                  }
                ]
              }
            ],
            "using": "gsi"
          }
// ...</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="section_w31_bnm_5z"><a class="anchor" href="#section_w31_bnm_5z"></a>Contrast with Composite Indexes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/adaptive-indexing.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div class="paragraph">
<p>Traditionally, composite secondary indexes are used to create indexes with multiple index keys.
For example, consider the following index in <a href="#C6">C6</a>:</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="C6" class="listingblock">
<div class="title">C6</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-c6.n1ql">CREATE INDEX `idx_city_faa_airport`
ON airport(city, faa, airportname);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Such composite indexes are very different from the adaptive index in <a href="#C4">C4</a> in many ways:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Order of index keys is vital for composite indexes.</strong>  When an index key is used in the WHERE clause, all prefixing index keys in the index definition must also be specified in the WHERE clause.
For example, to use the index <a href="#C6">C6</a>, a query to <em>"find details of airports with FAA code SFO"</em>, must specify the prefixing index key <code>city</code> also in the WHERE clause just to qualify the index <a href="#C6">C6</a>.
Contrast the following query <a href="#Q6">Q6</a> with <a href="#Q3">Q3</a> above that uses the adaptive index in <a href="#C3">C3</a>.</p>
<div class="exampleblock">
<div class="content">
<div id="Q6" class="listingblock">
<div class="title">Q6</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-q6.n1ql">SELECT * FROM airport
WHERE faa = "SFO"
AND city IS NOT MISSING;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The problem is not just the addition of an extraneous predicate, but the performance.
The predicate on the first index key <code>city IS NOT MISSING</code> is highly selective (i.e.
most of the index entries in the index will match it) and hence, it will result in almost a full index scan.</p>
</div>
</li>
<li>
<p><strong>Complication in Queries.</strong>  If a document has many fields to index, then the composite index will end up with all those fields as index keys.
Subsequently, queries that only need to use index keys farther in the index key order will need many unnecessary predicates referring to all the preceding index keys.
For example, if the index is:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx_name ON `travel-sample`(field1, field2, ..., field9);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>A query that has a predicate on <code class="var">field9</code> will get unnecessarily complicated, as it needs to use all preceding index keys from <code class="var">field1</code> to <code class="var">field8</code>.</p>
</div>
</li>
<li>
<p><strong>Explosion of number of indexes for ad hoc queries.</strong> At some point, it becomes highly unnatural and overly complicated to write ad hoc queries using composite indexes.
For instance, consider a user profile or inventory search use case where a person or item may need to be searched based on many criteria.</p>
<div class="paragraph">
<p>One approach is to create indexes on all possible attributes.
If that query can include any of the attributes, then it may require creation of innumerable indexes.
For example, a modest 20 attributes will result in 20 factorial (2.43&times;10<sup>18</sup>) indexes in order to consider all combinations of sort orders of the 20 attributes.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="partial-adaptive-indexes"><a class="anchor" href="#partial-adaptive-indexes"></a>Partial Adaptive Indexes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/adaptive-indexing.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div class="paragraph">
<p>An adaptive index may also be a <a href="#learn:services-and-indexes/indexes/indexing-and-query-perf.adoc#partial-index" class="xref unresolved">partial index</a>.
For a partial adaptive index, you must ensure that any fields filtered by the WHERE clause in the index definition are also referenced by the <a href="metafun.html#pairs" class="xref page">PAIRS()</a> function.</p>
</div>
<div class="paragraph">
<p>For example, the following query <a href="#Q9">Q7</a> cannot select the index defined in <a href="#C9A">C7A</a>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="C9A" class="listingblock">
<div class="title">C7A</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-c9a.n1ql">CREATE INDEX ai_geo ON landmark
(DISTINCT PAIRS({geo.alt, geo.lat, geo.lon}))
WHERE activity = "see"; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The WHERE clause filters on <code>activity</code>, but the <a href="metafun.html#pairs" class="xref page">PAIRS()</a> function does not include the <code>activity</code> field.</td>
</tr>
</table>
</div>
<div id="Q9" class="listingblock">
<div class="title">Q7</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-q9.n1ql">EXPLAIN SELECT META(t).id FROM landmark t
WHERE t.geo.alt &gt; 1000 AND t.activity = "see";</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "plan": {
      "#operator": "Sequence",
      "~children": [
        {
          "#operator": "PrimaryScan3",
          "as": "t",
          "bucket": "travel-sample",
          "index": "def_inventory_landmark_primary", <i class="conum" data-value="1"></i><b>(1)</b>
// ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The query does not use the incorrectly-defined partial adaptive index.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>However, the same query <a href="#Q9">Q7</a> does select the partial adaptive index defined in <a href="#C9B">C7B</a>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="C9B" class="listingblock">
<div class="title">C7B</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-c9b.n1ql">CREATE INDEX ai_geo_activity ON landmark
(DISTINCT PAIRS({geo.alt, geo.lat, geo.lon, activity}))
WHERE activity = "see"; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The WHERE clause filters on <code>activity</code>, and the <a href="metafun.html#pairs" class="xref page">PAIRS()</a> function includes the <code>activity</code> field.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "plan": {
      "#operator": "Sequence",
      "~children": [
        {
          "#operator": "IntersectScan",
          "scans": [
            {
              "#operator": "DistinctScan",
              "scan": {
                "#operator": "IndexScan3",
                "as": "t",
                "bucket": "travel-sample",
                "index": "ai_geo_activity", <i class="conum" data-value="1"></i><b>(1)</b>
                "index_id": "29640ebd837e32fb",
                "index_projection": {
                  "primary_key": true
                },
// ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The query does an IntersectScan, including the correct partial adaptive index.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can use the <code>SELF</code> keyword to ensure that the fields used in the WHERE clause are included in the <a href="metafun.html#pairs" class="xref page">PAIRS()</a> function.
Refer to <a href="#C5">C5</a> for an example.</p>
</div>
<div class="paragraph">
<p>An IntersectScan does not eliminate redundant queries, and this may impact performance.
Refer to <a href="#section_m12_552_dbb">Performance Implications</a> for details.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="section_m12_552_dbb"><a class="anchor" href="#section_m12_552_dbb"></a>Performance Implications</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/adaptive-indexing.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div class="paragraph">
<p>While Adaptive Indexes are very useful, there are performance implications you need to keep in mind:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>If a query is not covered by a regular index, then an unnested index will not have any elimination of redundant indexes</strong>; and it will instead do an IntersectScan on all the indexes, which can impact performance.</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-perform-1.n1ql">CREATE INDEX idx_name ON hotel(name); <i class="conum" data-value="1"></i><b>(1)</b>
CREATE INDEX idx_self ON hotel(DISTINCT PAIRS(self)); <i class="conum" data-value="2"></i><b>(2)</b>
EXPLAIN SELECT * FROM hotel WHERE name IS NOT NULL;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Index on the <code>name</code> field.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Adaptive index on the whole document.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-perform-1.jsonc">[
  {
    "plan": {
      "#operator": "Sequence",
      "~children": [
        {
          "#operator": "IntersectScan", <i class="conum" data-value="1"></i><b>(1)</b>
          "scans": [
            {
              "#operator": "IndexScan3",
              "bucket": "travel-sample",
              "index": "idx_name",
// ...
            },
            {
              "#operator": "DistinctScan",
              "scan": {
                "#operator": "IndexScan3",
                "bucket": "travel-sample",
                "index": "idx_self",
// ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>IntersectScan of <code>idx_name</code> AND <code>idx_self</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s another example with a partial Adaptive Index that uses IntersectScan on the index conditions:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-perform-2.n1ql">CREATE INDEX idx_adpt ON landmark(DISTINCT PAIRS(self))
WHERE city="Paris";

CREATE INDEX idx_reg1 ON landmark(name) WHERE city="Paris";

CREATE INDEX idx_reg2 ON landmark(city);

SELECT * FROM landmark
WHERE city="Paris" AND name IS NOT NULL;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The above query requires only a regular index, so it uses index <code>idx_reg1</code> and ignores index <code>idx_reg2</code>.
When the adaptive index <code>idx_adpt</code> has only the clause <code>city="Paris"</code> and is used with the above query, then index <code>idx_adpt</code> will still use IntersectScan.
Here, we have only a single adaptive index instead of a reduction in the number of indexes.
To fix this, you may need to remove the index condition from the predicate while spanning generations.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="section_u4c_gzm_5z"><a class="anchor" href="#section_u4c_gzm_5z"></a>Functional Limitations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/adaptive-indexing.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div class="paragraph">
<p>It is important to understand that adaptive indexes are not a panacea and that they have trade-offs compared to traditional composite indexes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Adaptive Indexes are bound to the limitations of Array Indexes</strong> because they are built over <a href="indexing-arrays.html" class="xref page">Array Indexing</a> technology.
Index Joins can’t use Adaptive Indexes because Index Joins can’t use array indexes, and Adaptive Index is basically an array index.</p>
</li>
<li>
<p><strong>Indexed entries of the Adaptive Index are typically larger in size compared to the simple index</strong> on respective fields because the indexed items are elements of the <a href="metafun.html#pairs" class="xref page">PAIRS()</a> array, which are basically name-value pairs of the document fields.
So, it may be relatively slower when compared with equivalent simple index.
For example, in the following equivalent queries, <a href="#C7">C8</a>/<a href="#Q7">Q8</a> may perform better than <a href="#C8">C9</a>/<a href="#Q8">Q9</a>.</p>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>This example uses the <code>def_inventory_hotel_city</code> index, which is installed with the <code>travel-sample</code> bucket.</p>
</div>
<div id="C7" class="listingblock">
<div class="title">C8</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-c7.n1ql">CREATE INDEX `def_inventory_hotel_city`
ON `travel-sample`.`inventory`.`hotel`(`city`) WITH { "defer_build":true };</code></pre>
</div>
</div>
<div id="Q7" class="listingblock">
<div class="title">Q8</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-q7.n1ql">EXPLAIN SELECT city FROM hotel
USE INDEX (def_inventory_hotel_city)
WHERE city = "San Francisco";</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "plan": {
    "#operator": "Sequence",
    "~children": [
      {
        "#operator": "IndexScan3",
        "bucket": "travel-sample",
        "covers": [
          "cover ((`hotel`.`city`))",
          "cover ((meta(`hotel`).`id`))"
        ],
        "filter": "(cover ((`hotel`.`city`)) = \"San Francisco\")",
        "index": "def_inventory_hotel_city",
        "index_id": "581febfa2f2a8923",
        "index_projection": {
          "entry_keys": [
            0
          ]
        },
        "keyspace": "hotel",
        "namespace": "default",
        "scope": "inventory",
        "spans": [
          {
            "exact": true,
            "range": [
              {
                "high": "\"San Francisco\"",
                "inclusion": 3,
                "low": "\"San Francisco\""
              }
            ]
          }
        ],
        "using": "gsi"
      },
// ...</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div id="C8" class="listingblock">
<div class="title">C9</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-c8.n1ql">CREATE INDEX `ai_city` ON hotel(DISTINCT PAIRS({city}));</code></pre>
</div>
</div>
<div id="Q8" class="listingblock">
<div class="title">Q9</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-q8.n1ql">EXPLAIN SELECT city FROM hotel
USE INDEX (ai_city)
WHERE city = "San Francisco";</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "plan": {
    "#operator": "Sequence",
    "~children": [
      {
        "#operator": "DistinctScan",
        "scan": {
          "#operator": "IndexScan3",
          "bucket": "travel-sample",
          "index": "ai_city",
          "index_id": "64e238e4686486d2",
          "index_projection": {
            "primary_key": true
          },
          "keyspace": "hotel",
          "namespace": "default",
          "scope": "inventory",
          "spans": [
            {
              "exact": true,
              "range": [
                {
                  "high": "[\"city\", \"San Francisco\"]",
                  "inclusion": 3,
                  "low": "[\"city\", \"San Francisco\"]" <i class="conum" data-value="1"></i><b>(1)</b>
                }
              ]
            }
          ],
          "using": "gsi"
        }
      },
// ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Note how the index key values are represented in the spans.</td>
</tr>
</table>
</div>
</div>
</div>
</li>
<li>
<p><strong>Adaptive index requires more storage and memory</strong>, especially in case of Memory Optimized Indexes.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The size of the index and the number of indexed items in an Adaptive Index grow rapidly with the number of fields in the documents, as well as, with the number of different values for various fields in the documents or keyspace.</p>
</li>
<li>
<p>Moreover, if the documents have nested sub-objects, then the adaptive index will index the sub-documents and related fields at each level of nesting.</p>
</li>
<li>
<p>Similarly, if the documents have array fields, then each of array elements are explored and indexed.</p>
</li>
<li>
<p>For example, the following queries show that a single route document in <code>travel-sample</code> generates 103 index items and that all route documents produce ~2.3 million items.</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-limits-3.n1ql">SELECT array_length(PAIRS(self)) FROM route
LIMIT 1;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-limits-3.jsonc">[
  {
    "$1": 103
  }
]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-limits-4.n1ql">SELECT sum(array_length(PAIRS(self))) FROM route
LIMIT 1;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-limits-4.jsonc">[
  {
    "$1": 2285464
  }
]</code></pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>So, the generic adaptive indexes (with <code>SELF</code>) should be employed carefully.
Whenever applicable, it is recommended to use the following techniques to minimize the size and scope of the adaptive index:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Instead of <code>SELF</code>, use selective adaptive indexes by specifying the field names of interest to the <a href="metafun.html#pairs" class="xref page">PAIRS()</a> function.
For examples, refer to <a href="#C4">C4</a>, <a href="#Q1">Q1</a>, <a href="#Q2">Q2</a>, and <a href="#Q3">Q3</a> above.</p>
</li>
<li>
<p>Use partial adaptive indexes with a WHERE clause that will filter the number of documents that will be indexed.
For examples, refer to <a href="#C5">C5</a>, <a href="#Q5">Q5</a>, and <a href="#Q5A">Q5A</a> above.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>A generic adaptive index (on SELF) will be qualified for all queries on the keyspace</strong>.
So, when using with other GSI indexes, this will result in more IntersectScan operations for queries that qualify other non-adaptive indexes.
This may impact query performance and overall load on query and indexer nodes.
To alleviate the negative effects, you may want to specify the <code>USE INDEX</code> clause in <code>SELECT</code> queries whenever possible.</p>
</li>
<li>
<p><strong>Adaptive Indexes cannot be used as Covered Indexes</strong> for any queries.
See example <a href="#Q8">Q9</a> above.</p>
</li>
<li>
<p><strong>Adaptive Indexes can be created only on document field identifiers</strong>, not on functional expressions on the fields.
For example, the following query uses a default index, such as <code class="var">def_inventory_hotel_city</code>, instead of the specified adaptive index <code class="var">ai_city1</code>:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-c10.n1ql">CREATE INDEX `ai_city1`
ON hotel(DISTINCT PAIRS({"city" : LOWER(city)}));</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-q10.n1ql">EXPLAIN SELECT city FROM hotel
USE INDEX (ai_city1)
WHERE LOWER(city) = "san francisco";</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "plan": {
      "#operator": "Sequence",
      "~children": [
        {
          "#operator": "IndexScan3",
          "bucket": "travel-sample",
          "covers": [
            "cover ((`hotel`.`city`))",
            "cover ((meta(`hotel`).`id`))"
          ],
          "filter": "(lower(cover ((`hotel`.`city`))) = \"san francisco\")",
          "index": "def_inventory_hotel_city", <i class="conum" data-value="1"></i><b>(1)</b>
          "index_id": "581febfa2f2a8923",
// ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The query does not use the specified <code class="var">ai_city1</code> index because the index uses a functional index expression on the field <code>city</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</li>
<li>
<p><strong>Adaptive Indexes do not work with NOT LIKE predicates with a leading wildcard</strong> (see <a href="https://issues.couchbase.com/browse/MB-23981" target="_blank" rel="noopener">MB-23981</a>).
For example, the following query also uses a default index, such as <code class="var">def_city</code>, instead of the specified adaptive index <code class="var">ai_city</code>.
However, it works fine for LIKE predicates with a leading wildcard.</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">Query: NOT LIKE with leading wildcard</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-q11.n1ql">EXPLAIN SELECT city FROM hotel
USE INDEX (ai_city)
WHERE city NOT LIKE "%Francisco";</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "plan": {
      "#operator": "Sequence",
      "~children": [
        {
          "#operator": "IndexScan3",
          "bucket": "travel-sample",
          "covers": [
            "cover ((`hotel`.`city`))",
            "cover ((meta(`hotel`).`id`))"
          ],
          "filter": "(not (cover ((`hotel`.`city`)) like \"%Francisco\"))",
          "index": "def_inventory_hotel_city", <i class="conum" data-value="1"></i><b>(1)</b>
          "index_id": "581febfa2f2a8923",
// ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Doesn&#8217;t use <code>ai_city</code> with <code>NOT LIKE</code> and leading wildcard.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Query: LIKE with leading wildcard</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-q12.n1ql">EXPLAIN SELECT city FROM hotel
USE INDEX (ai_city)
WHERE city LIKE "%Francisco";</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "plan": {
      "#operator": "Sequence",
      "~children": [
        {
          "#operator": "DistinctScan",
          "scan": {
            "#operator": "IndexScan3",
            "bucket": "travel-sample",
            "index": "ai_city", <i class="conum" data-value="1"></i><b>(1)</b>
            "index_id": "64e238e4686486d2",
// ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Uses <code>ai_city</code> with <code>LIKE</code> and leading wildcard.</td>
</tr>
</table>
</div>
</div>
</div>
</li>
<li>
<p><strong>Adaptive indexes can&#8217;t use Covered Scans</strong>.
An adaptive index can&#8217;t be a covering index, as seen in the following example:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-c13.n1ql">CREATE INDEX `ai_city2`
ON hotel(DISTINCT PAIRS({"city" : city}));</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/examples/n1ql-language-reference/adaptive-idx-q13.n1ql">EXPLAIN SELECT city FROM hotel
WHERE city = "San Francisco"; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>No index specified in query.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "plan": {
      "#operator": "Sequence",
      "~children": [
        {
          "#operator": "IndexScan3",
          "bucket": "travel-sample",
          "covers": [
            "cover ((`hotel`.`city`))",
            "cover ((meta(`hotel`).`id`))"
          ],
          "filter": "(cover ((`hotel`.`city`)) = \"San Francisco\")",
          "index": "def_inventory_hotel_city", <i class="conum" data-value="1"></i><b>(1)</b>
          "index_id": "581febfa2f2a8923",
// ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Doesn&#8217;t use <code>ai_city2</code> as a covering index.</td>
</tr>
</table>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2023 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Server","components":["server"],"url":"/home/server.html","latestVersions":{"server":"7.2"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../../../_/js/site.js"></script>
<script defer src="../../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
</body>
</html>
