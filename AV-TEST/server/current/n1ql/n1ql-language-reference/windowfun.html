<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<script>(window.dataLayer=window.dataLayer||[]).push({event:'gtm.js','gtm.start':+new Date()})</script>
<script async src="https://www.googletagmanager.com/gtm.js?id=GTM-MVPNN2"></script>
<title>Window Functions | Couchbase Docs</title>
<link rel="stylesheet" href="../../../../_/css/site.css">
<script src="../../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="Window functions are used to compute cumulative, moving, and reporting aggregations.">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="server">
<meta name="dcterms.identifier" content="7.2">
<meta name="page-url" content="/server/current/n1ql/n1ql-language-reference/windowfun.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://docs.couchbase.com/home/index.html">
                    <img src="../../../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://docs.couchbase.com/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../cloud/index.html">
                      Capella
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/pages/n1ql-language-reference/windowfun.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../../introduction/intro.html">Couchbase Server</a></li>
<li class="crumb"><a href="../query.html">Query</a></li>
<li class="crumb"><a href="index.html">SQL++ Language Reference</a></li>
<li class="crumb"><a href="functions.html">Functions</a></li>
<li class="crumb"><a href="windowfun.html">Window Functions</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Window Functions</h1>
<div class="labels">
<ul><li class="reference"><span><i class="fas fa-book"></i></i> reference</span></li>
</ul>
</div>
<div class="labels">
<ul>
<li class="edition"><a href="https://www.couchbase.com/products/editions">enterprise edition</a></li>
</ul>
</div>


</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<style type="text/css">
  /* DOC-10177 */
  .hdlist table tr td.hdlist1,
  .hdlist table tr td.hdlist2 {
    padding: 1.5rem 0 0;
  }

  /* Compact horizontal definition lists */
  .hdlist.compact,
  .hdlist.compact {
    padding-top: 1rem;
  }
  .hdlist.compact table tr td.hdlist1,
  .hdlist.compact table tr td.hdlist2 {
    padding: 0.5rem 0 0;
  }

  /* Descriptions in horizontal description lists should have left padding */
  .hdlist table tr td.hdlist2,
  .hdlist.compact table tr td.hdlist2 {
    padding-left: 1rem;
  }

  /* Paragraphs in horizontal description lists should not have left margin */
  .hdlist table .hdlist1 + .hdlist2 p {
    margin-left: 0; !important
  }

  /* Horizontal definitions should match style of vertical definitions */
  td.hdlist1 {
    font-weight: 600;
  }
</style>
<div class="quoteblock abstract">
<blockquote>
Window functions are used to compute cumulative, moving, and reporting aggregations.
</blockquote>
</div>
<div class="paragraph">
<p>Window functions are used to compute an aggregate or cumulative value, based on a group of objects.
The objects are not grouped into a single output object â€” each object remains separate in the query output.</p>
</div>
<div class="paragraph">
<p>All window functions must have a window definition.
This divides the query result set into one or more partitions, and determines the order of objects in those partitions.
Within each partition, a movable window frame is defined for every input object.
The window frame determines the objects to be used by the window function.</p>
</div>
<div class="paragraph">
<p>N1QL has a dedicated set of window functions.
Each window function call includes an OVER clause, which introduces the window specification.
Some window functions take additional window options, which are specified by further clauses before the OVER clause.</p>
</div>
<div class="paragraph">
<p>In Couchbase Server Enterprise Edition, <a href="aggregatefun.html" class="xref page">aggregate functions</a> can also be used as window functions when they are used with an OVER clause.</p>
</div>
<div class="paragraph">
<p>In Couchbase Server 7.0 and later, window functions (and aggregate functions used as window functions) may specify their own inline window definitions, or they may refer to a named window defined by the WINDOW clause elsewhere in the query.
By defining a named window with the WINDOW clause, you can reuse the window definition across several functions in the query, potentially making the query easier to write and maintain.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="syntax"><a class="anchor" href="#syntax"></a>Syntax</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section shows the generic syntax of window functions, including window options and the OVER clause.
See the sections below for details of the syntax of individual window functions.</p>
</div>
<div class="sect2">
<h3 id="window-function"><a class="anchor" href="#window-function"></a>Window Function</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/n1ql.ebnf#L289-L290">window-function ::= window-function-name '(' window-function-arguments ')'
                    window-function-options? over-clause</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/window-function.png" alt="Syntax diagram">
</div>
</div>
<div class="hdlist compact">
<table>
<tr>
<td class="hdlist1">
window-function-arguments
</td>
<td class="hdlist2">
<p><a href="#window-function-arguments">Window Function Arguments</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
<tr>
<td class="hdlist1">
window-function-options
</td>
<td class="hdlist2">
<p><a href="#window-function-options">Window Function Options</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
<tr>
<td class="hdlist1">
over-clause
</td>
<td class="hdlist2">
<p><a href="#over-clause">OVER Clause</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="window-function-arguments"><a class="anchor" href="#window-function-arguments"></a>Window Function Arguments</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/n1ql.ebnf#L294">window-function-arguments ::= ( expr ( ',' expr ( ',' expr )? )? )?</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/window-function-arguments.png" alt="Syntax diagram">
</div>
</div>
<div class="paragraph">
<p>Refer to individual functions below for details of the arguments.</p>
</div>
</div>
<div class="sect2">
<h3 id="window-function-options"><a class="anchor" href="#window-function-options"></a>Window Function Options</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/n1ql.ebnf#L298">window-function-options ::= nth-val-from? nulls-treatment?</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/window-function-options.png" alt="Syntax diagram">
</div>
</div>
<div class="hdlist compact">
<table>
<tr>
<td class="hdlist1">
nthval-from
</td>
<td class="hdlist2">
<p><a href="#nthval-from">From Modifier</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
<tr>
<td class="hdlist1">
nulls-treatment
</td>
<td class="hdlist2">
<p><a href="#nulls-treatment">Nulls Modifier</a> <span class="icon"><i class="fa fa-caret-down"></i></span></p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Window function options can only be used with some window functions, as described below.</p>
</div>
<div class="sect3">
<h4 id="nthval-from"><a class="anchor" href="#nthval-from"></a>From Modifier</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/n1ql.ebnf#L302">nthval-from ::= 'FROM' ( 'FIRST' | 'LAST' )</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/nthval-from.png" alt="Syntax diagram">
</div>
</div>
<div class="paragraph">
<p>The <strong>from modifier</strong> determines whether the computation begins at the first or last object in the window.</p>
</div>
<div class="paragraph">
<p>This clause can only be used with the <a href="#fn-window-nth-value">NTH_VALUE()</a> function.</p>
</div>
<div class="paragraph">
<p>This clause is optional.
If omitted, the default setting is <code>FROM FIRST</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="nulls-treatment"><a class="anchor" href="#nulls-treatment"></a>Nulls Modifier</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/n1ql.ebnf#L306">nulls-treatment ::= ( 'RESPECT' | 'IGNORE' ) 'NULLS'</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/nulls-treatment.png" alt="Syntax diagram">
</div>
</div>
<div class="paragraph">
<p>The <strong>nulls modifier</strong> determines whether NULL values are included in the computation, or ignored.
MISSING values are treated the same way as NULL values.</p>
</div>
<div class="paragraph">
<p>This clause can only be used with the <a href="#fn-window-first-value">FIRST_VALUE()</a>, <a href="#fn-window-last-value">LAST_VALUE()</a>, <a href="#fn-window-nth-value">NTH_VALUE()</a>, <a href="#fn-window-lag">LAG()</a>, and <a href="#fn-window-lead">LEAD()</a> functions.</p>
</div>
<div class="paragraph">
<p>This clause is optional.
If omitted, the default setting is <code>RESPECT NULLS</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="over-clause"><a class="anchor" href="#over-clause"></a>OVER Clause</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/n1ql.ebnf#L310">over-clause ::= 'OVER' ( '(' window-definition ')' | window-ref )</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/over-clause.png" alt="Syntax diagram">
</div>
</div>
<div class="paragraph">
<p>The OVER clause introduces the window specification for the function.
There are two ways of specifying the window.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An <em>inline window definition</em> specifies the window directly within the function call.
It is delimited by parentheses <code>()</code> and has exactly the same syntax as the window definition in a WINDOW clause.
For further details, refer to <a href="window.html#window-definition" class="xref page">Window Definition</a>.</p>
</li>
<li>
<p>A <em>window reference</em> is an <a href="identifiers.html" class="xref page">identifier</a> which refers to a named window.
The named window must be defined by a WINDOW clause in the same query block as the function call.
For further details, refer to <a href="window.html" class="xref page">WINDOW Clause</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>With some window functions, the window specification may include a <a href="window.html#window-partition-clause" class="xref page">window partition clause</a>, a <a href="window.html#window-order-clause" class="xref page">window order clause</a>, and a <a href="window.html#window-frame-clause" class="xref page">window frame clause</a>.
With other window functions, the window specification may only include a subset of these clauses.
Refer to individual functions below for details of the clauses permitted within the window specification.</p>
</div>
<div class="paragraph">
<p>Note that any restrictions on the clauses permitted in the window specification apply equally, whether the function has an inline window definition, or a reference to a named window.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="usage"><a class="anchor" href="#usage"></a>Usage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Window functions can only appear in the <a href="selectclause.html" class="xref page">SELECT</a> projection clause or query <a href="orderby.html" class="xref page">ORDER BY</a> clause.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Any expression within a window function may be a subquery.
However, this will lead to repeated evaluation when the query is processed.
If required, use a <a href="let.html" class="xref page">LET clause</a>, a <a href="with.html" class="xref page">WITH clause</a>, or an intervening <a href="subqueries.html" class="xref page">subquery</a> to avoid repeated evaluation.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
An expression within the window function may not contain another, nested window function.
If necessary, you can specify one window function in a <a href="subqueries.html" class="xref page">subquery</a>, and another window function in the parent query.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Window functions are processed after <a href="join.html" class="xref page">JOIN</a> clauses, the <a href="let.html" class="xref page">LET</a> clause, the <a href="where.html" class="xref page">WHERE</a> clause, and the <a href="groupby.html" class="xref page">GROUP BY</a>, <a href="groupby.html" class="xref page">LETTING</a>, and <a href="groupby.html" class="xref page">HAVING</a> clauses.
Window functions therefore operate on the query result set.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fn-window-cume-dist"><a class="anchor" href="#fn-window-cume-dist"></a>CUME_DIST()</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="description"><a class="anchor" href="#description"></a>Description</h3>
<div class="paragraph">
<p>Returns the percentile rank of the current object as part of the cumulative distribution&#8201;&#8212;&#8201;that is, the number of objects ranked lower than or equal to the current object, including the current object, divided by the total number of objects in the window partition.</p>
</div>
</div>
<div class="sect2">
<h3 id="syntax-2"><a class="anchor" href="#syntax-2"></a>Syntax</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf">cume-dist-function ::= 'CUME_DIST' '()' 'OVER' ( '(' window-definition ')' | window-ref )</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/fn-window-cume-dist.png" alt="Syntax diagram">
</div>
</div>
</div>
<div class="sect2">
<h3 id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h3>
<div class="paragraph">
<p>None.</p>
</div>
</div>
<div class="sect2">
<h3 id="window-specification"><a class="anchor" href="#window-specification"></a>Window Specification</h3>
<div class="paragraph">
<p>The window specification may include an optional <a href="window.html#window-partition-clause" class="xref page">window partition clause</a>,
and must include a <a href="window.html#window-order-clause" class="xref page">window order clause</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="return-value"><a class="anchor" href="#return-value"></a>Return Value</h3>
<div class="paragraph">
<p>A number greater than 0 and less than or equal to 1.
The higher the value, the higher the ranking.</p>
</div>
</div>
<div class="sect2">
<h3 id="example"><a class="anchor" href="#example"></a>Example</h3>
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/windowfun.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>For each destination airport, find the cumulative distribution of all routes in order of distance:</p>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT d.id, d.destinationairport, CUME_DIST() OVER (
  PARTITION BY d.destinationairport
  ORDER BY d.distance NULLS LAST
) AS `rank`
FROM route AS d
LIMIT 7;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
      "destinationairport": "AAE",
      "id": 10201,
      "rank": 0.25
  },
  {
      "destinationairport": "AAE",
      "id": 10190,
      "rank": 0.5
  },
  {
      "destinationairport": "AAE",
      "id": 10240,
      "rank": 0.75
  },
  {
      "destinationairport": "AAE",
      "id": 10136,
      "rank": 1
  },
  {
      "destinationairport": "AAL",
      "id": 14392,
      "rank": 0.3333333333333333
  },
  {
      "destinationairport": "AAL",
      "id": 14867,
      "rank": 0.6666666666666666
  },
  {
      "destinationairport": "AAL",
      "id": 22505,
      "rank": 1
  },
]</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fn-window-dense-rank"><a class="anchor" href="#fn-window-dense-rank"></a>DENSE_RANK()</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="description-2"><a class="anchor" href="#description-2"></a>Description</h3>
<div class="paragraph">
<p>Returns the dense rank of the current object&#8201;&#8212;&#8201;that is, the number of distinct objects preceding this object in the current window partition, plus one.</p>
</div>
<div class="paragraph">
<p>The objects are ordered by the <a href="window.html#window-order-clause" class="xref page">window order clause</a>.
If any objects are tied, they will have the same rank.</p>
</div>
<div class="paragraph">
<p>For this function, when any objects have the same rank, the rank of the next object will be consecutive, so there will not be a gap in the sequence of returned values.
For example, if there are three objects ranked 2, the next dense rank is 3.</p>
</div>
</div>
<div class="sect2">
<h3 id="syntax-3"><a class="anchor" href="#syntax-3"></a>Syntax</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf">dense-rank-function ::= 'DENSE_RANK' '()' 'OVER' ( '(' window-definition ')' | window-ref )</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/fn-window-dense-rank.png" alt="Syntax diagram">
</div>
</div>
</div>
<div class="sect2">
<h3 id="arguments-2"><a class="anchor" href="#arguments-2"></a>Arguments</h3>
<div class="paragraph">
<p>None.</p>
</div>
</div>
<div class="sect2">
<h3 id="window-specification-2"><a class="anchor" href="#window-specification-2"></a>Window Specification</h3>
<div class="paragraph">
<p>The window specification may include an optional <a href="window.html#window-partition-clause" class="xref page">window partition clause</a>,
and must include a <a href="window.html#window-order-clause" class="xref page">window order clause</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="return-values"><a class="anchor" href="#return-values"></a>Return Values</h3>
<div class="paragraph">
<p>An integer, greater than or equal to 1.</p>
</div>
</div>
<div class="sect2">
<h3 id="example-2"><a class="anchor" href="#example-2"></a>Example</h3>
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/windowfun.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>For each country, find the dense rank of all airports in order of altitude:</p>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT a.airportname, a.geo.alt, DENSE_RANK() OVER (
  PARTITION BY a.country
  ORDER BY a.geo.alt NULLS LAST
) AS `rank`
FROM airport AS a
LIMIT 10;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "airportname": "Croisette Heliport",
    "alt": 0,
    "rank": 1
  },
  {
    "airportname": "Andernos-Les-Bains",
    "alt": 0,
    "rank": 1
  },
  {
    "airportname": "La Defense Heliport",
    "alt": 0,
    "rank": 1
  },
  {
    "airportname": "Marigot Bus Stop",
    "alt": 0,
    "rank": 1
  },
  {
    "airportname": "Lille",
    "alt": 1,
    "rank": 2
  },
  {
    "airportname": "Le Palyvestre",
    "alt": 7,
    "rank": 3
  },
  {
    "airportname": "Frejus Saint Raphael",
    "alt": 7,
    "rank": 3
  },
  {
    "airportname": "Calais Dunkerque",
    "alt": 12,
    "rank": 4
  },
  {
    "airportname": "Cote D\\'Azur",
    "alt": 12,
    "rank": 4
  },
  {
    "airportname": "Propriano",
    "alt": 13,
    "rank": 5
  }
]</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fn-window-first-value"><a class="anchor" href="#fn-window-first-value"></a>FIRST_VALUE(<code>expr</code>)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="description-3"><a class="anchor" href="#description-3"></a>Description</h3>
<div class="paragraph">
<p>Returns the requested value from the first object in the current window frame, where the window frame is determined by the <a href="window.html#window-definition" class="xref page">window definition</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="syntax-4"><a class="anchor" href="#syntax-4"></a>Syntax</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf">first-value-function ::= 'FIRST_VALUE' '(' expr ')' nulls-treatment?
                         'OVER' ( '(' window-definition ')' | window-ref )</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/fn-window-first-value.png" alt="Syntax diagram">
</div>
</div>
</div>
<div class="sect2">
<h3 id="fn-window-first-value-args"><a class="anchor" href="#fn-window-first-value-args"></a>Arguments</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">expr</dt>
<dd>
<p>[Required] The value that you want to return from the first object in the window frame. <sup class="footnote" id="_footnote_disclaimer">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="fn-window-first-value-nulls"><a class="anchor" href="#fn-window-first-value-nulls"></a>Nulls Modifier</h4>
<div class="paragraph">
<p>The <a href="#nulls-treatment">nulls modifier</a> determines how NULL or MISSING values are treated when finding the first object in the window frame:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>IGNORE NULLS</code></dt>
<dd>
<p>If the values for any objects evaluate to NULL or MISSING, those objects are not included when finding the first object.
In this case, the function returns the first non-NULL, non-MISSING value.</p>
</dd>
<dt class="hdlist1"><code>RESPECT NULLS</code></dt>
<dd>
<p>If the values for any objects evaluate to NULL or MISSING, those objects are included when finding the first object.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If the <a href="#nulls-treatment">nulls modifier</a> is omitted, the default is <code>RESPECT NULLS</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="window-specification-3"><a class="anchor" href="#window-specification-3"></a>Window Specification</h3>
<div class="paragraph">
<p>The window specification may include an optional <a href="window.html#window-partition-clause" class="xref page">window partition clause</a>,
an optional <a href="window.html#window-order-clause" class="xref page">window order clause</a>,
and an optional <a href="window.html#window-frame-clause" class="xref page">window frame clause</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="return-values-2"><a class="anchor" href="#return-values-2"></a>Return Values</h3>
<div class="paragraph">
<p>The specified value from the first object.</p>
</div>
<div class="paragraph">
<p>If all values are NULL or MISSING it returns NULL.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In the following cases, this function may return unpredictable results.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the <a href="window.html#window-order-clause" class="xref page">window order clause</a> is omitted.</p>
</li>
<li>
<p>If the window frame is defined by <code>ROWS</code>, and there are tied objects in the window frame.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To make the function return deterministic results, add a <a href="window.html#window-order-clause" class="xref page">window order clause</a>, or add further ordering terms to the <a href="window.html#window-order-clause" class="xref page">window order clause</a> so that no objects are tied.</p>
</div>
<div class="paragraph">
<p>If the window frame is defined by <code>RANGE</code> or <code>GROUPS</code>, and there are tied objects in the window frame, the function returns the lowest value of the input expression.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="example-3"><a class="anchor" href="#example-3"></a>Example</h3>
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/windowfun.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>For each airport, show each route starting at that airport, including the distance of the route and the distance of the shortest route from that airport:</p>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT r.sourceairport, r.destinationairport, r.distance,
FIRST_VALUE(r.distance) OVER (
  PARTITION BY r.sourceairport
  ORDER BY r.distance
) AS `shortest_distance`
FROM route AS r
LIMIT 7;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
      "destinationairport": "MRS",
      "distance": 767.6526005881392,
      "shortest_distance": 767.6526005881392,
      "sourceairport": "AAE"
  },
  {
      "destinationairport": "LYS",
      "distance": 1015.6529968903878,
      "shortest_distance": 767.6526005881392,
      "sourceairport": "AAE"
  },
  {
      "destinationairport": "ORY",
      "distance": 1395.3690007167947,
      "shortest_distance": 767.6526005881392,
      "sourceairport": "AAE"
  },
  {
      "destinationairport": "CDG",
      "distance": 1420.6731433915318,
      "shortest_distance": 767.6526005881392,
      "sourceairport": "AAE"
  },
  {
      "destinationairport": "AAR",
      "distance": 99.89861063028253,
      "shortest_distance": 99.89861063028253,
      "sourceairport": "AAL"
  },
  {
      "destinationairport": "OSL",
      "distance": 352.33081791745275,
      "shortest_distance": 99.89861063028253,
      "sourceairport": "AAL"
  },
  {
      "destinationairport": "LGW",
      "distance": 928.284226131001,
      "shortest_distance": 99.89861063028253,
      "sourceairport": "AAL"
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Refer also to <a href="window.html#ex-3" class="xref page">WINDOW Clause example 3</a> for a query showing this function used with the WINDOW clause.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fn-window-lag"><a class="anchor" href="#fn-window-lag"></a>LAG(<code>expr</code> [, <code>offset</code> [, <code>default</code> ] ] )</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="description-4"><a class="anchor" href="#description-4"></a>Description</h3>
<div class="paragraph">
<p>Returns the value of an object at a given offset prior to the current object position.</p>
</div>
</div>
<div class="sect2">
<h3 id="syntax-5"><a class="anchor" href="#syntax-5"></a>Syntax</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf">lag-function ::= 'LAG' '(' expr ( ',' offset ( ',' default )? )? ')' nulls-treatment?
                 'OVER' ( '(' window-definition ')' | window-ref )</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/fn-window-lag.png" alt="Syntax diagram">
</div>
</div>
</div>
<div class="sect2">
<h3 id="fn-window-lag-args"><a class="anchor" href="#fn-window-lag-args"></a>Arguments</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">expr</dt>
<dd>
<p>[Required] The value that you want to return from the offset object. <sup class="footnoteref">[<a class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p>
</dd>
<dt class="hdlist1">offset</dt>
<dd>
<p>[Optional] A positive integer greater than 0.
If omitted, the default is 1.</p>
</dd>
<dt class="hdlist1">default</dt>
<dd>
<p>[Optional] The value to return when the offset goes out of window scope.
If omitted, the default is NULL.</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="fn-window-lag-nulls"><a class="anchor" href="#fn-window-lag-nulls"></a>Nulls Modifier</h4>
<div class="paragraph">
<p>The <a href="#nulls-treatment">nulls modifier</a> determines how NULL or MISSING values are treated when counting the offset:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>IGNORE NULLS</code></dt>
<dd>
<p>If the values for any objects evaluate to NULL or MISSING, those objects are not included when counting the offset.</p>
</dd>
<dt class="hdlist1"><code>RESPECT NULLS</code></dt>
<dd>
<p>If the values for any objects evaluate to NULL or MISSING, those objects are included when counting the offset.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If the <a href="#nulls-treatment">nulls modifier</a> is omitted, the default is <code>RESPECT NULLS</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="window-specification-4"><a class="anchor" href="#window-specification-4"></a>Window Specification</h3>
<div class="paragraph">
<p>The window specification may include an optional <a href="window.html#window-partition-clause" class="xref page">window partition clause</a>,
and must include a <a href="window.html#window-order-clause" class="xref page">window order clause</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="return-values-3"><a class="anchor" href="#return-values-3"></a>Return Values</h3>
<div class="paragraph">
<p>The specified value from the offset object.</p>
</div>
<div class="paragraph">
<p>If the offset object is out of scope, it returns the default value, or NULL if no default is specified.</p>
</div>
</div>
<div class="sect2">
<h3 id="example-4"><a class="anchor" href="#example-4"></a>Example</h3>
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/windowfun.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>For each airline, show each route operated by that airline, including the length of the route and the length of the next-shortest route:</p>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT r.airline, r.id, r.distance,
LAG(r.distance, 1, "No previous distance") OVER (
  PARTITION BY r.airline
  ORDER BY r.distance NULLS LAST
) AS `previous-distance`
FROM route AS r
LIMIT 7;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
      "airline": "2L",
      "distance": 770.9691328580009,
      "id": 125,
      "previous-distance": "No previous distance"
  },
  {
      "airline": "2L",
      "distance": 770.969132858001,
      "id": 117,
      "previous-distance": 770.9691328580009
  },
  {
      "airline": "2L",
      "distance": 922.7579695456559,
      "id": 118,
      "previous-distance": 770.969132858001
  },
  {
      "airline": "2L",
      "distance": 922.7579695456559,
      "id": 126,
      "previous-distance": 922.7579695456559
  },
  {
      "airline": "3F",
      "distance": 23.957943869396804,
      "id": 274,
      "previous-distance": "No previous distance"
  },
  {
      "airline": "3F",
      "distance": 23.957943869396804,
      "id": 276,
      "previous-distance": 23.957943869396804
  },
  {
      "airline": "3F",
      "distance": 26.397914084363418,
      "id": 282,
      "previous-distance": 23.957943869396804
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Refer also to <a href="window.html#ex-1" class="xref page">WINDOW Clause example 1</a> for a query showing this function used with the WINDOW clause.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fn-window-last-value"><a class="anchor" href="#fn-window-last-value"></a>LAST_VALUE(<code>expr</code>)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="description-5"><a class="anchor" href="#description-5"></a>Description</h3>
<div class="paragraph">
<p>Returns the requested value from the last object in the current window frame, where the window frame is specified by the <a href="window.html#window-definition" class="xref page">window definition</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="syntax-6"><a class="anchor" href="#syntax-6"></a>Syntax</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf">last-value-function ::= 'LAST_VALUE' '(' expr ')' nulls-treatment?
                        'OVER' ( '(' window-definition ')' | window-ref )</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/fn-window-last-value.png" alt="Syntax diagram">
</div>
</div>
</div>
<div class="sect2">
<h3 id="fn-window-last-value-args"><a class="anchor" href="#fn-window-last-value-args"></a>Arguments</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">expr</dt>
<dd>
<p>[Required] The value that you want to return from the last object in the window frame. <sup class="footnoteref">[<a class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="fn-window-last-value-nulls"><a class="anchor" href="#fn-window-last-value-nulls"></a>Nulls Modifier</h4>
<div class="paragraph">
<p>The <a href="#nulls-treatment">nulls modifier</a> determines how NULL or MISSING values are treated when finding the last object in the window frame:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>IGNORE NULLS</code></dt>
<dd>
<p>If the values for any objects evaluate to NULL or MISSING, those objects are not included when finding the last object.
In this case, the function returns the last non-NULL, non-MISSING value.</p>
</dd>
<dt class="hdlist1"><code>RESPECT NULLS</code></dt>
<dd>
<p>If the values for any objects evaluate to NULL or MISSING, those objects are included when finding the last object.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If the <a href="#nulls-treatment">nulls modifier</a> is omitted, the default is <code>RESPECT NULLS</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="window-specification-5"><a class="anchor" href="#window-specification-5"></a>Window Specification</h3>
<div class="paragraph">
<p>The window specification may include an optional <a href="window.html#window-partition-clause" class="xref page">window partition clause</a>,
an optional <a href="window.html#window-order-clause" class="xref page">window order clause</a>,
and an optional <a href="window.html#window-frame-clause" class="xref page">window frame clause</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="return-values-4"><a class="anchor" href="#return-values-4"></a>Return Values</h3>
<div class="paragraph">
<p>The specified value from the last object.</p>
</div>
<div class="paragraph">
<p>If all values are NULL or MISSING it returns NULL.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In the following cases, this function may return unpredictable results.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the <a href="window.html#window-order-clause" class="xref page">window order clause</a> is omitted.</p>
</li>
<li>
<p>If the <a href="window.html#window-frame-clause" class="xref page">window frame clause</a> is omitted.</p>
</li>
<li>
<p>If the window frame is defined by <code>ROWS</code>, and there are tied objects in the window frame.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To make the function return deterministic results, add a <a href="window.html#window-order-clause" class="xref page">window order clause</a>, or add further ordering terms to the <a href="window.html#window-order-clause" class="xref page">window order clause</a> so that no objects are tied.</p>
</div>
<div class="paragraph">
<p>If the window frame is defined by <code>RANGE</code> or <code>GROUPS</code>, and there are tied objects in the window frame, the function returns the highest value of the input expression.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="example-5"><a class="anchor" href="#example-5"></a>Example</h3>
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/windowfun.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>For each airport, show each route starting at that airport, including the distance of the route and the distance of the longest route from that airport:</p>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT r.sourceairport, r.destinationairport, r.distance,
LAST_VALUE(r.distance) OVER (
  PARTITION BY r.sourceairport
  ORDER BY r.distance
  ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING <i class="conum" data-value="1"></i><b>(1)</b>
) AS `longest_distance`
FROM route AS r
LIMIT 7;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This clause specifies that the window frame should extend to the end of the window partition.
Without this clause, the end point of the window frame would always be the current object.
This would mean that the longest distance would always be the same as the current distance.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
      "destinationairport": "MRS",
      "distance": 767.6526005881392,
      "longest_distance": 1420.6731433915318,
      "sourceairport": "AAE"
  },
  {
      "destinationairport": "LYS",
      "distance": 1015.6529968903878,
      "longest_distance": 1420.6731433915318,
      "sourceairport": "AAE"
  },
  {
      "destinationairport": "ORY",
      "distance": 1395.3690007167947,
      "longest_distance": 1420.6731433915318,
      "sourceairport": "AAE"
  },
  {
      "destinationairport": "CDG",
      "distance": 1420.6731433915318,
      "longest_distance": 1420.6731433915318,
      "sourceairport": "AAE"
  },
  {
      "destinationairport": "AAR",
      "distance": 99.89861063028253,
      "longest_distance": 928.284226131001,
      "sourceairport": "AAL"
  },
  {
      "destinationairport": "OSL",
      "distance": 352.33081791745275,
      "longest_distance": 928.284226131001,
      "sourceairport": "AAL"
  },
  {
      "destinationairport": "LGW",
      "distance": 928.284226131001,
      "longest_distance": 928.284226131001,
      "sourceairport": "AAL"
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Refer also to <a href="window.html#ex-3" class="xref page">WINDOW Clause example 3</a> for a query showing this function used with the WINDOW clause.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fn-window-lead"><a class="anchor" href="#fn-window-lead"></a>LEAD(<code>expr</code> [, <code>offset</code> [, <code>default</code> ] ] )</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="description-6"><a class="anchor" href="#description-6"></a>Description</h3>
<div class="paragraph">
<p>Returns the value of an object at a given offset ahead of the current object position.</p>
</div>
</div>
<div class="sect2">
<h3 id="syntax-7"><a class="anchor" href="#syntax-7"></a>Syntax</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf">lead-function ::= 'LEAD' '(' expr ( ',' offset ( ',' default )? )? ')' nulls-treatment?
                  'OVER' ( '(' window-definition ')' | window-ref )</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/fn-window-lead.png" alt="Syntax diagram">
</div>
</div>
</div>
<div class="sect2">
<h3 id="fn-window-lead-args"><a class="anchor" href="#fn-window-lead-args"></a>Arguments</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">expr</dt>
<dd>
<p>[Required] The value that you want to return from the offset object. <sup class="footnoteref">[<a class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p>
</dd>
<dt class="hdlist1">offset</dt>
<dd>
<p>[Optional] A positive integer greater than 0.
If omitted, the default is 1.</p>
</dd>
<dt class="hdlist1">default</dt>
<dd>
<p>[Optional] The value to return when the offset goes out of window scope.
If omitted, the default is NULL.</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="fn-window-lead-nulls"><a class="anchor" href="#fn-window-lead-nulls"></a>Nulls Modifier</h4>
<div class="paragraph">
<p>The <a href="#nulls-treatment">nulls modifier</a> determines how NULL or MISSING values are treated when counting the offset:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>IGNORE NULLS</code></dt>
<dd>
<p>If the values for any objects evaluate to NULL or MISSING, those objects are not included when counting the offset.</p>
</dd>
<dt class="hdlist1"><code>RESPECT NULLS</code></dt>
<dd>
<p>If the values for any objects evaluate to NULL or MISSING, those objects are included when counting the offset.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If the <a href="#nulls-treatment">nulls modifier</a> is omitted, the default is <code>RESPECT NULLS</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="window-specification-6"><a class="anchor" href="#window-specification-6"></a>Window Specification</h3>
<div class="paragraph">
<p>The window specification may include an optional <a href="window.html#window-partition-clause" class="xref page">window partition clause</a>,
and must include a <a href="window.html#window-order-clause" class="xref page">window order clause</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="return-values-5"><a class="anchor" href="#return-values-5"></a>Return Values</h3>
<div class="paragraph">
<p>The specified value from the offset object.</p>
</div>
<div class="paragraph">
<p>If the offset object is out of scope, it returns the default value, or NULL if no default is specified.</p>
</div>
</div>
<div class="sect2">
<h3 id="example-6"><a class="anchor" href="#example-6"></a>Example</h3>
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/windowfun.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>For each airline, show each route operated by that airline, including the length of the route and the length of the next-longest route:</p>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT r.airline, r.id, r.distance,
LEAD(r.distance, 1, "No next distance") OVER (
  PARTITION BY r.airline
  ORDER BY r.distance NULLS LAST
) AS `next-distance`
FROM route AS r
LIMIT 7;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">  [
  {
      "airline": "2L",
      "distance": 770.9691328580009,
      "id": 125,
      "next-distance": 770.969132858001
  },
  {
      "airline": "2L",
      "distance": 770.969132858001,
      "id": 117,
      "next-distance": 922.7579695456559
  },
  {
      "airline": "2L",
      "distance": 922.7579695456559,
      "id": 118,
      "next-distance": 922.7579695456559
  },
  {
      "airline": "2L",
      "distance": 922.7579695456559,
      "id": 126,
      "next-distance": "No next distance"
  },
  {
      "airline": "3F",
      "distance": 23.957943869396804,
      "id": 274,
      "next-distance": 23.957943869396804
  },
  {
      "airline": "3F",
      "distance": 23.957943869396804,
      "id": 276,
      "next-distance": 26.397914084363418
  },
  {
      "airline": "3F",
      "distance": 26.397914084363418,
      "id": 282,
      "next-distance": 26.397914084363418
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Refer also to <a href="window.html#ex-1" class="xref page">WINDOW Clause example 1</a> for a query showing this function used with the WINDOW clause.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fn-window-nth-value"><a class="anchor" href="#fn-window-nth-value"></a>NTH_VALUE(<code>expr</code>, <code>offset</code>)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="description-7"><a class="anchor" href="#description-7"></a>Description</h3>
<div class="paragraph">
<p>Returns the requested value from an object in the current window frame, where the window frame is specified by the <a href="window.html#window-definition" class="xref page">window definition</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="syntax-8"><a class="anchor" href="#syntax-8"></a>Syntax</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf">nth-value-function ::= 'NTH_VALUE' '(' expr ',' offset ')' nth-val-from? nulls-treatment?
                       'OVER' ( '(' window-definition ')' | window-ref )</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/fn-window-nth-value.png" alt="Syntax diagram">
</div>
</div>
</div>
<div class="sect2">
<h3 id="fn-window-nth-value-args"><a class="anchor" href="#fn-window-nth-value-args"></a>Arguments</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">expr</dt>
<dd>
<p>[Required] The value that you want to return from the offset object in the window frame. <sup class="footnoteref">[<a class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p>
</dd>
<dt class="hdlist1">offset</dt>
<dd>
<p>[Required] The number of the offset object within the window frame, counting from 1.</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="fn-window-nth-value-from"><a class="anchor" href="#fn-window-nth-value-from"></a>From Modifier</h4>
<div class="paragraph">
<p>The <a href="#nthval-from">from modifier</a> determines where the function starts counting the offset.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>FROM FIRST</code></dt>
<dd>
<p>Offset counting starts at the first object in the window frame.
In this case, an offset of 1 is the first object in the window frame, 2 is the second object, and so on.</p>
</dd>
<dt class="hdlist1"><code>FROM LAST</code></dt>
<dd>
<p>Offset counting starts at the last object in the window frame.
In this case, an offset of 1 is the last object in the window frame, 2 is the second-to-last object, and so on.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="fn-window-nth-value-nulls"><a class="anchor" href="#fn-window-nth-value-nulls"></a>Nulls Modifier</h4>
<div class="paragraph">
<p>The <a href="#nulls-treatment">nulls modifier</a> determines how NULL or MISSING values are treated when counting the offset:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>IGNORE NULLS</code></dt>
<dd>
<p>If the values for any objects evaluate to NULL or MISSING, those objects are not included when counting the offset.</p>
</dd>
<dt class="hdlist1"><code>RESPECT NULLS</code></dt>
<dd>
<p>If the values for any objects evaluate to NULL or MISSING, those objects are included when counting the offset.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If the <a href="#nulls-treatment">nulls modifier</a> is omitted, the default is <code>RESPECT NULLS</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="window-specification-7"><a class="anchor" href="#window-specification-7"></a>Window Specification</h3>
<div class="paragraph">
<p>The window specification may include an optional <a href="window.html#window-partition-clause" class="xref page">window partition clause</a>,
an optional <a href="window.html#window-order-clause" class="xref page">window order clause</a>,
and an optional <a href="window.html#window-frame-clause" class="xref page">window frame clause</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="return-values-6"><a class="anchor" href="#return-values-6"></a>Return Values</h3>
<div class="paragraph">
<p>The specified value from the offset object.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In the following cases, this function may return unpredictable results.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the <a href="window.html#window-order-clause" class="xref page">window order clause</a> is omitted.</p>
</li>
<li>
<p>If the <a href="window.html#window-frame-clause" class="xref page">window frame clause</a> is omitted.</p>
</li>
<li>
<p>If the window frame is defined by <code>ROWS</code>, and there are tied objects in the window frame.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To make the function return deterministic results, add a <a href="window.html#window-order-clause" class="xref page">window order clause</a>, or add further ordering terms to the <a href="window.html#window-order-clause" class="xref page">window order clause</a> so that no objects are tied.</p>
</div>
<div class="paragraph">
<p>If the window frame is defined by <code>RANGE</code> or <code>GROUPS</code>, and there are tied objects in the window frame, the function returns the lowest value of the input expression when counting <code>FROM FIRST</code>, or the highest value of the input expression when counting <code>FROM LAST</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="examples"><a class="anchor" href="#examples"></a>Examples</h3>
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/windowfun.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>For each airport, show each route starting at that airport, including the distance of the route and the distance of the second shortest route from that airport:</p>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT r.sourceairport, r.destinationairport, r.distance,
NTH_VALUE(r.distance, 2) FROM FIRST OVER (
  PARTITION BY r.sourceairport
  ORDER BY r.distance
  ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING <i class="conum" data-value="1"></i><b>(1)</b>
) AS `shortest_distance_but_1`
FROM route AS r
LIMIT 7;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This clause specifies that the window frame should extend to the end of the window partition.
Without this clause, the end point of the window frame would always be the current object.
This would mean that for the route with the shortest distance, the function would be unable to find the route with the second shortest distance.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
      "destinationairport": "MRS",
      "distance": 767.6526005881392,
      "shortest_distance_but_1": 1015.6529968903878,
      "sourceairport": "AAE"
  },
  {
      "destinationairport": "LYS", <i class="conum" data-value="1"></i><b>(1)</b>
      "distance": 1015.6529968903878,
      "shortest_distance_but_1": 1015.6529968903878,
      "sourceairport": "AAE"
  },
  {
      "destinationairport": "ORY",
      "distance": 1395.3690007167947,
      "shortest_distance_but_1": 1015.6529968903878,
      "sourceairport": "AAE"
  },
  {
      "destinationairport": "CDG",
      "distance": 1420.6731433915318,
      "shortest_distance_but_1": 1015.6529968903878,
      "sourceairport": "AAE"
  },
  {
      "destinationairport": "AAR",
      "distance": 99.89861063028253,
      "shortest_distance_but_1": 352.33081791745275,
      "sourceairport": "AAL"
  },
  {
      "destinationairport": "OSL", <i class="conum" data-value="2"></i><b>(2)</b>
      "distance": 352.33081791745275,
      "shortest_distance_but_1": 352.33081791745275,
      "sourceairport": "AAL"
  },
  {
      "destinationairport": "LGW",
      "distance": 928.284226131001,
      "shortest_distance_but_1": 352.33081791745275,
      "sourceairport": "AAL"
  }
]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the route with the second shortest distance from AAE.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This is the route with the second shortest distance from AAL.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>For each airport, show each route starting at that airport, including the distance of the route and the distance of the second longest route from that airport:</p>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT r.sourceairport, r.destinationairport, r.distance,
NTH_VALUE(r.distance, 2) FROM LAST OVER (
  PARTITION BY r.sourceairport
  ORDER BY r.distance
  ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING <i class="conum" data-value="1"></i><b>(1)</b>
) AS `longest_distance_but_1`
FROM route AS r
LIMIT 7;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This clause specifies that the window frame should extend to the end of the window partition.
Without this clause, the end point of the window frame would always be the current object.
This would mean the function would be unable to find the route with the second longest distance for routes with shorter distances.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
      "destinationairport": "MRS",
      "distance": 767.6526005881392,
      "longest_distance_but_1": 1395.3690007167947,
      "sourceairport": "AAE"
  },
  {
      "destinationairport": "LYS",
      "distance": 1015.6529968903878,
      "longest_distance_but_1": 1395.3690007167947,
      "sourceairport": "AAE"
  },
  {
      "destinationairport": "ORY",
      "distance": 1395.3690007167947,
      "longest_distance_but_1": 1395.3690007167947, <i class="conum" data-value="1"></i><b>(1)</b>
      "sourceairport": "AAE"
  },
  {
      "destinationairport": "CDG",
      "distance": 1420.6731433915318,
      "longest_distance_but_1": 1395.3690007167947,
      "sourceairport": "AAE"
  },
  {
      "destinationairport": "AAR",
      "distance": 99.89861063028253,
      "longest_distance_but_1": 352.33081791745275,
      "sourceairport": "AAL"
  },
  {
      "destinationairport": "OSL",
      "distance": 352.33081791745275,
      "longest_distance_but_1": 352.33081791745275, <i class="conum" data-value="2"></i><b>(2)</b>
      "sourceairport": "AAL"
  },
  {
      "destinationairport": "LGW",
      "distance": 928.284226131001,
      "longest_distance_but_1": 352.33081791745275,
      "sourceairport": "AAL"
  }
]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the route with the second longest distance from AAE.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This is the route with the second longest distance from AAL.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fn-window-ntile"><a class="anchor" href="#fn-window-ntile"></a>NTILE(<code>num_tiles</code>)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="description-8"><a class="anchor" href="#description-8"></a>Description</h3>
<div class="paragraph">
<p>Divides the window partition into the specified number of tiles, and allocates each object in the window partition to a tile, so that as far as possible each tile has an equal number of objects.
When the set of objects is not equally divisible by the number of tiles, the function puts more objects into the lower-numbered tiles.
For each object, the function returns the number of the tile into which that object was placed.</p>
</div>
</div>
<div class="sect2">
<h3 id="syntax-9"><a class="anchor" href="#syntax-9"></a>Syntax</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf">ntile-function ::= 'NTILE' '(' num_tiles ')'
                   'OVER' ( '(' window-definition ')' | window-ref )</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/fn-window-ntile.png" alt="Syntax diagram">
</div>
</div>
</div>
<div class="sect2">
<h3 id="fn-window-ntile-args"><a class="anchor" href="#fn-window-ntile-args"></a>Arguments</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">num_tiles</dt>
<dd>
<p>[Required] The number of tiles into which you want to divide the window partition.
This argument can be an expression and must evaluate to a number.
If the number is not an integer, it will be truncated.
If the expression depends on an object, it evaluates from the first object in the window partition.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="window-specification-8"><a class="anchor" href="#window-specification-8"></a>Window Specification</h3>
<div class="paragraph">
<p>The window specification may include an optional <a href="window.html#window-partition-clause" class="xref page">window partition clause</a>,
and must include a <a href="window.html#window-order-clause" class="xref page">window order clause</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="return-values-7"><a class="anchor" href="#return-values-7"></a>Return Values</h3>
<div class="paragraph">
<p>An value greater than or equal to 1 and less than or equal to the number of tiles.</p>
</div>
</div>
<div class="sect2">
<h3 id="example-7"><a class="anchor" href="#example-7"></a>Example</h3>
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/windowfun.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>For each airline, allocate each route to one of three tiles by distance:</p>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT r.airline, r.distance, NTILE(3) OVER (
  PARTITION BY r.airline
  ORDER BY r.distance
) AS `ntile`
FROM route AS r
LIMIT 16;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "airline": "2L",
    "distance": 770.9691328580009,
    "ntile": 1
  },
  {
    "airline": "2L",
    "distance": 770.969132858001,
    "ntile": 1
  },
  {
    "airline": "2L",
    "distance": 922.7579695456559,
    "ntile": 2
  },
  {
    "airline": "2L",
    "distance": 922.7579695456559,
    "ntile": 3
  },
  {
    "airline": "3F",
    "distance": 23.957943869396804,
    "ntile": 1
  },
  {
    "airline": "3F",
    "distance": 23.957943869396804,
    "ntile": 1
  },
  {
    "airline": "3F",
    "distance": 26.397914084363418,
    "ntile": 1
  },
  {
    "airline": "3F",
    "distance": 26.397914084363418,
    "ntile": 1
  },
  {
    "airline": "3F",
    "distance": 31.613003135476145,
    "ntile": 2
  },
  {
    "airline": "3F",
    "distance": 31.613003135476145,
    "ntile": 2
  },
  {
    "airline": "3F",
    "distance": 60.49012512494272,
    "ntile": 2
  },
  {
    "airline": "3F",
    "distance": 60.490125124942736,
    "ntile": 2
  },
  {
    "airline": "3F",
    "distance": 63.640308584677314,
    "ntile": 3
  },
  {
    "airline": "3F",
    "distance": 63.640308584677314,
    "ntile": 3
  },
  {
    "airline": "3F",
    "distance": 91.53839302649642,
    "ntile": 3
  },
  {
    "airline": "3F",
    "distance": 91.53839302649642,
    "ntile": 3
  }
]</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fn-window-percent-rank"><a class="anchor" href="#fn-window-percent-rank"></a>PERCENT_RANK()</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="description-9"><a class="anchor" href="#description-9"></a>Description</h3>
<div class="paragraph">
<p>Returns the percentile rank of the current object&#8201;&#8212;&#8201;that is, the rank of the object minus one, divided by the total number of objects in the window partition minus one.</p>
</div>
</div>
<div class="sect2">
<h3 id="syntax-10"><a class="anchor" href="#syntax-10"></a>Syntax</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf">percent-rank-function ::= 'PERCENT_RANK' '()'
                          'OVER' ( '(' window-definition ')' | window-ref )</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/fn-window-percent-rank.png" alt="Syntax diagram">
</div>
</div>
</div>
<div class="sect2">
<h3 id="arguments-3"><a class="anchor" href="#arguments-3"></a>Arguments</h3>
<div class="paragraph">
<p>None.</p>
</div>
</div>
<div class="sect2">
<h3 id="window-specification-9"><a class="anchor" href="#window-specification-9"></a>Window Specification</h3>
<div class="paragraph">
<p>The window specification may include an optional <a href="window.html#window-partition-clause" class="xref page">window partition clause</a>,
and must include a <a href="window.html#window-order-clause" class="xref page">window order clause</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="return-values-8"><a class="anchor" href="#return-values-8"></a>Return Values</h3>
<div class="paragraph">
<p>A number between 0 and 1.
The higher the value, the higher the ranking.</p>
</div>
</div>
<div class="sect2">
<h3 id="example-8"><a class="anchor" href="#example-8"></a>Example</h3>
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/windowfun.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>For each destination airport, find the percentile rank of all routes in order of distance:</p>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT d.id, d.destinationairport, PERCENT_RANK() OVER (
  PARTITION BY d.destinationairport
  ORDER BY d.distance NULLS LAST
) AS `rank`
FROM route AS d
LIMIT 7;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
      "destinationairport": "AAE",
      "id": 10201,
      "rank": 0
  },
  {
      "destinationairport": "AAE",
      "id": 10190,
      "rank": 0.3333333333333333
  },
  {
      "destinationairport": "AAE",
      "id": 10240,
      "rank": 0.6666666666666666
  },
  {
      "destinationairport": "AAE",
      "id": 10136,
      "rank": 1
  },
  {
      "destinationairport": "AAL",
      "id": 14392,
      "rank": 0
  },
  {
      "destinationairport": "AAL",
      "id": 14867,
      "rank": 0.5
  },
  {
      "destinationairport": "AAL",
      "id": 22505,
      "rank": 1
  }
]</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fn-window-rank"><a class="anchor" href="#fn-window-rank"></a>RANK()</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="description-10"><a class="anchor" href="#description-10"></a>Description</h3>
<div class="paragraph">
<p>Returns the rank of the current object&#8201;&#8212;&#8201;that is, the number of distinct objects preceding this object in the current window partition, plus one.</p>
</div>
<div class="paragraph">
<p>The objects are ordered by the <a href="window.html#window-order-clause" class="xref page">window order clause</a>.
If any objects are tied, they will have the same rank.</p>
</div>
<div class="paragraph">
<p>When any objects have the same rank, the rank of the next object will include all preceding objects, so there may be a gap in the sequence of returned values.
For example, if there are three objects ranked 2, the next rank is 5.</p>
</div>
</div>
<div class="sect2">
<h3 id="syntax-11"><a class="anchor" href="#syntax-11"></a>Syntax</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf">rank-function ::= 'RANK' '()' 'OVER' ( '(' window-definition ')' | window-ref )</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/fn-window-rank.png" alt="Syntax diagram">
</div>
</div>
</div>
<div class="sect2">
<h3 id="arguments-4"><a class="anchor" href="#arguments-4"></a>Arguments</h3>
<div class="paragraph">
<p>None.</p>
</div>
</div>
<div class="sect2">
<h3 id="window-specification-10"><a class="anchor" href="#window-specification-10"></a>Window Specification</h3>
<div class="paragraph">
<p>The window specification may include an optional <a href="window.html#window-partition-clause" class="xref page">window partition clause</a>,
and must include a <a href="window.html#window-order-clause" class="xref page">window order clause</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="return-values-9"><a class="anchor" href="#return-values-9"></a>Return Values</h3>
<div class="paragraph">
<p>An integer, greater than or equal to 1.</p>
</div>
</div>
<div class="sect2">
<h3 id="example-9"><a class="anchor" href="#example-9"></a>Example</h3>
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/windowfun.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>For each country, find the rank of all airports in order of altitude:</p>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT a.airportname, a.geo.alt, RANK() OVER (
  PARTITION BY a.country
  ORDER BY a.geo.alt NULLS LAST
) AS `rank`
FROM airport AS a
LIMIT 10;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "airportname": "Croisette Heliport",
    "alt": 0,
    "rank": 1
  },
  {
    "airportname": "Andernos-Les-Bains",
    "alt": 0,
    "rank": 1
  },
  {
    "airportname": "La Defense Heliport",
    "alt": 0,
    "rank": 1
  },
  {
    "airportname": "Marigot Bus Stop",
    "alt": 0,
    "rank": 1
  },
  {
    "airportname": "Lille",
    "alt": 1,
    "rank": 5
  },
  {
    "airportname": "Le Palyvestre",
    "alt": 7,
    "rank": 6
  },
  {
    "airportname": "Frejus Saint Raphael",
    "alt": 7,
    "rank": 6
  },
  {
    "airportname": "Calais Dunkerque",
    "alt": 12,
    "rank": 8
  },
  {
    "airportname": "Cote D\\'Azur",
    "alt": 12,
    "rank": 8
  },
  {
    "airportname": "Propriano",
    "alt": 13,
    "rank": 10
  }
]</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fn-window-ratio-to-report"><a class="anchor" href="#fn-window-ratio-to-report"></a>RATIO_TO_REPORT(<code>expr</code>)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="description-11"><a class="anchor" href="#description-11"></a>Description</h3>
<div class="paragraph">
<p>Returns the fractional ratio of the specified value for each object to the sum of values for all objects in the window frame.
If the <a href="window.html#window-frame-clause" class="xref page">window frame clause</a> is not specified, the fractional ratio is calculated for the whole window partition.</p>
</div>
</div>
<div class="sect2">
<h3 id="syntax-12"><a class="anchor" href="#syntax-12"></a>Syntax</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf">ratio-to-report-function ::= 'RATIO_TO_REPORT' '(' expr ')'
                             'OVER' ( '(' window-definition ')' | window-ref )</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/fn-window-ratio-to-report.png" alt="Syntax diagram">
</div>
</div>
</div>
<div class="sect2">
<h3 id="fn-window-ratio-to-report-args"><a class="anchor" href="#fn-window-ratio-to-report-args"></a>Arguments</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">expr</dt>
<dd>
<p>[Required] The value for which you want to calculate the fractional ratio. <sup class="footnoteref">[<a class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="window-specification-11"><a class="anchor" href="#window-specification-11"></a>Window Specification</h3>
<div class="paragraph">
<p>The window specification may include an optional <a href="window.html#window-partition-clause" class="xref page">window partition clause</a>,
an optional <a href="window.html#window-order-clause" class="xref page">window order clause</a>,
and an optional <a href="window.html#window-frame-clause" class="xref page">window frame clause</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="return-values-10"><a class="anchor" href="#return-values-10"></a>Return Values</h3>
<div class="paragraph">
<p>A number between 0 and 1, representing the fractional ratio of the value for the current object to the sum of values for all objects in the current window frame.
The sum of values for all objects in the current window frame is 1.</p>
</div>
<div class="paragraph">
<p>If the input expression does not evaluate to a number, or the sum of values for all objects is zero, it returns NULL.</p>
</div>
</div>
<div class="sect2">
<h3 id="example-10"><a class="anchor" href="#example-10"></a>Example</h3>
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/windowfun.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>For each destination airport, calculate the distance of each route as a fraction of the total distance of all routes:</p>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT d.id, d.destinationairport, RATIO_TO_REPORT(d.distance) OVER (
  PARTITION BY d.destinationairport
) AS `distance-ratio`
FROM route AS d
LIMIT 7;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
      "destinationairport": "AAE",
      "distance-ratio": 0.3088857862487639,
      "id": 10136
  },
  {
      "destinationairport": "AAE",
      "distance-ratio": 0.22082544177013463,
      "id": 10190
  },
  {
      "destinationairport": "AAE",
      "distance-ratio": 0.3033841055547952,
      "id": 10240
  },
  {
      "destinationairport": "AAE",
      "distance-ratio": 0.16690466642630636,
      "id": 10201
  },
  {
      "destinationairport": "AAL",
      "distance-ratio": 0.25521719160354467,
      "id": 14867
  },
  {
      "destinationairport": "AAL",
      "distance-ratio": 0.6724194454614251,
      "id": 22505
  },
  {
      "destinationairport": "AAL",
      "distance-ratio": 0.07236336293503035,
      "id": 14392
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Refer also to <a href="window.html#ex-2" class="xref page">WINDOW Clause example 2</a> for a query showing this function used with the WINDOW clause.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fn-window-row-number"><a class="anchor" href="#fn-window-row-number"></a>ROW_NUMBER()</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="description-12"><a class="anchor" href="#description-12"></a>Description</h3>
<div class="paragraph">
<p>Returns a unique row number for every object in every window partition.
In each window partition, the row numbering starts at 1.</p>
</div>
<div class="paragraph">
<p>The <a href="window.html#window-order-clause" class="xref page">window order clause</a> determines the sort order of the objects.
If the <a href="window.html#window-order-clause" class="xref page">window order clause</a> is omitted, the return values may be unpredictable.</p>
</div>
</div>
<div class="sect2">
<h3 id="syntax-13"><a class="anchor" href="#syntax-13"></a>Syntax</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf">row-number-function ::= 'ROW_NUMBER' '()' 'OVER' ( '(' window-definition ')' | window-ref )</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/fn-window-row-number.png" alt="Syntax diagram">
</div>
</div>
</div>
<div class="sect2">
<h3 id="arguments-5"><a class="anchor" href="#arguments-5"></a>Arguments</h3>
<div class="paragraph">
<p>None.</p>
</div>
</div>
<div class="sect2">
<h3 id="window-specification-12"><a class="anchor" href="#window-specification-12"></a>Window Specification</h3>
<div class="paragraph">
<p>The window specification may include an optional <a href="window.html#window-partition-clause" class="xref page">window partition clause</a>,
and an optional <a href="window.html#window-order-clause" class="xref page">window order clause</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="return-values-11"><a class="anchor" href="#return-values-11"></a>Return Values</h3>
<div class="paragraph">
<p>An integer, greater than or equal to 1.</p>
</div>
</div>
<div class="sect2">
<h3 id="example-11"><a class="anchor" href="#example-11"></a>Example</h3>
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/windowfun.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>For each destination airport, number all routes in order of distance:</p>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT d.id, d.destinationairport, ROW_NUMBER() OVER (
  PARTITION BY d.destinationairport
  ORDER BY d.distance NULLS LAST
) AS `row`
FROM route AS d
LIMIT 7;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "destinationairport": "AAE",
    "id": 10201,
    "row": 1
  },
  {
    "destinationairport": "AAE",
    "id": 10190,
    "row": 2
  },
  {
    "destinationairport": "AAE",
    "id": 10240,
    "row": 3
  },
  {
    "destinationairport": "AAE",
    "id": 10136,
    "row": 4
  },
  {
    "destinationairport": "AAL",
    "id": 14392,
    "row": 1
  },
  {
    "destinationairport": "AAL",
    "id": 14867,
    "row": 2
  },
  {
    "destinationairport": "AAL",
    "id": 22505,
    "row": 3
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Refer also to <a href="window.html#ex-2" class="xref page">WINDOW Clause example 2</a> for a query showing this function used with the WINDOW clause.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="related-links"><a class="anchor" href="#related-links"></a>Related Links</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="aggregatefun.html" class="xref page">Aggregate Functions</a></p>
</li>
<li>
<p><a href="window.html" class="xref page">WINDOW Clause</a></p>
</li>
</ul>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. If the query contains the <a href="groupby.html" class="xref page">GROUP BY</a> clause or <a href="aggregatefun.html" class="xref page">aggregate functions</a>, this expression must only depend on GROUP BY expressions or aggregate functions.
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>Â© 2023 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Server","components":["server"],"url":"/home/server.html","latestVersions":{"server":"7.2"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../../../_/js/site.js"></script>
<script defer src="../../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
</body>
</html>
