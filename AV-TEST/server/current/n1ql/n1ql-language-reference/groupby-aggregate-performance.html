<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<script>(window.dataLayer=window.dataLayer||[]).push({event:'gtm.js','gtm.start':+new Date()})</script>
<script async src="https://www.googletagmanager.com/gtm.js?id=GTM-MVPNN2"></script>
<title>Grouping and Aggregate Pushdown | Couchbase Docs</title>
<link rel="stylesheet" href="../../../../_/css/site.css">
<script src="../../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="SQL++ Pushdowns optimize the performance of SQL++ queries by supporting grouping and aggregate expressions.">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="server">
<meta name="dcterms.identifier" content="7.2">
<meta name="page-url" content="/server/current/n1ql/n1ql-language-reference/groupby-aggregate-performance.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://docs.couchbase.com/home/index.html">
                    <img src="../../../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://docs.couchbase.com/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../cloud/index.html">
                      Capella
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/pages/n1ql-language-reference/groupby-aggregate-performance.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../../introduction/intro.html">Couchbase Server</a></li>
<li class="crumb"><a href="groupby-aggregate-performance.html">Grouping and Aggregate Pushdown</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Grouping and Aggregate Pushdown</h1>
<div class="labels">
<ul></ul>
</div>
<div class="labels">
<ul>
<li class="edition"><a href="https://www.couchbase.com/products/editions">enterprise edition</a></li>
</ul>
</div>


</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
SQL++ Pushdowns optimize the performance of SQL++ queries by supporting grouping and aggregate expressions.
</blockquote>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Examples on this Page</div>
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/groupby-aggregate-performance.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Overview"><a class="anchor" href="#Overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Grouping and aggregate pushdown improves the performance of SQL++ queries with groupings and aggregations.</p>
</div>
<div class="paragraph">
<p>After the optimizer selects an index for a query block, it attempts the two optimizations below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pagination optimization, by pushing the OFFSET and LIMIT parameters to the index scan.</p>
</li>
<li>
<p>Grouping and aggregate pushdown to the indexer (introduced in Couchbase 5.5).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Prior to Couchbase Server 5.5, when a query contained aggregation and/or grouping, the query engine would fetch all relevant data from the indexer and group the data itself, even if the query was covered by an index.
With Couchbase Server 5.5 (Enterprise Edition) and later, the query intelligently requests the indexer to perform grouping and aggregation in addition to range scan.
The Indexer has been enhanced to perform grouping, COUNT(), SUM(), MIN(), MAX(), AVG(), and related operations.</p>
</div>
<div class="paragraph">
<p>You do not need to make any changes to the query to use this feature, but a good index design is required to cover the query and order the keys.
Not every query will benefit from this optimization, and not every index can accelerate every grouping and aggregation.
Understanding the right patterns will help you to design your indexes and queries.
Grouping and aggregate pushdown is supported on both storage engines: Standard GSI and Memory Optimized GSI (MOI).</p>
</div>
<div class="paragraph">
<p>This reduction step reduces the amount of data transfer and disk I/O, resulting in:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Improved query response time</p>
</li>
<li>
<p>Improved resource utilization</p>
</li>
<li>
<p>Low latency</p>
</li>
<li>
<p>High scalability</p>
</li>
<li>
<p>Low TCO</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s compare query performance with and without grouping and aggregate pushdown.
Consider the following generic example index and query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE INDEX <em>idx_expr</em> ON <em>keyspace_ref</em> (<em>a</em>);

SELECT <em>a</em>, <em>aggregate_function</em>(<em>a</em>)
FROM <em>keyspace_ref</em>
WHERE <em>a</em> IS NOT MISSING
GROUP BY <em>a</em>;</pre>
</div>
</div>
<div class="paragraph">
<p>Without grouping and aggregate pushdown, the query engine fetches relevant data from the indexer, and then the query engine groups and aggregates the data, as shown in the typical query execution plan below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/GBAP_Ex0_QP_before55.png" alt="Execution plan with 6 steps: Authorize, IndexScan3, Filter, Group, Project with 2 terms, and Stream">
</div>
</div>
<div class="paragraph">
<p>With grouping and aggregate pushdown, the query uses the same index, but the indexer does the grouping and aggregation as well.
In the typical query execution plan below, you can see fewer steps, and note the lack of the grouping step after the index scan.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/GBAP_Ex0_QP_after55.png" alt="Execution plan with 4 items: Authorize, IndexScan3, Project with 2 terms, and Stream">
</div>
</div>
<div class="paragraph">
<p>With grouping and aggregate pushdown, this simple generic query typically executes in less than a third of the time.
As the data and query complexity grows, the performance benefit (both latency and throughput) will grow as well.</p>
</div>
<div class="paragraph">
<p>The query plan shows the accelerated aggregation details.
For details, see <a href="#section_bpf_wjf_ycb">Appendix: Query Plan Fields</a>.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s how a query executes when the indexer handles the grouping and aggregation.
Note that the query engine does not fetch any data from the data service (KV service).</p>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="../_images/diag-87881c6e40b022bdd29624d2ff90c9ce5f695802.svg" alt="Query execution process, showing grouping and aggregation pushed down to the indexer">
</div>
<div class="title">Figure 1. Query execution process, showing grouping and aggregation pushed down to the indexer</div>
</div>
<div class="paragraph">
<p>For reference, this is how the same query would be executed without grouping and aggregate pushdown.</p>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="../_images/diag-ce08a566c86ce96edf653341c8e0acbd3acb75c3.svg" alt="Query execution process, showing grouping and aggregation performed by the query engine">
</div>
<div class="title">Figure 2. Query execution process, showing grouping and aggregation performed by the query engine</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="examples-for-grouping-and-aggregation"><a class="anchor" href="#examples-for-grouping-and-aggregation"></a>Examples for Grouping and Aggregation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Consider a composite index:</p>
</div>
<div class="listingblock">
<div class="title">Example A</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx_grp_add ON airport
(geo.alt, geo.lat, geo.lon, id);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This section considers sample queries that can benefit from this optimization, and queries that cannot.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Positive Case examples of queries that use indexing grouping and aggregation</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT COUNT(*) FROM airport WHERE geo.alt &gt; 10;

SELECT COUNT(geo.alt) FROM airport
WHERE geo.alt BETWEEN 10 AND 30;

SELECT COUNT(geo.lat) FROM airport
WHERE geo.alt BETWEEN 10 AND 30 AND geo.lat = 40;

SELECT geo.alt, AVG(id), SUM(id), COUNT(geo.alt), MIN (geo.lon), MAX(ABS(geo.lon))
FROM airport WHERE geo.alt &gt; 100 GROUP BY geo.alt;

SELECT lat_count, SUM(id) FROM airport
WHERE geo.alt &gt; 100 GROUP BY geo.alt
LETTING lat_count = COUNT(geo.lat) HAVING lat_count &gt; 1;

SELECT AVG(DISTINCT geo.lat) FROM airport
WHERE geo.alt &gt; 100 GROUP BY geo.alt;

SELECT ARRAY_AGG(geo.alt) FROM airport
WHERE geo.alt &gt; 10;</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Negative Case examples</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT COUNT(*) FROM airport WHERE geo.lat &gt; 20;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This query has no predicate on the leading key <code>geo.alt</code>.
The index <code>idx_grp_add</code> cannot be used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT COUNT(*) FROM airport;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This query has no predicate at all.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT COUNT(v1) FROM airport
LET v1 = ROUND(geo.lat) WHERE geo.lat &gt; 10;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The aggregate depends on <code>LET</code> variable.</p>
</div>
<div class="sect2">
<h3 id="positive-query-examples-with-group-by-on-leading-index-keys"><a class="anchor" href="#positive-query-examples-with-group-by-on-leading-index-keys"></a>Positive query examples with GROUP BY on leading index keys</h3>
<div class="paragraph">
<p>The following example uses the <code>idx_grp_add</code> index defined previously:</p>
</div>
<div class="listingblock">
<div class="title">Example B</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx_grp_add ON airport
(geo.alt, geo.lat, geo.lon, id);</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the following query, the GROUP BY keys <code>(geo.alt, geo.lat)</code> are the leading keys of the index, so the index is naturally ordered and grouped by the order of the index key definition.
Therefore, the query below is suitable for indexer to handle grouping and aggregation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT geo.alt, geo.lat, SUM(geo.lon), AVG(id), COUNT(DISTINCT geo.lon)
FROM airport
WHERE geo.alt BETWEEN 10 AND 30
GROUP BY geo.alt, geo.lat
HAVING SUM(geo.lon) &gt; 1000;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The query plan shows that the index scan handles grouping and aggregation:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/GBAP_ExB_Plan.png" alt="Visual plan with three steps: IndexScan3 using idx_grp_add, Filter, and Project with 5 terms">
</div>
</div>
</div>
<div class="sect2">
<h3 id="positive-query-examples-with-group-by-on-non-leading-index-keys"><a class="anchor" href="#positive-query-examples-with-group-by-on-non-leading-index-keys"></a>Positive query examples with GROUP BY on non-leading index keys</h3>
<div class="paragraph">
<p>The following example uses the <code>idx_grp_add</code> index defined previously:</p>
</div>
<div class="listingblock">
<div class="title">Example C</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx_grp_add ON airport
(geo.alt, geo.lat, geo.lon, id);

SELECT geo.lat, id, SUM(geo.lon)
FROM airport
WHERE geo.alt BETWEEN 10 AND 30
GROUP BY geo.lat, id
HAVING SUM(geo.lon) &gt; 1000;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the indexer sends partial group aggregation, which the query merges to create the final group and aggregation.
In this scenario (when the grouping is on non-leading keys), any query with aggregation and DISTINCT modifier cannot be accelerated by the indexer, such as <code>COUNT(DISTINCT id)</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/GBAP_ExC_Plan.png" alt="Visual plan with 4 steps: IndexScan3 using idx_grp_add, Group, Filter, and Project with 3 terms">
</div>
</div>
</div>
<div class="sect2">
<h3 id="positive-query-examples-on-array-indexes-with-group-by-on-leading-index-keys"><a class="anchor" href="#positive-query-examples-on-array-indexes-with-group-by-on-leading-index-keys"></a>Positive query examples on array indexes with GROUP BY on leading index keys</h3>
<div class="paragraph">
<p>Consider the following index and query:</p>
</div>
<div class="listingblock">
<div class="title">Example D</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx_grp_add_distinct ON hotel
(geo.lat, geo.lon, DISTINCT public_likes, id);

SELECT geo.lat, geo.lon, SUM(id), AVG(id)
FROM hotel
WHERE geo.lat BETWEEN 10 AND 30
 AND geo.lon &gt; 50
 AND ANY v IN public_likes SATISFIES  v = "%a%" END
GROUP BY geo.lat, geo.lon
HAVING SUM(id) &gt; 100;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the predicates are on the leading keys up to and including the array key.
Therefore, indexer can efficiently do the grouping as seen by the optimal plan below.
Itâ€™s important to note the array index key is created with a <code>DISTINCT</code> modifier (not the <code>ALL</code> modifier) to get this optimization and that the <code>SATISFIES</code> clause in the <code>ANY</code> predicate must be that of equality (that is, <code>v = "%a%"</code>).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/GBAP_ExD_Plan.png" alt="Visual plan with 3 steps: IndexScan3 using idx_grp_add_distinct, Filter, and Project with 4 terms">
</div>
</div>
<div class="paragraph">
<p>Consider the index and query:</p>
</div>
<div class="listingblock">
<div class="title">Example E</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx_grp_add_all ON hotel
(ALL public_likes, geo.lat, geo.lon, id);

SELECT un, t.geo.lat, COUNT(un), AVG(t.geo.lat)
FROM hotel AS t
 UNNEST t.public_likes AS un
WHERE un &gt; "J"
GROUP BY un, t.geo.lat;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the <code>UNNEST</code> operation can use the index because the leading <code>ALL</code> array key is the array being unwound.
Note, the unwound operation repeats the parent document (<code>hotel</code>) and the <code>t.geo.lat</code> reference would have duplicates compared to the original <code>hotel</code> documents.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/GBAP_ExE_Plan.png" alt="Visual plan with two steps: IndexScan3 using idx_grp_add_all, and Project with 4 terms">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="query-qualification-and-pushdown"><a class="anchor" href="#query-qualification-and-pushdown"></a>Query Qualification and Pushdown</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Not every GROUP BY and aggregate query can be handled by the indexer.
Following are some simple rules that will help you to write the proper queries and design the required indexes to get the most of this feature.</p>
</div>
<div class="paragraph">
<p>The following are necessary in order for an indexer to execute GROUP BY and aggregates:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All the query predicates are able to convert into ranges and able to push to indexer.</p>
</li>
<li>
<p>The whole query must be covered by an index.</p>
<div class="ulist">
<ul>
<li>
<p>For a query to be covered by an index, every attribute referenced in the query should be in one index.</p>
</li>
<li>
<p>Query should not have operations such as joins, subquery, or derived table queries.</p>
</li>
</ul>
</div>
</li>
<li>
<p>GROUP BY keys and Aggregate expressions must be one of the following:</p>
<div class="ulist">
<ul>
<li>
<p>Index keys or document key</p>
</li>
<li>
<p>An expression based on index keys or document key</p>
</li>
</ul>
</div>
</li>
<li>
<p>GROUP BY and aggregate expressions must be simple.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scenarios-for-grouping-and-aggregation"><a class="anchor" href="#scenarios-for-grouping-and-aggregation"></a>Scenarios for Grouping and Aggregation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Like any feature in a query language, there are subtle variations between each query and index that affects this optimization.
We use the travel sample dataset to illustrate both positive and negative use cases.</p>
</div>
<div class="paragraph">
<p>The following table lists the scenarios and requirements for queries to request the indexer to do the grouping and acceleration.
When the requirements are unmet, the query will fetch the relevant data and then do the grouping and acceleration as usual.
No application changes are necessary.
The query plan generated reflects this decision.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">GROUP BY Scenarios</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#group-by-on-leading-keys">GROUP BY on leading keys</a></p>
</li>
<li>
<p><a href="#group-by-on-non-leading-keys">GROUP BY on non-leading keys</a></p>
</li>
<li>
<p><a href="#group-by-keys-in-different-order">GROUP BY keys in different CREATE INDEX order</a></p>
</li>
<li>
<p><a href="#group-by-on-expression">GROUP BY on expression</a></p>
</li>
<li>
<p><a href="#heterogeneous-data-types">Heterogeneous data types for GROUP BY key</a></p>
</li>
<li>
<p><a href="#group-by-meta-id">GROUP BY META().ID Primary Index</a></p>
</li>
<li>
<p><a href="#limit-with-group-by">LIMIT with GROUP BY on leading keys</a></p>
</li>
<li>
<p><a href="#offset-with-group-by">OFFSET with GROUP BY on leading keys</a></p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1">Aggregate Scenarios</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#aggregate-without-group-by">Aggregate without GROUP BY key</a></p>
</li>
<li>
<p><a href="#expression-in-aggregate-function">Expression in Aggregate function</a></p>
</li>
<li>
<p><a href="#sum-count-min-max-avg">SUM, COUNT, MIN, MAX, or AVG Aggregate functions</a></p>
</li>
<li>
<p><a href="#distinct-aggregates">DISTINCT aggregates</a></p>
</li>
<li>
<p><a href="#having-with-aggregate-function">HAVING with an aggregate function inside</a></p>
</li>
<li>
<p><a href="#letting-with-aggregate-function">LETTING with an aggregate function inside</a></p>
</li>
</ol>
</div>
</dd>
</dl>
</div>
<div class="sect2">
<h3 id="group-by-on-leading-keys"><a class="anchor" href="#group-by-on-leading-keys"></a>GROUP BY on leading keys</h3>
<div class="paragraph">
<p>One of the common cases is to have both predicates and GROUP BY on leading keys of the index.
First create the index so that the query is covered by the index.
You can then think about the order of the keys.</p>
</div>
<div class="paragraph">
<p>The query requires a predicate on leading keys to consider an index.
The simplest predicate is <code>IS NOT MISSING</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE INDEX <em>idx_expr</em> ON <em>keyspace_ref</em> (<em>a</em>, <em>b</em>, <em>c</em>);

SELECT <em>a</em>, <em>b</em>, <em>aggregate_function</em>(<em>c</em>) <i class="conum" data-value="1"></i><b>(1)</b>
FROM <em>keyspace_ref</em>
WHERE <em>a</em> IS NOT MISSING <i class="conum" data-value="2"></i><b>(2)</b>
GROUP BY <em>a</em>, <em>b</em>;</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Where <code><em>aggregate_function</em>(<em>c</em>)</code> is <code>MIN(<em>c</em>)</code>, <code>MAX(<em>c</em>)</code>, <code>COUNT(<em>c</em>)</code>, or <code>SUM(<em>c</em>)</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>1st index field must be in a WHERE clause</td>
</tr>
</table>
</div>
<div id="ex1" class="exampleblock">
<div class="title">Example 1. List the cities with the landmarks with the highest latitude</div>
<div class="content">
<div class="paragraph">
<p>Use the <code>MAX()</code> aggregate to find the highest landmark latitude in each state, group the results by <code>country</code> and <code>state</code>, and then sort in reverse order by the highest latitudes per <code>state</code>.</p>
</div>
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx1 ON landmark
(country, state, geo.lat);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT country, state, MAX(ROUND(geo.lat)) AS Max_Latitude
FROM landmark
WHERE country IS NOT MISSING
GROUP BY country, state
ORDER BY Max_Latitude DESC;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this query, we need to give the predicate <code>country IS NOT MISSING</code> (or any WHERE clause) to ensure this index is selected for the query.
Without a matching predicate, the query will use the primary index.</p>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "Max_Latitude": 60,
    "country": "United Kingdom",
    "state": null
  },
  {
    "Max_Latitude": 51,
    "country": "United Kingdom",
    "state": "England"
  },
  {
    "Max_Latitude": 50,
    "country": "France",
    "state": "Picardie"
  },
...
]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Plan</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "plan": {
    "#operator": "Sequence",
    "~children": [
      {
        "#operator": "Sequence",
        "~children": [
          {
            "#operator": "IndexScan3",
            "bucket": "travel-sample",
            "covers": [
              "cover ((`landmark`.`country`))",
              "cover ((`landmark`.`state`))",
              "cover (((`landmark`.`geo`).`lat`))",
              "cover ((meta(`landmark`).`id`))",
              "cover (max(round(cover (((`landmark`.`geo`).`lat`)))))"
            ],
            "index": "idx1",
            "index_group_aggs": {
              "aggregates": [
                {
                  "aggregate": "MAX",
                  "depends": [
                    2
                  ],
                  "expr": "round(cover (((`landmark`.`geo`).`lat`)))",
                  "id": 4,
                  "keypos": -1
                }
              ],
              "depends": [
                0,
                1,
                2
              ],
              "group": [
                {
                  "depends": [
                    0
                  ],
                  "expr": "cover ((`landmark`.`country`))",
                  "id": 0,
                  "keypos": 0
                },
                {
                  "depends": [
                    1
                  ],
                  "expr": "cover ((`landmark`.`state`))",
                  "id": 1,
                  "keypos": 1
                }
              ]
            },
...
          }
        ]
      }
    ]
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The query plan shows that grouping is executed by the indexer.
This is detailed in <a href="#table_bw2_nrf_ycb">Table 2</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="group-by-on-non-leading-keys"><a class="anchor" href="#group-by-on-non-leading-keys"></a>GROUP BY on non-leading keys</h3>
<div class="paragraph">
<p>When using GROUP BY on a non-leading key:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The indexer will return <em>pre-aggregated</em> results.</p>
</li>
<li>
<p>Results can have duplicate or out-of-order groups.
The SQL++ indexer will do 2nd level of aggregation and compute the final result.</p>
</li>
<li>
<p>The SQL++ indexer can pushdown only if the leading key has a predicate.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To use Aggregate Pushdown, use the following syntax for the index and query statements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE INDEX <em>idx_expr</em> ON <em>keyspace_ref</em> (<em>a</em>, <em>b</em>, <em>c</em>);</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Syntax A</div>
<div class="content">
<pre>SELECT <em>aggregate_function</em>(<em>a</em>), <em>b</em>, <em>aggregate_function</em>(<em>c</em>)
FROM <em>keyspace_ref</em>
WHERE <em>a</em> IS NOT MISSING
GROUP BY <em>b</em>;</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Syntax B</div>
<div class="content">
<pre>SELECT <em>aggregate_function</em>(<em>a</em>), <em>aggregate_function</em>(<em>b</em>), <em>c</em>
FROM <em>keyspace_ref</em>
WHERE <em>a</em> IS NOT MISSING
GROUP BY <em>c</em>;</pre>
</div>
</div>
<div id="ex2-a" class="exampleblock">
<div class="title">Example 2. List the states with their total number of landmarks and the lowest latitude of any landmark</div>
<div class="content">
<div class="paragraph">
<p>Use the <code>COUNT()</code> operator to find the total number of landmarks and use the <code>MIN()</code> operator to find the lowest landmark latitude in each state, group the results by <code>state</code>, and then sort in order by the lowest latitudes per <code>state</code>.
This example uses the <code>idx1</code> index defined previously:</p>
</div>
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx1 ON landmark
(country, state, geo.lat);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT COUNT(country) AS Total_landmarks, state, MIN(ROUND(geo.lat)) AS Min_Latitude
FROM landmark
WHERE country IN ["France", "United States", "United Kingdom"]
GROUP BY state
ORDER BY Min_Latitude;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Plan</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "plan": {
    "#operator": "Sequence",
    "~children": [
      {
        "#operator": "Sequence",
        "~children": [
          {
            "#operator": "IndexScan3",
            "bucket": "travel-sample",
            "covers": [
              "cover ((`landmark`.`country`))",
              "cover ((`landmark`.`state`))",
              "cover (((`landmark`.`geo`).`lat`))",
              "cover ((meta(`landmark`).`id`))",
              "cover (count(cover ((`landmark`.`country`))))",
              "cover (min(round(cover (((`landmark`.`geo`).`lat`)))))"
            ],
            "index": "idx1",
            "index_group_aggs": {
              "aggregates": [
                {
                  "aggregate": "COUNT",
                  "depends": [
                    0
                  ],
                  "expr": "cover ((`landmark`.`country`))",
                  "id": 4,
                  "keypos": 0
                },
                {
                  "aggregate": "MIN",
                  "depends": [
                    2
                  ],
                  "expr": "round(cover (((`landmark`.`geo`).`lat`)))",
                  "id": 5,
                  "keypos": -1
                }
              ],
              "depends": [
                0,
                1,
                2
              ],
              "group": [
                {
                  "depends": [
                    1
                  ],
                  "expr": "cover ((`landmark`.`state`))",
                  "id": 1,
                  "keypos": 1
                }
              ],
              "partial": true <i class="conum" data-value="1"></i><b>(1)</b>
            },
...
          }
        ]
      }
    ]
  }
}</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/GBAP_Ex2A_EP.png" alt="Query plan with 4 steps: IndexScan3 using idx1, Group, Project with 3 terms, and Order by Min Latitude">
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "Min_Latitude": 33,
    "Total_landmarks": 1900,
    "state": "California"
  },
  {
    "Min_Latitude": 41,
    "Total_landmarks": 8,
    "state": "Corse"
  },
  {
    "Min_Latitude": 43,
    "Total_landmarks": 2208,
    "state": null
  },
...
]</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>"partial": true</code> line means it was pre-aggregated.</td>
</tr>
</table>
</div>
<div id="ex2-b" class="exampleblock">
<div class="title">Example 3. List the number of landmarks by latitude and the state it&#8217;s in</div>
<div class="content">
<div class="paragraph">
<p>Use <code>COUNT(country)</code> for the total number of landmarks at each latitude.
At a particular latitude, the <code>state</code> will be the same; but an aggregate function on it is needed, so <code>MIN()</code> or <code>MAX()</code> is used to return the original value.</p>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT COUNT(country) Num_Landmarks, MIN(state) State_Name, ROUND(geo.lat) Latitude
FROM landmark
WHERE country IS NOT MISSING
GROUP BY ROUND(geo.lat)
ORDER BY ROUND(geo.lat);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "Latitude": 33,
    "Num_Landmarks": 227,
    "State_Name": "California"
  },
  {
    "Latitude": 34,
    "Num_Landmarks": 608,
    "State_Name": "California"
  },
  {
    "Latitude": 35,
    "Num_Landmarks": 27,
    "State_Name": "California"
  },
...
]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="group-by-keys-in-different-order"><a class="anchor" href="#group-by-keys-in-different-order"></a>GROUP BY keys in different CREATE INDEX order</h3>
<div class="paragraph">
<p>When using GROUP BY on keys in a different order than they appear in the CREATE INDEX statement, use the following syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE INDEX <em>idx_expr</em> ON <em>keyspace_ref</em>(<em>a</em>, <em>b</em>, <em>c</em>);

SELECT <em>aggregate_function</em>(<em>c</em>)
FROM <em>keyspace_ref</em>
WHERE <em>a</em> IS NOT MISSING
GROUP BY <em>b</em>, <em>a</em>;</pre>
</div>
</div>
<div id="ex3" class="exampleblock">
<div class="title">Example 4. List the landmarks with the lowest longitude</div>
<div class="content">
<div class="paragraph">
<p>Like <a href="#ex1">Example 1</a> with the GROUP BY fields swapped.</p>
</div>
<div class="paragraph">
<p>Use the <code>MIN()</code> operator to find the lowest landmark longitude in each city, group the results by <code>activity</code> and <code>city</code>, and then sort in reverse order by the lowest longitudes per <code>activity</code>.</p>
</div>
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx3 ON landmark
(activity, city, geo.lon);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT activity, city, MIN(ROUND(geo.lon)) AS Min_Longitude
FROM landmark
WHERE country IS NOT MISSING
GROUP BY activity, city
ORDER BY Min_Longitude, activity;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "Min_Longitude": -124,
    "activity": "buy",
    "city": "Eureka"
  },
  {
    "Min_Longitude": -123,
    "activity": "eat",
    "city": "Santa Rosa"
  },
  {
    "Min_Longitude": -123,
    "activity": "eat",
    "city": "Sebastopol"
  },
  {
    "Min_Longitude": -123,
    "activity": "see",
    "city": "Sebastopol"
  },
...
]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="group-by-on-expression"><a class="anchor" href="#group-by-on-expression"></a>GROUP BY on expression</h3>
<div class="paragraph">
<p>When grouping on an expression or operation, the indexer will return pre-aggregated results whenever the GROUP BY and leading index keys are not an exact match.</p>
</div>
<div class="paragraph">
<p>To use Aggregate Pushdown and avoid pre-aggregated results, use one of the two following syntaxes for the index and query statements:</p>
</div>
<div class="listingblock">
<div class="title">Syntax A: Field with an expression&#8201;&#8212;&#8201;GROUP BY and Index keys match</div>
<div class="content">
<pre>CREATE INDEX <em>idx_expr</em> ON <em>keyspace_ref</em>(<em>a</em>+<em>b</em>, <em>b</em>, <em>c</em>);

SELECT <em>aggregate_function</em>(<em>c</em>)
FROM <em>keyspace_ref</em>
WHERE <em>a</em> IS NOT MISSING
GROUP BY <em>a</em>+<em>b</em>;</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Syntax B: Operation on a field&#8201;&#8212;&#8201;GROUP BY and Index keys match</div>
<div class="content">
<pre>CREATE INDEX <em>idx_operation</em> ON <em>keyspace_ref</em> (LOWER(<em>a</em>), <em>b</em>, <em>c</em>);

SELECT <em>aggregate_function</em>(<em>c</em>)
FROM <em>keyspace_ref</em>
WHERE <em>a</em> IS NOT MISSING
GROUP BY LOWER(<em>a</em>);</pre>
</div>
</div>
<div class="paragraph">
<p>For comparison, the below index and query combination will yield pre-aggregated results.</p>
</div>
<div class="listingblock">
<div class="title">Pre-aggregated Syntax&#8201;&#8212;&#8201;the GROUP BY and Index keys don&#8217;t match</div>
<div class="content">
<pre>CREATE INDEX <em>idx_operation</em> ON <em>keyspace_ref</em> (<em>a</em>, <em>b</em>, <em>c</em>);

SELECT <em>aggregate_function</em>(<em>c</em>)
FROM <em>keyspace_ref</em>
WHERE <em>a</em> IS NOT MISSING
GROUP BY UPPER(<em>a</em>);</pre>
</div>
</div>
<div id="ex4-a" class="exampleblock">
<div class="title">Example 5. A field with an expression</div>
<div class="content">
<div class="paragraph">
<p>Let&#8217;s say the distance of a flight feels like "nothing" when it&#8217;s direct, but feels like the true distance when there is one layover.
Then we can list and group by flight distances by calculating the distance multiplied by the stops it makes.</p>
</div>
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx4_expr ON route
(ROUND(distance*stops), ROUND(distance), sourceairport);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT ROUND(distance*stops) AS Distance_Feels_Like,
       MAX(ROUND(distance)) AS Distance_True,
       COUNT(sourceairport) Number_of_Airports
FROM route
WHERE ROUND(distance*stops) IS NOT MISSING
GROUP BY ROUND(distance*stops);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Plan</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">...
        "index_group_aggs": {
          "aggregates": [
            {
              "aggregate": "COUNT",
              "depends": [
                2
              ],
              "expr": "cover ((`route`.`sourceairport`))",
              "id": 4,
              "keypos": 2
            },
            {
              "aggregate": "MAX",
              "depends": [
                1
              ],
              "expr": "cover (round((`route`.`distance`)))",
              "id": 5,
              "keypos": 1
            }
          ],
          "depends": [
            0,
            1,
            2
          ],
          "group": [
            {
              "depends": [
                0
              ],
              "expr": "cover (round(((`route`.`distance`) * (`route`.`stops`))))",
              "id": 0,
              "keypos": 0
            }
          ]
        },
...</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/GBAP_Ex4A_VP.png" alt="Query plan with 2 steps: IndexScan3 using idx4_expr, and Project with 3 terms">
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "Distance_Feels_Like": 0,
    "Distance_True": 13808,
    "Number_of_Airports": 24018
  },
  {
    "Distance_Feels_Like": 309,
    "Distance_True": 309,
    "Number_of_Airports": 1
  },
  {
    "Distance_Feels_Like": 1055,
    "Distance_True": 1055,
    "Number_of_Airports": 1
  },
...
]</code></pre>
</div>
</div>
</div>
</div>
<div id="ex4-b" class="exampleblock">
<div class="title">Example 6. An operation on a field</div>
<div class="content">
<div class="paragraph">
<p>Let&#8217;s say the distance of a flight feels like "nothing" when it&#8217;s direct, but feels like the true distance when there is one layover.
Then we can list and group by the uppercase of the airport codes and listing the flight distances by calculating the distance multiplied by the stops it makes along with the total distance.</p>
</div>
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx4_oper ON route
(sourceairport, ROUND(distance*stops), distance);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT UPPER(sourceairport) AS Airport_Code,
       MIN(ROUND(distance*stops)) AS Distance_Feels_Like,
       SUM(ROUND(distance)) AS Total_Distance
FROM route
WHERE sourceairport IS NOT MISSING
GROUP BY UPPER(sourceairport);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "Airport_Code": "ITO",
    "Distance_Feels_Like": 0,
    "Total_Distance": 4828
  },
  {
    "Airport_Code": "GJT",
    "Distance_Feels_Like": 0,
    "Total_Distance": 6832
  },
  {
    "Airport_Code": "HYA",
    "Distance_Feels_Like": 0,
    "Total_Distance": 148
  },
...
]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="heterogeneous-data-types"><a class="anchor" href="#heterogeneous-data-types"></a>Heterogeneous data types for GROUP BY key</h3>
<div class="paragraph">
<p>When a field has a mix of data types for the GROUP BY key:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>NULLS</code> and <code>MISSING</code> are two separate groups.</p>
</li>
</ul>
</div>
<div id="ex5" class="exampleblock">
<div class="title">Example 7. Heterogeneous data types</div>
<div class="content">
<div class="paragraph">
<p>To see a separate grouping of <code>MISSING</code> and <code>NULL</code>, we need to <code>GROUP BY</code> a field we know exists in one document but not in another document while both documents have another field in common.</p>
</div>
<div class="listingblock">
<div class="title">Create Documents</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">INSERT INTO landmark
  VALUES("01",{"type":1, "email":"abc","xx":3});

INSERT INTO landmark
  VALUES("02",{"type":1, "email":"abc","xx":null});

INSERT INTO landmark
  VALUES("03",{"type":1, "email":"abcd"});</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT type, xx, MIN(email) AS Min_Email
FROM landmark
WHERE type IS NOT NULL
GROUP BY type, xx;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "Min_Email": "abc",
    "type": 1,
    "xx": 3
  },
  {
    "Min_Email": "abc",
    "type": 1,
    "xx": null
  },
  {
    "Min_Email": "abcd",
    "type": 1 <i class="conum" data-value="1"></i><b>(1)</b>
  },
  {
    "Min_Email": "2willowroad@nationaltrust.org.uk",
    "type": "landmark"
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is a separate result since field <code>xx</code> is MISSING</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="group-by-meta-id"><a class="anchor" href="#group-by-meta-id"></a>GROUP BY META().ID Primary Index</h3>
<div class="paragraph">
<p>If there is no filter, then pushdown is supported for an expression on the Document ID <code>META().id</code> in the <code>GROUP BY</code> clause.</p>
</div>
<div class="paragraph">
<p>To use Aggregate Pushdown, use the following syntax for the index and query statement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE PRIMARY INDEX <em>idx_expr</em> ON <em>named_keyspace_ref</em>;

SELECT COUNT(1)
FROM <em>named_keyspace_ref</em>
GROUP BY SUBSTR(META().id, <em>start</em>, <em>finish</em>);</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If there is a filter on the Document ID, then the primary index can be used as a secondary scan.
</td>
</tr>
</table>
</div>
<div id="ex6" class="exampleblock">
<div class="title">Example 8. List the number of airports that are in each decile of the <code>META().id</code> field</div>
<div class="content">
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE PRIMARY INDEX idx6 ON airport;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT COUNT(1) AS Count, SUBSTR(META().id,0,9) AS Meta_Group
FROM airport
GROUP BY SUBSTR(META().id,0,9);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "Count": 168,
    "Meta_Group": "airport_4"
  },
  {
    "Count": 175,
    "Meta_Group": "airport_5"
  },
  {
    "Count": 125,
    "Meta_Group": "airport_6"
  },
...
]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="limit-with-group-by"><a class="anchor" href="#limit-with-group-by"></a>LIMIT with GROUP BY on leading keys</h3>
<div class="paragraph">
<p>To use Aggregate Pushdown when there is a LIMIT clause and a GROUP BY clause on one or more leading keys, use the following example of the index and query statement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE INDEX <em>idx_expr</em> ON <em>named_keyspace_ref</em> (<em>k0</em>, <em>k1</em>);

SELECT <em>k0</em>, COUNT(<em>k1</em>)
FROM <em>named_keyspace_ref</em>
WHERE <em>k0</em> IS NOT MISSING
GROUP BY <em>k0</em>
LIMIT <em>n</em>;</pre>
</div>
</div>
<div id="ex7" class="exampleblock">
<div class="title">Example 9. LIMIT with GROUP BY on the leading key</div>
<div class="content">
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx7 ON landmark
(city, name);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT city AS City, COUNT(DISTINCT name) AS Landmark_Count
FROM landmark
WHERE city IS NOT MISSING
GROUP BY city
LIMIT 4;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Plan</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "plan": {
    "#operator": "Sequence",
    "~children": [
      {
        "#operator": "Sequence",
        "~children": [
          {
            "#operator": "IndexScan3",
            "bucket": "travel-sample",
            "covers": [
              "cover ((`landmark`.`city`))",
              "cover ((`landmark`.`name`))",
              "cover ((meta(`landmark`).`id`))",
              "cover (count(DISTINCT cover ((`landmark`.`name`))))"
            ],
            "index": "idx7",
            "index_group_aggs": {
              "aggregates": [
                {
                  "aggregate": "COUNT",
                  "depends": [
                    1
                  ],
                  "distinct": true,
                  "expr": "cover ((`landmark`.`name`))",
                  "id": 3,
                  "keypos": 1
                }
              ],
              "depends": [
                0,
                1
              ],
              "group": [
                {
                  "depends": [
                    0
                  ],
                  "expr": "cover ((`landmark`.`city`))",
                  "id": 0,
                  "keypos": 0
                }
              ]
            },
            "index_id": "7fe5ede3626e6d29",
            "index_projection": {
              "entry_keys": [
                0,
                3
              ]
            },
            "keyspace": "landmark",
            "limit": "4", <i class="conum" data-value="1"></i><b>(1)</b>
            "namespace": "default",
...
          }
        ]
      }
    ]
  }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "City": null,
    "Landmark_Count": 15
  },
  {
    "City": "Abbeville",
    "Landmark_Count": 1
  },
  {
    "City": "Abbots Langley",
    "Landmark_Count": 19
  },
  {
    "City": "Aberdeenshire",
    "Landmark_Count": 6
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>limit</code> is pushed to the indexer because the GROUP BY key matched with the leading index key.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="offset-with-group-by"><a class="anchor" href="#offset-with-group-by"></a>OFFSET with GROUP BY on leading keys</h3>
<div class="paragraph">
<p>To use Aggregate Pushdown when there is an OFFSET clause and a GROUP BY clause on one or more leading keys, use the following example of the index and query statement.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE INDEX <em>idx_expr</em> ON <em>named_keyspace_ref</em> (<em>k0</em>, <em>k1</em>);

SELECT <em>k0</em>, COUNT(k1)
FROM <em>named_keyspace_ref</em>
WHERE <em>k0</em> IS NOT MISSING
GROUP BY <em>k0</em>
OFFSET <em>n</em>;</pre>
</div>
</div>
<div id="ex8" class="exampleblock">
<div class="title">Example 10. OFFSET with GROUP BY on a leading key</div>
<div class="content">
<div class="paragraph">
<p>This example uses the <code>idx7</code> index defined previously:</p>
</div>
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx7 ON landmark
(city, name);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT city AS City, COUNT(DISTINCT name) AS Landmark_Count
FROM landmark
WHERE city IS NOT MISSING
GROUP BY city
OFFSET 4;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Plan</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "plan": {
    "#operator": "Sequence",
    "~children": [
      {
        "#operator": "Sequence",
        "~children": [
          {
            "#operator": "IndexScan3",
            "bucket": "travel-sample",
            "covers": [
              "cover ((`landmark`.`city`))",
              "cover ((`landmark`.`name`))",
              "cover ((meta(`landmark`).`id`))",
              "cover (count(DISTINCT cover ((`landmark`.`name`))))"
            ],
            "index": "idx7",
            "index_group_aggs": {
              "aggregates": [
                {
                  "aggregate": "COUNT",
                  "depends": [
                    1
                  ],
                  "distinct": true,
                  "expr": "cover ((`landmark`.`name`))",
                  "id": 3,
                  "keypos": 1
                }
              ],
              "depends": [
                0,
                1
              ],
              "group": [
                {
                  "depends": [
                    0
                  ],
                  "expr": "cover ((`landmark`.`city`))",
                  "id": 0,
                  "keypos": 0
                }
              ]
            },
            "index_id": "7fe5ede3626e6d29",
            "index_projection": {
              "entry_keys": [
                0,
                3
              ]
            },
            "keyspace": "landmark",
            "namespace": "default",
            "offset": "4", <i class="conum" data-value="1"></i><b>(1)</b>
            "scope": "inventory",
            "spans": [
...
            ]
          }
        ]
      }
    ]
  }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "City": "Aberdour",
    "Landmark_Count": 4
  },
  {
    "City": "Aberdulais",
    "Landmark_Count": 1
  },
  {
    "City": "Abereiddy",
    "Landmark_Count": 1
  },
  {
    "City": "Aberfeldy",
    "Landmark_Count": 2
  },
...
]</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>offset</code> is pushed to the indexer because the GROUP BY key matched with the leading index key.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="aggregate-without-group-by"><a class="anchor" href="#aggregate-without-group-by"></a>Aggregate without GROUP BY key</h3>
<div class="paragraph">
<p>This is a case of aggregation over a range without groups.
If the index can be used for computing the aggregate, the indexer will return a single aggregate value.
To use Aggregate Pushdown, use the following syntax for index and queries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE INDEX <em>idx_expr</em> ON <em>named_keyspace_ref</em> (<em>a</em>, <em>b</em>, <em>c</em>);</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Q1</div>
<div class="content">
<pre>SELECT <em>aggregate_function</em>(<em>c</em>)
FROM <em>named_keyspace_ref</em>
WHERE <em>a</em> IS NOT MISSING;</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Q2</div>
<div class="content">
<pre>SELECT SUM(<em>a</em>)
FROM <em>named_keyspace_ref</em>
WHERE <em>a</em> IS NOT MISSING;</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Q3</div>
<div class="content">
<pre>SELECT SUM(<em>a</em>), COUNT(<em>a</em>), MIN(<em>a</em>)
FROM <em>named_keyspace_ref</em>
WHERE <em>a</em> IS NOT MISSING;</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Q4</div>
<div class="content">
<pre>SELECT SUM(<em>a</em>), COUNT(<em>b</em>), MIN(<em>c</em>)
FROM <em>named_keyspace_ref</em>
WHERE <em>a</em> IS NOT MISSING;</pre>
</div>
</div>
<div id="ex9-q1" class="exampleblock">
<div class="title">Example 11. Multiple Aggregate without GROUP BY key&#8201;&#8212;&#8201;Q1</div>
<div class="content">
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx9 ON route
(distance, stops, sourceairport);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT SUM(ROUND(distance)) AS Total_Distance,
       SUM(stops) AS Total_Stops,
       COUNT(sourceairport) AS Total_Airports
FROM route
WHERE distance IS NOT MISSING;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "Total_Airports": 24024,
    "Total_Distance": 53538071,
    "Total_Stops": 6
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div id="ex9-q2" class="exampleblock">
<div class="title">Example 12. Aggregate without GROUP BY key&#8201;&#8212;&#8201;Q2</div>
<div class="content">
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT SUM(ROUND(distance)) AS Total_Distance
FROM route;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "Total_Distance": 53538071
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div id="ex9-q3" class="exampleblock">
<div class="title">Example 13. Multiple Aggregate without GROUP BY key&#8201;&#8212;&#8201;Q3</div>
<div class="content">
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT SUM(ROUND(distance)) AS Total_Distance,
       COUNT(ROUND(distance)) AS Count_of_Distance,
       MIN(ROUND(distance)) AS Min_of_Distance
FROM route
WHERE distance IS NOT MISSING;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "Count_of_Distance": 24024,
    "Min_of_Distance": 3,
    "Total_Distance": 53538071
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div id="ex9-q4" class="exampleblock">
<div class="title">Example 14. Multiple Aggregate without GROUP BY key&#8201;&#8212;&#8201;Q4</div>
<div class="content">
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT SUM(ROUND(distance)) AS Total_Distance,
       COUNT(stops) AS Count_of_Stops,
       MIN(sourceairport) AS Min_of_Airport
FROM route
WHERE distance IS NOT MISSING;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "Count_of_Stops": 24024,
    "Min_of_Airport": "AAE",
    "Total_Distance": 53538071
  }
]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="expression-in-aggregate-function"><a class="anchor" href="#expression-in-aggregate-function"></a>Expression in Aggregate function</h3>
<div class="paragraph">
<p>Aggregations with scalar expressions can be speeded up even if the index key does not have the matching expression on the key.
To use Aggregate Pushdown, use the following syntax for the index and query statement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE INDEX <em>idx_expr</em> ON <em>named_keyspace_ref</em> (<em>a</em>, <em>b</em>, <em>c</em>);

SELECT <em>aggregate_function1</em>(<em>expression</em>(c))
FROM <em>named_keyspace_ref</em>
WHERE <em>a</em> IS NOT MISSING
GROUP BY <em>a</em>, <em>b</em>;</pre>
</div>
</div>
<div id="ex10" class="exampleblock">
<div class="title">Example 15. List the landmarks with the highest latitude</div>
<div class="content">
<div class="paragraph">
<p>Use the <code>MAX()</code> operator to find the highest landmark latitude in each state, group the results by <code>country</code> and <code>state</code>, and then sort in reverse order by the highest latitudes.</p>
</div>
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx10 ON landmark
(country, state, ABS(ROUND(geo.lat)));</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT country, state, SUM(ABS(ROUND(geo.lat))) AS SumAbs_Latitude
FROM landmark
USE INDEX (idx10) <i class="conum" data-value="1"></i><b>(1)</b>
WHERE country IS NOT MISSING
GROUP BY country, state
ORDER BY SumAbs_Latitude DESC;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specifies that the query must use <code>idx10</code> rather than the similar <code>idx1</code></td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Plan</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "plan": {
    "#operator": "Sequence",
    "~children": [
      {
        "#operator": "Sequence",
        "~children": [
          {
            "#operator": "IndexScan3",
            "bucket": "travel-sample",
            "covers": [
              "cover ((`landmark`.`country`))",
              "cover ((`landmark`.`state`))",
              "cover (abs(round(((`landmark`.`geo`).`lat`))))",
              "cover ((meta(`landmark`).`id`))",
              "cover (sum(cover (abs(round(((`landmark`.`geo`).`lat`))))))"
            ],
            "index": "idx10",
            "index_group_aggs": {
              "aggregates": [
                {
                  "aggregate": "SUM",
                  "depends": [
                    2
                  ],
                  "expr": "cover (abs(round(((`landmark`.`geo`).`lat`))))",
                  "id": 4,
                  "keypos": 2
                }
              ],
              "depends": [
                0,
                1,
                2
              ],
              "group": [
                {
                  "depends": [
                    0
                  ],
                  "expr": "cover ((`landmark`.`country`))",
                  "id": 0,
                  "keypos": 0
                },
                {
                  "depends": [
                    1
                  ],
                  "expr": "cover ((`landmark`.`state`))",
                  "id": 1,
                  "keypos": 1
                }
...
              ]
            }
          }
        ]
      }
    ]
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The query plan shows that aggregates are executed by the indexer.
This is detailed in <a href="#docs-internal-guid-facfdbc0-bb3d-b00f-2ec0-6bee4921dabc">Table 3</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/GBAP_Ex10_VP.png" alt="Query plan with 3 steps: IndexScan3 using idx10, Project with 3 terms, and Order by SumAbs_Latitude">
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "SumAbs_Latitude": 117513,
    "country": "United Kingdom",
    "state": null
  },
  {
    "SumAbs_Latitude": 68503,
    "country": "United States",
    "state": "California"
  },
  {
    "SumAbs_Latitude": 10333,
    "country": "France",
    "state": "ÃŽle-de-France"
  },
...
]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sum-count-min-max-avg"><a class="anchor" href="#sum-count-min-max-avg"></a>SUM, COUNT, MIN, MAX, or AVG Aggregate functions</h3>
<div class="paragraph">
<p>Currently, the only aggregate functions that are supported are SUM(), COUNT(), MIN(), MAX(), and AVG() with or without the DISTINCT modifier.</p>
</div>
<div class="paragraph">
<p>To use Aggregate Pushdown, use the below syntax for the index and query statement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE INDEX <em>idx_expr</em> ON <em>named_keyspace_ref</em> (<em>a</em>, <em>b</em>, <em>c</em>, <em>d</em>);

SELECT <em>aggregate_function</em>(<em>a</em>), <em>aggregate_function</em>(<em>b</em>),
       <em>aggregate_function</em>(<em>c</em>), <em>aggregate_function</em>(<em>d</em>)
FROM <em>named_keyspace_ref</em>
WHERE <em>a</em> IS NOT MISSING
GROUP BY <em>a</em>;</pre>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 16. Aggregate functions</div>
<div class="content">
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx11 ON airport
(geo.lat, geo.alt, city, geo.lon);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT MIN(ROUND(geo.lat)) AS Min_Lat,
       SUM(geo.alt) AS Sum_Alt,
       COUNT(city) AS Count_City,
       MAX(ROUND(geo.lon)) AS Max_Lon
FROM airport
WHERE geo.lat IS NOT MISSING
GROUP BY (ROUND(geo.lat))
ORDER BY (ROUND(geo.lat)) DESC;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "Count_City": 1,
    "Max_Lon": 43,
    "Min_Lat": 72,
    "Sum_Alt": 149
  },
  {
    "Count_City": 3,
    "Max_Lon": -157,
    "Min_Lat": 71,
    "Sum_Alt": 120
  },
  {
    "Count_City": 6,
    "Max_Lon": -144,
    "Min_Lat": 70,
    "Sum_Alt": 292
  },
...
]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="distinct-aggregates"><a class="anchor" href="#distinct-aggregates"></a>DISTINCT aggregates</h3>
<div class="paragraph">
<p>There are four cases when DISTINCT aggregates can use this feature:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If the DISTINCT aggregate is on the leading GROUP BY key(s).</p>
</li>
<li>
<p>If the DISTINCT aggregate is on the leading GROUP By key(s) + 1 (the immediate next key).</p>
</li>
<li>
<p>If the DISTINCT aggregate is on a constant expression (GROUP BY can be on any key).</p>
</li>
<li>
<p>If there is no GROUP BY and the DISTINCT aggregate is on the first key only or in a constant expression.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To use Aggregate Pushdown, use one of the following syntaxes of the index and query statements:</p>
</div>
<div class="sect3">
<h4 id="case-1"><a class="anchor" href="#case-1"></a>Case 1</h4>
<div class="paragraph">
<p>If the DISTINCT aggregate is on the leading GROUP BY key(s).</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE INDEX <em>idx_expr</em> ON <em>named_keyspace_ref</em> (<em>a</em>, <em>b</em>, <em>c</em>);</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Syntax A</div>
<div class="content">
<pre>SELECT SUM(DISTINCT <em>a</em>)
FROM <em>named_keyspace_ref</em>
WHERE <em>a</em> IS NOT MISSING
GROUP BY <em>a</em>;</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Syntax B</div>
<div class="content">
<pre>SELECT COUNT(DISTINCT <em>a</em>), SUM(DISTINCT <em>b</em>)
FROM <em>named_keyspace_ref</em>
WHERE <em>a</em> IS NOT MISSING
GROUP BY <em>a</em>, <em>b</em>;</pre>
</div>
</div>
<div id="ex12-1-a" class="exampleblock">
<div class="title">Example 17. DISTINCT aggregate&#8201;&#8212;&#8201;Case 1, Syntax A</div>
<div class="content">
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx12_1 ON airport
(geo.lat, geo.lon, country);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT SUM(DISTINCT ROUND(geo.lat)) AS Sum_Lat
FROM airport
WHERE geo.lat IS NOT MISSING
GROUP BY ROUND(geo.lat);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "Sum_Lat": 27
  },
  {
    "Sum_Lat": 36
  },
  {
    "Sum_Lat": 71
  },
...
]</code></pre>
</div>
</div>
</div>
</div>
<div id="ex12-1-b" class="exampleblock">
<div class="title">Example 18. DISTINCT aggregate&#8201;&#8212;&#8201;Case 1, Syntax B</div>
<div class="content">
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT COUNT(DISTINCT ROUND(geo.lat)) AS Count_Lat,
       SUM(DISTINCT ROUND(geo.lon)) AS Sum_Lon
FROM airport
WHERE geo.lat IS NOT MISSING
GROUP BY ROUND(geo.lat), ROUND(geo.lon);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "Count_Lat": 1,
    "Sum_Lon": -166
  },
  {
    "Count_Lat": 1,
    "Sum_Lon": -107
  },
  {
    "Count_Lat": 1,
    "Sum_Lon": -159
  },
...
]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="case-2"><a class="anchor" href="#case-2"></a>Case 2</h4>
<div class="paragraph">
<p>If the DISTINCT aggregate is on the leading GROUP BY key(s) + 1 (the next key).</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE INDEX <em>idx_expr</em> ON <em>named_keyspace_ref</em> (<em>a</em>, <em>b</em>, <em>c</em>);</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Syntax A</div>
<div class="content">
<pre>SELECT SUM(DISTINCT <em>b</em>)
FROM <em>named_keyspace_ref</em>
WHERE <em>a</em> IS NOT MISSING
GROUP BY <em>a</em>;</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Syntax B</div>
<div class="content">
<pre>SELECT COUNT(DISTINCT <em>c</em>)
FROM <em>named_keyspace_ref</em>
WHERE <em>a</em> IS NOT MISSING
GROUP BY <em>a</em>, <em>b</em>;</pre>
</div>
</div>
<div id="ex12-2-a" class="exampleblock">
<div class="title">Example 19. DISTINCT aggregate&#8201;&#8212;&#8201;Case 2, Syntax A</div>
<div class="content">
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx12_2 ON airport
(country, ROUND(geo.lat), ROUND(geo.lon));</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT COUNT(DISTINCT country) AS Count_Country,
       SUM(DISTINCT ROUND(geo.lat)) AS Sum_Lat
FROM airport
WHERE country IS NOT MISSING
GROUP BY country;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "Count_Country": 1,
    "Sum_Lat": 483
  },
  {
    "Count_Country": 1,
    "Sum_Lat": 591
  },
  {
    "Count_Country": 1,
    "Sum_Lat": 2290
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div id="ex12-2-b" class="exampleblock">
<div class="title">Example 20. DISTINCT aggregate&#8201;&#8212;&#8201;Case 2, Syntax B</div>
<div class="content">
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT COUNT(DISTINCT country) AS Count_Country,
       SUM(DISTINCT ROUND(geo.lat)) AS Sum_Lat,
       COUNT(DISTINCT ROUND(geo.lon)) AS Count_Lon
FROM airport
WHERE country IS NOT MISSING
GROUP BY country, ROUND(geo.lat);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "Count_Country": 1,
    "Count_Lon": 1,
    "Sum_Lat": 18
  },
  {
    "Count_Country": 1,
    "Count_Lon": 1,
    "Sum_Lat": 42
  },
  {
    "Count_Country": 1,
    "Count_Lon": 9,
    "Sum_Lat": 43
  },
...
]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="case-3"><a class="anchor" href="#case-3"></a>Case 3</h4>
<div class="paragraph">
<p>If the DISTINCT aggregate is on a constant expression&#8201;&#8212;&#8201;GROUP BY can be on any key.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE INDEX <em>idx_expr</em> ON <em>named_keyspace_ref</em> (<em>a</em>, <em>b</em>, <em>c</em>);

SELECT <em>a</em>, COUNT(DISTINCT 1)
FROM <em>named_keyspace_ref</em>
WHERE <em>a</em> IS NOT MISSING
GROUP BY <em>b</em>;</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The results will be pre-aggregated if the <code>GROUP BY</code> key is non-leading, as in this case and example.
</td>
</tr>
</table>
</div>
<div id="ex12-3" class="exampleblock">
<div class="title">Example 21. DISTINCT aggregate&#8201;&#8212;&#8201;Case 3</div>
<div class="content">
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx12_3 ON airport
(country, geo.lat, geo.lon);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT MIN(country) AS Min_Country,
       COUNT(DISTINCT 1) AS Constant_Value,
       MIN(ROUND(geo.lon)) AS Min_Longitude
FROM airport
WHERE country IS NOT MISSING
GROUP BY geo.lat;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "Constant_Value": 1,
    "Min_Country": "United States",
    "Min_Longitude": -103
  },
  {
    "Constant_Value": 1,
    "Min_Country": "France",
    "Min_Longitude": 3
  },
  {
    "Constant_Value": 1,
    "Min_Country": "United States",
    "Min_Longitude": -105
  },
...
]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="case-4"><a class="anchor" href="#case-4"></a>Case 4</h4>
<div class="paragraph">
<p>If the DISTINCT aggregate is on the first key only or in a constant expression, and there is no GROUP BY clause.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE INDEX <em>idx_expr</em> ON <em>named_keyspace_ref</em> (<em>a</em>, <em>b</em>, <em>c</em>);</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Q1</div>
<div class="content">
<pre>SELECT <em>aggregate_function</em>(DISTINCT <em>a</em>)
FROM <em>named_keyspace_ref</em>; <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Q2</div>
<div class="content">
<pre>SELECT <em>aggregate_function</em>(DISTINCT 1)
FROM <em>named_keyspace_ref</em>; <i class="conum" data-value="2"></i><b>(2)</b></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Q3</div>
<div class="content">
<pre>SELECT <em>aggregate_function</em>(DISTINCT <em>c</em>)
FROM <em>named_keyspace_ref</em>; <i class="conum" data-value="3"></i><b>(3)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>OK</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>OK</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Not OK</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All other cases of DISTINCT pushdown will return an error.</p>
</div>
<div id="ex12-4-q1" class="exampleblock">
<div class="title">Example 22. DISTINCT aggregate&#8201;&#8212;&#8201;Case 4, Q1</div>
<div class="content">
<div class="paragraph">
<p>A DISTINCT aggregate on the first key only, where there is no GROUP BY clause.</p>
</div>
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx12_4 ON airport
(geo.alt, geo.lat, geo.lon);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT SUM(DISTINCT ROUND(geo.alt)) AS Sum_Alt
FROM airport
WHERE geo.alt IS NOT MISSING;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "Sum_Alt": 1463241
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div id="ex12-4-q2" class="exampleblock">
<div class="title">Example 23. DISTINCT aggregate&#8201;&#8212;&#8201;Case 4, Q2</div>
<div class="content">
<div class="paragraph">
<p>A DISTINCT aggregate on a constant expression, where there is no GROUP BY clause.
This query pushes the aggregation down to the indexer, but does not necessarily use the index <code>idx12_4</code>.</p>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT COUNT(DISTINCT 1) AS Const_expr
FROM airport;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "Const_expr": 1
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div id="ex12-4-q3" class="exampleblock">
<div class="title">Example 24. DISTINCT aggregate&#8201;&#8212;&#8201;Case 4, Q3</div>
<div class="content">
<div class="paragraph">
<p>A DISTINCT aggregate on a non-leading key, where there is no GROUP BY clause.
This query uses the index <code>idx12_4</code>, but does not push the aggregation down to the indexer.</p>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT SUM(DISTINCT ROUND(geo.lon)) AS Sum_Lon
FROM airport
WHERE geo.alt IS NOT MISSING;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "Sum_Lon": -11412
  }
]</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="having-with-aggregate-function"><a class="anchor" href="#having-with-aggregate-function"></a>HAVING with an aggregate function inside</h3>
<div class="paragraph">
<p>To use Aggregate Pushdown when a HAVING clause has an aggregate function inside, use the following syntax of index and query statement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE INDEX <em>idx_expr</em> ON <em>named_keyspace_ref</em> (<em>k0</em>, <em>k1</em>);

SELECT <em>k0</em>, COUNT(<em>k1</em>)
FROM <em>named_keyspace_ref</em>
WHERE <em>k0</em> IS NOT MISSING
GROUP BY <em>k0</em>
HAVING <em>aggregate_function</em>(<em>k1</em>);</pre>
</div>
</div>
<div id="ex13" class="exampleblock">
<div class="title">Example 25. HAVING with an aggregate function inside</div>
<div class="content">
<div class="paragraph">
<p>List the cities that have more than 180 landmarks.
This example uses the <code>idx7</code> index defined previously:</p>
</div>
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx7 ON landmark
(city, name);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT city AS City, COUNT(DISTINCT name) AS Landmark_Count
FROM landmark
WHERE city IS NOT MISSING
GROUP BY city
HAVING COUNT(DISTINCT name) &gt; 180;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "City": "London",
    "Landmark_Count": 443
  },
  {
    "City": "Los Angeles",
    "Landmark_Count": 284
  },
  {
    "City": "San Diego",
    "Landmark_Count": 197
  },
  {
    "City": "San Francisco",
    "Landmark_Count": 797
  }
]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="letting-with-aggregate-function"><a class="anchor" href="#letting-with-aggregate-function"></a>LETTING with an aggregate function inside</h3>
<div class="paragraph">
<p>To use Aggregate Pushdown when a LETTING clause has an aggregate function inside, use the following syntax of the index and query statement.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE INDEX <em>idx_expr</em> ON <em>named_keyspace_ref</em> (<em>k0</em>, <em>k1</em>);

SELECT <em>k0</em>, COUNT(<em>k1</em>)
FROM <em>named_keyspace_ref</em>
WHERE <em>k0</em> IS NOT MISSING
GROUP BY <em>k0</em>
LETTING var_expr = <em>aggregate_function</em>(<em>k1</em>)
HAVING var_expr;</pre>
</div>
</div>
<div id="ex14" class="exampleblock">
<div class="title">Example 26. LETTING with an aggregate function inside</div>
<div class="content">
<div class="paragraph">
<p>List cities that have more than half of all landmarks.
This example uses the <code>idx7</code> index defined previously:</p>
</div>
<div class="listingblock">
<div class="title">Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx7 ON landmark
(city, name);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT city AS City, COUNT(DISTINCT name) AS Landmark_Count
FROM landmark
WHERE city IS NOT MISSING
GROUP BY city
LETTING MinimumThingsToSee = COUNT(DISTINCT name)
HAVING MinimumThingsToSee &gt; 180;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "City": "London",
    "Landmark_Count": 443
  },
  {
    "City": "Los Angeles",
    "Landmark_Count": 284
  },
  {
    "City": "San Diego",
    "Landmark_Count": 197
  },
  {
    "City": "San Francisco",
    "Landmark_Count": 797
  }
]</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="limitations"><a class="anchor" href="#limitations"></a>Limitations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following are currently not supported and not pushed to the indexer:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>HAVING</code> or <code>LETTING</code> clauses, unless there is an aggregate function inside.</p>
</li>
<li>
<p><code>ORDER BY</code> clauses.</p>
</li>
<li>
<p><code>ARRAY_AGG()</code> or any facility to add new Aggregate function, such as Median.</p>
</li>
<li>
<p><code>LIMIT</code> pushdown with <code>GROUP BY</code> on non-leading keys.</p>
</li>
<li>
<p><code>OFFSET</code> pushdown with <code>GROUP BY</code> on non-leading keys.</p>
</li>
<li>
<p>A subquery in a <code>GROUP BY</code> or Aggregate pushdown.</p>
</li>
<li>
<p><code>FILTER</code> clauses on aggregate functions.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Aggregate Comparison</caption>
<colgroup>
<col style="width: 27.2727%;">
<col style="width: 18.1818%;">
<col style="width: 18.1818%;">
<col style="width: 18.1818%;">
<col style="width: 18.1819%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">Item</th>
<th class="tableblock halign-center valign-top">Aggregate on Non-Array Index Field</th>
<th class="tableblock halign-center valign-top">Aggregate on Array Index Field</th>
<th class="tableblock halign-center valign-top">DISTINCT Aggregate on Non-Array Index Field</th>
<th class="tableblock halign-center valign-top">DISTINCT Aggregate on Array Index Field</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Supports <code>MIN()</code> and <code>MAX()</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong>âœ“</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong>âœ“</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Supports <code>SUM()</code> and <code>COUNT()</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong>âœ“</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong>âœ“</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong>âœ“</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Supports <code>AVG()</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong>âœ“</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong>âœ“</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong>âœ“</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong>âœ“</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Supports <code>ARRAY_AGG()</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">-</p></td>
</tr>
</tbody>
</table>
<div class="sect2">
<h3 id="filter-clause"><a class="anchor" href="#filter-clause"></a>FILTER Clause</h3>
<div class="paragraph">
<p>If the query block contains an aggregate function which uses the FILTER clause, the aggregation is not pushed down to the indexer.
As a workaround, if you require aggregation pushdown, you can use a comparison operator as the argument for the aggregate function.
For example:</p>
</div>
<div class="listingblock">
<div class="title">Aggregate functions with FILTER clause</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT
  SUM(d.c3) FILTER (WHERE d.c2 IN ['X']),
  COUNT(1) FILTER (WHERE d.c2 IN ['Y'])
  ...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Workaround using comparison operators</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT
  SUM (CASE WHEN d.c2 IN ['X'] THEN d.c3 ELSE 0 END),
  COUNT (CASE WHEN d.c2 IN ['Y'] THEN 1 ELSE NULL END)
  ...</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="section_bpf_wjf_ycb"><a class="anchor" href="#section_bpf_wjf_ycb"></a>Appendix: Query Plan Fields</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Consider the example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx_landmark_activity
ON landmark(activity);

EXPLAIN SELECT activity, COUNT(activity)
FROM landmark
WHERE activity IS NOT MISSING
GROUP BY activity;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the query plan:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>plan.`~children`[0.covers]</code> shows that the index covers the query.</p>
</li>
<li>
<p><code>plan.`~children`[0.index_group_aggs]</code> shows the aggregation and groupings done by the indexer.</p>
</li>
<li>
<p><code>index_group_aggs</code> object has details on the aggregate, index key position, expression dependency, and group expressions handled by the indexer.
This object is present in the plan only when the indexer handles the grouping and aggregation.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 41.6666%;">
<col style="width: 41.6668%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Item Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Explain Text in This Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>aggregates</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array of Aggregate objects, and each object represents one aggregate function.
The absence of this item means there is no Aggregate function.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>aggregates</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... aggregate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Aggregate operation.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>COUNT</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... depends</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of index key positions the GROUP BY expression depends on, starting with 0.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0</code></p>
<p class="tableblock">(because it&#8217;s the 1st item)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... expr</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Group expression or an aggregate expression.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"cover ((`landmark`.`activity`))"</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique ID given internally and will be used in <code>index_projection</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... keypos</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Key Position to use the Index expr or the query expr.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A value &gt; -1 means the group key exactly matches the corresponding index keys, where 0 is the 1st index key.</p>
</li>
<li>
<p>A value of -1 means the group key does not match the index key and uses the query expression instead.</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0</code></p>
<p class="tableblock">(because it matches the 1st index key)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>depends</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of index key positions the GROUP BY expression depends on, starting with 0.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0</code></p>
<p class="tableblock">(because it&#8217;s the 1st item)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>group</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array of GROUP BY objects, and each object represents one group key.
The absence of this item means there is no GROUP BY clause.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>group</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... depends</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Index key position of a single GROUP BY expression</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0</code></p>
<p class="tableblock">(because it&#8217;s the 1st GROUP BY key)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... expr</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single GROUP BY expression.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"cover ((`landmark`.`activity`))"</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique ID given internally and will be used in <code>index_projection</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... keypos</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Key Position to use the Index expr or the query expr.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A value &gt; -1 means the group key exactly matches the corresponding index keys, where 0 is the 1st index key.</p>
</li>
<li>
<p>A value of -1 means the group key does not match the index key and uses the query expression instead.</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0</code></p>
<p class="tableblock">(because it matches the 1st key in the index expression)</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "plan": {
    "#operator": "Sequence",
    "~children": [
      {
        "#operator": "IndexScan3",
        "bucket": "travel-sample",
        "covers": [
          "cover ((`landmark`.`activity`))",
          "cover ((meta(`landmark`).`id`))",
          "cover (count(cover ((`landmark`.`activity`))))"
        ],
        "index": "idx_landmark_activity",
        "index_group_aggs": { <i class="conum" data-value="1"></i><b>(1)</b>
          "aggregates": [
            {
              "aggregate": "COUNT",
              "depends": [
                0
              ],
              "expr": "cover ((`landmark`.`activity`))",
              "id": 2,
              "keypos": 0
            }
          ],
          "depends": [
            0
          ],
          "group": [
            {
              "depends": [
                0
              ],
              "expr": "cover ((`landmark`.`activity`))",
              "id": 0,
              "keypos": 0
            }
          ]
        },
        "index_id": "ba98a2af8f4e0f4d",
        "index_projection": {
          "entry_keys": [
            0,
            2
          ]
        },
        "keyspace": "landmark",
        "namespace": "default",
        "scope": "inventory",
        "spans": [
          {
            "exact": true,
            "range": [
              {
                "inclusion": 1,
                "low": "null"
              }
            ]
          }
        ],
        "using": "gsi"
      },
      {
        "#operator": "Parallel",
        "~child": {
          "#operator": "Sequence",
          "~children": [
            {
              "#operator": "InitialProject",
              "result_terms": [
                {
                  "expr": "cover ((`landmark`.`activity`))"
                },
                {
                  "expr": "cover (count(cover ((`landmark`.`activity`))))"
                }
              ]
            }
          ]
        }
      }
    ]
  },
  "text": "SELECT activity, COUNT(activity)\nFROM landmark\nWHERE activity IS NOT MISSING\nGROUP BY activity;"
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>When the <code>index_group_aggs</code> section is present, it means that the query is using Index Aggregations.</td>
</tr>
</table>
</div>
<table id="table_bw2_nrf_ycb" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. GROUP BY Query Plan</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 41.6666%;">
<col style="width: 41.6668%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Item Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">EXPLAIN Text in <a href="#ex1">Example 1</a> (GROUP BY)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>aggregates</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array of Aggregate objects, and each object represents one aggregate function.
The absence of this item means there is no Aggregate function.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>aggregates</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... aggregate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Aggregate operation.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MAX</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... depends</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of index key positions the GROUP BY expression depends on, starting with 0.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2</code></p>
<p class="tableblock">(because it&#8217;s the 3rd item)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... expr</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Group expression or an aggregate expression.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>round(cover (((`landmark`.
`geo`).`lat`)))</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique ID given internally and will be used in <code>index_projection</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>4</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... keypos</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Key Position to use the Index expr or the query expr.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A value &gt; -1 means the group key exactly matches the corresponding index keys, where 0 is the 1st index key.</p>
</li>
<li>
<p>A value of -1 means the group key does not match the index key and uses the query expression instead.</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-1</code></p>
<p class="tableblock">(because the index has the field <code>geo.lat</code> but the query adds the <code>ROUND()</code> function to <code>geo.lat</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>depends</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of index key positions the GROUP BY expression depends on, starting with 0.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0, 1, 2</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>group</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array of GROUP BY objects, and each object represents one group key.
The absence of this item means there is no GROUP BY clause.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>group</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... depends</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Index key position of a single GROUP BY expression, starting with 0.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0</code></p>
<p class="tableblock">(because it&#8217;s the 1st GROUP BY key)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... expr</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single GROUP BY expression.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>`landmark`.`country`</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique ID given internally and will be used in <code>index_projection.</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... keypos</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Key Position to use the Index expr or the query expr.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A value &gt; -1 means the group key exactly matches the corresponding index keys, where 0 is the 1st index key.</p>
</li>
<li>
<p>A value of -1 means the group key does not match the index key and uses the query expression instead.</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0</code></p>
<p class="tableblock">(because it matches the first key in the index expression)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The Query Plan sections of an Aggregate pushdown are slightly different than those used in a GROUP BY.</p>
</div>
<table id="docs-internal-guid-facfdbc0-bb3d-b00f-2ec0-6bee4921dabc" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Aggregate Query Plan</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 41.6666%;">
<col style="width: 41.6668%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Item Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">EXPLAIN Text in <a href="#ex10">Example 15</a> (Aggregate)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>aggregates</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array of Aggregate objects, and each object represents one aggregate function.
The absence of this item means there is no Aggregate function.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>aggregates</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... aggregate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Aggregate operation.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SUM</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... depends</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of index key positions the GROUP BY expression depends on, starting with 0.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2</code></p>
<p class="tableblock">(because it&#8217;s the 3rd item)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... expr</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Group expression or an aggregate expression.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"abs(round(cover (((`landmark`.`geo`).`lat`))))"</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique ID given internally and will be used in <code>index_projection</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>4</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... keypos</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Key Position to use the Index expr or the query expr.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A value &gt; -1 means the group key exactly matches the corresponding index keys, where 0 is the 1st index key.</p>
</li>
<li>
<p>A value of -1 means the group key does not match the index key and uses the query expression instead.</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2</code></p>
<p class="tableblock">(because the query&#8217;s 3rd key exactly matches the index&#8217;s 3rd key)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>depends</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of index key positions the GROUP BY expression depends on, starting with 0.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0, 1, 2</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>group</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array of GROUP BY objects, and each object represents one group key.
The absence of this item means there is no GROUP BY clause.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>group</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... depends</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Index key position of a single GROUP BY expression, starting with 0.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0</code></p>
<p class="tableblock">(because it&#8217;s the 1st GROUP BY key)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... expr</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single GROUP BY expression.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"cover ((`landmark`.`country`))"</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique ID given internally and will be used in <code>index_projection.</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... keypos</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Key Position to use the Index expr or the query expr.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A value &gt; -1 means the group key exactly matches the corresponding index keys, where 0 is the 1st index key.</p>
</li>
<li>
<p>A value of -1 means the group key does not match the index key and uses the query expression instead.</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0</code></p>
<p class="tableblock">(because it matches the 1st key in the index expression)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... depends</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Index key position of a single GROUP BY expression, starting with 0.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1</code></p>
<p class="tableblock">(because it&#8217;s the 2nd GROUP BY key)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... expr</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single GROUP BY expression.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"cover ((`landmark`.`state`))"</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique ID given internally and will be used in <code>index_projection.</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>... keypos</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Key Position to use the Index expr or the query expr.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A value &gt; -1 means the group key exactly matches the corresponding index keys, where 0 is the 1st index key.</p>
</li>
<li>
<p>A value of -1 means the group key does not match the index key and uses the query expression instead.</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1</code></p>
<p class="tableblock">(because it matches the 2nd key in the index expression)</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="related-links"><a class="anchor" href="#related-links"></a>Related Links</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="#learn:services-and-indexes/indexes/index-scans.adoc#query-execution-details" class="xref unresolved">Query Execution: Details</a></p>
</li>
<li>
<p><a href="covering-indexes.html" class="xref page">Covering Indexes</a></p>
</li>
<li>
<p><a href="#learn:services-and-indexes/indexes/index_pushdowns.adoc" class="xref unresolved">Index Pushdown Optimizations</a></p>
</li>
<li>
<p><a href="#learn:services-and-indexes/indexes/early-filters-and-pagination.adoc" class="xref unresolved">Early Filters, Ordering and Pagination</a></p>
</li>
</ul>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>Â© 2023 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Server","components":["server"],"url":"/home/server.html","latestVersions":{"server":"7.2"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../../../_/js/site.js"></script>
<script defer src="../../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
</body>
</html>
