<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<script>(window.dataLayer=window.dataLayer||[]).push({event:'gtm.js','gtm.start':+new Date()})</script>
<script async src="https://www.googletagmanager.com/gtm.js?id=GTM-MVPNN2"></script>
<title>Configure Server Certificates | Couchbase Docs</title>
<link rel="stylesheet" href="../../../../_/css/site.css">
<script src="../../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="Couchbase Server Enterprise Edition supports X.509 certificates, for the encryption of communications between the server and networked clients.">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="server">
<meta name="dcterms.identifier" content="7.2">
<meta name="page-url" content="/server/current/manage/manage-security/configure-server-certificates.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://docs.couchbase.com/home/index.html">
                    <img src="../../../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://docs.couchbase.com/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../cloud/index.html">
                      Capella
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/manage/pages/manage-security/configure-server-certificates.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../../introduction/intro.html">Couchbase Server</a></li>
<li class="crumb">Manage</li>
<li class="crumb"><a href="security-management-overview.html">Manage Security</a></li>
<li class="crumb"><a href="manage-authentication.html">Manage Authentication</a></li>
<li class="crumb"><a href="manage-certificates.html">Manage Certificates</a></li>
<li class="crumb"><a href="configure-server-certificates.html">Configure Server Certificates</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Configure Server Certificates</h1>
<div class="labels">
<ul></ul>
</div>


</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
Couchbase Server Enterprise Edition supports X.509 certificates, for the encryption of communications between the server and networked clients.
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-server-side-certificates"><a class="anchor" href="#configure-server-side-certificates"></a>Configure Server Certificates</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section demonstrates how server certificates can be configured for Couchbase Server.
Note that the procedures are provided only as <em>limited examples</em>, giving guidance as to the basic steps typically involved in certificate creation.
Modification of the procedures will likely be required, for the preparation of certificates for different platforms and cluster-configurations.</p>
</div>
<div class="paragraph">
<p>Two procedures are provided, each of which configures X.509 certificates on Ubuntu 18 for a one-node Couchbase Server-cluster.
Before attempting to follow either procedure, see the conceptual and architectural information provided in <a href="../../learn/security/certificates.html" class="xref page">Certificates</a>.</p>
</div>
<div class="paragraph">
<p>The first procedure, <a href="#root-and-node-certificates">Cluster Protection with Root and Node Certificates</a>, is the simpler: it shows how to create a root certificate that is a trusted, self-signed authority; and how to use this to sign individual, per node certificates.</p>
</div>
<div class="paragraph">
<p>The second procedure, <a href="#root-intermediate-and-node-certificates">Cluster Protection with Root, Intermediate, and Node Certificates</a>, demonstrates how a created root certificate and its private key are used to sign one or more <em>intermediate</em> certificates; which are then in turn used with their own private keys to sign individual, per node certificates: such use of intermediate certificates and their private keys increases security &#8212; in that it minimizes use of the private key associated with the root certificate, when the signing of many node-certificates or client-certificates is required.</p>
</div>
<div class="paragraph">
<p>Although these procedures demonstrate certificate management and deployment on single-node clusters, the steps they contain can also be used on <em>multi-node</em> clusters; with some of the steps being necessarily repeated, across the different nodes.
See <a href="#protection-of-multi-node-clusters">Protection of Multi-Node Clusters</a>, below, for details.</p>
</div>
<div class="paragraph">
<p>Note also that once a cluster has been protected with administrator-defined certificates in accordance with these procedures, any new nodes subsequently to be added to the cluster must be individually protected with conformant certificates, before addition can take place.
See <a href="#adding-new-cluster-nodes">Adding New Cluster-Nodes</a>, below, for details.</p>
</div>
<div class="sect2">
<h3 id="root-certificates-single-versus-multiple"><a class="anchor" href="#root-certificates-single-versus-multiple"></a>Root Certificates: Single versus Multiple</h3>
<div class="paragraph">
<p>The examples in this section each feature creation and use of a single root certificate, which is used to provide its authority to a node certificate.
Prior to Couchbase Server 7.1, a single root certificate was the maximum that could be used for a cluster.
In Couchbase Server 7.1 and later, <em>multiple</em> root certificates can be maintained in a <em>trust store</em> for the cluster: this is described in <a href="../../learn/security/using-multiple-cas.html" class="xref page">Using Multiple Root Certificates</a>.
Procedures for creating root certificates, and using these to sign node or intermediate certificates, are unaffected.
However, procedures for <em>loading</em> root and node certificates have changed in 7.1: details are provided below.</p>
</div>
</div>
<div class="sect2">
<h3 id="using-an-externally-provided-root-certificate"><a class="anchor" href="#using-an-externally-provided-root-certificate"></a>Using an Externally Provided Root Certificate</h3>
<div class="paragraph">
<p>The examples below show how to <em>create</em> a root certificate, and how to use that certificate&#8217;s <em>private key</em> to <em>sign</em> (and thereby confer limited authority to) other certificates.
However, production deployments of Couchbase Server will frequently deploy an <em>externally provided</em> root certificate for the cluster, this having been provided by a recognized certificate authority.
Additionally, an <em>intermediate</em> (sometimes referred to as a <em>subordinate</em>) certificate, defined by the system administrator for the production environment, is likely to have been signed by the external authority, using its root certificate&#8217;s private key: this allows the intermediate certificate and its private key to be used by the system administrator in creating additional certificates for deployment, each of these certificates thereby acquiring authority indirectly from the root.</p>
</div>
<div class="paragraph">
<p>Therefore, to use the procedures provided below in the context of a root certificate having been provided by, and an intermediate certificate signed by, an external authority, substitute the externally provided root certificate for the generated <code>ca.pem</code>; use the externally signed intermediate in place of the generated intermediate; and use the private key of the externally signed intermediate to sign node and client certificates as appropriate.</p>
</div>
</div>
<div class="sect2">
<h3 id="node-to-node-encryption-and-certificate-management"><a class="anchor" href="#node-to-node-encryption-and-certificate-management"></a>Node-to-Node Encryption and Certificate Management</h3>
<div class="paragraph">
<p>Couchbase Server supports <a href="../../learn/clusters-and-availability/node-to-node-encryption.html" class="xref page">Node-to-Node Encryption</a>, whereby network traffic between the individual nodes of a cluster is encrypted.</p>
</div>
<div class="paragraph">
<p>Prior to Couchbase Server Version 7.1, node-to-node encryption, which is managed by means of the Couchbase CLI, needed to be <em>disabled</em> before management of either <em>root</em> or <em>intermediate</em> certificates could be performed.
This restriction is lifted in version 7.1: therefore, root and intermediate certificates <em>can</em> now be managed while node-to-node encryption is enabled.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="root-and-node-certificates"><a class="anchor" href="#root-and-node-certificates"></a>Cluster Protection with Root and Node Certificates</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following procedure shows how to create a root certificate that is the trusted, self-signed authority used to sign individual, per node certificates.
Note that corresponding, subsequent procedures that create certificates for <em>client</em>-authentication are provided in <a href="configure-client-certificates.html#client-certificate-authorized-by-a-root-certificate" class="xref page">Client Access: Root Certificate Authorization</a> and <a href="configure-client-certificates.html#java-client-access-root-certificate-authorization" class="xref page">Java Client Access: Root Certificate Authorization</a>.</p>
</div>
<div class="paragraph">
<p>Proceed as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On the server to be certificate-protected, create working directories:</p>
<div class="listingblock">
<div class="content">
<pre>mkdir servercertfiles
cd servercertfiles
mkdir -p {public,private,requests}</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>public</code> directory will be used to store certificates, which contain <em>public</em> keys.
The <code>private</code> directory will contain <em>private</em> keys.
The <code>requests</code> directory will store certificate <em>signing requests</em>, which are files generated from private keys: when a signing request is granted the signature of an appropriate authority, a <em>signed certificate</em> is produced.</p>
</div>
</li>
<li>
<p>Create a <em>private key</em> for the cluster.</p>
<div class="paragraph">
<p>A private key can be used to decrypt data previously encrypted by the corresponding <em>public</em> key.
It can also be used to sign a message that is then sent by the client to the server; allowing the client&#8217;s identity to be verified by the server, using the client&#8217;s public key.
In the key-creation sequence, the private key is created first.
Then, the public key is created, being <em>derived from</em> the private key.</p>
</div>
<div class="paragraph">
<p>Enter the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>openssl genrsa -out ca.key 2048</pre>
</div>
</div>
<div class="paragraph">
<p>The output of this command, <code>ca.key</code>, is the private key for the cluster.</p>
</div>
</li>
<li>
<p>Create the <em>certificate</em> (that is, the file that will contain the public key) for the cluster.
The certificate is intended to be <em>self-signed</em>, meaning that it will not be vouched for by any other authority.
This means that it can be created directly, based on the existing private key <code>ca.key</code>, without assistance from a third party.</p>
<div class="paragraph">
<p>Enter the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>openssl req -new -x509 -days 3650 -sha256 -key ca.key -out ca.pem \
-subj "/CN=Couchbase Root CA"</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>x509</code> flag indicates that in this case, an x509 structure, rather than a <em>request</em> is to be generated.
(By contrast, a request <em>will</em> need to be generated whenever the signature of a third-party authority is required: this is demonstrated below.)
The <code>days</code> flag specifies the number of days for which the certificate should be active.
The hashing algorithm to be used for digital-signature creation is specified as <code>sha256</code>.
The private key file on which the certificate is to be based is specified as <code>ca.key</code>, and the output-certificate is named as <code>ca.pem</code>.
The certificate&#8217;s <em>issuer</em> is specified to have the <code>CN</code> (<em>Common Name</em>) of <code>Couchbase Root CA</code>: as this name indicates, the certificate will be the <em>root</em> certificate for the Couchbase Server-cluster.</p>
</div>
<div class="paragraph">
<p>The output of the command is the certificate <code>ca.pem</code>; which contains the public key corresponding to the cluster&#8217;s private key, <code>ca.key</code>.</p>
</div>
<div class="paragraph">
<p>Optionally, the public key within the certificate can be displayed as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>openssl x509 -in ./ca.pem -noout -pubkey</pre>
</div>
</div>
<div class="paragraph">
<p>The output has approximately the following appearance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA3HMfiSjCwakfMbA20HUd
V372JbQG9UGjf9V3xyMa90IHFD8cFjPYao7SZOpe0nkm2UmZRgQbTwWxC4CZqrYZ
pyrWLn9rjDFkzzbRjMRcZv2D0s0KkPrNYxfHj3cL/j5bpB4/hquvb4RglMkyyJo9
mVx19lF4mtEsBqPGZBGArbzeArn4c1e6I4mqIfb9Vne/7vhIzLLSXoT5FmifWyGQ
4B9BSIrE9Ildwhez699MGfj+N+0xg2wTOIUVNvS1c5gF/uDS6t9Aswb60W+hjtF4
d1ZBKBIVkmPGX0XOgGtdndXza4sjVkh3bB/ipWo9zUJYwFCWkofbqGeSnSz9n9o6
fwIDAQAB
-----END PUBLIC KEY-----</pre>
</div>
</div>
<div class="paragraph">
<p>Note that by substituting other flags for <code>-pubkey</code>, other characteristics of the certificate can be displayed.
<code>-issuer</code> displays the certificate&#8217;s issuer, and <code>-subject</code> its subject (in both cases, <code>subject= /CN=Couchbase Root CA</code>).
The <code>-version</code>, <code>-serial</code>, <code>-subject-hash</code>, and more can be displayed.</p>
</div>
<div class="paragraph">
<p>The <em>entire certificate</em> can be displayed as text, by means of the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>openssl x509 -text -noout -in ./ca.pem</pre>
</div>
</div>
<div class="paragraph">
<p>The initial part of the output, which is extensive, is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 18276610881715621025 (0xfda390c366b2cca1)
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN=Couchbase Root CA
        Validity
            Not Before: Sep  2 08:32:31 2019 GMT
            Not After : Aug 30 08:32:31 2029 GMT
        Subject: CN=Couchbase Root CA
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
                    00:d7:a6:ba:5d:e2:e2:fd:6e:1b:33:9a:4b:bf:77:
                    6f:28:c3:37:60:33:da:09:b2:0b:73:1f:f9:65:2a:
                                  .
                                  .</pre>
</div>
</div>
<div class="paragraph">
<p>The displayed text thus provides information including the <code>Version</code>, the <code>Serial Number</code>, and the <code>Signature Algorithm</code> of the certificate.
The certificate&#8217;s <code>Issuer</code>, <code>Subject</code>, and period of <code>Validity</code> are also shown.
The <code>Algorithm</code> and <code>Modulus</code> (and, further below, the <code>Exponent</code>) of the public key are shown.</p>
</div>
<div class="paragraph">
<p>For detailed information on keys and key-generation, see <a href="https://en.wikipedia.org/wiki/RSA_(cryptosystem)">RSA (cryptosystem)</a>.</p>
</div>
</li>
<li>
<p>Create a private key for the individual node.
In addition to the root certificate and private key for the entire cluster, which are <code>ca.pem</code> and <code>ca.key</code>, a <em>node</em> certificate and private key must also be created.
The node certificate, along with its corresponding node-private key, will reside on its own, corresponding node.
When deployed, each node certificate must be named <code>chain.pem</code>, and each node private key <code>pkey.key</code>.
Consequently, if the node certificates and private keys for multiple nodes are being prepared on a single system, the files should be given individual, distinctive names on creation; and then each deployed on its appropriate node as either <code>chain.pem</code> or <code>pkey.key</code>.
This renaming procedure is indeed followed here for demonstration purposes, even though only a one-node cluster is involved.</p>
<div class="paragraph">
<p>Create the node private key as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>openssl genrsa -out private/couchbase.default.svc.key 2048</pre>
</div>
</div>
<div class="paragraph">
<p>The output file is <code>couchbase.default.svc.key</code>, which is the private key for the node.</p>
</div>
</li>
<li>
<p>Create a certificate signing request for the node certificate.
This step allows the materials required for certificate-creation to be passed to a third-party, who will <em>digitally sign</em> the certificate as part of its creation-process, and thereby confirm its validity.
(In this demonstration, however, no actual third-party is involved: the certificate will be signed by means of the <em>root</em> private key, which is owned by the current user.)</p>
<div class="paragraph">
<p>Enter the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>openssl req -new -key private/couchbase.default.svc.key \
-out requests/couchbase.default.svc.csr -subj "/CN=Couchbase Server"</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>key</code> specified as the input for the request is <code>couchbase.default.svc.key</code>, which was created in the last step.
The output request-file is specified as <code>couchbase.default.svc.csr</code>.
Note that this can be inspected as text, by entering the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>openssl req -text -noout -verify -in ./requests/couchbase.default.svc.csr</pre>
</div>
</div>
<div class="paragraph">
<p>The initial part of the displayed output, which is extensive, is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>verify OK
Certificate Request:
    Data:
        Version: 0 (0x0)
        Subject: CN=Couchbase Server
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
                    00:be:26:e5:06:c6:8e:43:bb:9d:bc:84:20:34:8e:
                    db:2f:d1:8b:b4:ff:c2:66:c0:61:70:8d:c3:8c:df:
                                      .
                                      .</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Version</code> and <code>Subject</code> of the request are listed, along with information on the public key that is to be included in the certificate.</p>
</div>
</li>
<li>
<p>Define <em>certificate extensions</em> for the node.
Certificate extensions specify constraints on how a certificate is to be used.
Extensions are submitted to the signing authority, along with the certificate signing request.</p>
<div class="paragraph">
<p>For example, the certificate&#8217;s public key can be specified, by means of the <code>keyUsage</code> extension, to support <em>digital signatures</em>, but <em>not</em> to support <em>key encipherment</em> &#8212; or, <em>the opposite</em> can be specified; or, support of <em>both</em> digital signatures <em>and</em> key encipherment can be specified.
Meanwhile, the <code>subjectAltName</code> extension can be used to specify the <em>DNS name</em> and <em>IP address</em> of the server on which the certificate resides; so that if the certificate is deployed in any other context, it becomes invalid.</p>
</div>
<div class="paragraph">
<p>For detailed information on certificate extensions, see the <a href="https://tools.ietf.org/html/rfc5280#section-4.2.1">Standard Extensions</a> section of the <a href="https://tools.ietf.org/html/rfc5280">Internet X.509 Public Key Infrastructure Certificate and Certificate Revocation List (CRL Profile)</a>.</p>
</div>
<div class="paragraph">
<p>Certificate extensions can be defined in a file, whose pathname is then provided as a parameter to the <code>openssl</code> command used to create the certificate.
Thus, such server-certificate extensions as are intended to be generic across all cluster-nodes might be written as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>cat &gt; server.ext &lt;&lt;EOF
basicConstraints=CA:FALSE
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer:always
extendedKeyUsage=serverAuth
keyUsage = digitalSignature,keyEncipherment
EOF</pre>
</div>
</div>
<div class="paragraph">
<p>The value of <code>extendedKeyUsage</code> is specified as <code>serverAuth</code>, indicating that the certificate is to be used for server authentication.
The values of <code>keyUsage</code> are <code>digitalSignature</code>, specifying that the certificate&#8217;s public key can be used in the verifying of information-origin; and <code>keyEncipherment</code>, specifying that the public key can be used in the encrypting of <em>symmetric keys</em> (through the exchange and use of which symmetrically encrypted communications between server and client can occur).</p>
</div>
</li>
<li>
<p>Create a customized certificate extensions file, which adds <em>per node</em> constraints to the generic constraints already specified.</p>
<div class="listingblock">
<div class="content">
<pre>cp ./server.ext ./server.ext.tmp

echo "subjectAltName = IP:10.143.192.102" \
&gt;&gt; ./server.ext.tmp</pre>
</div>
</div>
<div class="paragraph">
<p>This customized extensions file is to be used to authenticate a single node, whose IP address is <code>10.143.192.102</code>.
Note that if the DNS naming-convention is used by the cluster, the node&#8217;s DNS name might be specified instead: for example, <code>DNS:node2.cb.com</code>.
If the node is not identified appropriately in the certificate, authentication fails.</p>
</div>
<div class="paragraph">
<p>The creation of the customized extensions file should occur once for each node, with each customized extensions file containing only those extensions that apply to the current node.</p>
</div>
</li>
<li>
<p>Create the node certificate, applying the certificate and digital signature of the appropriate authority, and the customized extensions file for the node, to the materials in the signing request.</p>
<div class="paragraph">
<p>Enter the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>openssl x509 -CA ca.pem -CAkey ca.key -CAcreateserial -days 365 -req \
-in requests/couchbase.default.svc.csr \
-out public/couchbase.default.svc.pem \
-extfile server.ext.tmp</pre>
</div>
</div>
<div class="paragraph">
<p>The file generated by this command, <code>couchbase.default.svc.pem</code>, is the node certificate.
The root certificate and private key, <code>ca.pem</code> and <code>ca.key</code>, are specified as input values to the certificate-creation command.
This ensures that the new certificate&#8217;s chain of trust includes the root certificate, <code>ca.pem</code>, and is digitally signed by <code>ca.key</code>; allowing that signature to be verified by means of the public key.</p>
</div>
<div class="paragraph">
<p>The following confirmatory output is displayed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Signature ok
subject=/CN=Couchbase Server
Getting CA Private Key</pre>
</div>
</div>
<div class="paragraph">
<p>Note that if a node certificate were actually submitted to an external authority for signing, then the authority&#8217;s own <code>pem</code> and <code>key</code> would be specified as inputs, rather than <code>ca.pem</code> and <code>ca.key</code>: and in such a case, the authority&#8217;s <code>pem</code> would need to become the root certificate for the cluster.</p>
</div>
</li>
<li>
<p>Rename the node certificate and node private key.
For deployment on the node, the node certificate must be renamed <code>chain.pem</code>; and the node private key renamed <code>pkey.key</code>.
Proceed as follows:</p>
<div class="listingblock">
<div class="content">
<pre>cd ./public
mv couchbase.default.svc.pem chain.pem
cd ../private
mv couchbase.default.svc.key pkey.key</pre>
</div>
</div>
</li>
<li>
<p>Deploy the node certificate and node private key.
These are deployed by being moved to the <code>inbox</code> directory of the server, and made <em>executable</em>.
The <code>inbox</code> directory must be created by the administrator.
Proceed as follows:</p>
<div class="listingblock">
<div class="content">
<pre>cd ..
sudo mkdir /opt/couchbase/var/lib/couchbase/inbox/
sudo cp ./public/chain.pem /opt/couchbase/var/lib/couchbase/inbox/chain.pem
sudo cp ./private/pkey.key /opt/couchbase/var/lib/couchbase/inbox/pkey.key</pre>
</div>
</div>
</li>
<li>
<p>Ensure that all certificate and private key files in the <code>inbox</code> directory can be read by user <code>couchbase</code>.
This can be achieved by changing ownership of the files to <code>couchbase</code>, and setting <code>0600</code> permissions.</p>
</li>
<li>
<p>Deploy the root certificate.
This is achieved by creating the directory <code>CA</code>, within the previously created <code>inbox</code> directory, and copying the root certificate into the <code>CA</code> directory.
Proceed as follows:</p>
<div class="listingblock">
<div class="content">
<pre>sudo mkdir /opt/couchbase/var/lib/couchbase/inbox/CA
sudo cp ./ca.pem /opt/couchbase/var/lib/couchbase/inbox/CA/.</pre>
</div>
</div>
</li>
<li>
<p><em>Upload</em> the root certificate for the cluster.
Use the following REST command:</p>
<div class="listingblock">
<div class="content">
<pre>curl -X POST http://10.143.192.102:8091/node/controller/loadTrustedCAs -u Administrator:password</pre>
</div>
</div>
<div class="paragraph">
<p>All root certificates currently resident in the <code>CA</code> directory are now placed in the trust store, and are ready for use.
This can be verified by means of Couchbase Web Console: access the <strong>Security</strong> screen, by means of the <strong>Security</strong> option in the left-hand navigation bar.
Then, left-click on the <strong>Certificates</strong> tab, located on the upper, horizontal navigation bar.</p>
</div>
<div id="see-root-certificate-with-couchbase-web-console" class="paragraph">
<p>The screen&#8217;s left-hand panel appears as follows:</p>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-security/rootCertificateWithSignedCert.png" alt="600">
</div>
</div>
<div class="paragraph">
<p>The original <em>generated</em> root certificate appears at the top.
A notification is now provided, to the effect that this <code>doesn&#8217;t seem to be used by any node anymore.</code>
The new, <em>uploaded</em> root certificate appears below.
The text of each certificate appears in the panel to the right.
Details on the certificate, and button for certificate-deletion, appear at the left.
Note that a certificate cannot be deleted once it has provided its authority to one or more node certificates on the cluster.</p>
</div>
<div class="paragraph">
<p>For further information on the <strong>Certificates</strong> tab on the <strong>Security</strong> screen, see <a href="manage-security-settings.html#root-certificate-security-screen-display" class="xref page">Certificates</a>.</p>
</div>
</li>
<li>
<p><em>Load</em> the node certificate that was copied into the <code>inbox</code>, with its private key:</p>
<div class="listingblock">
<div class="content">
<pre>curl -X POST http://10.143.192.102:8091/node/controller/reloadCertificate -u Administrator:password</pre>
</div>
</div>
<div class="paragraph">
<p>The node certificate is now activated for the current node, bearing the authority of the root CA with which it was signed.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note that when, as is typical, the cluster contains more than one node, this step must be performed on <em>each node</em> of the cluster, with each individual IP address thereby specified in turn.</p>
</div>
<div class="paragraph">
<p>For more information using the REST API to manage certificates, see <a href="../../rest-api/rest-certificate-management.html" class="xref page">Certificate Management API</a>.
This includes details on retrieving root and nodes certificates that have been uploaded, and on certificate deletion.</p>
</div>
<div class="sect2">
<h3 id="configure-client-access-simple"><a class="anchor" href="#configure-client-access-simple"></a>Configuring Client Access</h3>
<div class="paragraph">
<p>Once the cluster has been protected by the deployment of root and node certificates described above, a <em>client</em> certificate can be signed by the root certificate, to allow a client to access the cluster.
Client-certificate preparation varies, depending on the type of client to be supported.
For steps to prepare a certificate supportive of Couchbase Server, see <a href="configure-client-certificates.html#client-certificate-authorized-by-a-root-certificate" class="xref page">Client Access: Root-Certificate Authorization</a>.
For steps to prepare a certificate supportive of a Java client, see <a href="configure-client-certificates.html#java-client-access-root-certificate-authorization" class="xref page">Java Client Access: Root-Certificate Authorization</a>.</p>
</div>
<div class="paragraph">
<p>Note that access by means of a client certificate must be specifically enabled, on the cluster that is to be accessed: see <a href="enable-client-certificate-handling.html" class="xref page">Enable Client-Certificate Handling</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="root-intermediate-and-node-certificates"><a class="anchor" href="#root-intermediate-and-node-certificates"></a>Cluster Protection with Root, Intermediate, and Node Certificates</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Optionally, a root certificate can be used to sign an <em>intermediate</em> certificate, which is then itself used to sign node certificates.
This increases security, since it minimizes use of the private key associated with the root certificate, when many node or client certificates are to be signed.</p>
</div>
<div class="paragraph">
<p>When a client attempts to access the cluster securely, it must be able to build the certificate chain used to convey the authority of the cluster&#8217;s root CA (see <a href="../../learn/security/certificates.html#intermediate-certificates" class="xref page">Intermediate Certificates</a>).
In Couchbase Server Version 7.1+, the certificates can be prepared for client inspection in either of two ways, which are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Concatenation of all intermediate and node certificates into a single <em>chain.pem</em> file, which is uploaded from the node&#8217;s <em>inbox</em>.</p>
</li>
<li>
<p>Upload, from the node&#8217;s inbox, of a <em>chain.pem</em> file containing only the unconcatenated node certificate; with the expectation that each intermediate certificate resides in the client&#8217;s <em>trust store</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Both procedures are shown below.
For more information, see <a href="../../learn/security/using-multiple-cas.html#adding-intermediate-certificates-to-the-trust-store" class="xref page">Adding Intermediate Certificates to the Trust Store</a>.</p>
</div>
<div class="paragraph">
<p>The steps and descriptions in the procedures below assume that the previous procedure, <a href="#root-and-node-certificates">Cluster Protection with Root and Node Certificates</a>, has already been successfully completed; and that familiarity with the basic certificate-related concepts explained there has been attained.</p>
</div>
<div class="paragraph">
<p>Note that corresponding, subsequent procedures that create certificates for <em>client</em>-authentication are provided in <a href="configure-client-certificates.html#client-certificate-authorized-by-an-intermediate-certificate" class="xref page">Client Access: Intermediate Certificate Authorization</a> and <a href="configure-client-certificates.html#java-client-access-intermediate-certificate-authorization" class="xref page">Java Client Access: Intermediate Certificate Authorization</a></p>
</div>
<div class="sect2">
<h3 id="intermediate-concatenation"><a class="anchor" href="#intermediate-concatenation"></a>Deploying an Intermediate Certificate as Part of the Node&#8217;s Chain</h3>
<div class="paragraph">
<p>Proceed as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On the node to be certificate-protected, create working directories:</p>
<div class="listingblock">
<div class="content">
<pre>mkdir servercertfiles2
cd servercertfiles2
mkdir -p {root,servers,clients}/{issued,reqs,private}</pre>
</div>
</div>
<div class="paragraph">
<p>The directories <code>root</code>, <code>servers</code>, and <code>clients</code> will contain the issued certificates, requests, and private keys generated for the root, the individual nodes, and clients wishing to access the nodes.
Each directory therefore contains <code>issued</code>, <code>reqs</code>, and <code>private</code> subdirectories.</p>
</div>
<div class="paragraph">
<p>Note that this directory infrastructure will also be used in the subsequent process, <a href="configure-client-certificates.html#client-certificate-authorized-by-an-intermediate-certificate" class="xref page">Client Access: Intermediate Certificate Authorization</a>; where the contents of the <code>clients</code> directory will be created.</p>
</div>
</li>
<li>
<p>Change directory to <code>root</code>.
Then, create a configuration file for the root certificate that is to be created.</p>
<div class="listingblock">
<div class="content">
<pre>cd root

cat &gt; config &lt;&lt;EOF
[req]
distinguished_name = cn_only
x509_extensions = ca_ext
[ cn_only ]
commonName = Common Name (eg: your user, host, or server name)
commonName_max = 64
commonName_default = CA
[ca_ext]
basicConstraints = CA:TRUE
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid:always,issuer:always
keyUsage = cRLSign, keyCertSign
EOF</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>config</code> file has three sections. The first, <code>req</code>, specifies values to be passed to the <code>req</code> command, which is used to create and process certificate requests: use <code>man req</code> to obtain information on the values passed.
The second section, <code>cn_only</code>, provides specifications for the Common Name to be used in the certificate, including the maximum number of characters and the default name.
The third section, <code>ca_ext</code>, provides basic extensions that limit the capability of the certificate.
These include a value of <code>TRUE</code> for <code>CA</code>, indicating that the certificate will be able to provide signing authority for other certificates.
Additionally, the values for <code>keyUsage</code> are provided as <code>cRLSign</code>, indicating that the certificate&#8217;s public key will be usable to verify signatures on <em>Certificate Revocation Lists</em>; and <code>keyCertSign</code>, indicating that the certificate&#8217;s public key will be usable to verify signatures on other certificates.</p>
</div>
</li>
<li>
<p>Create the root certificate, specifying the created <code>config</code> file.</p>
<div class="listingblock">
<div class="content">
<pre>openssl req -config config -new -x509 -days 3650 -sha256 -newkey rsa:2048 \
-keyout ca.key -out ca.pem -subj '/C=UA/O=MyCompany/CN=RootCA'</pre>
</div>
</div>
<div class="paragraph">
<p>This specifies that both the root certificate for the cluster and its private key be created.
The key is additionally specified to be encrypted.
In consequence, during execution, the following prompt is displayed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Generating a 2048 bit RSA private key
....+++
...................+++
writing new private key to 'ca.key'
Enter PEM pass phrase:</pre>
</div>
</div>
<div class="paragraph">
<p>This requires that a <em>pass phrase</em> be entered, for inclusion of the key in command-line procedures, such as those used for certificate generation.
The phrase will be stored in the certificate, and prompted for whenever administrative access is attempted.
Enter an appropriate phrase: a second prompt then appears, requesting confirmation of the phrase.
Enter the phrase again, and the operation completes.</p>
</div>
<div class="paragraph">
<p>The output file, <code>ca.pem</code> is the root certificate for the cluster, and is saved in the <code>root</code> folder.
(Note that in the steps that follow, other certificates named <code>ca.pem</code> are created in additional folders: these should not be confused with the certificate of the same name in <code>root</code>.)</p>
</div>
</li>
<li>
<p>Create an extensions file that will limit the capabilities of the <em>intermediate</em> certificate that is to be created.</p>
<div id="create-intermediate-extensions-file" class="paragraph">
<p>Enter the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>cat &gt; int.ext &lt;&lt;EOF
basicConstraints = CA:TRUE
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid:always,issuer:always
keyUsage = cRLSign, keyCertSign
EOF</pre>
</div>
</div>
<div class="paragraph">
<p>Here, <code>CA</code> is set to <code>TRUE</code>, meaning that the intermediate certificate will be able to act as an authority for other certificates (specifically, for the individual, per node certificates used by the cluster).
The specified <code>keyUsage</code> includes the value <code>keyCertSign</code>, meaning that the intermediate certificate&#8217;s public key will be used to verify signatures that appear on other certificates.</p>
</div>
</li>
<li>
<p>Create a private key and corresponding certificate signing request for the intermediate certificate.</p>
<div class="listingblock">
<div class="content">
<pre>openssl req -new -sha256 -newkey rsa:2048 -keyout ../servers/int.key \
-out reqs/server-signing.csr \
-subj '/C=UA/O=MyCompany/OU=Servers/CN=ServerSigningCA'</pre>
</div>
</div>
<div class="paragraph">
<p>Again, the key is specified to be encrypted.
Therefore, prompts appear, asking for a pass phrase for the certificate.
Enter an appropriate phrase in response to the prompts.</p>
</div>
<div class="paragraph">
<p>The output from the request consists of the encrypted private key <code>../servers/int.key</code> and the signing-request <code>req/server-signing.csr</code>.</p>
</div>
</li>
<li>
<p>Create the intermediate certificate, specifying the root certificate <code>ca.pem</code> and its key <code>ca.key</code>, to establish the root certificate&#8217;s authority.</p>
<div class="listingblock">
<div class="content">
<pre>openssl x509 -CA ca.pem -CAkey ca.key -CAcreateserial \
-CAserial serial.srl -days 3650 -req -in reqs/server-signing.csr \
-out issued/server-signing.pem -extfile int.ext</pre>
</div>
</div>
<div class="paragraph">
<p>Since this specifies that the encrypted key <code>ca.key</code> be used to sign the intermediate certificate, the user is prompted for the appropriate pass phrase.
Enter the phrase against the prompt.</p>
</div>
<div class="paragraph">
<p>The extension file <code>int.ext</code> is thus applied to the certificate, so as to limit the certificate&#8217;s capabilities.
The certificate is generated and saved in the <code>reqs</code> folder as <code>server-signing.pem</code>.</p>
</div>
</li>
<li>
<p>Save the intermediate certificate as the authority for the node certificates that are to be created.</p>
<div class="listingblock">
<div class="content">
<pre>cp issued/server-signing.pem ../servers/int.pem</pre>
</div>
</div>
</li>
<li>
<p>Within the <code>../servers</code> directory, create an extension file containing the information that will be generic across all the individual nodes of the cluster.</p>
<div class="listingblock">
<div class="content">
<pre>cd ../servers

cat &gt; server.ext &lt;&lt;EOF
basicConstraints = CA:FALSE
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer:always
extendedKeyUsage = serverAuth
keyUsage = digitalSignature,keyEncipherment
EOF</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>extendedKeyUsage</code> value <code>serverAuth</code> indicates that the certificate will be used for server authentication.
The <code>keyUsage</code> value <code>digitalSignature</code> specifies that the certificate&#8217;s public key can be used in the verifying of information-origin; while <code>keyEncipherment</code> allows the public key to be used in the encrypting of symmetric keys.</p>
</div>
</li>
<li>
<p>Generate the private key to be used for the individual cluster-node.</p>
<div class="listingblock">
<div class="content">
<pre>openssl genrsa -out private/couchbase.node.svc.key 2048</pre>
</div>
</div>
<div class="paragraph">
<p>The private key <code>couchbase.node.svc.key</code> is thus saved in the <code>private</code> folder, as the private key for the node.</p>
</div>
</li>
<li>
<p>Generate the certificate signing request for the node certificate.</p>
<div class="listingblock">
<div class="content">
<pre>openssl req -new -key private/couchbase.node.svc.key \
-out reqs/couchbase.node.svc.csr \
-subj "/C=UA/O=MyCompany/OU=Servers/CN=couchbase.node.svc"</pre>
</div>
</div>
<div class="paragraph">
<p>The signing-request file <code>couchbase.node.svc.csr</code> is thus saved in the <code>reqs</code> folder.</p>
</div>
</li>
<li>
<p>Add node-specific information for each node, in turn.
Although the current example features a single-node cluster, this step would be repeated for each node in the cluster, if the cluster contained multiple nodes: in each case, the node-specific information (here, the node&#8217;s IP address) being different.</p>
<div class="listingblock">
<div class="content">
<pre>cp server.ext temp.ext

echo 'subjectAltName = IP:10.143.192.102' &gt;&gt; temp.ext</pre>
</div>
</div>
<div class="paragraph">
<p>This creates <code>temp.ext</code> as an extension file that will be used for one node only.
The file specifies the IP address specific to the node.</p>
</div>
</li>
<li>
<p>Create the node certificate for an individual node, specifying the unique extension file for the node, and specifying the intermediate certificate and key as the signing authority.</p>
<div class="listingblock">
<div class="content">
<pre>openssl x509 -CA int.pem -CAkey int.key -CAcreateserial \
-CAserial serial.srl -days 365 -req -in reqs/couchbase.node.svc.csr \
-out issued/couchbase.node.svc.pem -extfile temp.ext</pre>
</div>
</div>
<div class="paragraph">
<p>Since this specifies that the certificate should be signed by the encrypted intermediate key, <code>int.key</code>, a prompt appears, requesting the appropriate pass phrase.
Enter the phrase against the prompt.</p>
</div>
<div class="paragraph">
<p>The node-certificate file <code>couchbase.node.svc.pem</code> is hereby saved in the <code>issued</code> folder.
The certificate bears the constraints specified in <code>temp.ext</code>, and is granted the authority of the intermediate certificate and key, which are <code>int.pem</code> and <code>int.key</code> respectively.</p>
</div>
</li>
<li>
<p><a id="check-validity"></a>Check that the node certificate is valid.
The following use of the <code>openssl</code> command verifies the relationship between the root certificate, the intermediate certificate, and the node certificate.</p>
<div class="listingblock">
<div class="content">
<pre>openssl verify -trusted ../root/ca.pem -untrusted int.pem \
issued/couchbase.node.svc.pem</pre>
</div>
</div>
<div class="paragraph">
<p>If the certificate is valid, the following output is displayed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>issued/couchbase.node.svc.pem: OK</pre>
</div>
</div>
</li>
<li>
<p>Prepare to deploy the certificate and private key for the node.
First, concatenate the node certificate and the intermediate certificate, to establish the chain of authority.
Then, rename the private key for the node.</p>
<div class="listingblock">
<div class="content">
<pre>cat issued/couchbase.node.svc.pem int.pem &gt; chain.pem

cp private/couchbase.node.svc.key pkey.key</pre>
</div>
</div>
</li>
<li>
<p>Move the node certificate and node private key into the <code>inbox</code> for the current node.</p>
<div class="listingblock">
<div class="content">
<pre>sudo mkdir /opt/couchbase/var/lib/couchbase/inbox/  # if needed

sudo cp ./chain.pem /opt/couchbase/var/lib/couchbase/inbox/chain.pem
sudo cp ./pkey.key /opt/couchbase/var/lib/couchbase/inbox/pkey.key</pre>
</div>
</div>
</li>
<li>
<p>Ensure that all certificate and private key files in the <code>inbox</code> directory can be read by user <code>couchbase</code>.
This can be achieved by changing ownership of the files to <code>couchbase</code>, and setting <code>0600</code> permissions.</p>
</li>
<li>
<p>Move the root certificate into the <code>inbox/CA</code> directory for the current node.</p>
<div class="listingblock">
<div class="content">
<pre>sudo mkdir /opt/couchbase/var/lib/couchbase/inbox/CA/  # if needed
cd ../root
sudo cp ca.pem /opt/couchbase/var/lib/couchbase/inbox/CA/.</pre>
</div>
</div>
</li>
<li>
<p>Upload the root certificate, thereby activating it for the entire cluster.</p>
<div class="listingblock">
<div class="content">
<pre>curl -X POST http://10.143.192.102:8091/node/controller/loadTrustedCAs -u Administrator:password</pre>
</div>
</div>
</li>
<li>
<p>Upload the node certificate, specifying the established password for the private key.</p>
<div class="listingblock">
<div class="content">
<pre>curl -X POST http://10.143.192.102:8091/node/controller/reloadCertificate -u Administrator:password</pre>
</div>
</div>
<div class="paragraph">
<p>Note that when, as is typical, the cluster contains more than one node, the <code>/node/controller/reloadCertificate</code> command must be executed on each node, specifying the IP address of the node on which execution is occurring.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>This concludes the certificate-deployment process.
The root certificate can be examined by means of Couchbase Web Console, as shown in <a href="#see-root-certificate-with-couchbase-web-console">Step 13</a> of the previous example on this page.</p>
</div>
<div class="paragraph">
<p>For more information using the REST API to manage certificates, see <a href="../../rest-api/rest-certificate-management.html" class="xref page">Certificate Management API</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="intermediate-upload"><a class="anchor" href="#intermediate-upload"></a>Deploying an Intermediate Certificate via Trust Store</h3>
<div class="paragraph">
<p>Proceed as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Perform all steps listed in the section <a href="#intermediate-concatenation">Representing Intermediate Certificates through Concatenation</a>, above; up to and including the step <a href="#check-validity">Check that the node certificate is valid</a>.</p>
</li>
<li>
<p>Prepare to deploy the certificate and private key for the node, by renaming both:</p>
<div class="listingblock">
<div class="content">
<pre>cp issued/couchbase.node.svc.pem chain.pem

cp private/couchbase.node.svc.key pkey.key</pre>
</div>
</div>
</li>
<li>
<p>Move the renamed node certificate and private key into the <code>inbox</code> for the current node.</p>
<div class="listingblock">
<div class="content">
<pre>sudo mkdir /opt/couchbase/var/lib/couchbase/inbox/  # if needed

sudo cp ./chain.pem /opt/couchbase/var/lib/couchbase/inbox/chain.pem
sudo cp ./pkey.key /opt/couchbase/var/lib/couchbase/inbox/pkey.key</pre>
</div>
</div>
</li>
<li>
<p>Ensure that all certificate and private key files in the <code>inbox</code> directory can be read by user <code>couchbase</code>.
This can be achieved by changing ownership of the files to <code>couchbase</code>, and setting <code>0600</code> permissions.</p>
</li>
<li>
<p>Move the root certificate and the intermediate certificate into the <code>inbox/CA</code> directory for the current node.</p>
<div class="listingblock">
<div class="content">
<pre>sudo mkdir /opt/couchbase/var/lib/couchbase/inbox/CA/  # if needed
sudo cp int.pem /opt/couchbase/var/lib/couchbase/inbox/CA/.
cd ../root
sudo cp ca.pem /opt/couchbase/var/lib/couchbase/inbox/CA/.</pre>
</div>
</div>
</li>
<li>
<p>Upload the root and intermediate certificates.</p>
<div class="listingblock">
<div class="content">
<pre>curl -X POST http://10.143.192.102:8091/node/controller/loadTrustedCAs -u Administrator:password</pre>
</div>
</div>
</li>
<li>
<p>Upload the node certificate, specifying the established password for the private key.</p>
<div class="listingblock">
<div class="content">
<pre>curl -X POST http://10.143.192.102:8091/node/controller/reloadCertificate -u Administrator:password</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note that when, as is typical, the cluster contains more than one node, the <code>/node/controller/reloadCertificate</code> command must be executed on each node, specifying the IP address of the node on which execution is occurring.</p>
</div>
<div class="paragraph">
<p>This concludes the certificate-deployment process.
The root certificate can be examined by means of Couchbase Web Console, as shown in <a href="#see-root-certificate-with-couchbase-web-console">Step 13</a> of the previous example on this page.</p>
</div>
<div class="paragraph">
<p>For more information using the REST API to manage certificates, see <a href="../../rest-api/rest-certificate-management.html" class="xref page">Certificate Management API</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="using-an-encrypted-private-node-key"><a class="anchor" href="#using-an-encrypted-private-node-key"></a>Using an Encrypted, Private Node-Key</h3>
<div class="paragraph">
<p>The above examples use an <em>unencrypted</em> private key, for the node.
If an <em>encrypted</em> private node-key is used, a passphrase must be registered for it, so that the key can be securely retrieved and used when required.
See the reference page <a href="#rest-api/upload-retrieve-node-cert.adoc" class="xref unresolved">Upload and Retrieve a Node Certificate</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="configure-client-access-advanced"><a class="anchor" href="#configure-client-access-advanced"></a>Configuring Client Access</h3>
<div class="paragraph">
<p>Once the cluster has been protected by the deployment of root, intermediate, and node certificates described above, a <em>client</em> certificate can be signed by a <em>client-intermediate</em> certificate that itself inherits the authority of the root: this allows the client certificate to access the cluster.
Client-certificate preparation varies, depending on the type of client to be supported.
For steps to prepare a certificate supportive of Couchbase Server, see <a href="configure-client-certificates.html#client-certificate-authorized-by-an-intermediate-certificate" class="xref page">Client Access: Intermediate-Certificate Authorization</a>.
For steps to prepare a certificate supportive of a Java client, see <a href="configure-client-certificates.html#java-client-access-intermediate-certificate-authorization" class="xref page">Java Client Access: Intermediate-Certificate Authorization</a>.</p>
</div>
<div class="paragraph">
<p>Note that access by means of a client certificate must be specifically enabled, on the cluster that is to be accessed: see <a href="enable-client-certificate-handling.html" class="xref page">Enable Client-Certificate Handling</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="protection-of-multi-node-clusters"><a class="anchor" href="#protection-of-multi-node-clusters"></a>Protection of Multi-Node Clusters</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When the certificate-management procedures described above are used, as intended, for multi-node clusters, the following should be observed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each CA certificate to be used by the cluster must be copied into an appropriately located <code>inbox/CA</code> directory on a cluster node, and must be loaded from there, using the call demonstrated above, and fully described in <a href="#rest-api:load-trusted.cas.adoc" class="xref unresolved">Load Root Certificates</a>.</p>
</li>
<li>
<p>A separate <code>chain.pem</code> must be prepared for each node.
Each <code>chain.pem</code> should be generated from a new, unique private key (<code>pkey.key</code>); must be an appropriate concatenation of the node certificate with whatever intermediate certificates have formed its chain; and must have its own node&#8217;s IP address specified as a <code>subjectAltName</code>.</p>
</li>
<li>
<p>If created on the same system as all other keys and certificates, the <code>chain.pem</code> and <code>pkey.key</code> for each node must be independently transferred onto the node they are intended to protect.
An inbox must be created on that node, and the <code>chain.pem</code> and <code>pkey.key</code> files then moved there.</p>
</li>
<li>
<p>The node certificate must be reloaded individually for each node in the cluster, after the <code>chain.pem</code> and <code>pkey.key</code> file have been moved into the node&#8217;s inbox.
Each reload command must therefore specify the node&#8217;s own IP address.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="adding-new-nodes"><a class="anchor" href="#adding-new-nodes"></a>Adding and Joining New Nodes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If a cluster uses <em>system-generated</em> certificates, which Couchbase Server provides by default, no certificate-related work needs to be performed in order to add or join a new node to the cluster.
However, once a cluster is using <em>uploaded</em> certificates, a node that is to be added or joined must itself be provisioned with conformant certificates, before addition or joining can be successfully performed: this means that the appropriate <em>chain</em> file (containing the node certificate) and <em>private key</em> must have been placed in the node&#8217;s <code>inbox</code>, and the appropriate REST API then called.
From Couchbase Server Version 7.1, the new node is now always added or joined over an <em>encrypted</em> connection.</p>
</div>
<div class="paragraph">
<p>Note also that when a cluster is using uploaded certificates, and a new node is added or joined to a cluster, the operation is performed with reference to a particular node that is already a member of the cluster.
Since this <em>cluster node</em> and this <em>new node</em> must be able to connect with one another, each must trust the CA of the other.
Therefore:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the two nodes already have the same CA, connection and node-addition (or node-joining) can occur.</p>
</li>
<li>
<p>If the two nodes do <em>not</em> have the same CA, the CA of each must be loaded onto the other; after which, connection and node-addition (or node-joining) can occur.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="readding-a-previously-removed-node"><a class="anchor" href="#readding-a-previously-removed-node"></a>Re-Adding a Previously Removed Node</h3>
<div class="paragraph">
<p>When a node is removed from a cluster, its configuration is deleted.
If the removed node is subsequently re-added to the cluster, it is added as a new node, with a new definition of its configuration.
Consequently, the appropriate root certificate and chain certificate for the node must again be loaded.</p>
</div>
<div class="paragraph">
<p>For more information on node removal, see <a href="../../learn/clusters-and-availability/removal.html" class="xref page">Removal</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="regenerating-default-certificates"><a class="anchor" href="#regenerating-default-certificates"></a>Regenerating Default Certificates</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>Default</em> certificates provided automatically by Couchbase Server &#8212; including the <em>root</em> certificate and each of the <em>node</em> certificates for the cluster &#8212; can be <em>regenerated</em> at any time, by means of the REST API.
This means that the current node certificates and (if they have been uploaded) intermediate certificates are removed; and new, system-generated root and node certificates are made active for the node.</p>
</div>
<div class="paragraph">
<p>Note that previously system-generated and uploaded root certificates remain in the trust store of the cluster, unless explicitly deleted.
For information on regenerating certificates, see <a href="../../rest-api/rest-regenerate-all-certs.html" class="xref page">Regenerate All Certificates</a>.
For information on deleting root certifictes, see <a href="../../rest-api/delete-trusted-cas.html" class="xref page">Delete Root Certificates</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="further-information"><a class="anchor" href="#further-information"></a>Further Information</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For information on certificate-management by means of the REST API, see <a href="#cli:cbcli/couchbase-cli-ssl-manage.adoc" class="xref unresolved">ssl-manage</a> and <a href="../../rest-api/rest-certificate-management.html" class="xref page">Certificate Management API</a>.</p>
</div>
<div class="paragraph">
<p>For step-by-step instructions on creating <em>client</em> certificates, see <a href="configure-client-certificates.html" class="xref page">Configure Client Certificates</a>.</p>
</div>
<div class="paragraph">
<p>For an example of using the certificates and keys created on the current page and on <a href="configure-client-certificates.html" class="xref page">Configure Client Certificates</a> to secure an <em>XDCR replication</em>, see <a href="../manage-xdcr/enable-full-secure-replication.html#specify-full-xdcr-security-with-certificates" class="xref page">Specify Root and Client Certificates, and Client Private Key</a>.</p>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2023 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Server","components":["server"],"url":"/home/server.html","latestVersions":{"server":"7.2"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../../../_/js/site.js"></script>
<script defer src="../../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
</body>
</html>
