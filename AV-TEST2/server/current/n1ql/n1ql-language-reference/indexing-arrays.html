<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<script>(window.dataLayer=window.dataLayer||[]).push({event:'gtm.js','gtm.start':+new Date()})</script>
<script async src="https://www.googletagmanager.com/gtm.js?id=GTM-MVPNN2"></script>
<title>Array Indexing | Couchbase Docs</title>
<link rel="stylesheet" href="../../../../_/css/site.css">
<script src="../../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="Array Indexing adds the capability to create global indexes on array elements and optimizes the execution of queries involving array elements.">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="server">
<meta name="dcterms.identifier" content="7.2">
<meta name="page-url" content="/server/current/n1ql/n1ql-language-reference/indexing-arrays.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://docs.couchbase.com/home/index.html">
                    <img src="../../../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://docs.couchbase.com/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../cloud/index.html">
                      Capella
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/pages/n1ql-language-reference/indexing-arrays.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../../introduction/intro.html">Couchbase Server</a></li>
<li class="crumb"><a href="../query.html">Query</a></li>
<li class="crumb"><a href="index.html">SQL++ Language Reference</a></li>
<li class="crumb">Statements</li>
<li class="crumb"><a href="createindex.html">CREATE INDEX</a></li>
<li class="crumb"><a href="indexing-arrays.html">Array Indexing</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Array Indexing</h1>
<div class="labels">
<ul><li class="reference"><span><i class="fas fa-book"></i></i> reference</span></li>
</ul>
</div>


</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Array Indexing adds the capability to create global indexes on array elements and optimizes the execution of queries involving array elements.</p>
</div>
<div class="paragraph">
<p>This is a huge leap from the previous versions where secondary indexes could only be created and subsequently queried on whole arrays.
You can now create an index of array elements ranging from plain scalar values to complex arrays or JSON objects nested deeper in the array.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="syntax"><a class="anchor" href="#syntax"></a>Syntax</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To create an array index, the overall syntax is the same as for a global secondary index.
The distinguishing feature is the use of an array expression as an index key.</p>
</div>
<div class="paragraph">
<p>Refer to the <a href="createindex.html" class="xref page">CREATE INDEX</a> statement for details of the syntax.</p>
</div>
<div class="sect2">
<h3 id="index-key"><a class="anchor" href="#index-key"></a>Index Key</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/ddl.ebnf#L71">index-key ::= expr | array-expr</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/index-key.png" alt="Syntax diagram: refer to source code listing">
</div>
</div>
<div class="paragraph">
<p>To create an array index, one index key must be an array expression.
The index key containing the array expression is referred to as the <em>array index key</em>.
The index definition may also contain other index keys which are not array expressions.</p>
</div>
<div id="index-key-args" class="dlist">
<dl>
<dt class="hdlist1">expr</dt>
<dd>
<p>A SQL++ <a href="index.html" class="xref page">expression</a> over any fields in the document.
This cannot use constant expressions, aggregate functions, or sub-queries.</p>
</dd>
<dt class="hdlist1">array-expr</dt>
<dd>
<p>An array expression.
Refer to <a href="#array-expr">Array Expression</a> below.</p>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Array Index Key</div>
<div class="paragraph">
<p>Currently, the index definition for an array index may only contain one array index key.
However, the array index key may index more than one field or expression within the array, as described below.</p>
</div>
<div class="paragraph">
<p>For an UNNEST scan to use an array index, the array index key containing the appropriate array expression must be the <em>leading key</em> of the index definition.
The UNNEST scan can generate index spans on other non-leading index keys when appropriate predicates exist.</p>
</div>
<div class="paragraph">
<p>In order for the optimizer to select the correct array index for a SELECT, UPDATE, or DELETE statement, the query predicate which appears in the WHERE clause must be constructed to match the format of the array index key.
See <a href="#query-predicate-format">Format of Query Predicate</a> for details.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><span class="status">Couchbase Server 7.1.2</span></p>
</div>
<div class="paragraph">
<p>In Couchbase Server 7.1.2 and later, you can add the <code>INCLUDE MISSING</code> modifier to a leading array index key, just as you can with any other leading index key, in order to index documents in which the specified array is missing.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="array-expr"><a class="anchor" href="#array-expr"></a>Array Expression</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/ddl.ebnf#L91">array-expr ::= full-array-expr | simple-array-expr</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/array-expr.png" alt="Syntax diagram: refer to source code listing">
</div>
</div>
<div class="paragraph">
<p>The array expression can be either a <a href="#full-array-expr">full array expression</a>, which uses the <code>ARRAY</code> operator to index specified fields and elements within the array; or a <a href="#simple-array-expr">simple array expression</a>, which indexes all fields and elements in the array.</p>
</div>
<div class="sect3">
<h4 id="full-array-expr"><a class="anchor" href="#full-array-expr"></a>Full Array Expression</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/ddl.ebnf#L95-L97">full-array-expr ::= ( 'ALL' | 'DISTINCT' ) 'ARRAY' var-expr
                    'FOR' var ( 'IN' | 'WITHIN' ) expr
                    ( ',' var ( 'IN' | 'WITHIN' ) expr )* ( 'WHEN' cond )? 'END'</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/full-array-expr.png" alt="Syntax diagram: refer to source code listing">
</div>
</div>
<div class="paragraph">
<p>The <code>ARRAY</code> operator lets you map and filter the elements or attributes of a collection, object, or objects.
It evaluates to an array of the operand expression that satisfies the WHEN clause, if specified.</p>
</div>
<div id="full-array-expr-args" class="dlist">
<dl>
<dt class="hdlist1">var-expr</dt>
<dd>
<p>A function of the <code>var</code> variable used in the FOR clause.</p>
</dd>
<dt class="hdlist1">var</dt>
<dd>
<p>Represents elements in the array specified by <code>expr</code>.</p>
</dd>
<dt class="hdlist1">expr</dt>
<dd>
<p>Evaluates to an array of objects, elements of which are represented by the <code>var</code> variable.</p>
</dd>
<dt class="hdlist1">cond</dt>
<dd>
<p>Specifies predicates to qualify the subset of documents to include in the index array.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Variable Expression</div>
<div class="paragraph">
<p>In Couchbase Server 7.1 and later, you can index one or more expressions <em>within</em> the array (up to maximum of 32) by using the <a href="metafun.html#flatten_keys" class="xref page">FLATTEN_KEYS()</a> function in the <code>var-expr</code>.
This function flattens expressions within the array, as if they were separate index keys; and all subsequent index keys are accordingly moved to the right.
Queries will be <a href="selectintro.html#index-selection" class="xref page">sargable</a> and will generate spans.
Refer to <a href="#query-predicate-format">Format of Query Predicate</a> below.</p>
</div>
<div class="paragraph">
<p>The <code>var-expr</code> itself may be a nested <a href="#array-expr">array expression</a>.
This enables creating array indexes on nested array fields.
Refer to <a href="#example-5">Example 6</a> below.</p>
</div>
<div class="paragraph">
<p>To create an array index involving multiple array elements or multiple arrays, you may construct the <code>var-expr</code> as a compound object constituted with different elements of the same array or multiple arrays.
Refer to <a href="#example-6">Example 7</a> below.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><span class="status">Couchbase Server 7.1.2</span></p>
</div>
<div class="paragraph">
<p>In Couchbase Server 7.1.2 and later, you can add the <code>INCLUDE MISSING</code> modifier to the first argument in the <a href="metafun.html#flatten_keys" class="xref page">FLATTEN_KEYS()</a> function, in order to index array elements in which the specified field is missing.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="simple-array-expr"><a class="anchor" href="#simple-array-expr"></a>Simple Array Expression</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/tony.hillman/Documents/71docs/docs-server/modules/n1ql/partials/grammar/ddl.ebnf#L101">simple-array-expr ::= ( 'ALL' | 'DISTINCT' ) expr</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/simple-array-expr.png" alt="Syntax diagram: refer to source code listing">
</div>
</div>
<div class="paragraph">
<p>Couchbase Server 5.0 and later provides a simpler syntax for array indexing when all array elements are indexed as is, without needing to use the <code>ARRAY</code> operator in the index definition.</p>
</div>
<div id="simple-array-expr-args" class="dlist">
<dl>
<dt class="hdlist1">expr</dt>
<dd>
<p>An array field name, or an expression that can evaluate to an array.
In this case, all fields and elements of the array are indexed.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="query-predicate-format"><a class="anchor" href="#query-predicate-format"></a>Format of Query Predicate</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order for the optimizer to select the correct array index for a SELECT, UPDATE, or DELETE statement, the query predicate which appears in the WHERE clause must be constructed to match the format of the array index key.</p>
</div>
<div class="paragraph">
<p>Consider the following expressions used in a CREATE INDEX statement:</p>
</div>
<table class="tableblock frame-none grid-none stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div id="c1" class="listingblock">
<div class="title">C1</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-n1ql hljs" data-lang="n1ql">DISTINCT ARRAY f(x) FOR x IN expr1 END;</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div id="c2" class="listingblock">
<div class="title">C2</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-n1ql hljs" data-lang="n1ql">DISTINCT ARRAY f(x) FOR x WITHIN expr1 END;</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>And the following expressions used in the SELECT statement WHERE clause:</p>
</div>
<table class="tableblock frame-none grid-none stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div id="q1" class="listingblock">
<div class="title">Q1</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-n1ql hljs" data-lang="n1ql">ANY x IN expr2 SATISFIES g(x) END;</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div id="q2" class="listingblock">
<div class="title">Q2</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-n1ql hljs" data-lang="n1ql">ANY x WITHIN expr2 SATISFIES g(x) END;</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following dependencies must be satisfied for the Query service to consider the array index:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The index keys used in CREATE INDEX must be used in the WHERE clause.
(The query can use different variable names from those used in the array index definition.)</p>
</li>
<li>
<p>The <code>expr2</code> in <a href="#q1">Q1</a> and <a href="#q2">Q2</a> must be equivalent to the <code>expr1</code> in <a href="#c1">C1</a> and <a href="#c2">C2</a>.
This is a formal notion of equivalence.
For example, they must be the same expressions, or equivalent arithmetic expressions such as <code>(x+y)</code> and <code>(y+x)</code>.</p>
</li>
<li>
<p>Usually, <code>g(x)</code> in <a href="#q1">Q1</a> and <a href="#q2">Q2</a> must be sargable for <code>f(x)</code> in <a href="#c1">C1</a> and <a href="#c2">C2</a>.
In other words, if there were a scalar index with key <code>f(x)</code>, then that index would be applicable to the predicate <code>g(x)</code>.
For example, the predicate <code>UPPER(x) LIKE "John%"</code> is sargable for the index key <code>UPPER(x)</code>.</p>
</li>
</ul>
</div>
<h5 id="flatten-keys" class="discrete">Flatten Keys</h5>
<div class="paragraph">
<p>Now consider the following variants of <a href="#c1">C1</a> and <a href="#c2">C2</a>, in which the index key <code>f(x)</code> uses the <a href="metafun.html#flatten_keys" class="xref page">FLATTEN_KEYS()</a> function to flatten expressions within the array:</p>
</div>
<table class="tableblock frame-none grid-none stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div id="c3" class="listingblock">
<div class="title">C3</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-n1ql hljs" data-lang="n1ql">DISTINCT ARRAY
  FLATTEN_KEYS(f1(x) ASC, f2(x) DESC)
  FOR x IN expr1 END;</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div id="c4" class="listingblock">
<div class="title">C4</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-n1ql hljs" data-lang="n1ql">DISTINCT ARRAY
  FLATTEN_KEYS(f1(x) ASC, f2(x) DESC)
  FOR x WITHIN expr1 END;</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>The index keys <a href="#c3">C3</a> and <a href="#c4">C4</a> flatten expressions within the array, as if they were separate index keys; and all subsequent index keys are accordingly moved to the right.
Queries will be sargable and will generate spans.</p>
</li>
<li>
<p>In order to select an array index defined using <a href="#c3">C3</a> or <a href="#c4">C4</a>, the predicate <code>g(x)</code> in <a href="#q1">Q1</a> and <a href="#q2">Q2</a> must be sargable for one of the <em>arguments</em> of the <a href="metafun.html#flatten_keys" class="xref page">FLATTEN_KEYS()</a> function&#8201;&#8212;&#8201;<code>f1(x)</code> or <code>f2(x)</code>.</p>
</li>
</ul>
</div>
<h5 id="in-vs-within" class="discrete">IN vs. WITHIN</h5>
<div class="ulist">
<ul>
<li>
<p>Index key <a href="#c1">C1</a> can be used for query predicate <a href="#q1">Q1</a>.
Index key <a href="#c2">C2</a> can be used for both query predicates <a href="#q1">Q1</a> and <a href="#q2">Q2</a>.</p>
</li>
<li>
<p>Index key <a href="#c2">C2</a> is strictly more expensive than index key <a href="#c1">C1</a>, for both index maintenance and query processing.
Index key <a href="#c2">C2</a> and query predicate <a href="#q2">Q2</a> are very powerful.
They can efficiently index and query recursive trees of arbitrary depth.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/indexing-arrays.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div id="example-1" class="exampleblock">
<div class="title">Example 1. Array index of distinct elements</div>
<div class="content">
<div id="C1" class="listingblock">
<div class="title">Index: Create an index on all schedules</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx_sched
ON route
( DISTINCT ARRAY v.flight FOR v IN schedule END );</code></pre>
</div>
</div>
<div id="Q1" class="listingblock">
<div class="title">Query: Find the list of scheduled 'UA' flights</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT * FROM route
WHERE ANY v IN schedule SATISFIES v.flight LIKE 'UA%' END;</code></pre>
</div>
</div>
</div>
</div>
<div id="example-2" class="exampleblock">
<div class="title">Example 2. Partial array index</div>
<div class="content">
<div class="paragraph">
<p>Create a partial index (with WHERE clause) of individual attributes from selected elements (using WHEN clause) of an array.</p>
</div>
<div id="C2" class="listingblock">
<div class="title">Index: Create an index on flights from San Francisco scheduled in the first 4 days of the week</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx_flight_sfo
ON route
( ALL ARRAY v.flight FOR v IN schedule WHEN v.day &lt; 4 END )
WHERE sourceairport = "SFO";</code></pre>
</div>
</div>
<div id="Q2" class="listingblock">
<div class="title">Query: Find the list of scheduled 'UA' flights on day 1</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT * FROM route
WHERE sourceairport = "SFO" <i class="conum" data-value="1"></i><b>(1)</b>
AND ANY v IN schedule SATISFIES (v.flight LIKE 'UA%') <i class="conum" data-value="2"></i><b>(2)</b>
AND (v.day=1) END; <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the <a href="#C2">Index</a> qualifies for the <a href="#Q2">Query</a> because:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <a href="#Q2">Query</a> predicate <code>sourceairport = "SFO"</code> matches that of the partial index WHERE clause.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The ANY operator uses the index key <code>v.flight</code> on which <a href="#C2">Index</a> is defined.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The ANY-SATISFIES condition <code>v.day=1</code> in the <a href="#Q2">Query</a> is sargable to the WHEN clause condition <code>v.day &lt; 4</code> in the index definition.</td>
</tr>
</table>
</div>
</div>
</div>
<div id="example-3" class="exampleblock">
<div class="title">Example 3. Flattened array index</div>
<div class="content">
<div id="C3" class="listingblock">
<div class="title">Index: Create an index on day and flight from schedule array</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX ixf_sched
  ON route
  (ALL ARRAY FLATTEN_KEYS(s.day DESC, s.flight) FOR s IN schedule END,
  sourceairport, destinationairport, stops);</code></pre>
</div>
</div>
<div id="Q3A" class="listingblock">
<div class="title">Query A: Find the weekday Delta flights FROM SFO to ATL</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT META(r).id
  FROM route AS r
  WHERE r.sourceairport = "SFO" <i class="conum" data-value="1"></i><b>(1)</b>
    AND r.destinationairport = "ATL" <i class="conum" data-value="2"></i><b>(2)</b>
    AND ANY s IN r.schedule SATISFIES s.day BETWEEN 1 AND 5 <i class="conum" data-value="3"></i><b>(3)</b>
    AND s.flight LIKE "DL%" END; <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, <a href="#Q3A">Query A</a> is able to use the <code>ixf_sched</code> index defined by the <a href="#C3">Index</a>, pass all the predicate information to index scan, and cover the query.</p>
</div>
<div class="listingblock">
<div class="title">Partial Explain Plan</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-JSON hljs" data-lang="JSON">"spans": [
             {
                 "exact": true,
                 "range": [
                     {
                         "high": "5",
                         "inclusion": 3,
                         "index_key": "(`s`.`day`)", <i class="conum" data-value="3"></i><b>(3)</b>
                         "low": "1"
                     },
                     {
                         "high": "\"DM\"",
                         "inclusion": 1,
                         "index_key": "(`s`.`flight`)", <i class="conum" data-value="4"></i><b>(4)</b>
                         "low": "\"DL\""
                     },
                     {
                         "high": "\"SFO\"",
                         "inclusion": 3,
                         "index_key": "`sourceairport`", <i class="conum" data-value="1"></i><b>(1)</b>
                         "low": "\"SFO\""
                     },
                     {
                         "high": "\"ATL\"",
                         "inclusion": 3,
                         "index_key": "`destinationairport`", <i class="conum" data-value="2"></i><b>(2)</b>
                         "low": "\"ATL\""
                     }

                 ]
             }
         ]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>r.sourceairport = "SFO"</code> is able to match and pass to IndexScan.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>r.destinationairport = "ATL"</code> is able to match and pass to IndexScan.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>ARRAY predicate <code>s.day BETWEEN 1 AND 5</code> is able to match and pass to IndexScan.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>ARRAY predicate <code>s.flight LIKE "DL%"</code> is able to match and pass to IndexScan.</td>
</tr>
</table>
</div>
<div id="Q3B" class="listingblock">
<div class="title">Query B: Find the weekday Delta flights from SFO to ATL</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT  s.day, s.flight,r.sourceairport, r.destinationairport, r.stops
FROM route AS r
UNNEST r.schedule AS s
WHERE r.sourceairport = "SFO" AND r.destinationairport = "ATL"
      AND s.day BETWEEN 1 AND 5 AND s.flight LIKE "DL%"
ORDER BY s.day DESC
OFFSET 2
LIMIT 3;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This query performs a covering UNNEST IndexScan, by applying all the predicates, using the <code>ixf_sched</code> index defined by the <a href="#C3">Index</a>.
Even though the ORDER BY key uses an array index key, it can use index order, and pass LIMIT and OFFSET to the indexer.</p>
</div>
</div>
</div>
<div id="example-missing" class="exampleblock">
<div class="title">Example 4. Array index with missing leading key</div>
<div class="content">
<div class="paragraph">
<p><span class="status">Couchbase Server 7.1.2</span></p>
</div>
<div class="paragraph">
<p>The following statement creates an index of flight numbers from the <code>schedule</code> array for all routes.
If the schedule array is missing from any route, that route is indexed anyway.</p>
</div>
<div class="paragraph">
<p>Compare this statement with the <a href="#C1">Index</a> in <a href="#example-1">Example 1</a>.</p>
</div>
<div class="listingblock">
<div class="title">Index I: Create an array index, including missing leading key</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx_sched_missing
ON route
(DISTINCT ARRAY v.flight FOR v IN schedule END INCLUDE MISSING);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following statement creates a flattened index on the time (<code>utc</code>) and day from the <code>schedule</code> array for all routes.
If the <code>utc</code> element is missing from any schedule, that schedule is indexed anyway.</p>
</div>
<div class="listingblock">
<div class="title">Index II: Create a flattened array index, including missing leading key</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX ixf_sched_missing
ON route
(DISTINCT ARRAY FLATTEN_KEYS(v.utc INCLUDE MISSING, v.day) FOR v IN schedule END);</code></pre>
</div>
</div>
</div>
</div>
<div id="example-4" class="exampleblock">
<div class="title">Example 5. Composite array index</div>
<div class="content">
<div id="C4" class="listingblock">
<div class="title">Index: Create an index on individual elements of an array and other non-array fields</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx_flight_stops
ON route
    ( stops, DISTINCT ARRAY v.flight FOR v IN schedule END );</code></pre>
</div>
</div>
<div id="Q4" class="listingblock">
<div class="title">Query: Find the list of scheduled 'FL' flights that have one or more stops</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT * FROM route
WHERE stops &gt;=1
AND ANY v IN schedule SATISFIES v.flight LIKE 'FL%' END;</code></pre>
</div>
</div>
</div>
</div>
<div id="example-5" class="exampleblock">
<div class="title">Example 6. Nested array index</div>
<div class="content">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Please note that the example below will alter the data in your sample buckets.
To restore your sample data, remove and reinstall the <code>travel-sample</code> bucket.
Refer to <a href="../../manage/manage-settings/install-sample-buckets.html" class="xref page">Sample Buckets</a> for details.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Update: Create a nested array</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">UPDATE route
SET schedule[0] = {"day" : 7, "special_flights" :
               [ {"flight" : "AI444", "utc" : "4:44:44"},
                 {"flight" : "AI333", "utc" : "3:33:33"}
               ] }
WHERE destinationairport = "CDG" AND sourceairport = "TLV";</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the DISTINCT ARRAY clause in a nested fashion to index specific attributes of a document when the array contains other arrays or documents that contain arrays.</p>
</div>
<div id="C5i" class="listingblock">
<div class="title">Index I: Create a partial index on a nested array</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx_nested ON route
    (DISTINCT ARRAY
        (DISTINCT ARRAY y.flight <i class="conum" data-value="1"></i><b>(1)</b>
        FOR y IN x.special_flights END)
    FOR x IN schedule END);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In this case, the inner ARRAY construct is used as the <code>var_expr</code> for the outer ARRAY construct in the SQL++ Syntax above.</td>
</tr>
</table>
</div>
<div id="Q5A" class="listingblock">
<div class="title">Query A: Use nested ANY operator to use the index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT count(*) FROM route
WHERE ANY x in schedule SATISFIES
    (ANY y in x.special_flights SATISFIES y.flight IS NOT NULL END)
END;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This query uses the index <code>idx_nested</code> defined by <a href="#C5i">Index I</a>.
It returns 3 results, as there are 3 routes with special flights.</p>
</div>
<div id="Q5B" class="listingblock">
<div class="title">Query B: Use UNNEST operators to use the index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT count(*) FROM route
UNNEST schedule AS x
UNNEST x.special_flights AS y
WHERE y.flight IS NOT NULL;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This query uses the index <code>idx_nested</code> defined by <a href="#C5i">Index I</a>.
It returns 6 results, as there are 3 routes with 2 special flights each.</p>
</div>
<div id="C5ii" class="listingblock">
<div class="title">Index II: Create a flattened index on a nested array</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX ixf_sched_nested ON route
    (ALL ARRAY
        (ALL ARRAY FLATTEN_KEYS(s.day, sf.flight)
         FOR sf IN s.special_flights END)
    FOR s IN schedule END);</code></pre>
</div>
</div>
<div id="Q5C" class="listingblock">
<div class="title">Query C: Use nested ANY operator to use the index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT RAW count(1)
FROM route AS r
WHERE ANY s IN schedule
      SATISFIES (ANY sf IN s.special_flights
                 SATISFIES sf.flight IS NOT NULL AND s.day = 7
                 END)
      END;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This query performs a covering UNNEST IndexScan, by applying the predicates on both levels of the ARRAY, using the index <code>ixf_sched_nested</code> defined by <a href="#C5ii">Index II</a>.</p>
</div>
<div id="Q5D" class="listingblock">
<div class="title">Query D: Use UNNEST operators to use the index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT RAW count(1)
FROM route AS r
UNNEST r.schedule AS s
UNNEST s.special_flights AS sf
WHERE sf.flight IS NOT NULL AND s.day = 7;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This query performs a covering UNNEST IndexScan, by applying the predicates on both levels of the ARRAY, using the index <code>ixf_sched_nested</code> defined by <a href="#C5ii">Index II</a>; and uses index aggregation.</p>
</div>
</div>
</div>
<div id="example-6" class="exampleblock">
<div class="title">Example 7. Array index on compound object</div>
<div class="content">
<div id="C6" class="listingblock">
<div class="title">Index: Create an index on multiple elements of an array</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx_flight_day ON route
    (DISTINCT ARRAY [v.flight, v.day] FOR v IN schedule END);</code></pre>
</div>
</div>
<div id="Q6" class="listingblock">
<div class="title">Query: Find the list of scheduled 'US681' flights on day 2</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT meta().id FROM route
WHERE ANY v in schedule SATISFIES [v.flight, v.day] = ["US681", 2] END;</code></pre>
</div>
</div>
</div>
</div>
<div id="example-7" class="exampleblock">
<div class="title">Example 8. Simplified array index</div>
<div class="content">
<div id="C7" class="listingblock">
<div class="title">Index: Create an index on all schedules using simplified array index syntax</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx_sched_simple
ON route (ALL schedule);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following queries find details of all route documents matching a specific schedule.</p>
</div>
<div id="Q7A" class="listingblock">
<div class="title">Query A: Use ANY operator to use the index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT * FROM route
WHERE ANY v IN schedule
SATISFIES v = {"day":2, "flight": "US681", "utc": "19:20:00"} END; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Elements of the schedule array are objects, and hence the right side value of the predicate condition should be a similarly structured object.</td>
</tr>
</table>
</div>
<div id="Q7B" class="listingblock">
<div class="title">Query B: Use UNNEST operator to use the index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT * FROM route t
UNNEST schedule sch
WHERE sch = {"day":2, "flight": "US681", "utc": "19:20:00"};</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a variant of <a href="#Q7A">Query A</a> using UNNEST in the SELECT statement.</p>
</div>
<div id="Q7C" class="listingblock">
<div class="title">Query C: Alternative using a flattened array index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT META(r).id
FROM route AS r
WHERE ANY v IN r.schedule SATISFIES v.day = 2 AND v.flight = "US681" END;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For comparison, this query performs a covering index scan, by applying all the predicates, using <code>ixf_sched</code> defined by the <a href="#C3">Index</a> in <a href="#example-3">Example 3</a>.
The query syntax is more intuitive than <a href="#Q7A">Query A</a> and <a href="#Q7B">Query B</a>, since the multiple fields within the array have not required complex indexing.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="covering-array-index"><a class="anchor" href="#covering-array-index"></a>Covering Array Index</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Covering indexes are an efficient method of using an Index for a particular query, whereby the index itself can completely cover the query in terms of providing all data required for the query.
Basically, it avoids the fetch phase of the query processing and related overhead in fetching the required documents from data-service nodes.
For more details, see <a href="covering-indexes.html" class="xref page">Covering Indexes</a>.</p>
</div>
<div class="paragraph">
<p>Array indexing requires special attention to create covering array indexes.
In general, the array field itself should be included as one of the index keys in the CREATE INDEX definition.
For instance, in <a href="#example-1">Example 1</a>, the <a href="#C1">Index</a> does not cover the <a href="#Q1">Query</a> because the <a href="#Q1">Query</a> projection list includes * which needs to fetch the document from the Data Service.</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/indexing-arrays.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div id="example-8" class="exampleblock">
<div class="title">Example 9. Covering Array Index</div>
<div class="content">
<div id="C8i" class="listingblock">
<div class="title">Index I: Creating a Covering Array Index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx_sched_cover ON route
    (DISTINCT ARRAY v.flight FOR v IN schedule END, schedule);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The index keys of an index must be used in the WHERE clause of a DML statement to use the index for that query.
In the SELECT or DML WHERE clause, Covering Array Indexes can be used by the following operators:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ANY: As shown in <a href="#Q8A">Query A</a> below.</p>
</li>
<li>
<p>ANY AND EVERY: As shown in <a href="#Q8B">Query B</a> (a variant of <a href="#Q8A">Query A</a>) below.</p>
</li>
</ul>
</div>
<div id="Q8A" class="listingblock">
<div class="title">Query A: Covering Array Index using the ANY clause</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">EXPLAIN SELECT meta().id FROM route
USE INDEX (idx_sched_cover) <i class="conum" data-value="1"></i><b>(1)</b>
WHERE ANY v IN schedule SATISFIES v.flight LIKE 'UA%' END;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In this example, <a href="#Q8A">Query A</a> needs <a href="#C8i">Index I</a> to cover it because the query predicate refers to the array <code>schedule</code> in the ANY operator.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-JSON hljs" data-lang="JSON">[
  {
    "plan": {
      "#operator": "Sequence",
      "~children": [
        {
          "#operator": "DistinctScan",
          "scan": {
            "#operator": "IndexScan3",
            "bucket": "travel-sample",
            "covers": [
              "cover ((distinct (array (`v`.`flight`) for `v` in (`route`.`schedule`) end)))",
              "cover ((`route`.`schedule`))",
              "cover ((meta(`route`).`id`))"
            ],
            "filter": "cover (any `v` in (`route`.`schedule`) satisfies ((`v`.`flight`) like \"UA%\") end)",
            "filter_covers": {
              "cover (any `v` in (`route`.`schedule`) satisfies ((\"UA\" &lt;= (`v`.`flight`)) and ((`v`.`flight`) &lt; \"UB\")) end)": true,
              "cover (any `v` in (`route`.`schedule`) satisfies ((`v`.`flight`) like \"UA%\") end)": true
            },
            "index": "idx_sched_cover",
          // ...
          }
        }
      ]
    }
  }
]</code></pre>
</div>
</div>
<div id="Q8B" class="listingblock">
<div class="title">Query B: Covering Array Index using the ANY AND EVERY clause</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">EXPLAIN SELECT meta().id FROM route
USE INDEX (idx_sched_cover)
WHERE ANY AND EVERY v IN schedule SATISFIES v.flight LIKE 'UA%' END;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-JSON hljs" data-lang="JSON">[
  {
    "plan": {
      "#operator": "Sequence",
      "~children": [
        {
          "#operator": "DistinctScan",
          "scan": {
            "#operator": "IndexScan3",
            "bucket": "travel-sample",
            "covers": [
              "cover ((distinct (array (`v`.`flight`) for `v` in (`route`.`schedule`) end)))",
              "cover ((`route`.`schedule`))",
              "cover ((meta(`route`).`id`))"
            ],
            "filter": "any and every `v` in cover ((`route`.`schedule`)) satisfies ((`v`.`flight`) like \"UA%\") end",
            "index": "idx_sched_cover",
          // ...
          }
        }
      ]
    }
  }
]</code></pre>
</div>
</div>
<div id="Q8C" class="listingblock">
<div class="title">Query C: Covering Array Index using the UNNEST clause and aliasing</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">EXPLAIN SELECT meta(t).id FROM route t
USE INDEX (idx_sched_cover)
UNNEST schedule v
WHERE v.flight LIKE 'UA%';</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-JSON hljs" data-lang="JSON">[
  {
    "plan": {
      "#operator": "Sequence",
      "~children": [
        {
          "#operator": "DistinctScan",
          "scan": {
            "#operator": "IndexScan3",
            "as": "t",
            "bucket": "travel-sample",
            "covers": [
              "cover ((distinct (array (`v`.`flight`) for `v` in (`t`.`schedule`) end)))",
              "cover ((`t`.`schedule`))",
              "cover ((meta(`t`).`id`))"
            ],
            "filter": "is_array(cover ((`t`.`schedule`)))",
            "index": "idx_sched_cover",
          // ...
          }
        }
      ]
    }
  }
]</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In this example, <a href="#Q8A">Query A</a> has the following limitation: the collection operator EVERY cannot use array indexes or covering array indexes because the EVERY operator needs to apply the SATISFIES predicate to all elements in the array, including the case where an array has zero elements.</p>
</div>
<div class="paragraph">
<p>As items cannot be indexed, it is not possible to index MISSING items, so the EVERY operator is evaluated in the SQL++ engine and cannot leverage the array index scan.</p>
</div>
<div class="paragraph">
<p>For example, <a href="#Q8D">Query D</a> below uses the primary index <code>def_inventory_route_primary</code> ignoring the <a href="hints.html#use-index-clause" class="xref page">USE INDEX</a> hint to use the array indexes.
(Note that in this example, <a href="#C8i">Index I</a> defines a DISTINCT array index while <a href="#C8ii">Index II</a> defines an ALL array index, and both are ignored).</p>
</div>
</td>
</tr>
</table>
</div>
<div id="C8ii" class="listingblock">
<div class="title">Index II: Non-array index with an ALL array index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx_sched_cover_all ON route
    (ALL ARRAY v.flight FOR v IN schedule END, schedule);</code></pre>
</div>
</div>
<div id="Q8D" class="listingblock">
<div class="title">Query D: Non-array index with an ALL array index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">EXPLAIN SELECT meta().id FROM route
USE INDEX (idx_sched_cover_all, idx_sched_cover)
WHERE EVERY v IN schedule SATISFIES v.flight LIKE 'UA%' END;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-JSON hljs" data-lang="JSON">[
  {
    "plan": {
      "#operator": "Sequence",
      "~children": [
        {
          "#operator": "PrimaryScan3",
          "bucket": "travel-sample",
          "index": "def_inventory_route_primary",
        // ...
        }
      ]
    }
  }
]</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="implicit-covering-array-index"><a class="anchor" href="#implicit-covering-array-index"></a>Implicit Covering Array Index</h2>
<div class="sectionbody">
<div class="paragraph">
<p>SQL++ supports simplified Implicit Covering Array Index syntax in certain cases where the mandatory array index-key requirement is relaxed to create a covering array-index.
This special optimization applies to those queries and DML which have WHERE clause predicates that can be exactly and completely pushed to the indexer during the array index scan.</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/n1ql/pages/n1ql-language-reference/indexing-arrays.adoc - include::ROOT:partial$query-context.adoc[]</p>
</div>
<div id="example-9" class="exampleblock">
<div class="title">Example 10. ANY operator with an =, &lt;, &gt;, and LIKE predicate in the SATISFIES clause</div>
<div class="content">
<div class="paragraph">
<p>Note that the GSI indexes are tree structures that support exact match and range matches.
And the ANY predicate returns <code>true</code> as long as it finds at least one matching item in the index.
Hence, an item found in the index can cover the query.
Furthermore, this is covered by both ALL and DISTINCT array indexes.</p>
</div>
<div id="C9" class="listingblock">
<div class="title">Index: Creating an Implicit Covering Array Index with DISTINCT</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx_sched_cover_simple ON route
    (DISTINCT ARRAY v.flight FOR v IN schedule END);</code></pre>
</div>
</div>
<div id="Q9" class="listingblock">
<div class="title">Query: Implicit Covering Array Index using the ANY clause</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">EXPLAIN SELECT meta().id FROM route
USE INDEX (idx_sched_cover_simple)
WHERE ANY v IN schedule SATISFIES v.flight LIKE 'UA%' END;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-JSON hljs" data-lang="JSON">[
  {
    "plan": {
      "#operator": "Sequence",
      "~children": [
        {
          "#operator": "DistinctScan",
          "scan": {
            "#operator": "IndexScan3",
            "bucket": "travel-sample",
            "covers": [
              "cover ((distinct (array (`v`.`flight`) for `v` in (`route`.`schedule`) end)))",
              "cover ((meta(`route`).`id`))"
            ],
            "filter": "cover (any `v` in (`route`.`schedule`) satisfies ((`v`.`flight`) like \"UA%\") end)",
            "filter_covers": {
              "cover (any `v` in (`route`.`schedule`) satisfies ((\"UA\" &lt;= (`v`.`flight`)) and ((`v`.`flight`) &lt; \"UB\")) end)": true,
              "cover (any `v` in (`route`.`schedule`) satisfies ((`v`.`flight`) like \"UA%\") end)": true
            },
            "index": "idx_sched_cover_simple",
          // ...
          }
        }
      ]
    }
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div id="example-10" class="exampleblock">
<div class="title">Example 11. UNNEST operator with =, &lt;, &gt;, or LIKE predicate in the WHERE clause</div>
<div class="content">
<div class="paragraph">
<p>This applies to only ALL array indexes because, for such index, all array elements are indexed in the array index, and the UNNEST operation needs all the elements to reconstruct the array.
Note that the array cannot be reconstructed if on DISTINCT elements of the array are indexed.</p>
</div>
<div class="paragraph">
<p>In this example, <a href="#Q10A">Query A</a> can be covered with the ALL index <code>idx_sched_cover_simple_all</code> defined by the <a href="#C10">Index</a>, but <a href="#Q10B">Query B</a> is not covered when using the DISTINCT index <code>idx_sched_cover_simple</code> defined by the <a href="#C9">Index</a> in <a href="#example-9">Example 10</a>.</p>
</div>
<div id="C10" class="listingblock">
<div class="title">Index: UNNEST covered with the ALL index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX idx_sched_cover_simple_all ON route
    (ALL ARRAY v.flight FOR v IN schedule END);</code></pre>
</div>
</div>
<div id="Q10A" class="listingblock">
<div class="title">Query A: UNNEST covered with the ALL index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">EXPLAIN SELECT meta(t).id FROM route t
USE INDEX (idx_sched_cover_simple_all)
UNNEST schedule v
WHERE v.flight LIKE 'UA%';</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-JSON hljs" data-lang="JSON">[
  {
    "plan": {
      "#operator": "Sequence",
      "~children": [
        {
          "#operator": "IndexScan3",
          "as": "t",
          "bucket": "travel-sample",
          "covers": [
            "cover ((`v`.`flight`))",
            "cover ((meta(`t`).`id`))"
          ],
          "filter": "cover (is_array((`t`.`schedule`)))",
          "filter_covers": {
            "cover (((`t`.`schedule`) &lt; {}))": true,
            "cover (([] &lt;= (`t`.`schedule`)))": true,
            "cover (is_array((`t`.`schedule`)))": true
          },
          "index": "idx_sched_cover_simple_all",
          "index_id": "de0704c3fdb45b07",
          "keyspace": "route",
          "namespace": "default",
          "scope": "inventory",
          "spans": [
            {
              "exact": true,
              "range": [
                {
                  "high": "\"UB\"",
                  "inclusion": 1,
                  "low": "\"UA\""
                }
              ]
            }
          ],
          "using": "gsi"
        },
      // ...
      ]
    }
  }
]</code></pre>
</div>
</div>
<div id="Q10B" class="listingblock">
<div class="title">Query B: UNNEST not covered when using the DISTINCT index</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">EXPLAIN SELECT meta(t).id FROM route t
USE INDEX (idx_sched_cover_simple)
UNNEST schedule v
WHERE v.flight LIKE 'UA%';</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-JSON hljs" data-lang="JSON">[
  {
    "plan": {
      "#operator": "Sequence",
      "~children": [
        {
          "#operator": "DistinctScan",
          "scan": {
            "#operator": "IndexScan3",
            "as": "t",
            "bucket": "travel-sample",
            "index": "idx_sched_cover_simple",
            "index_id": "198a2bc8b0a3ea55",
            "index_projection": {
              "primary_key": true
            },
            "keyspace": "route",
            "namespace": "default",
            "scope": "inventory",
            "spans": [
              {
                "exact": true,
                "range": [
                  {
                    "high": "\"UB\"",
                    "inclusion": 1,
                    "low": "\"UA\""
                  }
                ]
              }
            ],
            "using": "gsi"
          }
        // ...
        }
      ]
    }
  }
]</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="summary"><a class="anchor" href="#summary"></a>Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following table summarizes SQL++-supported collection operators in the DML WHERE clause for different kinds of array index features:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. SQL++-supported collection operators</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">Operator in the SELECT/DML WHERE clause</th>
<th class="tableblock halign-center valign-top">Array Index</th>
<th class="tableblock halign-center valign-top">Covering Array Index (with explicit array index-key)</th>
<th class="tableblock halign-center valign-top">Implicit Covering Array Index (without explicit array index-key)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong>ANY</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✓ (both ALL &amp; DISTINCT)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✓ (both ALL &amp; DISTINCT)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✓ (both ALL &amp; DISTINCT)</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong>UNNEST</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✓ (only ALL, with array as leading index-key)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✓ (only ALL, with array as leading index-key)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✓ (only ALL, with array as leading index-key)</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong>ANY AND EVERY</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✓ (both ALL &amp; DISTINCT)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✓ (both ALL &amp; DISTINCT)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✘</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong>EVERY</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✘</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✘</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✘</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In Couchbase Server 6.5 and later, you can use any arbitrary alias for the right side of an UNNEST&#8201;&#8212;&#8201;the alias does not have to be the same as the ARRAY index variable name in order to use that index.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2023 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Server","components":["server"],"url":"/home/server.html","latestVersions":{"server":"7.2"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../../../_/js/site.js"></script>
<script defer src="../../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
</body>
</html>
